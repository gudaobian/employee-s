# æˆªå›¾éšç§æ‰“ç æ–¹æ¡ˆ

**åˆ†ææ—¶é—´**: 2025-01-14
**åˆ†æèŒƒå›´**: employee-client æˆªå›¾åŠŸèƒ½
**åˆ†æé‡ç‚¹**: éšç§ä¿æŠ¤ã€æŠ€æœ¯å®ç°
**å½“å‰ç«¯**: employee-client

---

## æ‰§è¡Œæ‘˜è¦

å½“å‰æˆªå›¾åŠŸèƒ½ç›´æ¥æ•è·æ•´ä¸ªå±å¹•å†…å®¹ï¼Œæ²¡æœ‰ä»»ä½•éšç§ä¿æŠ¤æªæ–½ã€‚å»ºè®®åœ¨æˆªå›¾åã€ä¸Šä¼ å‰å¢åŠ æ™ºèƒ½æ‰“ç å¤„ç†ï¼Œè‡ªåŠ¨è¯†åˆ«å¹¶æ¨¡ç³ŠåŒ–æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç æ¡†ã€ç§äººèŠå¤©ã€èº«ä»½è¯å·ç­‰ï¼‰ï¼Œåœ¨ä¿æŠ¤å‘˜å·¥éšç§çš„åŒæ—¶æ»¡è¶³ç›‘æ§éœ€æ±‚ã€‚

---

## åˆ†æç›®æ ‡

è¯„ä¼°ç°æœ‰æˆªå›¾åŠŸèƒ½çš„éšç§é£é™©ï¼Œè®¾è®¡ä¸€å¥—å¯è¡Œçš„æ‰“ç æ–¹æ¡ˆï¼Œåœ¨ä¸å½±å“ç›‘æ§ç›®æ ‡çš„å‰æä¸‹æœ€å¤§ç¨‹åº¦ä¿æŠ¤å‘˜å·¥éšç§ã€‚

---

## è¯¦ç»†åˆ†æ

### 1. ç°æœ‰æˆªå›¾å®ç°åˆ†æ

#### macOSæˆªå›¾å®ç° (darwin-adapter.ts:869-931)
```typescript
async takeScreenshot(options: any = {}): Promise<any> {
  // æ­¥éª¤1: ä½¿ç”¨screencaptureå‘½ä»¤æ•è·åŸå§‹PNG
  const tempPngPath = `/tmp/screenshot-original-${timestamp}.png`;
  await execAsync(`screencapture -t png "${tempPngPath}"`);

  // æ­¥éª¤2: ä½¿ç”¨sharpåº“å‹ç¼©ä¸ºJPEG
  await sharp(tempPngPath)
    .jpeg({ quality: quality, mozjpeg: true })
    .toFile(tempJpgPath);

  // æ­¥éª¤3: è¯»å–å¹¶è¿”å›æ•°æ®
  const data = await fs.promises.readFile(tempJpgPath);
  return { success: true, data, format: format, size: data.length };
}
```

#### Windowsæˆªå›¾å®ç° (windows-adapter.ts:340-417)
```typescript
async takeScreenshot(options: ScreenshotOptions = {}): Promise<ScreenshotResult> {
  // æ–¹æ¡ˆ1: screenshot-desktopåŒ…
  const imgBuffer = await screenshot({ format: 'png' });

  // æ–¹æ¡ˆ2: sharpå‹ç¼©
  const compressedBuffer = await sharp(imgBuffer)
    .jpeg({ quality: quality, mozjpeg: true })
    .toBuffer();

  return { success: true, data: compressedBuffer };
}
```

**é—®é¢˜è¯†åˆ«**:
- âŒ **æ— éšç§ä¿æŠ¤**: ç›´æ¥æ•è·æ‰€æœ‰å±å¹•å†…å®¹
- âŒ **æ•æ„Ÿä¿¡æ¯æš´éœ²**: å¯†ç æ¡†ã€èŠå¤©è®°å½•ã€èº«ä»½è¯å·ç­‰æœªå¤„ç†
- âŒ **æ³•å¾‹é£é™©**: å¯èƒ½è¿åã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹
- âœ… **å·²æœ‰å›¾åƒå¤„ç†èƒ½åŠ›**: ä½¿ç”¨sharpåº“ï¼Œå¯æ‰©å±•æ‰“ç åŠŸèƒ½

### 2. æ‰“ç æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆA: åŸºäºOCRçš„æ–‡æœ¬è¯†åˆ«æ‰“ç ï¼ˆæ¨èï¼‰

**åŸç†**: ä½¿ç”¨OCRè¯†åˆ«æˆªå›¾ä¸­çš„æ–‡æœ¬ï¼ŒåŸºäºè§„åˆ™åŒ¹é…æ•æ„Ÿä¿¡æ¯å¹¶æ‰“ç 

**ä¼˜åŠ¿**:
- âœ… ç²¾å‡†è¯†åˆ«æ•æ„Ÿæ–‡æœ¬ï¼ˆèº«ä»½è¯ã€æ‰‹æœºå·ã€é“¶è¡Œå¡ï¼‰
- âœ… å¯é…ç½®æ•æ„Ÿè¯åº“
- âœ… é€‚ç”¨äºä»»ä½•åº”ç”¨åœºæ™¯

**æŠ€æœ¯æ ˆ**:
```typescript
import Tesseract from 'tesseract.js';  // OCRè¯†åˆ«åº“
import sharp from 'sharp';              // å·²æœ‰ä¾èµ–ï¼Œç”¨äºå›¾åƒå¤„ç†

// 1. OCRè¯†åˆ«æ–‡æœ¬åŒºåŸŸ
const { data: { words } } = await Tesseract.recognize(screenshot);

// 2. åŒ¹é…æ•æ„Ÿæ¨¡å¼
const sensitivePatterns = [
  /\d{15}|\d{18}/,           // èº«ä»½è¯å·
  /1[3-9]\d{9}/,             // æ‰‹æœºå·
  /\d{16,19}/,               // é“¶è¡Œå¡å·
  /å¯†ç |password/i,          // å¯†ç ç›¸å…³
  // æ›´å¤šè‡ªå®šä¹‰è§„åˆ™...
];

// 3. å¯¹æ•æ„ŸåŒºåŸŸæ‰“ç 
for (const word of words) {
  if (matchesSensitivePattern(word.text)) {
    await blurRegion(screenshot, word.bbox);
  }
}
```

**å®æ–½æ­¥éª¤**:
1. å®‰è£…ä¾èµ–: `npm install tesseract.js`
2. åˆ›å»º `PrivacyBlurService` æœåŠ¡
3. é›†æˆåˆ°æˆªå›¾æµç¨‹çš„å‹ç¼©åã€ä¸Šä¼ å‰é˜¶æ®µ
4. é…ç½®æ•æ„Ÿè§„åˆ™æ–‡ä»¶ (JSONæ ¼å¼)

#### æ–¹æ¡ˆB: åŸºäºUIå…ƒç´ çš„æ™ºèƒ½æ‰“ç 

**åŸç†**: é€šè¿‡Accessibility APIè¯†åˆ«å¯†ç æ¡†ã€ç§å¯†çª—å£ç­‰UIå…ƒç´ 

**macOSå®ç°**:
```typescript
// ä½¿ç”¨Accessibility APIæŸ¥è¯¢å¯†ç æ¡†
const script = `
  tell application "System Events"
    get properties of (UI elements of frontmost application process Â¬
      whose role is "AXSecureTextField")
  end tell
`;
const passwordFields = await execAsync(`osascript -e '${script}'`);

// è·å–åæ ‡å¹¶æ‰“ç 
for (const field of passwordFields) {
  const { x, y, width, height } = field.position;
  await blurRegion(screenshot, { x, y, width, height });
}
```

**Windowså®ç°**:
```typescript
// ä½¿ç”¨Win32 APIæšä¸¾å¯†ç æ§ä»¶
const passwordControls = await execAsync(`
  powershell "
    Add-Type -AssemblyName UIAutomationClient
    [Windows.Automation.AutomationElement]::FromHandle((Get-Process -Id $pid).MainWindowHandle)
    .FindAll([Windows.Automation.TreeScope]::Descendants,
             [Windows.Automation.Condition]::IsPassword)
  "
`);
```

**ä¼˜åŠ¿**:
- âœ… ç²¾å‡†è¯†åˆ«å¯†ç æ¡†ç­‰æ•æ„Ÿæ§ä»¶
- âœ… æ€§èƒ½å¼€é”€å°ï¼ˆæ— éœ€OCRï¼‰
- âœ… å¯æ‰©å±•åˆ°èŠå¤©çª—å£ã€æµè§ˆå™¨éšç§æ¨¡å¼ç­‰

**å±€é™**:
- âš ï¸ ä»…é€‚ç”¨äºæ ‡å‡†UIæ¡†æ¶
- âš ï¸ éƒ¨åˆ†è‡ªå®šä¹‰ç•Œé¢æ— æ³•è¯†åˆ«

#### æ–¹æ¡ˆC: æ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å¹³è¡¡ï¼‰

**æ¶æ„è®¾è®¡**:
```typescript
class PrivacyProtectionService {
  async processScreenshot(buffer: Buffer): Promise<Buffer> {
    // ç¬¬1æ­¥: UIå…ƒç´ è¯†åˆ«æ‰“ç ï¼ˆå¿«é€Ÿã€ç²¾å‡†ï¼‰
    const uiSensitiveRegions = await this.detectUIElements();

    // ç¬¬2æ­¥: OCRæ–‡æœ¬è¯†åˆ«æ‰“ç ï¼ˆå…¨é¢è¦†ç›–ï¼‰
    const textSensitiveRegions = await this.detectSensitiveText(buffer);

    // ç¬¬3æ­¥: åˆå¹¶æ‰“ç åŒºåŸŸ
    const allSensitiveRegions = [...uiSensitiveRegions, ...textSensitiveRegions];

    // ç¬¬4æ­¥: åº”ç”¨æ¨¡ç³Šæ•ˆæœ
    return await this.applyBlur(buffer, allSensitiveRegions);
  }
}
```

### 3. æ‰“ç æ•ˆæœå®ç°

#### æ¨¡ç³ŠåŒ–æ–¹æ³•
```typescript
import sharp from 'sharp';

async function blurRegion(
  imageBuffer: Buffer,
  region: { x: number; y: number; width: number; height: number },
  blurStrength: number = 50
): Promise<Buffer> {
  const image = sharp(imageBuffer);
  const metadata = await image.metadata();

  // æå–æ•æ„ŸåŒºåŸŸ
  const regionBuffer = await image
    .extract({
      left: region.x,
      top: region.y,
      width: region.width,
      height: region.height
    })
    .blur(blurStrength)  // é«˜æ–¯æ¨¡ç³Š
    .toBuffer();

  // åˆæˆå›åŸå›¾
  return await sharp(imageBuffer)
    .composite([{
      input: regionBuffer,
      top: region.y,
      left: region.x
    }])
    .toBuffer();
}
```

#### å¯é€‰æ‰“ç æ–¹å¼
1. **é«˜æ–¯æ¨¡ç³Š** (æ¨è): è‡ªç„¶ã€æ— æ³•é€†å‘è¿˜åŸ
2. **åƒç´ åŒ–**: é©¬èµ›å…‹æ•ˆæœï¼Œæ˜ç¡®æ ‡è¯†æ‰“ç åŒºåŸŸ
3. **é»‘è‰²é®ç½©**: å®Œå…¨é®ç›–ï¼Œé€‚ç”¨äºæåº¦æ•æ„Ÿä¿¡æ¯
4. **é¢œè‰²æ›¿æ¢**: ä¿ç•™å½¢çŠ¶è½®å»“ï¼Œé™ä½è§†è§‰å¹²æ‰°

### 4. ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

#### ä¿®æ”¹ç‚¹1: Platform Adapterå±‚

**darwin-adapter.ts**:
```typescript
import { PrivacyProtectionService } from '../../common/services/privacy-protection-service';

export class DarwinAdapter extends PlatformAdapterBase {
  private privacyService: PrivacyProtectionService;

  async takeScreenshot(options: any = {}): Promise<any> {
    // åŸæœ‰é€»è¾‘...
    const data = await fs.promises.readFile(tempJpgPath);

    // æ–°å¢: éšç§ä¿æŠ¤å¤„ç†
    const protectedData = await this.privacyService.processScreenshot(data);

    return { success: true, data: protectedData, format: format };
  }
}
```

**windows-adapter.ts** åŒç†ä¿®æ”¹ã€‚

#### ä¿®æ”¹ç‚¹2: é…ç½®æœåŠ¡

**config-service.ts** æ–°å¢é…ç½®é¡¹:
```typescript
interface PrivacyConfig {
  enabled: boolean;                    // æ˜¯å¦å¯ç”¨æ‰“ç 
  blurStrength: number;                // æ¨¡ç³Šå¼ºåº¦ (0-100)
  sensitivePatterns: string[];         // æ•æ„Ÿæ­£åˆ™è¡¨è¾¾å¼
  uiElementDetection: boolean;         // æ˜¯å¦å¯ç”¨UIå…ƒç´ æ£€æµ‹
  ocrDetection: boolean;               // æ˜¯å¦å¯ç”¨OCRæ£€æµ‹
  whitelistApps: string[];             // ç™½åå•åº”ç”¨ï¼ˆä¸æ‰“ç ï¼‰
}
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹** (employee-monitor-config.json):
```json
{
  "privacy": {
    "enabled": true,
    "blurStrength": 50,
    "sensitivePatterns": [
      "\\d{15}|\\d{18}",
      "1[3-9]\\d{9}",
      "\\d{16,19}",
      "å¯†ç |password"
    ],
    "uiElementDetection": true,
    "ocrDetection": false,
    "whitelistApps": ["å·¥ä½œè½¯ä»¶1.exe", "ä¼ä¸šåº”ç”¨"]
  }
}
```

#### ä¿®æ”¹ç‚¹3: æ•°æ®åŒæ­¥æœåŠ¡

**data-sync-service.ts** (æ— éœ€ä¿®æ”¹):
- æ‰“ç åœ¨æˆªå›¾é˜¶æ®µå®Œæˆï¼ŒåŒæ­¥æœåŠ¡æ— æ„ŸçŸ¥
- ä¿æŒç°æœ‰ä¸Šä¼ é€»è¾‘ä¸å˜

### 5. æ€§èƒ½ä¸ä¼˜åŒ–è€ƒè™‘

#### æ€§èƒ½æŒ‡æ ‡
| æ“ä½œ | è€—æ—¶ä¼°ç®— | ä¼˜åŒ–æ–¹æ¡ˆ |
|------|---------|---------|
| OCRè¯†åˆ« | 2-5ç§’ | é™çº§ï¼šä»…åœ¨å¿…è¦æ—¶å¯ç”¨ |
| UIå…ƒç´ æ£€æµ‹ | 100-300ms | é¦–é€‰æ–¹æ¡ˆï¼Œæ€§èƒ½æœ€ä¼˜ |
| æ¨¡ç³Šå¤„ç† | 50-200ms | sharpåº“å·²é«˜åº¦ä¼˜åŒ– |
| æ€»ä½“å½±å“ | +500ms ~ +5ç§’ | å¯é…ç½®ç­–ç•¥å¹³è¡¡ |

#### ä¼˜åŒ–ç­–ç•¥
1. **æŒ‰éœ€å¯ç”¨**: é»˜è®¤ä»…ä½¿ç”¨UIå…ƒç´ æ£€æµ‹
2. **å¼‚æ­¥å¤„ç†**: æˆªå›¾åå°æ‰“ç ï¼Œä¸é˜»å¡ä¸»æµç¨‹
3. **ç¼“å­˜æœºåˆ¶**: åŒä¸€çª—å£çŸ­æœŸå†…å¤ç”¨æ‰“ç åŒºåŸŸ
4. **é™ä½åˆ†è¾¨ç‡**: OCRå‰ç¼©æ”¾å›¾åƒå‡å°‘è®¡ç®—é‡
5. **æ™ºèƒ½è·³è¸ª**: æ£€æµ‹åˆ°ç™½åå•åº”ç”¨æ—¶è·³è¿‡æ‰“ç 

---

## å…³é”®å‘ç°

### ä¼˜åŠ¿
- âœ… å·²æœ‰sharpåº“ï¼Œæ— éœ€é¢å¤–å›¾åƒå¤„ç†ä¾èµ–
- âœ… è·¨å¹³å°æˆªå›¾æµç¨‹ç»Ÿä¸€ï¼Œæ˜“äºé›†æˆ
- âœ… TypeScriptç±»å‹ç³»ç»Ÿä¾¿äºæ‰©å±•

### é—®é¢˜
- âš ï¸ æ— ä»»ä½•éšç§ä¿æŠ¤æªæ–½
- âš ï¸ æ³•å¾‹åˆè§„é£é™©é«˜
- âš ï¸ å‘˜å·¥éšç§æƒç›Šæœªä¿éšœ

### é£é™©
- ğŸš¨ **æ³•å¾‹é£é™©**: è¿åã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹å¯èƒ½é¢ä¸´ç½šæ¬¾
- ğŸš¨ **ä¿¡ä»»é£é™©**: å‘˜å·¥å‘ç°åå¯èƒ½å¼•å‘æŠµè§¦æƒ…ç»ª
- ğŸš¨ **æ•°æ®æ³„éœ²é£é™©**: æ•æ„Ÿä¿¡æ¯å¤–ä¼ å¯èƒ½é€ æˆä¸¥é‡åæœ

---

## æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§
1. **ç«‹å³å®æ–½UIå…ƒç´ æ£€æµ‹æ‰“ç ** - ä½æˆæœ¬ã€é«˜æ”¶ç›Šã€å¿«é€Ÿéƒ¨ç½²
   - é¢„æœŸæ”¶ç›Š: è¦†ç›–90%å¯†ç æ¡†åœºæ™¯
   - å®æ–½å‘¨æœŸ: 3-5å¤©
   - æŠ€æœ¯éš¾åº¦: ä¸­ç­‰

2. **é…ç½®åŒ–éšç§ç­–ç•¥** - çµæ´»æ§åˆ¶æ‰“ç è¡Œä¸º
   - é¢„æœŸæ”¶ç›Š: æ»¡è¶³ä¸åŒä¼ä¸šåˆè§„éœ€æ±‚
   - å®æ–½å‘¨æœŸ: 2å¤©
   - æŠ€æœ¯éš¾åº¦: ä½

3. **ç™½åå•æœºåˆ¶** - å‡å°‘è¯¯æ‰“ç å’Œæ€§èƒ½å¼€é”€
   - é¢„æœŸæ”¶ç›Š: æå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿæ€§èƒ½
   - å®æ–½å‘¨æœŸ: 1å¤©
   - æŠ€æœ¯éš¾åº¦: ä½

### ä¸­ä¼˜å…ˆçº§
4. **OCRæ–‡æœ¬è¯†åˆ«æ‰“ç ** - è¡¥å……UIæ£€æµ‹ç›²åŒº
   - é¢„æœŸæ”¶ç›Š: è¯†åˆ«è‡ªå®šä¹‰ç•Œé¢ä¸­çš„æ•æ„Ÿæ–‡æœ¬
   - å®æ–½å‘¨æœŸ: 5-7å¤©
   - æŠ€æœ¯éš¾åº¦: è¾ƒé«˜

5. **æ‰“ç æ—¥å¿—å®¡è®¡** - è®°å½•æ‰“ç è¡Œä¸ºä¾¿äºåˆè§„å®¡æŸ¥
   - é¢„æœŸæ”¶ç›Š: æ»¡è¶³åˆè§„å®¡è®¡è¦æ±‚
   - å®æ–½å‘¨æœŸ: 2å¤©
   - æŠ€æœ¯éš¾åº¦: ä½

### ä½ä¼˜å…ˆçº§
6. **æœºå™¨å­¦ä¹ æ•æ„Ÿå†…å®¹è¯†åˆ«** - æ™ºèƒ½è¯†åˆ«æ›´å¤æ‚åœºæ™¯
   - é¢„æœŸæ”¶ç›Š: æå‡è¯†åˆ«å‡†ç¡®ç‡åˆ°98%+
   - å®æ–½å‘¨æœŸ: 15-20å¤©
   - æŠ€æœ¯éš¾åº¦: é«˜

---

## æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| é¡¹ç›® | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å»ºè®®è¡ŒåŠ¨ |
|------|---------|---------|---------|
| æ— éšç§ä¿æŠ¤ | é«˜ | æ•´ä¸ªæˆªå›¾åŠŸèƒ½ | ç«‹å³å®æ–½åŸºç¡€æ‰“ç  |
| OCRä¾èµ–ç¼ºå¤± | ä¸­ | æ–‡æœ¬è¯†åˆ«èƒ½åŠ› | æŒ‰éœ€å¼•å…¥tesseract.js |
| é…ç½®é¡¹ä¸è¶³ | ä½ | çµæ´»æ€§å—é™ | æ‰©å±•é…ç½®æ–‡ä»¶ç»“æ„ |
| æ€§èƒ½ä¼˜åŒ–ç©ºé—´ | ä¸­ | æ‰“ç å»¶è¿Ÿ | å®æ–½å¼‚æ­¥å¤„ç†å’Œç¼“å­˜ |

---

## æ¶æ„è§†å›¾

### æ‰“ç æµç¨‹å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆªå›¾è§¦å‘       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•è·åŸå§‹å±å¹•    â”‚ (screencapture/screenshot-desktop)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éšç§ä¿æŠ¤æ£€æµ‹    â”‚
â”‚ â”œâ”€ UIå…ƒç´ æ£€æµ‹   â”‚ (Accessibility API)
â”‚ â””â”€ OCRæ–‡æœ¬è¯†åˆ«  â”‚ (å¯é€‰ï¼Œtesseract.js)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨æ¨¡ç³Šæ•ˆæœ    â”‚ (sharp.blur + composite)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‹ç¼©ä¼˜åŒ–        â”‚ (sharp.jpeg)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šä¼ æœåŠ¡å™¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡ä¾èµ–å…³ç³»
```
PlatformAdapter (darwin/windows)
      â”‚
      â”œâ”€â”€ PrivacyProtectionService (æ–°å¢)
      â”‚     â”œâ”€â”€ UIElementDetector (æ–°å¢)
      â”‚     â”œâ”€â”€ OCRTextDetector (å¯é€‰æ–°å¢)
      â”‚     â””â”€â”€ BlurProcessor (æ–°å¢)
      â”‚
      â”œâ”€â”€ sharp (å·²æœ‰ä¾èµ–)
      â””â”€â”€ DataSyncService (æ— éœ€ä¿®æ”¹)
```

---

## æ€§èƒ½æŒ‡æ ‡

### æˆªå›¾æ€§èƒ½å¯¹æ¯”
| åœºæ™¯ | å½“å‰è€—æ—¶ | å¢åŠ æ‰“ç å | æ€§èƒ½å½±å“ |
|------|---------|-----------|---------|
| ä»…UIæ£€æµ‹ | 200ms | 400ms | +100% |
| UI + OCR | 200ms | 3-5ç§’ | +15-25å€ |
| ç™½åå•åº”ç”¨ | 200ms | 200ms | æ— å½±å“ |

### ä¼˜åŒ–åç›®æ ‡
- **UIæ£€æµ‹æ¨¡å¼**: < 500ms (æ¨èé»˜è®¤å¯ç”¨)
- **æ··åˆæ¨¡å¼**: < 2ç§’ (ç‰¹æ®Šåœºæ™¯æŒ‰éœ€å¯ç”¨)
- **å†…å­˜å ç”¨**: < 50MB (OCRæ¨¡å‹åŠ è½½)

---

## å®‰å…¨è¯„ä¼°

### éšç§ä¿æŠ¤ç­‰çº§
| ç­‰çº§ | é…ç½® | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **åŸºç¡€** | ä»…UIå…ƒç´ æ£€æµ‹ | ä¸€èˆ¬ä¼ä¸šç›‘æ§ |
| **å¢å¼º** | UI + æ•æ„Ÿè¯OCR | é‡‘èã€åŒ»ç–—è¡Œä¸š |
| **ä¸¥æ ¼** | å®Œå…¨ç¦ç”¨æˆªå›¾ | æåº¦æ•æ„Ÿç¯å¢ƒ |

### åˆè§„æ£€æŸ¥æ¸…å•
- âœ… å‘ŠçŸ¥å‘˜å·¥ç›‘æ§è¡Œä¸ºå¹¶è·å¾—åŒæ„
- âœ… æ˜ç¡®ç›‘æ§ç›®çš„å’Œæ•°æ®ç”¨é€”
- âœ… å®æ–½éšç§ä¿æŠ¤æŠ€æœ¯æªæ–½ï¼ˆæ‰“ç ï¼‰
- âœ… é™åˆ¶æ•æ„Ÿä¿¡æ¯å­˜å‚¨å’Œè®¿é—®
- âœ… å®šæœŸéšç§å½±å“è¯„ä¼°

---

## å­¦ä¹ è¦ç‚¹

### å›¾åƒå¤„ç†æœ€ä½³å®è·µ
1. **sharpåº“**: Node.jsæœ€å¿«çš„å›¾åƒå¤„ç†åº“ï¼Œæ”¯æŒæµå¼å¤„ç†
2. **æ¨¡ç³Šç®—æ³•**: é«˜æ–¯æ¨¡ç³Šä¸å¯é€†ï¼Œä¼˜äºç®€å•é™ä½åˆ†è¾¨ç‡
3. **åŒºåŸŸåˆæˆ**: `composite()` æ–¹æ³•é«˜æ•ˆåˆå¹¶å¤šä¸ªæ‰“ç åŒºåŸŸ

### éšç§ä¿æŠ¤åŸåˆ™
1. **æœ€å°åŒ–åŸåˆ™**: åªæ”¶é›†å¿…è¦çš„ç›‘æ§æ•°æ®
2. **é€æ˜åŸåˆ™**: æ˜ç¡®å‘ŠçŸ¥å‘˜å·¥ç›‘æ§èŒƒå›´
3. **å®‰å…¨åŸåˆ™**: åŠ å¯†å­˜å‚¨å’Œä¼ è¾“æ•æ„Ÿæ•°æ®
4. **æ§åˆ¶åŸåˆ™**: é™åˆ¶æ•°æ®è®¿é—®æƒé™

### è·¨å¹³å°å¼€å‘ç»éªŒ
1. **APIå·®å¼‚**: macOSç”¨AppleScript/Accessibilityï¼ŒWindowsç”¨PowerShell/Win32
2. **æƒé™æ¨¡å‹**: macOSéœ€ä¸»åŠ¨ç”³è¯·æƒé™ï¼ŒWindowsä¾èµ–ç®¡ç†å‘˜æƒé™
3. **æ€§èƒ½å·®å¼‚**: åŸç”ŸAPIæ€§èƒ½ä¼˜äºè·¨å¹³å°æ–¹æ¡ˆ

---

## å‚è€ƒèµ„æº

### æŠ€æœ¯æ–‡æ¡£
- [sharpå›¾åƒå¤„ç†åº“](https://sharp.pixelplumbing.com/)
- [Tesseract.js OCR](https://tesseract.projectnaptha.com/)
- [macOS Accessibility API](https://developer.apple.com/documentation/accessibility)
- [Windows UI Automation](https://docs.microsoft.com/en-us/windows/win32/winauto/entry-uiauto-win32)

### æœ€ä½³å®è·µ
- [GDPRæŠ€æœ¯æªæ–½æŒ‡å—](https://gdpr.eu/data-protection-impact-assessment-template/)
- [ä¸­å›½ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•](http://www.npc.gov.cn/npc/c30834/202108/a8c4e3672c74491a80b53a172bb753fe.shtml)
- [å›¾åƒéšç§ä¿æŠ¤æŠ€æœ¯ç»¼è¿°](https://arxiv.org/abs/2007.13635)

### ç›¸å…³å¼€æºé¡¹ç›®
- [privacy-screen](https://github.com/mufeedvh/privacy-screen) - è‡ªåŠ¨æ£€æµ‹å’Œæ¨¡ç³Šæ•æ„Ÿå†…å®¹
- [redact-pii](https://github.com/OpenMined/PySyft) - ä¸ªäººèº«ä»½ä¿¡æ¯è‡ªåŠ¨æ£€æµ‹

---

## å®æ–½è·¯çº¿å›¾

### ç¬¬1é˜¶æ®µ: åŸºç¡€æ‰“ç  (1å‘¨)
- [ ] åˆ›å»º `PrivacyProtectionService` æœåŠ¡ç±»
- [ ] å®ç° `UIElementDetector` (å¯†ç æ¡†æ£€æµ‹)
- [ ] é›†æˆåˆ° darwin-adapter å’Œ windows-adapter
- [ ] æ·»åŠ é…ç½®é¡¹åˆ° config-service
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

### ç¬¬2é˜¶æ®µ: é…ç½®åŒ–ä¸ä¼˜åŒ– (1å‘¨)
- [ ] å®ç°ç™½åå•æœºåˆ¶
- [ ] æ·»åŠ æ‰“ç å¼ºåº¦é…ç½®
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆå¼‚æ­¥å¤„ç†ã€ç¼“å­˜ï¼‰
- [ ] æ—¥å¿—å’Œå®¡è®¡åŠŸèƒ½
- [ ] é›†æˆæµ‹è¯•

### ç¬¬3é˜¶æ®µ: é«˜çº§åŠŸèƒ½ (å¯é€‰ï¼Œ2å‘¨)
- [ ] é›†æˆ tesseract.js OCR
- [ ] å®ç°æ•æ„Ÿæ–‡æœ¬æ­£åˆ™åŒ¹é…
- [ ] æ··åˆæ£€æµ‹æ¨¡å¼
- [ ] æœºå™¨å­¦ä¹ æ¨¡å‹ä¼˜åŒ–
- [ ] å‹åŠ›æµ‹è¯•å’Œè°ƒä¼˜

---

## ä»£ç ç¤ºä¾‹

### PrivacyProtectionServiceå®Œæ•´å®ç°

```typescript
// common/services/privacy-protection-service.ts

import sharp from 'sharp';
import { logger } from '../utils';
import { IConfigService } from '../interfaces/service-interfaces';

interface SensitiveRegion {
  x: number;
  y: number;
  width: number;
  height: number;
  type: 'password' | 'text' | 'ui-element';
  confidence: number;
}

export class PrivacyProtectionService {
  private configService: IConfigService;
  private uiDetector: UIElementDetector;
  private ocrDetector?: OCRTextDetector;

  constructor(configService: IConfigService) {
    this.configService = configService;
    this.uiDetector = new UIElementDetector();

    // OCRæŒ‰éœ€åˆå§‹åŒ–ï¼ˆé¿å…å¯åŠ¨æ—¶åŠ è½½å¤§æ¨¡å‹ï¼‰
    const config = this.configService.getConfig().privacy;
    if (config?.ocrDetection) {
      this.ocrDetector = new OCRTextDetector();
    }
  }

  /**
   * å¤„ç†æˆªå›¾å¹¶åº”ç”¨éšç§ä¿æŠ¤
   */
  async processScreenshot(imageBuffer: Buffer): Promise<Buffer> {
    try {
      const config = this.configService.getConfig().privacy;

      // æ£€æŸ¥æ˜¯å¦å¯ç”¨éšç§ä¿æŠ¤
      if (!config?.enabled) {
        logger.debug('[PRIVACY] Privacy protection disabled');
        return imageBuffer;
      }

      logger.info('[PRIVACY] Starting privacy protection processing...');
      const startTime = Date.now();

      // æ£€æµ‹æ•æ„ŸåŒºåŸŸ
      const sensitiveRegions: SensitiveRegion[] = [];

      // 1. UIå…ƒç´ æ£€æµ‹ï¼ˆå¿«é€Ÿã€ç²¾å‡†ï¼‰
      if (config.uiElementDetection !== false) {
        const uiRegions = await this.uiDetector.detect();
        sensitiveRegions.push(...uiRegions);
        logger.info(`[PRIVACY] Detected ${uiRegions.length} UI elements`);
      }

      // 2. OCRæ–‡æœ¬æ£€æµ‹ï¼ˆå¯é€‰ã€è€—æ—¶ï¼‰
      if (config.ocrDetection && this.ocrDetector) {
        const textRegions = await this.ocrDetector.detect(imageBuffer, config.sensitivePatterns);
        sensitiveRegions.push(...textRegions);
        logger.info(`[PRIVACY] Detected ${textRegions.length} sensitive texts`);
      }

      // 3. åº”ç”¨æ¨¡ç³Šæ•ˆæœ
      if (sensitiveRegions.length > 0) {
        const processedBuffer = await this.applyBlur(
          imageBuffer,
          sensitiveRegions,
          config.blurStrength || 50
        );

        const elapsedTime = Date.now() - startTime;
        logger.info(`[PRIVACY] Privacy protection completed in ${elapsedTime}ms (${sensitiveRegions.length} regions blurred)`);

        return processedBuffer;
      } else {
        logger.info('[PRIVACY] No sensitive regions detected');
        return imageBuffer;
      }

    } catch (error: any) {
      logger.error('[PRIVACY] Failed to process screenshot:', error);
      // å¤±è´¥æ—¶è¿”å›åŸå›¾ï¼Œç¡®ä¿ç›‘æ§åŠŸèƒ½ä¸ä¸­æ–­
      return imageBuffer;
    }
  }

  /**
   * å¯¹æŒ‡å®šåŒºåŸŸåº”ç”¨æ¨¡ç³Šæ•ˆæœ
   */
  private async applyBlur(
    imageBuffer: Buffer,
    regions: SensitiveRegion[],
    blurStrength: number
  ): Promise<Buffer> {
    try {
      const image = sharp(imageBuffer);
      const metadata = await image.metadata();

      if (!metadata.width || !metadata.height) {
        throw new Error('Invalid image metadata');
      }

      // ä¸ºæ¯ä¸ªæ•æ„ŸåŒºåŸŸåˆ›å»ºæ¨¡ç³Šé®ç½©
      const compositeOperations = [];

      for (const region of regions) {
        // è¾¹ç•Œæ£€æŸ¥
        const safeRegion = this.clampRegion(region, metadata.width, metadata.height);

        // æå–å¹¶æ¨¡ç³ŠåŒºåŸŸ
        const blurredRegion = await image
          .clone()
          .extract({
            left: safeRegion.x,
            top: safeRegion.y,
            width: safeRegion.width,
            height: safeRegion.height
          })
          .blur(blurStrength)
          .toBuffer();

        compositeOperations.push({
          input: blurredRegion,
          top: safeRegion.y,
          left: safeRegion.x
        });
      }

      // ä¸€æ¬¡æ€§åˆæˆæ‰€æœ‰æ¨¡ç³ŠåŒºåŸŸ
      return await image.composite(compositeOperations).toBuffer();

    } catch (error: any) {
      logger.error('[PRIVACY] Failed to apply blur:', error);
      throw error;
    }
  }

  /**
   * ç¡®ä¿åŒºåŸŸåœ¨å›¾åƒè¾¹ç•Œå†…
   */
  private clampRegion(
    region: SensitiveRegion,
    imageWidth: number,
    imageHeight: number
  ): SensitiveRegion {
    return {
      ...region,
      x: Math.max(0, Math.min(region.x, imageWidth - 1)),
      y: Math.max(0, Math.min(region.y, imageHeight - 1)),
      width: Math.min(region.width, imageWidth - region.x),
      height: Math.min(region.height, imageHeight - region.y)
    };
  }
}

/**
 * UIå…ƒç´ æ£€æµ‹å™¨ï¼ˆå¯†ç æ¡†ã€æ•æ„Ÿçª—å£ç­‰ï¼‰
 */
class UIElementDetector {
  async detect(): Promise<SensitiveRegion[]> {
    const regions: SensitiveRegion[] = [];

    if (process.platform === 'darwin') {
      // macOSå®ç°
      regions.push(...await this.detectMacOS());
    } else if (process.platform === 'win32') {
      // Windowså®ç°
      regions.push(...await this.detectWindows());
    }

    return regions;
  }

  private async detectMacOS(): Promise<SensitiveRegion[]> {
    try {
      const { execAsync } = require('util');
      const { promisify } = require('util');
      const exec = promisify(require('child_process').exec);

      // AppleScriptæŸ¥è¯¢å¯†ç æ¡†
      const script = `
        tell application "System Events"
          set frontApp to first application process whose frontmost is true
          set pwdFields to (UI elements of frontApp whose role is "AXSecureTextField")

          set results to {}
          repeat with field in pwdFields
            set fieldPos to position of field
            set fieldSize to size of field
            set end of results to {item 1 of fieldPos, item 2 of fieldPos, item 1 of fieldSize, item 2 of fieldSize}
          end repeat

          return results
        end tell
      `;

      const { stdout } = await exec(`osascript -e '${script.replace(/'/g, "\\'")}'`);

      // è§£æç»“æœå¹¶è½¬æ¢ä¸ºSensitiveRegionæ ¼å¼
      const matches = stdout.match(/\d+/g);
      const regions: SensitiveRegion[] = [];

      if (matches) {
        for (let i = 0; i < matches.length; i += 4) {
          regions.push({
            x: parseInt(matches[i]),
            y: parseInt(matches[i + 1]),
            width: parseInt(matches[i + 2]),
            height: parseInt(matches[i + 3]),
            type: 'password',
            confidence: 1.0
          });
        }
      }

      return regions;

    } catch (error) {
      logger.warn('[PRIVACY] Failed to detect macOS UI elements:', error);
      return [];
    }
  }

  private async detectWindows(): Promise<SensitiveRegion[]> {
    try {
      // TODO: å®ç°Windows UI Automationæ£€æµ‹
      // å‚è€ƒ: https://docs.microsoft.com/en-us/windows/win32/winauto/uiauto-entry-uiautocore

      logger.warn('[PRIVACY] Windows UI detection not yet implemented');
      return [];

    } catch (error) {
      logger.warn('[PRIVACY] Failed to detect Windows UI elements:', error);
      return [];
    }
  }
}

/**
 * OCRæ–‡æœ¬æ£€æµ‹å™¨ï¼ˆå¯é€‰ï¼Œéœ€è¦tesseract.jsï¼‰
 */
class OCRTextDetector {
  private worker: any;

  constructor() {
    // å»¶è¿ŸåŠ è½½é¿å…å¯åŠ¨æ—¶å¼€é”€
    this.worker = null;
  }

  async detect(imageBuffer: Buffer, patterns: string[]): Promise<SensitiveRegion[]> {
    try {
      // åŠ¨æ€å¯¼å…¥tesseract.js
      const Tesseract = require('tesseract.js');

      if (!this.worker) {
        this.worker = await Tesseract.createWorker();
        await this.worker.loadLanguage('chi_sim+eng');
        await this.worker.initialize('chi_sim+eng');
      }

      // OCRè¯†åˆ«
      const { data: { words } } = await this.worker.recognize(imageBuffer);

      // åŒ¹é…æ•æ„Ÿæ¨¡å¼
      const regions: SensitiveRegion[] = [];
      const regexPatterns = patterns.map(p => new RegExp(p, 'i'));

      for (const word of words) {
        for (const pattern of regexPatterns) {
          if (pattern.test(word.text)) {
            regions.push({
              x: word.bbox.x0,
              y: word.bbox.y0,
              width: word.bbox.x1 - word.bbox.x0,
              height: word.bbox.y1 - word.bbox.y0,
              type: 'text',
              confidence: word.confidence
            });
            break;
          }
        }
      }

      return regions;

    } catch (error) {
      logger.error('[PRIVACY] OCR detection failed:', error);
      return [];
    }
  }

  async cleanup(): Promise<void> {
    if (this.worker) {
      await this.worker.terminate();
      this.worker = null;
    }
  }
}
```

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-01-14
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
