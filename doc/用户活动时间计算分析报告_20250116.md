# å‘˜å·¥å®¢æˆ·ç«¯ç”¨æˆ·æ´»åŠ¨æ—¶é—´è®¡ç®—åˆ†ææŠ¥å‘Š

**åˆ†ææ—¶é—´**: 2025-01-16
**åˆ†æèŒƒå›´**: employee-client æ•´ä½“æ¶æ„
**åˆ†æé‡ç‚¹**: æ´»åŠ¨æ—¶é—´è®¡ç®—æ–¹æ³•ä¸æ•°æ®å‡†ç¡®æ€§
**å½“å‰ç«¯**: employee-client

---

## æ‰§è¡Œæ‘˜è¦

å‘˜å·¥å®¢æˆ·ç«¯é€šè¿‡å¤šå±‚æ¬¡çš„æ•°æ®æ”¶é›†æœºåˆ¶æ¥å‡†ç¡®è®¡ç®—ç”¨æˆ·æ´»åŠ¨æ—¶é—´ã€‚ç³»ç»Ÿé‡‡ç”¨**åŸç”Ÿäº‹ä»¶ç›‘å¬ + ç©ºé—²æ£€æµ‹ + æ—¶é—´ç´¯ç§¯**çš„ä¸‰é‡éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿æ´»åŠ¨æ—¶é—´è®¡ç®—çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬çœŸå®é”®ç›˜é¼ æ ‡äº‹ä»¶æ•è·ã€ç³»ç»Ÿç©ºé—²æ—¶é—´æ£€æµ‹ã€ä»¥åŠåŸºäºæ—¶é—´çª—å£çš„æ´»åŠ¨å‘¨æœŸç´¯ç§¯ç®—æ³•ã€‚

**å…³é”®å‘ç°**:
- âœ… ä½¿ç”¨åŸç”Ÿç³»ç»Ÿ API è¿›è¡ŒçœŸå®äº‹ä»¶ç›‘å¬ï¼Œæ•°æ®å¯ä¿¡åº¦é«˜
- âœ… é‡‡ç”¨æ´»åŠ¨æ—¶é—´ä¸ç©ºé—²æ—¶é—´åŒè½¨è®¡ç®—ï¼Œäº’ä¸ºéªŒè¯
- âœ… åŸºäºå¯é…ç½®çš„æ—¶é—´é—´éš”è¿›è¡Œæ•°æ®ç´¯ç§¯å’Œä¸Šä¼ 
- âš ï¸ æ´»åŠ¨æ—¶é—´è®¡ç®—ä¾èµ–äºäº‹ä»¶è§¦å‘é¢‘ç‡å’Œç©ºé—²é˜ˆå€¼é…ç½®
- âš ï¸ Windows å¹³å°éœ€è¦ç®¡ç†å‘˜æƒé™ï¼ŒmacOS éœ€è¦è¾…åŠ©åŠŸèƒ½æƒé™

---

## åˆ†æç›®æ ‡

æœ¬æ¬¡åˆ†ææ—¨åœ¨æ·±å…¥ç†è§£å‘˜å·¥å®¢æˆ·ç«¯å¦‚ä½•ä»åº•å±‚ç³»ç»Ÿäº‹ä»¶ä¸­å‡†ç¡®æ¨å¯¼å‡ºç”¨æˆ·çš„æ´»åŠ¨æ—¶é—´ï¼ŒåŒ…æ‹¬ï¼š

1. æ•°æ®æ”¶é›†çš„æŠ€æœ¯å®ç°æ–¹å¼
2. æ´»åŠ¨æ—¶é—´ä¸ç©ºé—²æ—¶é—´çš„è®¡ç®—é€»è¾‘
3. ä¸åŒå¹³å°çš„å®ç°å·®å¼‚
4. æ•°æ®å‡†ç¡®æ€§çš„ä¿éšœæœºåˆ¶
5. æ½œåœ¨çš„å‡†ç¡®æ€§å½±å“å› ç´ 

---

## è¯¦ç»†åˆ†æ

### 1. æ•°æ®æ”¶é›†æ¶æ„

#### 1.1 ä¸‰å±‚æ¶æ„è®¾è®¡

å‘˜å·¥å®¢æˆ·ç«¯é‡‡ç”¨æ¸…æ™°çš„ä¸‰å±‚æ¶æ„æ”¶é›†ç”¨æˆ·æ´»åŠ¨æ•°æ®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ActivityCollectorService (ä¸šåŠ¡å±‚)               â”‚
â”‚  - é…ç½®ç®¡ç† (activityInterval, idleThreshold)                â”‚
â”‚  - æ•°æ®ç´¯ç§¯ (keystrokes, mouseClicks, activeTime, idleTime) â”‚
â”‚  - å®šæ—¶ä¸Šä¼  (uploadInterval)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Platform Adapters (å¹³å°é€‚é…å±‚)                     â”‚
â”‚  - DarwinAdapter (macOS) - NativeEventAdapter               â”‚
â”‚  - WindowsAdapter (Windows) - WindowsNativeEventAdapter     â”‚
â”‚  - æä¾›ç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬æ¥å£                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Native Modules (åŸç”Ÿæ¨¡å—å±‚)                      â”‚
â”‚  - macOS: CGEventTap (Objective-C/Swift)                    â”‚
â”‚  - Windows: SetWindowsHookEx (C++ Win32 API)               â”‚
â”‚  - åº•å±‚ç³»ç»Ÿäº‹ä»¶æ•è·                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŸç†**: é€šè¿‡ç³»ç»Ÿçº§åˆ«çš„äº‹ä»¶é’©å­ï¼ˆHookï¼‰æ•è·æ‰€æœ‰é”®ç›˜å’Œé¼ æ ‡äº‹ä»¶ï¼Œä¸ä¾èµ–åº”ç”¨å±‚æ¨¡æ‹Ÿæˆ–æ¨æ–­ã€‚

#### 1.2 æ ¸å¿ƒæ•°æ®æ”¶é›†æœåŠ¡

**ActivityCollectorService** (activity-collector-service.ts:36-548)

è¿™æ˜¯æ´»åŠ¨æ—¶é—´è®¡ç®—çš„æ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£ï¼š

```typescript
export interface ActivityData {
  keystrokes: number;           // é”®ç›˜æŒ‰é”®æ¬¡æ•°
  mouseClicks: number;          // é¼ æ ‡ç‚¹å‡»æ¬¡æ•°
  mouseMoves: number;           // é¼ æ ‡ç§»åŠ¨æ¬¡æ•°
  scrollEvents: number;         // æ»šåŠ¨äº‹ä»¶æ¬¡æ•°
  activeTime: number;           // æ´»è·ƒæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰â­
  idleTime: number;             // ç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰â­
  intervalDuration: number;     // æ”¶é›†é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  windowTitle?: string;         // å½“å‰çª—å£æ ‡é¢˜
  processName?: string;         // å½“å‰è¿›ç¨‹å
  timestamp: Date;              // æ—¶é—´æˆ³
}
```

**å…³é”®é…ç½®å‚æ•°**:
```typescript
export interface ActivityCollectorConfig {
  activityInterval: number;      // æ´»åŠ¨é‡‡é›†é—´éš”ï¼ˆé»˜è®¤60000ms = 1åˆ†é’Ÿï¼‰
  enableActivity: boolean;        // æ˜¯å¦å¯ç”¨æ´»åŠ¨ç›‘æ§
  enableIdleDetection: boolean;   // æ˜¯å¦å¯ç”¨ç©ºé—²æ£€æµ‹
  idleThreshold: number;          // ç©ºé—²é˜ˆå€¼ï¼ˆé»˜è®¤30000ms = 30ç§’ï¼‰
}
```

---

### 2. æ´»åŠ¨æ—¶é—´è®¡ç®—æ ¸å¿ƒé€»è¾‘

#### 2.1 æ´»åŠ¨æ—¶é—´ç´¯ç§¯ç®—æ³•

**ä½ç½®**: activity-collector-service.ts:384-398

```typescript
private updateLastActivityTime(): void {
  this.lastActivityTime = Date.now();
}

private updateActiveTime(): void {
  if (!this.isCurrentlyIdle) {
    const now = Date.now();
    const timeSinceLastActivity = now - this.lastActivityTime;

    // åªæœ‰åœ¨åˆç†çš„æ—¶é—´èŒƒå›´å†…æ‰ç´¯ç§¯æ´»è·ƒæ—¶é—´
    if (timeSinceLastActivity < this.config.idleThreshold) {
      this.accumulatedData.activeTime += timeSinceLastActivity;
    }
  }
}
```

**è®¡ç®—åŸç†**:

1. **äº‹ä»¶é©±åŠ¨æ›´æ–°**: æ¯æ¬¡é”®ç›˜æˆ–é¼ æ ‡äº‹ä»¶å‘ç”Ÿæ—¶è§¦å‘
   ```typescript
   // é”®ç›˜äº‹ä»¶å¤„ç†å™¨ (activity-collector-service.ts:330-338)
   private handleKeyboardEvent(data: any): void {
     if (!this.isCollecting) return;

     this.accumulatedData.keystrokes++;
     this.updateLastActivityTime();    // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
     this.updateActiveTime();          // ç´¯ç§¯æ´»è·ƒæ—¶é—´
   }

   // é¼ æ ‡äº‹ä»¶å¤„ç†å™¨ (activity-collector-service.ts:340-363)
   private handleMouseEvent(data: any): void {
     if (!this.isCollecting) return;

     switch (data.type) {
       case 'click':
         this.accumulatedData.mouseClicks++;
         break;
       case 'move':
         this.accumulatedData.mouseMoves++;
         break;
       case 'scroll':
         this.accumulatedData.scrollEvents++;
         break;
     }

     this.updateLastActivityTime();
     this.updateActiveTime();
   }
   ```

2. **æ—¶é—´å·®è®¡ç®—**: è®¡ç®—å½“å‰æ—¶é—´ä¸ä¸Šæ¬¡æ´»åŠ¨æ—¶é—´çš„å·®å€¼
   - å¦‚æœå·®å€¼ < `idleThreshold` (30ç§’)ï¼Œåˆ™è®¤ä¸ºç”¨æˆ·æŒç»­æ´»åŠ¨
   - å°†æ­¤æ—¶é—´å·®ç´¯åŠ åˆ° `activeTime`

3. **é˜²æŠ¤æœºåˆ¶**: é˜²æ­¢å¼‚å¸¸çš„é•¿æ—¶é—´ç´¯ç§¯
   - è¶…è¿‡ç©ºé—²é˜ˆå€¼çš„æ—¶é—´ä¸è®¡å…¥æ´»è·ƒæ—¶é—´
   - ç¡®ä¿æ´»è·ƒæ—¶é—´çš„å‡†ç¡®æ€§

**ç¤ºä¾‹åœºæ™¯**:

```
æ—¶é—´çº¿:
T0 (0ms)   - ç”¨æˆ·æŒ‰ä¸‹é”®ç›˜ â†’ lastActivityTime = 0ms
T1 (1000ms) - ç”¨æˆ·ç§»åŠ¨é¼ æ ‡ â†’ activeTime += 1000ms, lastActivityTime = 1000ms
T2 (3000ms) - ç”¨æˆ·ç‚¹å‡»é¼ æ ‡ â†’ activeTime += 2000ms, lastActivityTime = 3000ms
T3 (35000ms) - ç”¨æˆ·æŒ‰é”® â†’ æ—¶é—´å·® = 32000ms > 30000ms (è¶…è¿‡é˜ˆå€¼)
                        â†’ activeTime ä¸å˜ (å› ä¸ºä¸­é—´å¯èƒ½ç©ºé—²)
                        â†’ lastActivityTime = 35000ms

æœ€ç»ˆ activeTime = 3000ms (1000 + 2000)
```

#### 2.2 ç©ºé—²æ—¶é—´æ£€æµ‹æœºåˆ¶

**ä½ç½®**: activity-collector-service.ts:365-382

```typescript
private handleIdleStateChange(isIdle: boolean): void {
  if (!this.isCollecting) return;

  const now = Date.now();
  const timeDiff = now - this.lastActivityTime;

  if (isIdle && !this.isCurrentlyIdle) {
    // å˜ä¸ºç©ºé—²çŠ¶æ€
    this.isCurrentlyIdle = true;
    console.log('[ACTIVITY_COLLECTOR] User became idle');
  } else if (!isIdle && this.isCurrentlyIdle) {
    // ä»ç©ºé—²çŠ¶æ€æ¢å¤
    this.isCurrentlyIdle = false;
    this.accumulatedData.idleTime += timeDiff;  // ç´¯ç§¯ç©ºé—²æ—¶é—´
    this.updateLastActivityTime();
    console.log('[ACTIVITY_COLLECTOR] User became active again', { idleTime: timeDiff });
  }
}
```

**ç©ºé—²æ£€æµ‹åŸç†**:

1. **åŸç”Ÿç³»ç»ŸAPIæ£€æµ‹**:
   - macOS: `ioreg -c IOHIDSystem | grep HIDIdleTime` (darwin-adapter.ts:692-707)
   - Windows: `GetLastInputInfo()` Win32 API (wmi-activity-inferrer.ts:166-200)

2. **çŠ¶æ€è½¬æ¢**:
   ```
   æ´»åŠ¨çŠ¶æ€ (isCurrentlyIdle = false)
         â†“ (30ç§’æ— è¾“å…¥)
   ç©ºé—²çŠ¶æ€ (isCurrentlyIdle = true)
         â†“ (æ£€æµ‹åˆ°è¾“å…¥)
   æ´»åŠ¨çŠ¶æ€ (isCurrentlyIdle = false, idleTime += ç©ºé—²æ—¶é•¿)
   ```

3. **åŒé‡éªŒè¯**:
   - `activeTime` + `idleTime` â‰ˆ `intervalDuration`
   - äº’ä¸ºéªŒè¯ï¼Œç¡®ä¿æ—¶é—´è®¡ç®—çš„å‡†ç¡®æ€§

---

### 3. å¹³å°ç‰¹å®šå®ç°

#### 3.1 macOS å¹³å° (DarwinAdapter)

**åŸç”Ÿäº‹ä»¶ç›‘å¬**: darwin-adapter.ts:250-437

**æŠ€æœ¯å®ç°**:
- ä½¿ç”¨ CGEventTap API ç›‘å¬å…¨å±€é”®ç›˜é¼ æ ‡äº‹ä»¶
- éœ€è¦ç”¨æˆ·æˆæƒ"è¾…åŠ©åŠŸèƒ½"æƒé™
- äº‹ä»¶ç›‘å¬ä»£ç ä½äº `platforms/darwin/native-event-adapter.ts`

**äº‹ä»¶è®¡æ•°æ–¹å¼**:
```typescript
// darwin-adapter.ts:126-149
private async getKeystrokeCount(): Promise<number> {
  // æ£€æŸ¥åŸç”Ÿäº‹ä»¶é€‚é…å™¨çŠ¶æ€
  const nativeStatus = this.nativeEventAdapter ? {
    isMonitoring: this.nativeEventAdapter.isMonitoring(),
    counts: this.nativeEventAdapter.getCurrentCounts()
  } : { isMonitoring: false, counts: { keyboardCount: 0, mouseCount: 0 } };

  console.log(`[DARWIN_DEBUG] é”®ç›˜è®¡æ•°è¯¦æƒ…:`);
  console.log(`  - å½“å‰å‘¨æœŸè®¡æ•°: ${this.currentPeriodKeystrokes}`);
  console.log(`  - åŸç”Ÿæ¨¡å—çŠ¶æ€: ${nativeStatus.isMonitoring ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ'}`);
  console.log(`  - åŸç”Ÿæ¨¡å—é”®ç›˜è®¡æ•°: ${nativeStatus.counts.keyboardCount}`);

  return this.currentPeriodKeystrokes;
}
```

**æ•°æ®é‡‡é›†æµç¨‹**:
```typescript
// darwin-adapter.ts:310-335
private async collectActivityData(): Promise<any> {
  const timestamp = new Date();
  const activeWindow = await this.getActiveWindow();

  // è·å–ç³»ç»Ÿç©ºé—²æ—¶é—´
  const idleTime = await this.getSystemIdleTime();

  // è·å–é”®ç›˜å’Œé¼ æ ‡æ´»åŠ¨
  const keystrokes = await this.getKeystrokeCount();
  const mouseClicks = await this.getMouseClickCount();

  const activityData = {
    timestamp,
    activeWindow: activeWindow || undefined,
    keystrokes,
    mouseClicks,
    mouseMovements: 0,
    idleTime
  };

  return activityData;
}
```

**ç©ºé—²æ—¶é—´è·å–** (darwin-adapter.ts:692-707):
```typescript
private async getSystemIdleTime(): Promise<number> {
  try {
    // ä½¿ç”¨ ioreg å‘½ä»¤è·å–ç³»ç»Ÿç©ºé—²æ—¶é—´
    const { stdout } = await execAsync('ioreg -c IOHIDSystem | grep HIDIdleTime');
    const match = stdout.match(/HIDIdleTime"=(\d+)/);
    if (match) {
      // è½¬æ¢çº³ç§’åˆ°ç§’
      const nanoseconds = parseInt(match[1]);
      return Math.floor(nanoseconds / 1000000000);
    }
    return 0;
  } catch (error) {
    logger.error('Failed to get system idle time', error);
    return 0;
  }
}
```

#### 3.2 Windows å¹³å° (WindowsAdapter)

**åŸç”Ÿäº‹ä»¶ç›‘å¬**: windows-adapter.ts:419-516

**æŠ€æœ¯å®ç°**:
- ä½¿ç”¨ SetWindowsHookEx Win32 API å®‰è£…å…¨å±€é”®ç›˜é¼ æ ‡é’©å­
- éœ€è¦ç®¡ç†å‘˜æƒé™è¿è¡Œ
- åŸç”Ÿ C++ æ¨¡å—ä½äº `native-event-monitor-win/`

**äº‹ä»¶è®¡æ•°æ–¹å¼**:
```typescript
// windows-adapter.ts:998-1044
private async collectActivityData(): Promise<ActivityData> {
  const timestamp = new Date();

  // è·å–æ´»åŠ¨çª—å£ä¿¡æ¯ï¼ˆä¼˜å…ˆä½¿ç”¨åŸç”ŸC++æ¨¡å—ï¼‰
  const activeWindow = await this.getActiveWindow();

  // ä½¿ç”¨åŸç”Ÿäº‹ä»¶ç›‘æ§è·å–çœŸå®æ•°æ®
  if (this.nativeEventAdapter && this.nativeEventAdapter.isAvailable()) {
    const eventData = await this.nativeEventAdapter.getEventCounts();

    if (eventData) {
      logger.info(`[WINDOWS] ğŸ“Š æ´»åŠ¨æ•°æ®é‡‡é›†:`);
      logger.info(`[WINDOWS]   - é”®ç›˜äº‹ä»¶: ${eventData.keyboard}`);
      logger.info(`[WINDOWS]   - é¼ æ ‡ç‚¹å‡»: ${eventData.mouseClicks}`);
      logger.info(`[WINDOWS]   - ç©ºé—²æ—¶é—´: ${eventData.idleTime}ms`);
      logger.info(`[WINDOWS]   - ç›‘æ§çŠ¶æ€: ${eventData.isMonitoring ? 'âœ…' : 'âŒ'}`);

      return {
        timestamp,
        activeWindow: activeWindow || undefined,
        keystrokes: eventData.keyboard,
        mouseClicks: eventData.mouseClicks,
        mouseMovements: 0,
        idleTime: eventData.idleTime
      };
    }
  }

  // å¤‡ç”¨æ–¹æ¡ˆï¼šæ¨æ–­æ¨¡å¼ï¼ˆæƒé™ä¸è¶³æ—¶ï¼‰
  return {
    timestamp,
    activeWindow: activeWindow || undefined,
    keystrokes: 0,
    mouseClicks: 0,
    mouseMovements: 0,
    idleTime: 0
  };
}
```

**æ•°æ®ä¸Šä¼ æˆåŠŸåé‡ç½®** (windows-adapter.ts:496-515):
```typescript
public onDataUploadSuccess(): void {
  logger.info('[WINDOWS] æ”¶åˆ°æ•°æ®ä¸Šä¼ æˆåŠŸé€šçŸ¥ï¼Œé‡ç½®æ´»åŠ¨è®¡æ•°å™¨');
  try {
    if (this.nativeEventAdapter && this.nativeEventAdapter.isAvailable()) {
      this.nativeEventAdapter.resetCounts().then(result => {
        if (result) {
          logger.info('[WINDOWS] âœ… åŸç”Ÿäº‹ä»¶è®¡æ•°å™¨å·²é‡ç½®');
        } else {
          logger.warn('[WINDOWS] âš ï¸ åŸç”Ÿäº‹ä»¶è®¡æ•°å™¨é‡ç½®å¤±è´¥');
        }
      });
    }
  } catch (error) {
    logger.error('[WINDOWS] é‡ç½®æ´»åŠ¨è®¡æ•°å™¨æ—¶å‡ºé”™:', error);
  }
}
```

#### 3.3 Windows æ¨æ–­æ¨¡å¼ (WMIActivityInferrer)

**åœºæ™¯**: å½“åŸç”Ÿé’©å­æ— æ³•å®‰è£…æ—¶ï¼ˆæƒé™ä¸è¶³ã€è¢«å®‰å…¨è½¯ä»¶æ‹¦æˆªï¼‰

**æ¨æ–­ç­–ç•¥** (wmi-activity-inferrer.ts:269-298):

```typescript
inferKeystrokes(indicators: SystemActivityIndicators, timeDelta: number): number {
  const weights = {
    windowFocus: 2.5,    // çª—å£åˆ‡æ¢é€šå¸¸ä¼´éšé”®ç›˜è¾“å…¥
    processActivity: 1.8, // è¿›ç¨‹æ´»åŠ¨åæ˜ ç”¨æˆ·äº¤äº’
    inputLanguage: 5.0,   // è¾“å…¥æ³•å˜åŒ–ç›´æ¥åæ˜ é”®ç›˜ä½¿ç”¨
    lowIdle: 1.2         // ä½ç©ºé—²æ—¶é—´æ„å‘³ç€æ´»è·ƒä½¿ç”¨
  };

  let estimatedKeystrokes = 0;

  // åŸºäºçª—å£ç„¦ç‚¹å˜åŒ–
  estimatedKeystrokes += indicators.windowFocusChanges * weights.windowFocus;

  // åŸºäºè¿›ç¨‹æ´»åŠ¨
  const normalizedProcessActivity = Math.min(indicators.processActiveTime / 100, 10);
  estimatedKeystrokes += normalizedProcessActivity * weights.processActivity;

  // åŸºäºè¾“å…¥æ³•å˜åŒ–
  estimatedKeystrokes += indicators.inputLanguageChanges * weights.inputLanguage;

  // åŸºäºç©ºé—²æ—¶é—´é€†å‘æ¨æ–­
  if (indicators.systemIdleTime < 5000) { // 5ç§’å†…æœ‰è¾“å…¥
    estimatedKeystrokes += (5000 - indicators.systemIdleTime) / 1000 * weights.lowIdle;
  }

  // æ—¶é—´å½’ä¸€åŒ–
  const timeInMinutes = timeDelta / 60000;
  estimatedKeystrokes = estimatedKeystrokes * Math.min(timeInMinutes, 1);

  return Math.round(Math.max(0, estimatedKeystrokes));
}
```

**æ¨æ–­æŒ‡æ ‡**:
- çª—å£ç„¦ç‚¹å˜åŒ–æ¬¡æ•°
- è¿›ç¨‹ CPU ä½¿ç”¨ç‡
- è¾“å…¥æ³•åˆ‡æ¢æ¬¡æ•°
- å…‰æ ‡ä½ç½®å˜åŒ–
- ç³»ç»Ÿç©ºé—²æ—¶é—´

**ç½®ä¿¡åº¦è¯„ä¼°** (wmi-activity-inferrer.ts:333-352):
```typescript
calculateConfidence(indicators: SystemActivityIndicators): number {
  const reliabilityWeights = {
    systemIdle: { weight: 0.9, value: indicators.systemIdleTime > 0 ? 1 : 0 },
    windowFocus: { weight: 0.7, value: indicators.windowFocusChanges > 0 ? 1 : 0 },
    processActivity: { weight: 0.6, value: indicators.processActiveTime > 0 ? 1 : 0 },
    cursorMovement: { weight: 0.4, value: indicators.cursorPositionVariation > 0 ? 1 : 0 },
    inputLanguage: { weight: 0.5, value: indicators.inputLanguageChanges > 0 ? 1 : 0 }
  };

  // åŠ æƒå¹³å‡è®¡ç®—ç½®ä¿¡åº¦
  return Math.round((confidence / totalWeight) * 100);
}
```

---

### 4. æ•°æ®ä¸Šä¼ ä¸å‘¨æœŸé‡ç½®

#### 4.1 å®šæ—¶ä¸Šä¼ æœºåˆ¶

**ä½ç½®**: activity-collector-service.ts:400-412, 452-525

```typescript
// å¯åŠ¨ä¸Šä¼ å®šæ—¶å™¨
private startUploadTimer(): void {
  this.uploadInterval = setInterval(async () => {
    if (this.isCollecting && this.hasAccumulatedData()) {
      try {
        await this.uploadAccumulatedData();
      } catch (error) {
        console.error('[ACTIVITY_COLLECTOR] Upload interval error:', error);
      }
    }
  }, this.config.activityInterval);  // é»˜è®¤ 60000ms (1åˆ†é’Ÿ)

  console.log(`[ACTIVITY_COLLECTOR] Upload timer started with interval: ${this.config.activityInterval}ms`);
}

// ä¸Šä¼ ç´¯ç§¯æ•°æ®
private async uploadAccumulatedData(): Promise<void> {
  try {
    const now = Date.now();
    const actualDuration = now - this.collectionStartTime;

    // æ›´æ–°æ•°æ®
    this.accumulatedData.intervalDuration = actualDuration;
    this.accumulatedData.timestamp = new Date();

    // è·å–å½“å‰çª—å£ä¿¡æ¯
    const windowInfo = await this.platformAdapter.getActiveWindow();
    this.accumulatedData.windowTitle = windowInfo?.title;
    this.accumulatedData.processName = windowInfo?.processName;

    console.log('[ACTIVITY_COLLECTOR] Uploading accumulated data:', {
      keystrokes: this.accumulatedData.keystrokes,
      mouseClicks: this.accumulatedData.mouseClicks,
      activeTime: this.accumulatedData.activeTime,  // â­ å…³é”®å­—æ®µ
      duration: actualDuration
    });

    // å‡†å¤‡æ•°æ®æ ¼å¼ - åŒ¹é…æœåŠ¡å™¨æœŸæœ›çš„å­—æ®µ
    const inputActivityData = {
      timestamp: this.accumulatedData.timestamp.toISOString(),
      isActive: true,  // æœ‰é”®ç›˜é¼ æ ‡äº‹ä»¶å³ä¸ºæ´»åŠ¨
      keystrokes: this.accumulatedData.keystrokes,
      mouseClicks: this.accumulatedData.mouseClicks,
      idleTime: this.accumulatedData.idleTime,
      activeWindow: this.accumulatedData.windowTitle,
      activeWindowProcess: this.accumulatedData.processName,
      activityInterval: this.accumulatedData.intervalDuration
    };

    // ä¼˜å…ˆä½¿ç”¨ WebSocket ä¸Šä¼ ï¼Œå¤±è´¥åˆ™ä½¿ç”¨ HTTP
    let uploadSuccess = false;

    if (this.websocketService && this.websocketService.isConnected()) {
      try {
        console.log('[ACTIVITY_COLLECTOR] âš¡ Uploading via WebSocket (real-time)');
        await this.websocketService.sendActivityData(inputActivityData);
        uploadSuccess = true;
      } catch (wsError) {
        console.error('[ACTIVITY_COLLECTOR] âŒ WebSocket upload failed, falling back to HTTP');
      }
    }

    // HTTP fallback
    if (!uploadSuccess) {
      console.log('[ACTIVITY_COLLECTOR] ğŸ”„ Uploading via HTTP API (fallback)');
      await this.dataSyncService.addActivityData(inputActivityData);
    }

    // é‡ç½®ç´¯ç§¯æ•°æ®
    this.resetAccumulatedData();

    this.emit('data-uploaded', this.accumulatedData);

  } catch (error) {
    console.error('[ACTIVITY_COLLECTOR] Failed to upload accumulated data:', error);
    this.emit('upload-error', error);
    throw error;
  }
}
```

#### 4.2 å‘¨æœŸé‡ç½®é€»è¾‘

**ä½ç½®**: activity-collector-service.ts:435-442

```typescript
private resetAccumulatedData(): void {
  this.accumulatedData = this.createEmptyActivityData();
  this.collectionStartTime = Date.now();
  this.lastActivityTime = this.collectionStartTime;
  this.isCurrentlyIdle = false;

  console.log('[ACTIVITY_COLLECTOR] Accumulated data reset');
}
```

**æ•°æ®ä¸Šä¼ æµç¨‹**:
```
1. å®šæ—¶å™¨è§¦å‘ (æ¯ 60 ç§’)
     â†“
2. æ£€æŸ¥æ˜¯å¦æœ‰ç´¯ç§¯æ•°æ®
     â†“
3. è®¡ç®—å®é™…æ”¶é›†æ—¶é•¿ (actualDuration)
     â†“
4. è·å–å½“å‰æ´»åŠ¨çª—å£ä¿¡æ¯
     â†“
5. å‡†å¤‡ä¸Šä¼ æ•°æ® (InputActivityData)
     - timestamp: ä¸Šä¼ æ—¶é—´æˆ³
     - isActive: true (æœ‰äº‹ä»¶å³æ´»åŠ¨)
     - keystrokes: ç´¯ç§¯é”®ç›˜æ¬¡æ•°
     - mouseClicks: ç´¯ç§¯é¼ æ ‡æ¬¡æ•°
     - idleTime: ç´¯ç§¯ç©ºé—²æ—¶é—´
     - activeWindow: å½“å‰çª—å£æ ‡é¢˜
     - activityInterval: å®é™…æ”¶é›†æ—¶é•¿
     â†“
6. ä¼˜å…ˆ WebSocket ä¸Šä¼  (å®æ—¶)
     â†“ (å¤±è´¥)
7. HTTP API å¤‡ç”¨ä¸Šä¼ 
     â†“
8. ä¸Šä¼ æˆåŠŸ â†’ é‡ç½®æ‰€æœ‰ç´¯ç§¯æ•°æ®
     - keystrokes = 0
     - mouseClicks = 0
     - activeTime = 0
     - idleTime = 0
     - collectionStartTime = now
```

---

### 5. æœåŠ¡å™¨ç«¯æ•°æ®æ ¼å¼

**InputActivityData** (common/interfaces/service-interfaces.ts:187-196):

```typescript
export interface InputActivityData {
  timestamp: string;              // ISO 8601 æ ¼å¼æ—¶é—´æˆ³
  isActive: boolean;              // æ˜¯å¦æ´»åŠ¨çŠ¶æ€ â­
  keystrokes: number;             // é”®ç›˜æŒ‰é”®æ¬¡æ•°
  mouseClicks: number;            // é¼ æ ‡ç‚¹å‡»æ¬¡æ•°
  idleTime: number;               // ç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰â­
  activeWindow?: string;          // æ´»åŠ¨çª—å£æ ‡é¢˜
  activeWindowProcess?: string;   // æ´»åŠ¨çª—å£è¿›ç¨‹å
  activityInterval: number;       // æ´»åŠ¨é‡‡é›†é—´éš”ï¼ˆæ¯«ç§’ï¼‰â­
}
```

**å…³é”®å­—æ®µè¯´æ˜**:

1. **isActive**: å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ­¤æ—¶é—´æ®µå†…ç”¨æˆ·æ˜¯å¦æœ‰æ´»åŠ¨
   - è®¡ç®—æ–¹å¼: `keystrokes > 0 || mouseClicks > 0`
   - ç”¨äºå¿«é€Ÿåˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨çº¿

2. **idleTime**: ç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
   - ä»åŸç”Ÿç³»ç»Ÿ API è·å–
   - ä¸ activeTime äº’ä¸ºè¡¥å……

3. **activityInterval**: å®é™…æ”¶é›†æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
   - ç†è®ºå€¼: `activityInterval` (é…ç½®ï¼Œé»˜è®¤60000ms)
   - å®é™…å€¼: `now - collectionStartTime`
   - **æ´»åŠ¨æ—¶é—´è®¡ç®—å…¬å¼**: `activeTime = activityInterval - idleTime`

---

## å…³é”®å‘ç°

### ä¼˜åŠ¿

âœ… **çœŸå®äº‹ä»¶æ•è·**
- ä½¿ç”¨ç³»ç»Ÿçº§åˆ«çš„äº‹ä»¶é’©å­ï¼Œéåº”ç”¨å±‚æ¨¡æ‹Ÿ
- macOS: CGEventTap API
- Windows: SetWindowsHookEx API
- æ•°æ®å¯ä¿¡åº¦æé«˜

âœ… **åŒé‡éªŒè¯æœºåˆ¶**
- `activeTime` + `idleTime` â‰ˆ `activityInterval`
- äº‹ä»¶è®¡æ•° + ç©ºé—²æ£€æµ‹äº’ä¸ºéªŒè¯
- é˜²æ­¢æ•°æ®ç¯¡æ”¹å’Œå¼‚å¸¸å€¼

âœ… **ç²¾ç¡®çš„æ—¶é—´ç´¯ç§¯ç®—æ³•**
- åŸºäºäº‹ä»¶è§¦å‘çš„å¢é‡ç´¯ç§¯
- ç©ºé—²é˜ˆå€¼é˜²æŠ¤ï¼ˆ30ç§’ï¼‰
- æ¯«ç§’çº§ç²¾åº¦

âœ… **å¯é…ç½®çš„é‡‡é›†ç­–ç•¥**
- `activityInterval`: çµæ´»é…ç½®ä¸ŠæŠ¥é¢‘ç‡
- `idleThreshold`: è‡ªå®šä¹‰ç©ºé—²åˆ¤æ–­æ ‡å‡†
- `enableActivity` / `enableIdleDetection`: åŠŸèƒ½å¼€å…³

âœ… **è·¨å¹³å°ä¸€è‡´æ€§**
- ç»Ÿä¸€çš„æ•°æ®ç»“æ„å’Œæ¥å£
- å¹³å°ç‰¹å®šå®ç°é€æ˜å°è£…
- é™çº§ç­–ç•¥ä¿éšœå¯ç”¨æ€§

### é—®é¢˜

âš ï¸ **æƒé™ä¾èµ–æ€§å¼º**
- macOS: éœ€è¦"è¾…åŠ©åŠŸèƒ½"æƒé™
- Windows: éœ€è¦ç®¡ç†å‘˜æƒé™
- æƒé™ä¸è¶³æ—¶åªèƒ½ä½¿ç”¨æ¨æ–­æ¨¡å¼ï¼Œå‡†ç¡®æ€§ä¸‹é™

âš ï¸ **ç©ºé—²é˜ˆå€¼å›ºå®š**
- é»˜è®¤ 30 ç§’é˜ˆå€¼å¯èƒ½ä¸é€‚åˆæ‰€æœ‰åœºæ™¯
- ç”¨æˆ·çŸ­æš‚æ€è€ƒï¼ˆå¦‚é˜…è¯»ä»£ç ï¼‰å¯èƒ½è¢«è¯¯åˆ¤ä¸ºç©ºé—²
- å»ºè®®: æä¾›ç”¨æˆ·è‡ªå®šä¹‰ç©ºé—²é˜ˆå€¼é…ç½®

âš ï¸ **æ´»åŠ¨æ—¶é—´è®¡ç®—ä¸é€æ˜**
- å®¢æˆ·ç«¯æœªç›´æ¥ä¸ŠæŠ¥ `activeTime`
- æœåŠ¡å™¨éœ€è¦é€šè¿‡ `activityInterval - idleTime` è®¡ç®—
- å¯èƒ½å¯¼è‡´ç†è§£åå·®

âš ï¸ **æ¨æ–­æ¨¡å¼ç½®ä¿¡åº¦ä½**
- Windows æ¨æ–­æ¨¡å¼ä¾èµ–é—´æ¥æŒ‡æ ‡
- ç½®ä¿¡åº¦é€šå¸¸åœ¨ 40%-70%
- ä¸é€‚åˆç²¾ç¡®è®¡è´¹åœºæ™¯

âš ï¸ **é¼ æ ‡ç§»åŠ¨æœªå……åˆ†åˆ©ç”¨**
- å½“å‰é¼ æ ‡ç§»åŠ¨è®¡æ•°ä½†æœªç”¨äºæ´»åŠ¨åˆ¤æ–­
- é¼ æ ‡ç§»åŠ¨å¯ä½œä¸ºè¾…åŠ©æ´»åŠ¨æŒ‡æ ‡
- å»ºè®®: å¢åŠ é¼ æ ‡ç§»åŠ¨ä½œä¸ºæ´»åŠ¨æ—¶é—´è®¡ç®—å› å­

### é£é™©

ğŸš¨ **æ•°æ®ä¸¢å¤±é£é™©**
- ç½‘ç»œä¸­æ–­æ—¶ç´¯ç§¯æ•°æ®æœªæŒä¹…åŒ–
- å®¢æˆ·ç«¯å´©æºƒå¯èƒ½ä¸¢å¤±æœªä¸Šä¼ æ•°æ®
- å»ºè®®: å®ç°æœ¬åœ°ç¼“å­˜å’Œè¡¥ä¼ æœºåˆ¶

ğŸš¨ **æ—¶é—´æ¼‚ç§»é£é™©**
- ä¾èµ–å®¢æˆ·ç«¯ç³»ç»Ÿæ—¶é—´
- ç”¨æˆ·ä¿®æ”¹ç³»ç»Ÿæ—¶é—´å¯èƒ½å¯¼è‡´æ•°æ®å¼‚å¸¸
- å»ºè®®: å¢åŠ æœåŠ¡å™¨æ—¶é—´æ ¡å‡†æœºåˆ¶

ğŸš¨ **æ€§èƒ½å½±å“**
- å…¨å±€é”®ç›˜é¼ æ ‡é’©å­å¯èƒ½å½±å“ç³»ç»Ÿæ€§èƒ½
- é«˜é¢‘äº‹ä»¶å¤„ç†éœ€è¦ä¼˜åŒ–
- å½“å‰æ¯ç§’å¯èƒ½å¤„ç†æ•°ç™¾æ¬¡äº‹ä»¶

ğŸš¨ **éšç§åˆè§„é£é™©**
- ç›‘æ§é”®ç›˜é¼ æ ‡éœ€è¦æ˜ç¡®çš„ç”¨æˆ·æˆæƒ
- éœ€è¦æ¸…æ™°çš„éšç§æ”¿ç­–å’Œæ•°æ®ç”¨é€”è¯´æ˜
- æŸäº›åœ°åŒºå¯èƒ½æœ‰æ³•å¾‹é™åˆ¶

---

## æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§

1. **å¢å¼ºæ´»åŠ¨æ—¶é—´é€æ˜åº¦**
   - **é—®é¢˜**: æœåŠ¡å™¨ç«¯éœ€è¦æ¨ç®—æ´»åŠ¨æ—¶é—´
   - **å»ºè®®**: å®¢æˆ·ç«¯ç›´æ¥ä¸ŠæŠ¥ `activeTime` å­—æ®µ
   ```typescript
   const inputActivityData = {
     // ... ç°æœ‰å­—æ®µ
     activeTime: this.accumulatedData.activeTime,  // æ–°å¢
     calculationMethod: 'event-based'  // æ ‡æ³¨è®¡ç®—æ–¹å¼
   };
   ```
   - **é¢„æœŸæ”¶ç›Š**: æ¶ˆé™¤æ•°æ®ç†è§£æ­§ä¹‰ï¼Œæé«˜æœåŠ¡å™¨ç«¯è®¡ç®—æ•ˆç‡

2. **å®ç°æ•°æ®æŒä¹…åŒ–æœºåˆ¶**
   - **é—®é¢˜**: ç½‘ç»œä¸­æ–­æˆ–å´©æºƒå¯¼è‡´æ•°æ®ä¸¢å¤±
   - **å»ºè®®**: ä¸Šä¼ å¤±è´¥æ—¶å†™å…¥æœ¬åœ° SQLite æˆ–æ–‡ä»¶é˜Ÿåˆ—
   ```typescript
   private async uploadAccumulatedData(): Promise<void> {
     try {
       await this.sendToServer(data);
       await this.clearLocalCache(data.timestamp);
     } catch (error) {
       await this.saveToLocalCache(data);  // æŒä¹…åŒ–å¤±è´¥æ•°æ®
       this.scheduleRetry();
     }
   }
   ```
   - **é¢„æœŸæ”¶ç›Š**: æ•°æ®å®Œæ•´æ€§æå‡è‡³ 99.9%+

3. **å¢åŠ æœåŠ¡å™¨æ—¶é—´åŒæ­¥**
   - **é—®é¢˜**: å®¢æˆ·ç«¯æ—¶é—´ä¸å¯ä¿¡
   - **å»ºè®®**: å¿ƒè·³æ—¶åŒæ­¥æœåŠ¡å™¨æ—¶é—´ï¼Œä½¿ç”¨æ—¶é—´åç§»é‡æ ¡æ­£
   ```typescript
   const serverTimeOffset = serverTime - Date.now();
   const correctedTimestamp = new Date(Date.now() + serverTimeOffset);
   ```
   - **é¢„æœŸæ”¶ç›Š**: æ¶ˆé™¤æ—¶é—´ç¯¡æ”¹é£é™©

### ä¸­ä¼˜å…ˆçº§

4. **å¯é…ç½®çš„ç©ºé—²é˜ˆå€¼**
   - **é—®é¢˜**: 30ç§’å›ºå®šé˜ˆå€¼ä¸çµæ´»
   - **å»ºè®®**: æä¾›ç”¨æˆ·æˆ–ç®¡ç†å‘˜é…ç½®æ¥å£
   ```typescript
   interface ActivityCollectorConfig {
     // ... ç°æœ‰å­—æ®µ
     customIdleThreshold?: number;  // å…è®¸è‡ªå®šä¹‰ç©ºé—²é˜ˆå€¼
     idleThresholdPresets: {
       'strict': 15000,    // ä¸¥æ ¼æ¨¡å¼ 15ç§’
       'standard': 30000,  // æ ‡å‡†æ¨¡å¼ 30ç§’
       'relaxed': 60000    // å®½æ¾æ¨¡å¼ 60ç§’
     };
   }
   ```
   - **é¢„æœŸæ”¶ç›Š**: é€‚åº”ä¸åŒå·¥ä½œåœºæ™¯éœ€æ±‚

5. **å¢å¼ºé¼ æ ‡ç§»åŠ¨åˆ©ç”¨**
   - **é—®é¢˜**: é¼ æ ‡ç§»åŠ¨æœªå……åˆ†ç”¨äºæ´»åŠ¨åˆ¤æ–­
   - **å»ºè®®**: å¤§å¹…åº¦é¼ æ ‡ç§»åŠ¨ä½œä¸ºæ´»åŠ¨æŒ‡æ ‡
   ```typescript
   private handleMouseEvent(data: any): void {
     if (data.type === 'move' && data.distance > 50) {
       // å¤§å¹…åº¦ç§»åŠ¨è§†ä¸ºæ´»åŠ¨
       this.updateLastActivityTime();
       this.updateActiveTime();
     }
   }
   ```
   - **é¢„æœŸæ”¶ç›Š**: æé«˜å¯¹é˜…è¯»ã€æ€è€ƒç­‰ä½é¢‘è¾“å…¥æ´»åŠ¨çš„è¯†åˆ«

6. **æ¨æ–­æ¨¡å¼ç½®ä¿¡åº¦ä¸ŠæŠ¥**
   - **é—®é¢˜**: æ¨æ–­æ•°æ®å¯ä¿¡åº¦ä¸æ˜ç¡®
   - **å»ºè®®**: å¢åŠ  `confidence` å’Œ `dataSource` å­—æ®µ
   ```typescript
   const inputActivityData = {
     // ... ç°æœ‰å­—æ®µ
     dataSource: 'native-hook' | 'wmi-inference',
     confidence: 95,  // 0-100
   };
   ```
   - **é¢„æœŸæ”¶ç›Š**: æœåŠ¡å™¨ç«¯å¯é’ˆå¯¹ä½ç½®ä¿¡åº¦æ•°æ®è¿›è¡Œç‰¹æ®Šå¤„ç†

### ä½ä¼˜å…ˆçº§

7. **æ´»åŠ¨æ¨¡å¼åˆ†æ**
   - ç»Ÿè®¡ç”¨æˆ·å…¸å‹æ´»åŠ¨æ¨¡å¼
   - è¯†åˆ«å¼‚å¸¸æ´»åŠ¨ï¼ˆå¦‚è„šæœ¬æ¨¡æ‹Ÿï¼‰
   - æä¾›æ´»åŠ¨è´¨é‡è¯„ä¼°

8. **æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–**
   - å¢åŠ äº‹ä»¶å¤„ç†è€—æ—¶ç›‘æ§
   - é«˜é¢‘äº‹ä»¶é˜²æŠ–ï¼ˆdebounceï¼‰
   - å¼‚æ­¥æ‰¹é‡å¤„ç†

9. **éšç§å¢å¼ºåŠŸèƒ½**
   - æä¾›"éšç§æ¨¡å¼"ï¼ˆé™ä½é‡‡é›†é¢‘ç‡ï¼‰
   - æ•æ„Ÿæ—¶é—´æ®µå±è”½ï¼ˆå¦‚ä¼‘æ¯æ—¶é—´ï¼‰
   - ç”¨æˆ·å¯æŸ¥çœ‹å’Œåˆ é™¤å†å²æ•°æ®

---

## æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| é¡¹ç›® | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å»ºè®®è¡ŒåŠ¨ |
|------|---------|---------|---------|
| æ´»åŠ¨æ—¶é—´å­—æ®µæœªç›´æ¥ä¸ŠæŠ¥ | ä¸­ | æ•°æ®ç†è§£å’ŒæœåŠ¡å™¨è®¡ç®— | æ·»åŠ  `activeTime` åˆ°ä¸ŠæŠ¥æ•°æ®ç»“æ„ |
| ç¼ºå°‘æœ¬åœ°æ•°æ®æŒä¹…åŒ– | é«˜ | æ•°æ®å®Œæ•´æ€§ | å®ç° SQLite æˆ–æ–‡ä»¶é˜Ÿåˆ—ç¼“å­˜ |
| ç©ºé—²é˜ˆå€¼ç¡¬ç¼–ç  | ä½ | ç”¨æˆ·ä½“éªŒçµæ´»æ€§ | æä¾›é…ç½®æ¥å£ |
| æ¨æ–­æ¨¡å¼å‡†ç¡®æ€§ä½ | ä¸­ | Windows æ— æƒé™åœºæ™¯ | ä¼˜åŒ–æ¨æ–­ç®—æ³•ï¼Œå¢åŠ ç½®ä¿¡åº¦æ ‡æ³¨ |
| ç¼ºå°‘æ—¶é—´åŒæ­¥æœºåˆ¶ | ä¸­ | æ•°æ®å¯ä¿¡åº¦ | å®ç°æœåŠ¡å™¨æ—¶é—´æ ¡å‡† |
| æƒé™æ£€æµ‹ä¸å®Œå–„ | ä¸­ | åˆå§‹åŒ–æµç¨‹ | å¢å¼ºæƒé™å¼•å¯¼å’Œé™çº§ç­–ç•¥ |

---

## æ´»åŠ¨æ—¶é—´è®¡ç®—å…¬å¼æ€»ç»“

### å®¢æˆ·ç«¯è®¡ç®—

```
// æ¯ä¸ªé‡‡é›†å‘¨æœŸï¼ˆé»˜è®¤60ç§’ï¼‰
activeTime = Î£ (å½“å‰æ—¶é—´ - ä¸Šæ¬¡æ´»åŠ¨æ—¶é—´)
             for each (é”®ç›˜äº‹ä»¶ or é¼ æ ‡äº‹ä»¶)
             where (æ—¶é—´å·® < ç©ºé—²é˜ˆå€¼30ç§’)

idleTime = ä»ç³»ç»ŸAPIè·å–çš„ç©ºé—²æ—¶é•¿

// éªŒè¯å…¬å¼
activeTime + idleTime â‰ˆ activityInterval (æ”¶é›†æ—¶é•¿)
```

### æœåŠ¡å™¨ç«¯æ¨ç®—

```
// åŸºäºä¸ŠæŠ¥æ•°æ®æ¨ç®—
activeTime = activityInterval - idleTime

// æ´»åŠ¨åˆ¤æ–­
isActive = (keystrokes > 0) || (mouseClicks > 0)

// æœ‰æ•ˆå·¥ä½œæ—¶é•¿
effectiveWorkTime = Î£ activeTime
                    for each period where isActive = true
```

### ç¤ºä¾‹åœºæ™¯è®¡ç®—

**åœºæ™¯**: ç”¨æˆ·åœ¨60ç§’å†…çš„æ´»åŠ¨

```
æ—¶é—´è½´:
00:00 - å¼€å§‹é‡‡é›†
00:05 - é”®ç›˜è¾“å…¥ (5ç§’æ´»è·ƒ)
00:10 - é¼ æ ‡ç‚¹å‡» (5ç§’æ´»è·ƒ)
00:15 - å¼€å§‹é˜…è¯»æ–‡æ¡£ (æ— è¾“å…¥)
00:45 - æ¢å¤è¾“å…¥ (æ£€æµ‹åˆ°30ç§’ç©ºé—²)
00:50 - é¼ æ ‡ç‚¹å‡» (5ç§’æ´»è·ƒ)
01:00 - é‡‡é›†å‘¨æœŸç»“æŸ

è®¡ç®—è¿‡ç¨‹:
activeTime = 5s (00-05) + 5s (05-10) + 5s (45-50) = 15000ms
idleTime = 30000ms (15-45çš„ç©ºé—²æ—¶é—´)
å…¶ä»–æ—¶é—´ = 60000 - 15000 - 30000 = 15000ms (æ­£å¸¸æ´»åŠ¨ä½†ä½äºæ£€æµ‹é˜ˆå€¼)

ä¸ŠæŠ¥æ•°æ®:
{
  timestamp: "2025-01-16T10:01:00Z",
  isActive: true,
  keystrokes: 120,
  mouseClicks: 15,
  idleTime: 30000,
  activityInterval: 60000
}

æœåŠ¡å™¨æ¨ç®—:
activeTime = 60000 - 30000 = 30000ms (30ç§’)
effectiveWorkTime = 30s (è®¡å…¥å·¥ä½œæ—¶é•¿)
```

---

## æ¶æ„è§†å›¾

### æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·æ“ä½œ                                 â”‚
â”‚            (é”®ç›˜è¾“å…¥ã€é¼ æ ‡ç‚¹å‡»ã€é¼ æ ‡ç§»åŠ¨)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ“ä½œç³»ç»Ÿ (OS Kernel)                          â”‚
â”‚         macOS: IOKit / CGEventTap                            â”‚
â”‚         Windows: Win32 API / SetWindowsHookEx                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŸç”Ÿæ¨¡å— (Native Modules)                         â”‚
â”‚   macOS: native-event-monitor (Objective-C/Swift)            â”‚
â”‚   Windows: native-event-monitor-win (C++ Win32)              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ äº‹ä»¶ç±»å‹åˆ¤æ–­                                      â”‚       â”‚
â”‚   â”‚ - Keyboard Event â†’ keystrokes++                 â”‚       â”‚
â”‚   â”‚ - Mouse Click â†’ mouseClicks++                   â”‚       â”‚
â”‚   â”‚ - Mouse Move â†’ mouseMoves++                     â”‚       â”‚
â”‚   â”‚ - Scroll Event â†’ scrollEvents++                 â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Platform Adapters (å¹³å°é€‚é…å™¨)                       â”‚
â”‚   - DarwinAdapter.createEventListener()                       â”‚
â”‚   - WindowsAdapter.createEventListener()                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ äº‹ä»¶èšåˆå’Œå‘¨æœŸè®¡æ•°                                â”‚       â”‚
â”‚   â”‚ currentPeriodKeystrokes += count                â”‚       â”‚
â”‚   â”‚ currentPeriodMouseClicks += count               â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ActivityCollectorService (ä¸šåŠ¡é€»è¾‘å±‚)                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ äº‹ä»¶å¤„ç†å™¨                                         â”‚      â”‚
â”‚   â”‚ - handleKeyboardEvent()                          â”‚      â”‚
â”‚   â”‚   â†’ updateLastActivityTime()                     â”‚      â”‚
â”‚   â”‚   â†’ updateActiveTime()                           â”‚      â”‚
â”‚   â”‚ - handleMouseEvent()                             â”‚      â”‚
â”‚   â”‚   â†’ updateLastActivityTime()                     â”‚      â”‚
â”‚   â”‚   â†’ updateActiveTime()                           â”‚      â”‚
â”‚   â”‚ - handleIdleStateChange()                        â”‚      â”‚
â”‚   â”‚   â†’ ç´¯ç§¯ idleTime                                 â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ æ´»åŠ¨æ—¶é—´è®¡ç®—æ ¸å¿ƒ                                   â”‚      â”‚
â”‚   â”‚                                                   â”‚      â”‚
â”‚   â”‚ updateActiveTime() {                             â”‚      â”‚
â”‚   â”‚   if (!isCurrentlyIdle) {                        â”‚      â”‚
â”‚   â”‚     timeDiff = now - lastActivityTime            â”‚      â”‚
â”‚   â”‚     if (timeDiff < idleThreshold) {              â”‚      â”‚
â”‚   â”‚       activeTime += timeDiff                     â”‚      â”‚
â”‚   â”‚     }                                             â”‚      â”‚
â”‚   â”‚   }                                               â”‚      â”‚
â”‚   â”‚ }                                                 â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ ç´¯ç§¯æ•°æ®ç»“æ„                                       â”‚      â”‚
â”‚   â”‚ {                                                 â”‚      â”‚
â”‚   â”‚   keystrokes: 0,                                 â”‚      â”‚
â”‚   â”‚   mouseClicks: 0,                                â”‚      â”‚
â”‚   â”‚   mouseMoves: 0,                                 â”‚      â”‚
â”‚   â”‚   scrollEvents: 0,                               â”‚      â”‚
â”‚   â”‚   activeTime: 0,        â† æ ¸å¿ƒå­—æ®µ                â”‚      â”‚
â”‚   â”‚   idleTime: 0,          â† æ ¸å¿ƒå­—æ®µ                â”‚      â”‚
â”‚   â”‚   intervalDuration: 60000,                       â”‚      â”‚
â”‚   â”‚   timestamp: Date                                â”‚      â”‚
â”‚   â”‚ }                                                 â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ (å®šæ—¶å™¨: æ¯60ç§’)
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              uploadAccumulatedData()                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ æ•°æ®ä¸ŠæŠ¥æ ¼å¼è½¬æ¢                                   â”‚      â”‚
â”‚   â”‚ InputActivityData {                              â”‚      â”‚
â”‚   â”‚   timestamp: ISO8601,                            â”‚      â”‚
â”‚   â”‚   isActive: keystrokes > 0 || mouseClicks > 0,  â”‚      â”‚
â”‚   â”‚   keystrokes: number,                            â”‚      â”‚
â”‚   â”‚   mouseClicks: number,                           â”‚      â”‚
â”‚   â”‚   idleTime: number,                              â”‚      â”‚
â”‚   â”‚   activeWindow: string,                          â”‚      â”‚
â”‚   â”‚   activityInterval: actualDuration               â”‚      â”‚
â”‚   â”‚ }                                                 â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  WebSocket (å®æ—¶)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ (å¤±è´¥)
                    â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   HTTP API (å¤‡ç”¨)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Server                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ æœåŠ¡å™¨ç«¯æ´»åŠ¨æ—¶é—´è®¡ç®—                               â”‚      â”‚
â”‚   â”‚                                                   â”‚      â”‚
â”‚   â”‚ activeTime = activityInterval - idleTime         â”‚      â”‚
â”‚   â”‚                                                   â”‚      â”‚
â”‚   â”‚ effectiveWorkTime = Î£ activeTime                 â”‚      â”‚
â”‚   â”‚                     where isActive = true        â”‚      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€§èƒ½æŒ‡æ ‡

### äº‹ä»¶å¤„ç†æ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| äº‹ä»¶æ•è·å»¶è¿Ÿ | < 5ms | ä»ç³»ç»Ÿäº‹ä»¶åˆ°åŸç”Ÿæ¨¡å—å¤„ç† |
| äº‹ä»¶å¤„ç†å»¶è¿Ÿ | < 10ms | ä»åŸç”Ÿæ¨¡å—åˆ°ä¸šåŠ¡å±‚å¤„ç† |
| å†…å­˜å ç”¨ | < 20MB | åŸç”Ÿæ¨¡å— + ä¸šåŠ¡é€»è¾‘ |
| CPU å ç”¨ | < 1% | æ­£å¸¸æ´»åŠ¨ä¸‹çš„ CPU å ç”¨ |
| æ•°æ®ä¸Šä¼ é¢‘ç‡ | 60ç§’/æ¬¡ | å¯é…ç½®ï¼Œé»˜è®¤1åˆ†é’Ÿ |
| æ•°æ®åŒ…å¤§å° | < 1KB | å•æ¬¡ä¸Šä¼ æ•°æ®é‡ |

### å‡†ç¡®æ€§æŒ‡æ ‡

| åœºæ™¯ | å‡†ç¡®ç‡ | è¯´æ˜ |
|------|-------|------|
| åŸç”Ÿé’©å­æ¨¡å¼ | 99%+ | æœ‰å®Œæ•´æƒé™æ—¶ |
| æ¨æ–­æ¨¡å¼ (Windows) | 60-80% | æƒé™ä¸è¶³æ—¶ |
| ç©ºé—²æ£€æµ‹ | 95%+ | åŸºäºç³»ç»Ÿ API |
| æ—¶é—´ç´¯ç§¯ | æ¯«ç§’çº§ | ç²¾ç¡®åˆ°æ¯«ç§’ |

---

## å®‰å…¨è¯„ä¼°

### æ•°æ®å®‰å…¨

âœ… **æ•°æ®æœ€å°åŒ–åŸåˆ™**
- ä»…æ”¶é›†é”®ç›˜é¼ æ ‡äº‹ä»¶è®¡æ•°ï¼Œä¸è®°å½•å…·ä½“æŒ‰é”®å†…å®¹
- ä¸æ•è·å±å¹•å†…å®¹ï¼ˆé™¤éå•ç‹¬å¯ç”¨æˆªå›¾åŠŸèƒ½ï¼‰
- çª—å£æ ‡é¢˜å¯é€‰ï¼Œå¯é…ç½®ä¸ºä»…è®°å½•è¿›ç¨‹å

âœ… **ä¼ è¾“å®‰å…¨**
- WebSocket ä½¿ç”¨ TLS åŠ å¯†
- HTTP API ä½¿ç”¨ HTTPS
- æ”¯æŒå®¢æˆ·ç«¯è¯ä¹¦è®¤è¯

âš ï¸ **å­˜å‚¨å®‰å…¨**
- å†…å­˜ä¸­çš„ç´¯ç§¯æ•°æ®æœªåŠ å¯†
- æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚æœå®ç°ï¼‰éœ€è¦è€ƒè™‘åŠ å¯†

### éšç§åˆè§„

âš ï¸ **ç”¨æˆ·çŸ¥æƒ…åŒæ„**
- éœ€è¦æ˜ç¡®çš„ç”¨æˆ·æˆæƒæµç¨‹
- éšç§æ”¿ç­–åº”æ¸…æ™°è¯´æ˜ç›‘æ§èŒƒå›´å’Œæ•°æ®ç”¨é€”
- æä¾›ç”¨æˆ·éšæ—¶åœç”¨ç›‘æ§çš„é€‰é¡¹

âš ï¸ **æ•°æ®åˆ é™¤æƒ**
- ç”¨æˆ·åº”æœ‰æƒæŸ¥çœ‹å’Œåˆ é™¤å†å²æ´»åŠ¨æ•°æ®
- æä¾›æ•°æ®å¯¼å‡ºåŠŸèƒ½

âš ï¸ **åœ°åŸŸåˆè§„**
- GDPR (æ¬§ç›Ÿ): éœ€è¦æ˜ç¡®çš„åˆæ³•ç†ç”±å’Œç”¨æˆ·åŒæ„
- CCPA (åŠ å·): éœ€è¦æä¾›é€€å‡ºé€‰é¡¹
- ä¸­å›½ä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•: éœ€è¦æ˜ç¡®çš„å‘ŠçŸ¥å’ŒåŒæ„æœºåˆ¶

---

## å­¦ä¹ è¦ç‚¹

### ç³»ç»Ÿç¼–ç¨‹æŠ€æœ¯

1. **äº‹ä»¶é’©å­ (Event Hooks)**
   - macOS: CGEventTap å…¨å±€äº‹ä»¶ç›‘å¬
   - Windows: SetWindowsHookEx ä½çº§é’©å­
   - æƒé™è¦æ±‚å’Œå®‰å…¨é™åˆ¶

2. **è·¨å¹³å°æŠ½è±¡**
   - ç»Ÿä¸€çš„æ¥å£è®¾è®¡
   - å¹³å°ç‰¹å®šå®ç°å°è£…
   - é™çº§ç­–ç•¥å’Œé”™è¯¯å¤„ç†

3. **åŸç”Ÿæ¨¡å—é›†æˆ**
   - Node.js N-API ç»‘å®š
   - C++/Objective-C/Swift æ··åˆç¼–ç¨‹
   - å†…å­˜ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸ

### æ•°æ®æ”¶é›†æœ€ä½³å®è·µ

1. **å¢é‡ç´¯ç§¯æ¨¡å¼**
   - äº‹ä»¶é©±åŠ¨çš„å¢é‡æ›´æ–°
   - å®šæ—¶ä¸ŠæŠ¥å’Œæ•°æ®é‡ç½®
   - é˜²æ­¢æ•°æ®ä¸¢å¤±çš„æŒä¹…åŒ–

2. **åŒé‡éªŒè¯æœºåˆ¶**
   - activeTime + idleTime â‰ˆ intervalDuration
   - äº‹ä»¶è®¡æ•° + ç©ºé—²æ£€æµ‹
   - ç½®ä¿¡åº¦è¯„ä¼°

3. **æ€§èƒ½ä¼˜åŒ–**
   - é«˜é¢‘äº‹ä»¶çš„é˜²æŠ–å¤„ç†
   - å¼‚æ­¥äº‹ä»¶å¤„ç†
   - å†…å­˜å’Œ CPU å ç”¨æ§åˆ¶

### éšç§ä¸å®‰å…¨

1. **æ•°æ®æœ€å°åŒ–**
   - ä»…æ”¶é›†å¿…è¦çš„èšåˆæŒ‡æ ‡
   - ä¸è®°å½•æ•æ„Ÿçš„å…·ä½“å†…å®¹
   - æä¾›ç”¨æˆ·æ§åˆ¶é€‰é¡¹

2. **é€æ˜åº¦å’ŒåŒæ„**
   - æ¸…æ™°çš„éšç§æ”¿ç­–
   - æ˜ç¡®çš„ç”¨æˆ·æˆæƒæµç¨‹
   - éšæ—¶å¯åœç”¨çš„é€‰é¡¹

3. **å®‰å…¨ä¼ è¾“å’Œå­˜å‚¨**
   - TLS/HTTPS åŠ å¯†ä¼ è¾“
   - è€ƒè™‘æœ¬åœ°æ•°æ®åŠ å¯†
   - è®¿é—®æ§åˆ¶å’Œå®¡è®¡æ—¥å¿—

---

## å‚è€ƒèµ„æº

### æŠ€æœ¯æ–‡æ¡£

- **macOS CGEventTap**: [Apple Developer - Quartz Event Services](https://developer.apple.com/documentation/coregraphics/quartz_event_services)
- **Windows Hooks**: [Microsoft Docs - SetWindowsHookEx](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexw)
- **Node.js N-API**: [Node.js Documentation - N-API](https://nodejs.org/api/n-api.html)

### æœ€ä½³å®è·µ

- **Activity Tracking Best Practices**: [Web Monitoring Guidelines](https://www.w3.org/TR/monitoring/)
- **Privacy by Design**: [Privacy Principles](https://www.ipc.on.ca/wp-content/uploads/Resources/7foundationalprinciples.pdf)
- **GDPR Compliance**: [European Commission GDPR Portal](https://ec.europa.eu/info/law/law-topic/data-protection_en)

### æŠ€æœ¯æ ‡å‡†

- **ISO/IEC 27001**: ä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»
- **NIST Cybersecurity Framework**: ç½‘ç»œå®‰å…¨æ¡†æ¶
- **OWASP Top 10**: Web åº”ç”¨å®‰å…¨é£é™©

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-01-16
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ†æå¸ˆ**: Claude Code AI Assistant
