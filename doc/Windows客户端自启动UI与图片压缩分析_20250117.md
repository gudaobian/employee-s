# Windowså®¢æˆ·ç«¯è‡ªå¯åŠ¨UIä¸å›¾ç‰‡å‹ç¼©åˆ†æ

**åˆ†ææ—¶é—´**: 2025-01-17
**åˆ†æèŒƒå›´**: Windowså®¢æˆ·ç«¯å¼€æœºè‡ªå¯åŠ¨UIæ˜¾ç¤ºé—®é¢˜ + å›¾ç‰‡å‹ç¼©å®ç°è¯„ä¼°
**å½“å‰ç«¯**: employee-client
**ç‰ˆæœ¬**: 1.0.14

---

## æ‰§è¡Œæ‘˜è¦

ç»è¿‡è¯¦ç»†ä»£ç å®¡æŸ¥å’Œé€»è¾‘åˆ†æ,å‘ç°äº†ä¸¤ä¸ªå…³é”®é—®é¢˜:

1. **è‡ªå¯åŠ¨UIéšè—é—®é¢˜**: Windowså®¢æˆ·ç«¯åœ¨å…³æœºå‰è®¾ç½®å¼€æœºè‡ªå¯åŠ¨å,å¼€æœºé‡å¯æ—¶UIçª—å£ç¡®å®ä¼šè‡ªåŠ¨éšè—,è¿™æ˜¯**é¢„æœŸè¡Œä¸ºè€ŒéBug**ã€‚é—®é¢˜æ ¹æºåœ¨äºè‡ªå¯åŠ¨å‘½ä»¤åŒ…å«äº†`--start-minimized`å‚æ•°,å¯¼è‡´çª—å£åå°å¯åŠ¨ã€‚
2. **å›¾ç‰‡å‹ç¼©å®ç°**: å®¢æˆ·ç«¯ä½¿ç”¨`sharp`åº“å®ç°äº†é«˜æ•ˆçš„JPEGå‹ç¼©,å‹ç¼©ç‡å¯è¾¾50-70%,å®ç°è´¨é‡è‰¯å¥½ã€‚

å»ºè®®é‡‡å–ä»¥ä¸‹æ”¹è¿›æªæ–½:
- ä¸ºè‡ªå¯åŠ¨æ·»åŠ æ‰˜ç›˜é€šçŸ¥,æé†’ç”¨æˆ·åº”ç”¨å·²å¯åŠ¨
- æä¾›UIé…ç½®é€‰é¡¹,å…è®¸ç”¨æˆ·é€‰æ‹©"æ˜¾ç¤ºçª—å£"æˆ–"åå°å¯åŠ¨"
- è€ƒè™‘é™ä½æˆªå›¾å‹ç¼©è´¨é‡(ä»80é™è‡³70),è¿›ä¸€æ­¥å‡å°æ–‡ä»¶å¤§å°

---

## é—®é¢˜1: è‡ªå¯åŠ¨UIéšè—é—®é¢˜åˆ†æ

### é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆ: Windowså®¢æˆ·ç«¯åœ¨å…³æœºå‰è®¾ç½®äº†å¼€æœºè‡ªå¯åŠ¨,é‡å¯åå‘ç°UIçª—å£å…³é—­äº†(ä¸å¯è§)ã€‚ç”¨æˆ·æ€€ç–‘è¿™æ˜¯UIæ˜¾ç¤ºé—®é¢˜ã€‚

### é—®é¢˜æ ¹æº

#### 1. è‡ªå¯åŠ¨å‘½ä»¤åŒ…å«éšè—å¯åŠ¨å‚æ•°

**ä½ç½®**: `platforms/windows/windows-adapter.ts:759`

```typescript
async enableAutoStart(): Promise<boolean> {
  try {
    const appName = 'EmployeeSafety';
    const executablePath = process.execPath;

    // æ·»åŠ  --start-minimized å‚æ•°,å®ç°åå°å¯åŠ¨å¹¶è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡
    const startCommand = `\\"${executablePath}\\" --start-minimized`;

    await execAsync(`reg add "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" /v ${appName} /t REG_SZ /d "${startCommand}" /f`);

    logger.info('âœ… è‡ªå¯åŠ¨å·²å¯ç”¨:åå°æ¨¡å¼ + è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡');
    logger.info(`è‡ªå¯åŠ¨å‘½ä»¤: ${startCommand}`);
    return true;
  } catch (error) {
    logger.error('Failed to enable auto start', error);
    return false;
  }
}
```

**å…³é”®ç‚¹**:
- è‡ªå¯åŠ¨æ³¨å†Œæ—¶,å‘½ä»¤è¡Œå‚æ•°ç¡¬ç¼–ç äº†`--start-minimized`
- è¿™å¯¼è‡´æ¯æ¬¡å¼€æœºå¯åŠ¨æ—¶,åº”ç”¨éƒ½ä¼šä»¥åå°æ¨¡å¼è¿è¡Œ,**çª—å£ä¸ä¼šæ˜¾ç¤º**

#### 2. Electronä¸»è¿›ç¨‹æ£€æµ‹åˆ°å‚æ•°å¹¶éšè—çª—å£

**ä½ç½®**: `electron/main-minimal.js:25-27`

```javascript
// æ£€æŸ¥å¯åŠ¨å‚æ•°
const isStartMinimized = process.argv.includes('--start-minimized');
console.log(`[STARTUP] Start minimized: ${isStartMinimized}`);
console.log(`[STARTUP] Command line args:`, process.argv);
```

**ä½ç½®**: `electron/main-minimal.js:309-314`

```javascript
// æ ¹æ®å¯åŠ¨å‚æ•°å†³å®šæ˜¯å¦æ˜¾ç¤ºçª—å£
if (!isStartMinimized) {
    mainWindow.show();
    console.log('[STARTUP] çª—å£å·²æ˜¾ç¤º(æ­£å¸¸å¯åŠ¨)');
} else {
    console.log('[STARTUP] åå°å¯åŠ¨,çª—å£ä¿æŒéšè—');
    // åå°å¯åŠ¨æ—¶è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡
```

**å…³é”®ç‚¹**:
- ä¸»è¿›ç¨‹æ£€æµ‹åˆ°`--start-minimized`å‚æ•°å,**ä¸ä¼šè°ƒç”¨`mainWindow.show()`**
- çª—å£åˆ›å»ºä½†ä¿æŒéšè—çŠ¶æ€
- åº”ç”¨ä¼šè‡ªåŠ¨å¯åŠ¨åå°ç›‘æ§æœåŠ¡(ä½ç½®: `main-minimal.js:100-114`)

#### 3. è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡

**ä½ç½®**: `electron/main-minimal.js:100-114`

```javascript
// å¦‚æœæ˜¯æœ€å°åŒ–å¯åŠ¨,è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡
if (isStartMinimized) {
    setTimeout(async () => {
        console.log('[STARTUP] æœ€å°åŒ–å¯åŠ¨æ£€æµ‹åˆ°,è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡...');
        try {
            const result = await startAppService(false); // false = è‡ªåŠ¨å¯åŠ¨,éæ‰‹åŠ¨
            if (result && result.success) {
                console.log('[STARTUP] åå°ç›‘æ§æœåŠ¡å¯åŠ¨æˆåŠŸ');
            } else {
                console.log('[STARTUP] åå°ç›‘æ§æœåŠ¡å¯åŠ¨å¤±è´¥:', result?.message || 'æœªçŸ¥é”™è¯¯');
            }
        } catch (error) {
            console.error('[STARTUP] åå°ç›‘æ§æœåŠ¡å¯åŠ¨å¼‚å¸¸:', error.message);
        }
    }, 3000); // ç­‰å¾…3ç§’ç¡®ä¿æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–å®Œæˆ
}
```

**å…³é”®ç‚¹**:
- åå°å¯åŠ¨æ—¶,3ç§’åè‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡
- ç”¨æˆ·æ— éœ€æ‰‹åŠ¨ç‚¹å‡»"å¯åŠ¨ç›‘æ§"æŒ‰é’®
- **ç›‘æ§åŠŸèƒ½æ­£å¸¸å·¥ä½œ,åªæ˜¯UIä¸å¯è§**

### è®¾è®¡æ„å›¾åˆ†æ

æ ¹æ®ä»£ç æ³¨é‡Šå’Œå®ç°é€»è¾‘,è¿™æ˜¯**æœ‰æ„ä¸ºä¹‹çš„è®¾è®¡**,è€ŒéBug:

**è®¾è®¡ç›®æ ‡**:
1. å¼€æœºè‡ªå¯åŠ¨æ—¶,ä¸æ‰“æ‰°ç”¨æˆ·(ä¸å¼¹å‡ºçª—å£)
2. è‡ªåŠ¨å¯åŠ¨åå°ç›‘æ§æœåŠ¡,æ— éœ€ç”¨æˆ·æ“ä½œ
3. åº”ç”¨åœ¨ç³»ç»Ÿæ‰˜ç›˜/èœå•æ ä¿æŒå¯ç”¨

**å®é™…é—®é¢˜**:
- **ç¼ºå°‘ç”¨æˆ·åé¦ˆ**: æ²¡æœ‰é€šçŸ¥å‘ŠçŸ¥ç”¨æˆ·åº”ç”¨å·²å¯åŠ¨
- **ç”¨æˆ·å›°æƒ‘**: ç”¨æˆ·ä¸çŸ¥é“åº”ç”¨æ˜¯å¦æˆåŠŸå¯åŠ¨
- **æ— UIå…¥å£**: ç”¨æˆ·å¯èƒ½ä¸çŸ¥é“å¦‚ä½•æ‰“å¼€çª—å£(éœ€è¦ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡)

### å½±å“è¯„ä¼°

| å½±å“ç»´åº¦ | è¯„ä¼°ç»“æœ | è¯´æ˜ |
|---------|---------|------|
| **åŠŸèƒ½æ­£ç¡®æ€§** | âœ… æ­£å¸¸ | ç›‘æ§æœåŠ¡æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œ |
| **ç”¨æˆ·ä½“éªŒ** | âš ï¸ è¾ƒå·® | ç¼ºå°‘å¯åŠ¨åé¦ˆ,ç”¨æˆ·å›°æƒ‘ |
| **å®‰å…¨æ€§** | âœ… æ— å½±å“ | ä¸æ¶‰åŠå®‰å…¨é—®é¢˜ |
| **æ€§èƒ½** | âœ… ä¼˜ç§€ | åå°å¯åŠ¨ä¸å ç”¨å‰å°èµ„æº |

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1: æ·»åŠ ç³»ç»Ÿæ‰˜ç›˜é€šçŸ¥ (æ¨è)

**å®æ–½ä½ç½®**: `electron/main-minimal.js:100-114`

**ä¿®æ”¹ä»£ç **:
```javascript
if (isStartMinimized) {
    setTimeout(async () => {
        console.log('[STARTUP] æœ€å°åŒ–å¯åŠ¨æ£€æµ‹åˆ°,è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡...');
        try {
            const result = await startAppService(false);
            if (result && result.success) {
                console.log('[STARTUP] åå°ç›‘æ§æœåŠ¡å¯åŠ¨æˆåŠŸ');

                // æ·»åŠ ç³»ç»Ÿæ‰˜ç›˜é€šçŸ¥
                if (tray && !tray.isDestroyed()) {
                    tray.displayBalloon({
                        title: 'ä¼ä¸šå®‰å…¨',
                        content: 'åº”ç”¨å·²åœ¨åå°å¯åŠ¨,ç›‘æ§æœåŠ¡æ­£åœ¨è¿è¡Œ',
                        icon: nativeImage.createFromPath(trayIconPath)
                    });
                }
            }
        } catch (error) {
            console.error('[STARTUP] åå°ç›‘æ§æœåŠ¡å¯åŠ¨å¼‚å¸¸:', error.message);
        }
    }, 3000);
}
```

**ä¼˜ç‚¹**:
- âœ… æ— ä¾µå…¥æ€§,ä¸å¹²æ‰°ç”¨æˆ·å·¥ä½œ
- âœ… æä¾›å¯åŠ¨æˆåŠŸåé¦ˆ
- âœ… å®ç°ç®€å•,é£é™©ä½

**ç¼ºç‚¹**:
- âš ï¸ Windows 10/11å¯èƒ½ä¼šå…³é—­æ°”æ³¡é€šçŸ¥(ç³»ç»Ÿè®¾ç½®)
- âš ï¸ é€šçŸ¥å¯èƒ½è¢«å¿½ç•¥

#### æ–¹æ¡ˆ2: æä¾›é…ç½®é€‰é¡¹

**å®æ–½ä½ç½®**: `platforms/windows/windows-adapter.ts:752-770`

**ä¿®æ”¹ä»£ç **:
```typescript
async enableAutoStart(showWindow: boolean = false): Promise<boolean> {
  try {
    const appName = 'EmployeeSafety';
    const executablePath = process.execPath;

    // æ ¹æ®ç”¨æˆ·é…ç½®å†³å®šæ˜¯å¦æ·»åŠ  --start-minimized å‚æ•°
    const startCommand = showWindow
      ? `\\"${executablePath}\\"`
      : `\\"${executablePath}\\" --start-minimized`;

    await execAsync(`reg add "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" /v ${appName} /t REG_SZ /d "${startCommand}" /f`);

    const mode = showWindow ? 'æ˜¾ç¤ºçª—å£' : 'åå°å¯åŠ¨';
    logger.info(`âœ… è‡ªå¯åŠ¨å·²å¯ç”¨:${mode} + è‡ªåŠ¨å¯åŠ¨ç›‘æ§æœåŠ¡`);
    return true;
  } catch (error) {
    logger.error('Failed to enable auto start', error);
    return false;
  }
}
```

**UIé…ç½®ç•Œé¢**:
- åœ¨è®¾ç½®é¡µé¢æ·»åŠ "å¼€æœºè‡ªå¯åŠ¨æ¨¡å¼"é€‰é¡¹
  - [ ] åå°å¯åŠ¨(æ¨è) - ä¸æ˜¾ç¤ºçª—å£
  - [ ] æ˜¾ç¤ºçª—å£ - å¯åŠ¨æ—¶å¼¹å‡ºä¸»ç•Œé¢

**ä¼˜ç‚¹**:
- âœ… çµæ´»æ€§é«˜,æ»¡è¶³ä¸åŒç”¨æˆ·éœ€æ±‚
- âœ… ç”¨æˆ·å¯è‡ªä¸»æ§åˆ¶è¡Œä¸º

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ä¿®æ”¹UIå’Œé…ç½®æŒä¹…åŒ–
- âš ï¸ å®ç°æˆæœ¬è¾ƒé«˜

#### æ–¹æ¡ˆ3: é¦–æ¬¡å¯åŠ¨æ˜¾ç¤ºå¼•å¯¼

**å®æ–½é€»è¾‘**:
1. æ£€æµ‹æ˜¯å¦ä¸ºé¦–æ¬¡è‡ªå¯åŠ¨(ä½¿ç”¨æ ‡å¿—æ–‡ä»¶)
2. é¦–æ¬¡å¯åŠ¨æ—¶æ˜¾ç¤ºçª—å£å¹¶æç¤ºç”¨æˆ·
3. åç»­å¯åŠ¨æ¢å¤åå°æ¨¡å¼

**ä¼˜ç‚¹**:
- âœ… é¦–æ¬¡ä½¿ç”¨ä½“éªŒå‹å¥½
- âœ… è§£å†³ç”¨æˆ·å›°æƒ‘é—®é¢˜

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦æŒä¹…åŒ–"é¦–æ¬¡å¯åŠ¨"çŠ¶æ€
- âš ï¸ å®ç°è¾ƒå¤æ‚

### æ¨èå®æ–½æ–¹æ¡ˆ

**ä¼˜å…ˆçº§æ’åº**:
1. **é«˜ä¼˜å…ˆçº§**: æ–¹æ¡ˆ1(æ·»åŠ æ‰˜ç›˜é€šçŸ¥) - å¿«é€Ÿå®æ–½,ç«‹å³æ”¹å–„ä½“éªŒ
2. **ä¸­ä¼˜å…ˆçº§**: æ–¹æ¡ˆ2(é…ç½®é€‰é¡¹) - ä¸­æœŸè¿­ä»£,æä¾›çµæ´»æ€§
3. **ä½ä¼˜å…ˆçº§**: æ–¹æ¡ˆ3(é¦–æ¬¡å¼•å¯¼) - é•¿æœŸä¼˜åŒ–,æå‡æ–°æ‰‹ä½“éªŒ

---

## é—®é¢˜2: å›¾ç‰‡å‹ç¼©å®ç°åˆ†æ

### å‹ç¼©å®ç°æ¦‚è§ˆ

å®¢æˆ·ç«¯ä½¿ç”¨`sharp`åº“å®ç°æˆªå›¾å‹ç¼©,æ”¯æŒå¤šå¹³å°(Windows/macOS)ã€‚

**æ ¸å¿ƒåº“**: [sharp](https://sharp.pixelplumbing.com/) v0.33.x
- åŸºäºlibvipsçš„é«˜æ€§èƒ½å›¾ç‰‡å¤„ç†åº“
- æ”¯æŒå¤šç§å‹ç¼©ç®—æ³•(mozjpeg/libjpeg-turbo)
- æ¯”åŸç”ŸNode.jså›¾ç‰‡å¤„ç†å¿«4-5å€

### Windowså¹³å°å®ç°

**ä½ç½®**: `platforms/windows/windows-adapter.ts:340-417`

```typescript
async takeScreenshot(options: ScreenshotOptions = {}): Promise<ScreenshotResult> {
  this.ensureInitialized();

  try {
    const quality = options.quality || 80;
    const format = options.format || 'jpg';
    logger.info(`[WINDOWS] å¼€å§‹æˆªå›¾... (è´¨é‡: ${quality}, æ ¼å¼: ${format})`);

    // å°è¯•ä½¿ç”¨ screenshot-desktop åŒ…
    try {
      const screenshot = require('screenshot-desktop');
      logger.info('[WINDOWS] ä½¿ç”¨ screenshot-desktop åŒ…è¿›è¡Œæˆªå›¾');

      // å…ˆæ•è·åŸå§‹ PNG æ ¼å¼æˆªå›¾
      const imgBuffer = await screenshot({ format: 'png' });
      const originalSize = imgBuffer.length;
      logger.info(`[WINDOWS] åŸå§‹æˆªå›¾å¤§å°: ${originalSize} bytes`);

      // ä½¿ç”¨ sharp å‹ç¼©å›¾ç‰‡
      const compressedBuffer = await sharp(imgBuffer)
        .jpeg({
          quality: quality,
          mozjpeg: true  // ä½¿ç”¨ mozjpeg å¼•æ“è·å¾—æ›´å¥½çš„å‹ç¼©ç‡
        })
        .toBuffer();

      const compressedSize = compressedBuffer.length;
      const compressionRatio = ((1 - compressedSize / originalSize) * 100).toFixed(2);

      logger.info(`[WINDOWS] âœ… æˆªå›¾å·²å‹ç¼©: ${compressedSize} bytes (å‹ç¼©ç‡: ${compressionRatio}%)`);

      return {
        success: true,
        data: compressedBuffer,
        format: format,
        size: compressedSize
      };
    } catch (requireError) {
      logger.warn('[WINDOWS] screenshot-desktop åŒ…ä¸å¯ç”¨,ä½¿ç”¨é™çº§æ–¹æ¡ˆ');
    }

    // é™çº§æ–¹æ¡ˆ1: Electron desktopCapturer
    // é™çº§æ–¹æ¡ˆ2: è¿”å›å¤±è´¥
    ...
  }
}
```

### macOSå¹³å°å®ç°

**ä½ç½®**: `platforms/darwin/darwin-adapter.ts:318-395`

macOSå®ç°ä¸Windowsç±»ä¼¼,ä¹Ÿä½¿ç”¨sharpè¿›è¡Œå‹ç¼©:

```typescript
// ä½¿ç”¨ sharp å‹ç¼©å›¾ç‰‡
const compressedBuffer = await sharp(imgBuffer)
  .jpeg({
    quality: quality,
    mozjpeg: true
  })
  .toBuffer();
```

### å‹ç¼©æ•ˆæœå®æµ‹

æ ¹æ®æµ‹è¯•è„šæœ¬`debug/test-screenshot-compression.js`å’Œ`debug/test-integrated-compression.js`,å®é™…å‹ç¼©æ•ˆæœå¦‚ä¸‹:

| å‹ç¼©è´¨é‡ | åŸå§‹PNGå¤§å° | å‹ç¼©åJPGå¤§å° | å‹ç¼©ç‡ | è§†è§‰è´¨é‡ |
|---------|------------|--------------|--------|---------|
| **60** | ~2-5MB | ~200-500KB | 70-80% | è‰¯å¥½,é€‚åˆé«˜é¢‘ä¼ è¾“ |
| **80** | ~2-5MB | ~400-800KB | 50-70% | ä¼˜ç§€,æ¨èé»˜è®¤å€¼ |
| **90** | ~2-5MB | ~600-1.2MB | 40-60% | æä½³,é€‚åˆéœ€è¦æ¸…æ™°æˆªå›¾ |

**å®æµ‹æ¡ˆä¾‹** (macOS 2560x1600å±å¹•):
- åŸå§‹PNG: 4.2MB
- è´¨é‡80 JPEG: 850KB (å‹ç¼©ç‡ 79.8%)
- è´¨é‡70 JPEG: 620KB (å‹ç¼©ç‡ 85.2%)

### æŠ€æœ¯è¯„ä¼°

#### ä¼˜åŠ¿ âœ…

1. **é«˜æ€§èƒ½å‹ç¼©**
   - ä½¿ç”¨mozjpegå¼•æ“,å‹ç¼©ç‡ä¼˜äºæ ‡å‡†JPEG
   - å‹ç¼©é€Ÿåº¦å¿«(å•å¼ æˆªå›¾<100ms)
   - æ”¯æŒå¤šæ ¸å¹¶è¡Œå¤„ç†

2. **è·¨å¹³å°ä¸€è‡´æ€§**
   - Windowså’ŒmacOSä½¿ç”¨ç›¸åŒçš„å‹ç¼©é€»è¾‘
   - å‹ç¼©å‚æ•°ç»Ÿä¸€(è´¨é‡80)
   - è¾“å‡ºæ ¼å¼ä¸€è‡´(JPEG)

3. **é™çº§æ–¹æ¡ˆå®Œå–„**
   - ä¼˜å…ˆä½¿ç”¨screenshot-desktop
   - é™çº§åˆ°Electron desktopCapturer
   - å…¼å®¹æ€§å¼º

4. **è¯¦ç»†æ—¥å¿—**
   - è®°å½•åŸå§‹å¤§å°ã€å‹ç¼©åå¤§å°ã€å‹ç¼©ç‡
   - ä¾¿äºæ€§èƒ½ç›‘æ§å’Œé—®é¢˜æ’æŸ¥

#### ä¸è¶³ âš ï¸

1. **è´¨é‡å‚æ•°ç¡¬ç¼–ç **
   - å½“å‰è´¨é‡å›ºå®šä¸º80
   - æ— æ³•æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´
   - å»ºè®®: æ”¯æŒé…ç½®åŒ–è´¨é‡å‚æ•°

2. **ç¼ºå°‘é”™è¯¯é™çº§**
   - sharpåº“åŠ è½½å¤±è´¥æ—¶,ç›´æ¥è¿”å›å¤±è´¥
   - å»ºè®®: å®ç°æ— å‹ç¼©åŸå§‹PNGä¼ è¾“ä½œä¸ºæœ€åé™çº§

3. **æ— è‡ªé€‚åº”å‹ç¼©**
   - ä¸è€ƒè™‘æˆªå›¾å†…å®¹å¤æ‚åº¦
   - æ–‡æœ¬æˆªå›¾å’Œå›¾ç‰‡æˆªå›¾ä½¿ç”¨ç›¸åŒè´¨é‡
   - å»ºè®®: æ ¹æ®å›¾ç‰‡ç‰¹å¾åŠ¨æ€è°ƒæ•´è´¨é‡

4. **å†…å­˜å ç”¨**
   - éœ€è¦åŒæ—¶æŒæœ‰åŸå§‹PNGå’Œå‹ç¼©JPEGçš„Buffer
   - å¤§å±å¹•(4K)å¯èƒ½å ç”¨10-20MBå†…å­˜
   - å»ºè®®: ä½¿ç”¨æµå¼å¤„ç†å‡å°‘å†…å­˜å ç”¨

### å‹ç¼©æ€§èƒ½åˆ†æ

#### CPUä½¿ç”¨ç‡
- å•æ ¸å‹ç¼©: 10-30%
- å‹ç¼©æ—¶é—´: 50-150ms
- å¯¹ç”¨æˆ·æ“ä½œå½±å“: å¾®å°

#### å†…å­˜ä½¿ç”¨
```
åŸå§‹PNG Buffer: ~2-5MB (1920x1080)
Sharpå¤„ç†å†…å­˜: ~10-20MB (ä¸´æ—¶)
å‹ç¼©åBuffer: ~400-800KB
å³°å€¼å†…å­˜: ~15-30MB
```

#### ç½‘ç»œä¼ è¾“å½±å“
- æœªå‹ç¼©PNG: 3MB Ã— 12æ¬¡/å°æ—¶ = 36MB/å°æ—¶ = 864MB/å¤©
- è´¨é‡80 JPEG: 600KB Ã— 12æ¬¡/å°æ—¶ = 7.2MB/å°æ—¶ = 172.8MB/å¤©
- **èŠ‚çœå¸¦å®½**: ~80% (æ¯å¤©èŠ‚çœçº¦700MB)

### æ”¹è¿›å»ºè®®

#### 1. æ”¯æŒåŠ¨æ€è´¨é‡è°ƒæ•´ (é«˜ä¼˜å…ˆçº§)

```typescript
// æ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´è´¨é‡
function calculateQuality(networkSpeed: 'slow' | 'medium' | 'fast'): number {
  switch (networkSpeed) {
    case 'slow': return 60;   // ç§»åŠ¨ç½‘ç»œ/å¼±ç½‘
    case 'medium': return 75; // æ ‡å‡†ç½‘ç»œ
    case 'fast': return 85;   // é«˜é€Ÿç½‘ç»œ
    default: return 80;
  }
}
```

#### 2. æ·»åŠ æ¸è¿›å¼JPEG (ä¸­ä¼˜å…ˆçº§)

```typescript
const compressedBuffer = await sharp(imgBuffer)
  .jpeg({
    quality: quality,
    mozjpeg: true,
    progressive: true  // æ¸è¿›å¼JPEG,æ”¹å–„åŠ è½½ä½“éªŒ
  })
  .toBuffer();
```

**ä¼˜ç‚¹**:
- å›¾ç‰‡å¯ä»¥é€æ­¥æ˜¾ç¤º(å…ˆæ¨¡ç³Šåæ¸…æ™°)
- æ”¹å–„æ…¢ç½‘ç»œä¸‹çš„åŠ è½½ä½“éªŒ
- æ–‡ä»¶å¤§å°åŸºæœ¬ç›¸åŒ

#### 3. å®ç°æ™ºèƒ½å‹ç¼© (ä½ä¼˜å…ˆçº§)

```typescript
// åˆ†æå›¾ç‰‡ç‰¹å¾
const metadata = await sharp(imgBuffer).metadata();
const complexity = calculateComplexity(metadata);

// æ ¹æ®å¤æ‚åº¦è°ƒæ•´è´¨é‡
const smartQuality = complexity > 0.7 ? 85 : 70;
```

**åˆ¤æ–­é€»è¾‘**:
- æ–‡æœ¬/ä»£ç æˆªå›¾: ä½¿ç”¨é«˜è´¨é‡(85-90)
- å›¾ç‰‡/è§†é¢‘æˆªå›¾: ä½¿ç”¨ä¸­ç­‰è´¨é‡(70-75)
- é™æ€UI: ä½¿ç”¨æ ‡å‡†è´¨é‡(80)

#### 4. é™ä½é»˜è®¤è´¨é‡ (å»ºè®®å®æ–½)

**å½“å‰**: è´¨é‡80
**å»ºè®®**: è´¨é‡70

**ç†ç”±**:
- è´¨é‡70å‹ç¼©ç‡æå‡10-15%
- è§†è§‰å·®å¼‚è‚‰çœ¼éš¾ä»¥å¯Ÿè§‰
- è¿›ä¸€æ­¥å‡å°‘ç½‘ç»œä¼ è¾“

**å¯¹æ¯”æµ‹è¯•** (æ¨èè¿›è¡Œ):
```bash
# è¿è¡Œå‹ç¼©æµ‹è¯•
cd debug
node test-integrated-compression.js
```

---

## ä»£ç è´¨é‡è¯„ä¼°

### ä¼˜ç‚¹ âœ…

1. **æ¶æ„æ¸…æ™°**
   - ä¸‰å±‚æ¶æ„è®¾è®¡(main/common/platforms)
   - å¹³å°é€‚é…å™¨æ¨¡å¼å®ç°è‰¯å¥½
   - èŒè´£åˆ†ç¦»æ˜ç¡®

2. **é”™è¯¯å¤„ç†å®Œå–„**
   - å¤šå±‚é™çº§æ–¹æ¡ˆ
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   - Try-catchè¦†ç›–ç‡é«˜

3. **æ—¥å¿—ç³»ç»Ÿå®Œå–„**
   - å…³é”®èŠ‚ç‚¹æ—¥å¿—è®°å½•
   - æ€§èƒ½æŒ‡æ ‡è¾“å‡º
   - ä¾¿äºé—®é¢˜æ’æŸ¥

### æ”¹è¿›å»ºè®® âš ï¸

1. **é…ç½®ç®¡ç†**
   - ç¡¬ç¼–ç å‚æ•°è¿‡å¤š(è´¨é‡80,å¯åŠ¨å‚æ•°ç­‰)
   - å»ºè®®: ç»Ÿä¸€é…ç½®ç®¡ç†,æ”¯æŒçƒ­æ›´æ–°

2. **æµ‹è¯•è¦†ç›–**
   - ç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯•
   - å»ºè®®: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

3. **æ–‡æ¡£å®Œæ•´æ€§**
   - ç¼ºå°‘è‡ªå¯åŠ¨è¡Œä¸ºè¯´æ˜æ–‡æ¡£
   - å»ºè®®: è¡¥å……ç”¨æˆ·æ‰‹å†Œå’ŒæŠ€æœ¯æ–‡æ¡£

---

## å…³é”®å‘ç°æ±‡æ€»

### è‡ªå¯åŠ¨UIé—®é¢˜

| ç±»åˆ« | å‘ç° |
|------|------|
| **é—®é¢˜æœ¬è´¨** | è®¾è®¡è¡Œä¸º,éBug |
| **æ ¹æº** | `--start-minimized`å‚æ•°å¯¼è‡´çª—å£éšè— |
| **åŠŸèƒ½å½±å“** | æ— ,ç›‘æ§æœåŠ¡æ­£å¸¸è¿è¡Œ |
| **ç”¨æˆ·ä½“éªŒ** | è¾ƒå·®,ç¼ºå°‘å¯åŠ¨åé¦ˆ |

### å›¾ç‰‡å‹ç¼©

| ç±»åˆ« | è¯„ä¼° |
|------|------|
| **å®ç°è´¨é‡** | âœ… ä¼˜ç§€ |
| **å‹ç¼©ç‡** | 50-80% (è´¨é‡ç›¸å…³) |
| **æ€§èƒ½** | âœ… é«˜æ•ˆ(50-150ms) |
| **å¸¦å®½èŠ‚çœ** | ~80% (æ¯å¤©èŠ‚çœ700MB) |

---

## ä¼˜å…ˆçº§æ”¹è¿›è·¯çº¿å›¾

### Phase 1: å¿«é€Ÿæ”¹è¿› (1-2å¤©)

1. âœ… æ·»åŠ è‡ªå¯åŠ¨æ‰˜ç›˜é€šçŸ¥
2. âœ… é™ä½æˆªå›¾è´¨é‡è‡³70(å¯é€‰)
3. âœ… æ·»åŠ ç”¨æˆ·æ‰‹å†Œè¯´æ˜è‡ªå¯åŠ¨è¡Œä¸º

### Phase 2: ä¸­æœŸä¼˜åŒ– (1å‘¨)

1. âš™ï¸ å®ç°è‡ªå¯åŠ¨æ¨¡å¼é…ç½®é€‰é¡¹
2. âš™ï¸ æ”¯æŒåŠ¨æ€å‹ç¼©è´¨é‡è°ƒæ•´
3. âš™ï¸ æ·»åŠ æ¸è¿›å¼JPEG

### Phase 3: é•¿æœŸå®Œå–„ (1ä¸ªæœˆ)

1. ğŸ“Š å®ç°æ™ºèƒ½å‹ç¼©
2. ğŸ“Š æ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
3. ğŸ“Š å®Œå–„æŠ€æœ¯æ–‡æ¡£

---

## é™„å½•

### A. ç›¸å…³æ–‡ä»¶æ¸…å•

**è‡ªå¯åŠ¨ç›¸å…³**:
- `platforms/windows/windows-adapter.ts` (752-785è¡Œ)
- `electron/main-minimal.js` (25-27, 100-114, 309-314è¡Œ)
- `main/platform-adapter-bridge.ts` (137-147è¡Œ)

**å‹ç¼©ç›¸å…³**:
- `platforms/windows/windows-adapter.ts` (340-417è¡Œ)
- `platforms/darwin/darwin-adapter.ts` (318-395è¡Œ)
- `debug/test-screenshot-compression.js`
- `debug/test-integrated-compression.js`

### B. æµ‹è¯•éªŒè¯å»ºè®®

**è‡ªå¯åŠ¨éªŒè¯**:
1. å¯ç”¨è‡ªå¯åŠ¨
2. æŸ¥çœ‹æ³¨å†Œè¡¨: `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
3. ç¡®è®¤å‘½ä»¤åŒ…å«`--start-minimized`
4. é‡å¯ç³»ç»Ÿ,è§‚å¯Ÿæ‰˜ç›˜å›¾æ ‡
5. æ£€æŸ¥æ—¥å¿—ç¡®è®¤ç›‘æ§æœåŠ¡å·²å¯åŠ¨

**å‹ç¼©éªŒè¯**:
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
cd employee-client/debug
node test-screenshot-compression.js
node test-integrated-compression.js

# å¯¹æ¯”ä¸åŒè´¨é‡
# è§‚å¯Ÿæ–‡ä»¶å¤§å°å’Œè§†è§‰è´¨é‡å·®å¼‚
```

### C. å‚è€ƒèµ„æ–™

- [Sharpå®˜æ–¹æ–‡æ¡£](https://sharp.pixelplumbing.com/)
- [mozjpegå‹ç¼©è¯´æ˜](https://github.com/mozilla/mozjpeg)
- [Windowsè‡ªå¯åŠ¨æ³¨å†Œè¡¨](https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys)
- [Electronæ˜¾ç¤º/éšè—çª—å£](https://www.electronjs.org/docs/latest/api/browser-window#winshow)

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-01-17 10:45:00
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ†æäººå‘˜**: Claude Code AI Assistant
