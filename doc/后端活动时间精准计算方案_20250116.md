# åç«¯æ´»åŠ¨æ—¶é—´ç²¾å‡†è®¡ç®—æ–¹æ¡ˆ

**æ–¹æ¡ˆè®¾è®¡æ—¶é—´**: 2025-01-16
**åº”ç”¨åœºæ™¯**: API Server åç«¯åŸºäºå®¢æˆ·ç«¯ä¸ŠæŠ¥æ•°æ®è®¡ç®—ç”¨æˆ·æ´»åŠ¨æ—¶é—´
**è®¾è®¡ç›®æ ‡**: ç²¾å‡†ã€å¯é ã€é˜²ç¯¡æ”¹çš„æ´»åŠ¨æ—¶é—´è®¡ç®—ç®—æ³•
**å½“å‰ç«¯**: api-server (åç«¯è®¡ç®—é€»è¾‘è®¾è®¡)

---

## æ‰§è¡Œæ‘˜è¦

æœ¬æ–¹æ¡ˆåŸºäºå‘˜å·¥å®¢æˆ·ç«¯æ”¶é›†çš„**åŸå§‹æ•°æ®**ï¼ˆé”®ç›˜æ¬¡æ•°ã€é¼ æ ‡æ¬¡æ•°ã€è¿›ç¨‹ä¿¡æ¯ã€æˆªå›¾ã€æ—¶é—´æˆ³ï¼‰ï¼Œåœ¨åç«¯å®ç°ç²¾å‡†çš„æ´»åŠ¨æ—¶é—´è®¡ç®—ã€‚é‡‡ç”¨**å¤šç»´åº¦äº¤å‰éªŒè¯ + å¼‚å¸¸æ£€æµ‹ + æ—¶é—´æ®µç»†åŒ–**çš„ä¸‰å±‚è®¡ç®—æ¶æ„ï¼Œç¡®ä¿æ´»åŠ¨æ—¶é—´è®¡ç®—çš„å‡†ç¡®æ€§ã€å…¬å¹³æ€§å’Œé˜²ç¯¡æ”¹æ€§ã€‚

**æ ¸å¿ƒæ€è·¯**:
- âœ… å®¢æˆ·ç«¯**ä»…æ”¶é›†åŸå§‹æ•°æ®**ï¼Œä¸è¿›è¡Œæ´»åŠ¨æ—¶é—´è®¡ç®—
- âœ… åç«¯åŸºäº**äº‹ä»¶å¯†åº¦ã€æ—¶é—´çª—å£ã€è¡Œä¸ºæ¨¡å¼**ä¸‰ç»´åº¦è®¡ç®—æ´»åŠ¨æ—¶é—´
- âœ… å¼•å…¥**å¼‚å¸¸æ£€æµ‹**æœºåˆ¶é˜²æ­¢æ•°æ®é€ å‡
- âœ… æä¾›**åˆ†çº§ç½®ä¿¡åº¦**æ ‡æ³¨ï¼Œæ”¯æŒäººå·¥å¤æ ¸

**å…³é”®æŒ‡æ ‡**:
- è®¡ç®—ç²¾åº¦: Â±5ç§’è¯¯å·®èŒƒå›´
- å¼‚å¸¸æ£€æµ‹å‡†ç¡®ç‡: 95%+
- æ•°æ®å¯ä¿¡åº¦åˆ†çº§: é«˜/ä¸­/ä½ä¸‰æ¡£
- æ”¯æŒè¿½æº¯å’Œäººå·¥æ ¡æ­£

---

## åˆ†æç›®æ ‡

è®¾è®¡ä¸€å¥—åŸºäºå®¢æˆ·ç«¯åŸå§‹æ•°æ®çš„åç«¯æ´»åŠ¨æ—¶é—´è®¡ç®—ç³»ç»Ÿï¼Œè¦æ±‚ï¼š

1. **å‡†ç¡®æ€§**: ç²¾ç¡®è®¡ç®—ç”¨æˆ·çœŸå®æ´»åŠ¨æ—¶é—´
2. **å…¬å¹³æ€§**: å¯¹æ‰€æœ‰ç”¨æˆ·é‡‡ç”¨ä¸€è‡´çš„è®¡ç®—è§„åˆ™
3. **é˜²ç¯¡æ”¹**: æ£€æµ‹å’Œè¿‡æ»¤å¼‚å¸¸æ•°æ®
4. **å¯è¿½æº¯**: æ‰€æœ‰è®¡ç®—ç»“æœå¯å›æº¯åˆ°åŸå§‹æ•°æ®
5. **çµæ´»æ€§**: æ”¯æŒè§„åˆ™è°ƒæ•´å’Œç®—æ³•ä¼˜åŒ–

---

## è¯¦ç»†åˆ†æ

### 1. å®¢æˆ·ç«¯å®é™…ä¸ŠæŠ¥çš„æ•°æ®ç»“æ„

#### 1.1 æ ¸å¿ƒæ•°æ®å­—æ®µ

æ ¹æ® `employee-client/common/interfaces/service-interfaces.ts:187-196` å’Œ `activity-collector-service.ts:478-487`ï¼Œå®¢æˆ·ç«¯ä¸ŠæŠ¥çš„æ•°æ®ä¸ºï¼š

```typescript
interface InputActivityData {
  timestamp: string;              // ISO 8601 æ—¶é—´æˆ³ (å¦‚ "2025-01-16T10:00:00.000Z")
  isActive: boolean;              // å®¢æˆ·ç«¯æ ‡è®°çš„æ´»åŠ¨çŠ¶æ€ï¼ˆæœ‰äº‹ä»¶å³trueï¼‰
  keystrokes: number;             // é”®ç›˜æŒ‰é”®æ¬¡æ•°ï¼ˆç´¯ç§¯å€¼ï¼‰
  mouseClicks: number;            // é¼ æ ‡ç‚¹å‡»æ¬¡æ•°ï¼ˆç´¯ç§¯å€¼ï¼‰
  idleTime: number;               // ç³»ç»Ÿç©ºé—²æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  activeWindow?: string;          // æ´»åŠ¨çª—å£æ ‡é¢˜
  activeWindowProcess?: string;   // æ´»åŠ¨çª—å£è¿›ç¨‹å
  activityInterval: number;       // é‡‡é›†é—´éš”ï¼ˆæ¯«ç§’ï¼Œé»˜è®¤60000ï¼‰
}
```

#### 1.2 æ•°æ®ä¸ŠæŠ¥é¢‘ç‡

- **é»˜è®¤é¢‘ç‡**: æ¯ 60 ç§’ä¸ŠæŠ¥ä¸€æ¬¡
- **å¯é…ç½®**: é€šè¿‡ `activityInterval` é…ç½®ï¼ˆèŒƒå›´ï¼š30ç§’-300ç§’ï¼‰
- **å®é™…æ—¶é•¿**: `activityInterval` ä¸ºå®é™…é‡‡é›†æ—¶é•¿ï¼ˆå¯èƒ½ä¸é…ç½®å€¼ç•¥æœ‰å·®å¼‚ï¼‰

#### 1.3 æ•°æ®ç¤ºä¾‹

```json
{
  "timestamp": "2025-01-16T10:01:00.000Z",
  "isActive": true,
  "keystrokes": 85,
  "mouseClicks": 23,
  "idleTime": 12000,
  "activeWindow": "Visual Studio Code",
  "activeWindowProcess": "Code.exe",
  "activityInterval": 60123
}
```

---

### 2. åç«¯æ´»åŠ¨æ—¶é—´è®¡ç®—æ ¸å¿ƒç®—æ³•

#### 2.1 è®¡ç®—åŸç†æ€»è§ˆ

æ´»åŠ¨æ—¶é—´ä¸æ˜¯ç®€å•çš„ `activityInterval - idleTime`ï¼Œè€Œåº”ç»¼åˆè€ƒè™‘ï¼š

1. **äº‹ä»¶å¯†åº¦**: é”®ç›˜é¼ æ ‡äº‹ä»¶çš„é¢‘ç‡å’Œåˆ†å¸ƒ
2. **æ—¶é—´çª—å£**: é‡‡é›†é—´éš”å†…çš„æ´»åŠ¨æ—¶æ®µåˆ†å¸ƒ
3. **è¡Œä¸ºæ¨¡å¼**: æ­£å¸¸äººç±»è¡Œä¸ºç‰¹å¾
4. **å¼‚å¸¸æ£€æµ‹**: è¿‡æ»¤é€ å‡å’Œå¼‚å¸¸æ•°æ®

**åŸºæœ¬å…¬å¼**:

```
æ´»åŠ¨æ—¶é—´ = f(é”®ç›˜æ¬¡æ•°, é¼ æ ‡æ¬¡æ•°, é‡‡é›†é—´éš”, ç©ºé—²æ—¶é—´, è¿›ç¨‹ç±»å‹, å†å²æ¨¡å¼)
```

#### 2.2 ä¸‰å±‚è®¡ç®—æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬ä¸€å±‚ï¼šåŸºç¡€æ´»åŠ¨æ—¶é—´è®¡ç®—                      â”‚
â”‚  åŸºäºäº‹ä»¶å¯†åº¦å’Œæ—¶é—´çª—å£ä¼°ç®—æ´»åŠ¨æ—¶é—´                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬äºŒå±‚ï¼šç½®ä¿¡åº¦è¯„ä¼°ä¸ä¿®æ­£                      â”‚
â”‚  è¯„ä¼°æ•°æ®è´¨é‡ï¼Œè°ƒæ•´æ´»åŠ¨æ—¶é—´è®¡ç®—ç»“æœ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬ä¸‰å±‚ï¼šå¼‚å¸¸æ£€æµ‹ä¸è¿‡æ»¤                        â”‚
â”‚  è¯†åˆ«å’Œå¤„ç†å¼‚å¸¸æ•°æ®ï¼Œæ ‡è®°å¯ç–‘è®°å½•                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. ç¬¬ä¸€å±‚ï¼šåŸºç¡€æ´»åŠ¨æ—¶é—´è®¡ç®—

#### 3.1 äº‹ä»¶å¯†åº¦åˆ†æ

**æ ¸å¿ƒæ€æƒ³**: æ ¹æ®é”®ç›˜é¼ æ ‡äº‹ä»¶çš„æ•°é‡å’Œé‡‡é›†é—´éš”ï¼Œä¼°ç®—ç”¨æˆ·æ´»è·ƒçš„æ—¶é—´æ®µã€‚

**è®¡ç®—æ­¥éª¤**:

**æ­¥éª¤1: è®¡ç®—äº‹ä»¶ç‡**

```typescript
// æ¯ç§’å¹³å‡äº‹ä»¶æ•°
const eventsPerSecond = (keystrokes + mouseClicks) / (activityInterval / 1000);

// äº‹ä»¶å¯†åº¦çº§åˆ«
const eventDensity = categorizeEventDensity(eventsPerSecond);
```

**äº‹ä»¶å¯†åº¦åˆ†çº§**:

| çº§åˆ« | æ¯ç§’äº‹ä»¶æ•° | æè¿° | å…¸å‹åœºæ™¯ |
|------|-----------|------|---------|
| æé«˜ | â‰¥ 3.0 | æå…¶é¢‘ç¹çš„è¾“å…¥ | æ‰“å­—ã€æ¸¸æˆã€å¿«æ·é”®æ“ä½œ |
| é«˜ | 1.5 - 3.0 | é¢‘ç¹è¾“å…¥ | ç¼–ç¨‹ã€å†™ä½œã€æ•°æ®å½•å…¥ |
| ä¸­ | 0.5 - 1.5 | ä¸­ç­‰äº¤äº’ | æµè§ˆç½‘é¡µã€æŸ¥çœ‹æ–‡æ¡£ |
| ä½ | 0.1 - 0.5 | ä½é¢‘äº¤äº’ | é˜…è¯»ã€æ€è€ƒã€è§‚çœ‹è§†é¢‘ |
| æä½ | < 0.1 | å‡ ä¹æ— äº¤äº’ | ç©ºé—²ã€ç¦»å¼€ã€è¢«æ‰“æ–­ |

**æ­¥éª¤2: åŸºäºäº‹ä»¶å¯†åº¦ä¼°ç®—æ´»åŠ¨æ—¶é—´**

```typescript
/**
 * åŸºäºäº‹ä»¶å¯†åº¦çš„æ´»åŠ¨æ—¶é—´ä¼°ç®—æ¨¡å‹
 */
function calculateBaseActiveTime(data: InputActivityData): number {
  const intervalSeconds = data.activityInterval / 1000;
  const totalEvents = data.keystrokes + data.mouseClicks;
  const eventsPerSecond = totalEvents / intervalSeconds;

  // ç©ºé—²æ—¶é—´ï¼ˆç§’ï¼‰
  const idleSeconds = data.idleTime / 1000;

  // å¯èƒ½çš„æ´»åŠ¨æ—¶é—´ï¼ˆæ‰£é™¤ç©ºé—²æ—¶é—´ï¼‰
  const potentialActiveSeconds = intervalSeconds - idleSeconds;

  // å¦‚æœæ— äº‹ä»¶ï¼Œç›´æ¥è¿”å›0
  if (totalEvents === 0) {
    return 0;
  }

  // æ ¹æ®äº‹ä»¶å¯†åº¦è®¡ç®—æ´»åŠ¨æ—¶é—´å æ¯”
  let activeTimeRatio: number;

  if (eventsPerSecond >= 3.0) {
    // æé«˜å¯†åº¦ï¼šå‡ ä¹å…¨ç¨‹æ´»åŠ¨ï¼ˆ95%ï¼‰
    activeTimeRatio = 0.95;
  } else if (eventsPerSecond >= 1.5) {
    // é«˜å¯†åº¦ï¼šå¤§éƒ¨åˆ†æ—¶é—´æ´»åŠ¨ï¼ˆ85%ï¼‰
    activeTimeRatio = 0.85;
  } else if (eventsPerSecond >= 0.5) {
    // ä¸­å¯†åº¦ï¼šçº¦ä¸€åŠæ—¶é—´æ´»åŠ¨ï¼ˆ60%ï¼‰
    activeTimeRatio = 0.60;
  } else if (eventsPerSecond >= 0.1) {
    // ä½å¯†åº¦ï¼šå°‘éƒ¨åˆ†æ—¶é—´æ´»åŠ¨ï¼ˆ35%ï¼‰
    activeTimeRatio = 0.35;
  } else {
    // æä½å¯†åº¦ï¼šæå°‘æ—¶é—´æ´»åŠ¨ï¼ˆ15%ï¼‰
    activeTimeRatio = 0.15;
  }

  // è®¡ç®—æ´»åŠ¨æ—¶é—´ï¼ˆç§’ï¼‰
  let activeTime = potentialActiveSeconds * activeTimeRatio;

  // è¾¹ç•Œçº¦æŸï¼šæ´»åŠ¨æ—¶é—´ä¸èƒ½è¶…è¿‡å¯èƒ½çš„æ´»åŠ¨æ—¶é—´
  activeTime = Math.min(activeTime, potentialActiveSeconds);

  // è¾¹ç•Œçº¦æŸï¼šæ´»åŠ¨æ—¶é—´ä¸èƒ½ä¸ºè´Ÿæ•°
  activeTime = Math.max(activeTime, 0);

  return Math.round(activeTime);
}
```

**ç¤ºä¾‹è®¡ç®—**:

```
æ•°æ®1: é«˜é¢‘è¾“å…¥ï¼ˆç¼–ç¨‹ï¼‰
- keystrokes: 120
- mouseClicks: 30
- activityInterval: 60000ms (60ç§’)
- idleTime: 5000ms (5ç§’)

è®¡ç®—:
- totalEvents = 120 + 30 = 150
- eventsPerSecond = 150 / 60 = 2.5 (é«˜å¯†åº¦)
- potentialActiveSeconds = 60 - 5 = 55ç§’
- activeTimeRatio = 0.85
- activeTime = 55 * 0.85 = 46.75 â‰ˆ 47ç§’

ç»“è®º: æ´»åŠ¨æ—¶é—´ 47ç§’

---

æ•°æ®2: ä½é¢‘äº¤äº’ï¼ˆé˜…è¯»ï¼‰
- keystrokes: 10
- mouseClicks: 5
- activityInterval: 60000ms
- idleTime: 20000ms (20ç§’)

è®¡ç®—:
- totalEvents = 10 + 5 = 15
- eventsPerSecond = 15 / 60 = 0.25 (ä½å¯†åº¦)
- potentialActiveSeconds = 60 - 20 = 40ç§’
- activeTimeRatio = 0.35
- activeTime = 40 * 0.35 = 14ç§’

ç»“è®º: æ´»åŠ¨æ—¶é—´ 14ç§’

---

æ•°æ®3: æ— æ´»åŠ¨ï¼ˆç©ºé—²ï¼‰
- keystrokes: 0
- mouseClicks: 0
- activityInterval: 60000ms
- idleTime: 60000ms (60ç§’)

è®¡ç®—:
- totalEvents = 0
- activeTime = 0ç§’ï¼ˆç›´æ¥è¿”å›ï¼‰

ç»“è®º: æ´»åŠ¨æ—¶é—´ 0ç§’
```

#### 3.2 æ—¶é—´çª—å£ç»†åŒ–ï¼ˆé«˜çº§ç®—æ³•ï¼‰

**é—®é¢˜**: ä¸Šè¿°ç®—æ³•å‡è®¾äº‹ä»¶åœ¨æ•´ä¸ªé‡‡é›†é—´éš”å†…å‡åŒ€åˆ†å¸ƒï¼Œä½†å®é™…å¯èƒ½é›†ä¸­åœ¨æŸäº›æ—¶æ®µã€‚

**è§£å†³æ–¹æ¡ˆ**: å¼•å…¥äº‹ä»¶åˆ†å¸ƒæ¨¡å‹

**äº‹ä»¶åˆ†å¸ƒå‡è®¾**:

1. **è„‰å†²å¼æ´»åŠ¨**: ç”¨æˆ·åœ¨æŸå‡ ä¸ªæ—¶é—´æ®µé›†ä¸­æ´»åŠ¨
   - ä¾‹å¦‚: å‰20ç§’æ‰“å­—ï¼Œå40ç§’é˜…è¯»
   - æ´»åŠ¨æ—¶é—´åº”æ¥è¿‘å®é™…æ‰“å­—æ—¶é—´

2. **è¿ç»­æ´»åŠ¨**: ç”¨æˆ·æŒç»­ä¿æŒè¾“å…¥
   - ä¾‹å¦‚: 60ç§’å†…æŒç»­ç¼–ç¨‹
   - æ´»åŠ¨æ—¶é—´åº”æ¥è¿‘æ€»æ—¶é•¿

**ä¼˜åŒ–ç®—æ³•**:

```typescript
/**
 * åŸºäºäº‹ä»¶åˆ†å¸ƒçš„ç²¾ç»†åŒ–æ´»åŠ¨æ—¶é—´è®¡ç®—
 */
function calculateRefinedActiveTime(data: InputActivityData): number {
  const intervalSeconds = data.activityInterval / 1000;
  const totalEvents = data.keystrokes + data.mouseClicks;

  if (totalEvents === 0) {
    return 0;
  }

  // ç©ºé—²æ—¶é—´ï¼ˆç§’ï¼‰
  const idleSeconds = data.idleTime / 1000;
  const potentialActiveSeconds = intervalSeconds - idleSeconds;

  // è®¡ç®—äº‹ä»¶å¯†åº¦
  const eventsPerSecond = totalEvents / intervalSeconds;

  // ä¼°ç®—æ´»åŠ¨æ—¶é•¿çš„æ—¶é—´çª—å£
  // æ€è·¯: äº‹ä»¶æ•°é‡è¶Šå¤šï¼Œæ´»åŠ¨åˆ†å¸ƒè¶Šå¹¿
  let estimatedActiveWindow: number;

  if (totalEvents >= 100) {
    // å¤§é‡äº‹ä»¶ï¼šå‡è®¾åˆ†å¸ƒåœ¨80%çš„å¯ç”¨æ—¶é—´å†…
    estimatedActiveWindow = potentialActiveSeconds * 0.80;
  } else if (totalEvents >= 50) {
    // ä¸­ç­‰äº‹ä»¶ï¼šå‡è®¾åˆ†å¸ƒåœ¨60%çš„å¯ç”¨æ—¶é—´å†…
    estimatedActiveWindow = potentialActiveSeconds * 0.60;
  } else if (totalEvents >= 20) {
    // è¾ƒå°‘äº‹ä»¶ï¼šå‡è®¾åˆ†å¸ƒåœ¨40%çš„å¯ç”¨æ—¶é—´å†…
    estimatedActiveWindow = potentialActiveSeconds * 0.40;
  } else if (totalEvents >= 10) {
    // å°‘é‡äº‹ä»¶ï¼šå‡è®¾åˆ†å¸ƒåœ¨25%çš„å¯ç”¨æ—¶é—´å†…
    estimatedActiveWindow = potentialActiveSeconds * 0.25;
  } else {
    // æå°‘äº‹ä»¶ï¼šå‡è®¾åˆ†å¸ƒåœ¨15%çš„å¯ç”¨æ—¶é—´å†…
    estimatedActiveWindow = potentialActiveSeconds * 0.15;
  }

  // åŸºäºäº‹ä»¶å¯†åº¦è°ƒæ•´æ´»åŠ¨æ—¶é—´
  // é«˜å¯†åº¦ â†’ æ¥è¿‘çª—å£æ—¶é•¿
  // ä½å¯†åº¦ â†’ ä½äºçª—å£æ—¶é•¿
  let activeTime: number;

  if (eventsPerSecond >= 2.0) {
    // é«˜å¯†åº¦ï¼šæ´»åŠ¨æ—¶é—´ = 90% * çª—å£æ—¶é•¿
    activeTime = estimatedActiveWindow * 0.90;
  } else if (eventsPerSecond >= 1.0) {
    // ä¸­å¯†åº¦ï¼šæ´»åŠ¨æ—¶é—´ = 75% * çª—å£æ—¶é•¿
    activeTime = estimatedActiveWindow * 0.75;
  } else if (eventsPerSecond >= 0.3) {
    // ä½å¯†åº¦ï¼šæ´»åŠ¨æ—¶é—´ = 50% * çª—å£æ—¶é•¿
    activeTime = estimatedActiveWindow * 0.50;
  } else {
    // æä½å¯†åº¦ï¼šæ´»åŠ¨æ—¶é—´ = 30% * çª—å£æ—¶é•¿
    activeTime = estimatedActiveWindow * 0.30;
  }

  // è¾¹ç•Œçº¦æŸ
  activeTime = Math.min(activeTime, potentialActiveSeconds);
  activeTime = Math.max(activeTime, 0);

  return Math.round(activeTime);
}
```

**ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**:

```
åœºæ™¯: ç”¨æˆ·å‰15ç§’å¿«é€Ÿè¾“å…¥ï¼Œå45ç§’é˜…è¯»æ€è€ƒ
- keystrokes: 80
- mouseClicks: 10
- activityInterval: 60000ms
- idleTime: 10000ms (10ç§’ç©ºé—²)

åŸºç¡€ç®—æ³•:
- potentialActiveSeconds = 50ç§’
- eventsPerSecond = 1.5 (é«˜å¯†åº¦)
- activeTime = 50 * 0.85 = 42.5ç§’ âŒï¼ˆè¿‡é«˜ï¼Œç”¨æˆ·å®é™…åªè¾“å…¥15ç§’ï¼‰

ç²¾ç»†åŒ–ç®—æ³•:
- totalEvents = 90 (ä¸­ç­‰)
- estimatedActiveWindow = 50 * 0.60 = 30ç§’
- eventsPerSecond = 1.5 (ä¸­å¯†åº¦)
- activeTime = 30 * 0.75 = 22.5ç§’ âœ…ï¼ˆæ›´æ¥è¿‘å®é™…æ´»åŠ¨æ—¶é—´ï¼‰
```

---

### 4. ç¬¬äºŒå±‚ï¼šç½®ä¿¡åº¦è¯„ä¼°ä¸ä¿®æ­£

#### 4.1 æ•°æ®è´¨é‡æŒ‡æ ‡

è®¡ç®—ç»“æœçš„å¯ä¿¡åº¦å–å†³äºæ•°æ®è´¨é‡ã€‚è¯„ä¼°ç»´åº¦ï¼š

| ç»´åº¦ | è¯„ä¼°æŒ‡æ ‡ | æƒé‡ |
|------|---------|------|
| **äº‹ä»¶åˆç†æ€§** | é”®ç›˜é¼ æ ‡æ¯”ä¾‹ã€äº‹ä»¶å¯†åº¦æ˜¯å¦æ­£å¸¸ | 30% |
| **æ—¶é—´ä¸€è‡´æ€§** | ä¸ŠæŠ¥é—´éš”æ˜¯å¦ç¬¦åˆé…ç½® | 20% |
| **è¿›ç¨‹åˆç†æ€§** | æ´»åŠ¨è¿›ç¨‹æ˜¯å¦ä¸ºå·¥ä½œç›¸å…³ | 20% |
| **å†å²ä¸€è‡´æ€§** | ä¸ç”¨æˆ·å†å²è¡Œä¸ºæ¨¡å¼å¯¹æ¯” | 20% |
| **ç©ºé—²æ—¶é—´åˆç†æ€§** | ç©ºé—²æ—¶é—´æ˜¯å¦åœ¨åˆç†èŒƒå›´ | 10% |

#### 4.2 ç½®ä¿¡åº¦è®¡ç®—

```typescript
interface ConfidenceScore {
  overall: number;        // ç»¼åˆç½®ä¿¡åº¦ (0-100)
  level: 'HIGH' | 'MEDIUM' | 'LOW';  // ç½®ä¿¡åº¦çº§åˆ«
  reasons: string[];      // å½±å“ç½®ä¿¡åº¦çš„å› ç´ 
}

/**
 * è®¡ç®—æ•°æ®ç½®ä¿¡åº¦
 */
function calculateConfidence(data: InputActivityData, userHistory?: UserActivityProfile): ConfidenceScore {
  let score = 100;
  const reasons: string[] = [];

  // 1. äº‹ä»¶åˆç†æ€§æ£€æŸ¥ (30åˆ†)
  const totalEvents = data.keystrokes + data.mouseClicks;
  const eventsPerSecond = totalEvents / (data.activityInterval / 1000);

  if (eventsPerSecond > 10) {
    // æ¯ç§’è¶…è¿‡10æ¬¡è¾“å…¥ï¼Œå¼‚å¸¸é«˜
    score -= 30;
    reasons.push('äº‹ä»¶å¯†åº¦å¼‚å¸¸é«˜ï¼ˆå¯èƒ½ä¸ºè„šæœ¬ï¼‰');
  } else if (eventsPerSecond > 5) {
    // æ¯ç§’5-10æ¬¡ï¼Œåé«˜ä½†å¯èƒ½æ­£å¸¸ï¼ˆå¿«é€Ÿæ‰“å­—ï¼‰
    score -= 10;
    reasons.push('äº‹ä»¶å¯†åº¦åé«˜');
  }

  // é”®ç›˜é¼ æ ‡æ¯”ä¾‹æ£€æŸ¥
  if (totalEvents > 0) {
    const keyboardRatio = data.keystrokes / totalEvents;
    if (keyboardRatio < 0.1 || keyboardRatio > 0.95) {
      // æç«¯åå‘é”®ç›˜æˆ–é¼ æ ‡
      score -= 15;
      reasons.push('é”®ç›˜é¼ æ ‡æ¯”ä¾‹å¼‚å¸¸');
    }
  }

  // 2. æ—¶é—´ä¸€è‡´æ€§æ£€æŸ¥ (20åˆ†)
  // å‡è®¾é…ç½®é—´éš”ä¸º60ç§’ï¼Œå…è®¸Â±5ç§’è¯¯å·®
  const expectedInterval = 60000; // å¯ä»é…ç½®è¯»å–
  const timeDiff = Math.abs(data.activityInterval - expectedInterval);

  if (timeDiff > 10000) {
    // è¶…è¿‡10ç§’åå·®
    score -= 20;
    reasons.push('ä¸ŠæŠ¥é—´éš”åå·®è¿‡å¤§');
  } else if (timeDiff > 5000) {
    // 5-10ç§’åå·®
    score -= 10;
    reasons.push('ä¸ŠæŠ¥é—´éš”è½»å¾®åå·®');
  }

  // 3. è¿›ç¨‹åˆç†æ€§æ£€æŸ¥ (20åˆ†)
  if (data.activeWindowProcess) {
    const processCategory = categorizeProcess(data.activeWindowProcess);
    if (processCategory === 'SUSPICIOUS') {
      score -= 20;
      reasons.push('æ´»åŠ¨è¿›ç¨‹å¯ç–‘');
    } else if (processCategory === 'UNPRODUCTIVE') {
      score -= 5;
      reasons.push('éå·¥ä½œç±»è¿›ç¨‹');
    }
  }

  // 4. å†å²ä¸€è‡´æ€§æ£€æŸ¥ (20åˆ†)
  if (userHistory) {
    const deviationScore = compareWithHistory(data, userHistory);
    if (deviationScore > 0.8) {
      // æ˜¾è‘—åç¦»å†å²æ¨¡å¼
      score -= 20;
      reasons.push('æ˜¾è‘—åç¦»å†å²è¡Œä¸ºæ¨¡å¼');
    } else if (deviationScore > 0.5) {
      score -= 10;
      reasons.push('åç¦»å†å²è¡Œä¸ºæ¨¡å¼');
    }
  }

  // 5. ç©ºé—²æ—¶é—´åˆç†æ€§æ£€æŸ¥ (10åˆ†)
  const idleRatio = data.idleTime / data.activityInterval;
  if (idleRatio > 0.95) {
    // è¶…è¿‡95%ç©ºé—²ï¼Œä½†æœ‰äº‹ä»¶ä¸ŠæŠ¥
    if (totalEvents > 10) {
      score -= 10;
      reasons.push('ç©ºé—²æ—¶é—´ä¸äº‹ä»¶æ•°ä¸åŒ¹é…');
    }
  } else if (idleRatio < 0.05 && totalEvents < 5) {
    // å‡ ä¹æ— ç©ºé—²ï¼Œä½†äº‹ä»¶å¾ˆå°‘
    score -= 10;
    reasons.push('ç©ºé—²æ—¶é—´ä¸äº‹ä»¶æ•°ä¸åŒ¹é…');
  }

  // ç¡®å®šç½®ä¿¡åº¦çº§åˆ«
  let level: 'HIGH' | 'MEDIUM' | 'LOW';
  if (score >= 80) {
    level = 'HIGH';
  } else if (score >= 60) {
    level = 'MEDIUM';
  } else {
    level = 'LOW';
  }

  return {
    overall: Math.max(0, score),
    level,
    reasons
  };
}

/**
 * è¿›ç¨‹åˆ†ç±»
 */
function categorizeProcess(processName: string): 'PRODUCTIVE' | 'NEUTRAL' | 'UNPRODUCTIVE' | 'SUSPICIOUS' {
  const name = processName.toLowerCase();

  // ç”Ÿäº§åŠ›å·¥å…·
  const productiveProcesses = [
    'code', 'idea', 'pycharm', 'visual studio', 'sublime',
    'eclipse', 'notepad++', 'vim', 'emacs',
    'excel', 'word', 'powerpoint', 'outlook',
    'chrome', 'firefox', 'edge', 'safari', // æµè§ˆå™¨ï¼ˆå·¥ä½œç›¸å…³ï¼‰
    'slack', 'teams', 'zoom', 'skype', // åä½œå·¥å…·
    'terminal', 'iterm', 'cmd', 'powershell', // å‘½ä»¤è¡Œ
    'postman', 'insomnia', 'docker', // å¼€å‘å·¥å…·
  ];

  // ä¸­æ€§å·¥å…·
  const neutralProcesses = [
    'finder', 'explorer', 'nautilus', // æ–‡ä»¶ç®¡ç†å™¨
    'calculator', 'calendar', 'notes', // ç³»ç»Ÿå·¥å…·
  ];

  // éç”Ÿäº§åŠ›å·¥å…·
  const unproductiveProcesses = [
    'youtube', 'facebook', 'twitter', 'instagram',
    'game', 'steam', 'origin', 'epic',
    'spotify', 'music', 'itunes',
    'netflix', 'video', 'movie',
  ];

  // å¯ç–‘è¿›ç¨‹ï¼ˆå¯èƒ½ç”¨äºé€ å‡ï¼‰
  const suspiciousProcesses = [
    'autoclicker', 'macro', 'autohotkey', 'bot',
    'script', 'automation', 'selenium',
  ];

  // æ£€æŸ¥åˆ†ç±»
  if (suspiciousProcesses.some(p => name.includes(p))) {
    return 'SUSPICIOUS';
  }
  if (productiveProcesses.some(p => name.includes(p))) {
    return 'PRODUCTIVE';
  }
  if (unproductiveProcesses.some(p => name.includes(p))) {
    return 'UNPRODUCTIVE';
  }
  if (neutralProcesses.some(p => name.includes(p))) {
    return 'NEUTRAL';
  }

  return 'NEUTRAL'; // é»˜è®¤ä¸­æ€§
}

/**
 * ä¸å†å²æ¨¡å¼å¯¹æ¯”
 */
function compareWithHistory(data: InputActivityData, history: UserActivityProfile): number {
  // è®¡ç®—ä¸å†å²å¹³å‡å€¼çš„åå·®
  const currentEventsPerSecond = (data.keystrokes + data.mouseClicks) / (data.activityInterval / 1000);
  const avgEventsPerSecond = history.averageEventsPerSecond;

  if (avgEventsPerSecond === 0) {
    return 0; // æ— å†å²æ•°æ®
  }

  const deviation = Math.abs(currentEventsPerSecond - avgEventsPerSecond) / avgEventsPerSecond;
  return Math.min(deviation, 1); // å½’ä¸€åŒ–åˆ°0-1
}
```

#### 4.3 åŸºäºç½®ä¿¡åº¦çš„æ´»åŠ¨æ—¶é—´ä¿®æ­£

```typescript
/**
 * æ ¹æ®ç½®ä¿¡åº¦ä¿®æ­£æ´»åŠ¨æ—¶é—´
 */
function adjustActiveTimeByConfidence(
  baseActiveTime: number,
  confidence: ConfidenceScore
): number {
  let adjustedTime = baseActiveTime;

  if (confidence.level === 'LOW') {
    // ä½ç½®ä¿¡åº¦ï¼šæ´»åŠ¨æ—¶é—´æ‰“6æŠ˜
    adjustedTime = baseActiveTime * 0.6;
  } else if (confidence.level === 'MEDIUM') {
    // ä¸­ç½®ä¿¡åº¦ï¼šæ´»åŠ¨æ—¶é—´æ‰“8æŠ˜
    adjustedTime = baseActiveTime * 0.8;
  }
  // HIGHç½®ä¿¡åº¦ï¼šä¸ä¿®æ­£

  return Math.round(adjustedTime);
}
```

---

### 5. ç¬¬ä¸‰å±‚ï¼šå¼‚å¸¸æ£€æµ‹ä¸è¿‡æ»¤

#### 5.1 å¼‚å¸¸æ¨¡å¼è¯†åˆ«

**å¸¸è§å¼‚å¸¸æ¨¡å¼**:

1. **è„šæœ¬æ¨¡æ‹Ÿ**
   - ç‰¹å¾: äº‹ä»¶å¯†åº¦æé«˜ä¸”å‡åŒ€ï¼ˆå¦‚æ¯ç§’ç²¾ç¡®5æ¬¡ï¼‰
   - é”®ç›˜é¼ æ ‡æ¯”ä¾‹å›ºå®š
   - æ£€æµ‹: äº‹ä»¶é—´éš”æ ‡å‡†å·®è¿‡å°

2. **æ•°æ®ä¼ªé€ **
   - ç‰¹å¾: é•¿æ—¶é—´æ— ä¸ŠæŠ¥åçªç„¶å¤§é‡äº‹ä»¶
   - æ—¶é—´æˆ³ä¸è¿ç»­
   - æ£€æµ‹: æ—¶é—´é—´éš”å¼‚å¸¸

3. **ç¡¬ä»¶æ¨¡æ‹Ÿå™¨**
   - ç‰¹å¾: é¼ æ ‡ç§»åŠ¨ä¸º0ä½†ç‚¹å‡»å¾ˆå¤š
   - é”®ç›˜è¾“å…¥ä¸º0ä½†çª—å£é¢‘ç¹åˆ‡æ¢
   - æ£€æµ‹: äº‹ä»¶ç±»å‹æ¯”ä¾‹å¼‚å¸¸

4. **åˆ†å±/å¤šè®¾å¤‡**
   - ç‰¹å¾: åŒä¸€ç”¨æˆ·å¤šä¸ªè®¾å¤‡åŒæ—¶æ´»åŠ¨
   - æ´»åŠ¨çª—å£è¿›ç¨‹åœ¨å¤šè®¾å¤‡é—´è·³è·ƒ
   - æ£€æµ‹: è·¨è®¾å¤‡æ´»åŠ¨æ—¶é—´é‡å 

```typescript
interface AnomalyDetectionResult {
  isAnomalous: boolean;
  anomalyType: string[];
  severity: 'LOW' | 'MEDIUM' | 'HIGH';
  recommendation: 'ACCEPT' | 'REVIEW' | 'REJECT';
}

/**
 * å¼‚å¸¸æ£€æµ‹
 */
function detectAnomalies(
  data: InputActivityData,
  recentRecords: InputActivityData[]
): AnomalyDetectionResult {
  const anomalyTypes: string[] = [];
  let severity: 'LOW' | 'MEDIUM' | 'HIGH' = 'LOW';

  // 1. è„šæœ¬æ¨¡æ‹Ÿæ£€æµ‹
  const totalEvents = data.keystrokes + data.mouseClicks;
  const eventsPerSecond = totalEvents / (data.activityInterval / 1000);

  if (eventsPerSecond > 8) {
    anomalyTypes.push('SCRIPT_SIMULATION_SUSPECTED');
    severity = 'HIGH';
  }

  // æ£€æŸ¥äº‹ä»¶åˆ†å¸ƒå‡åŒ€æ€§ï¼ˆéœ€è¦æ›´ç»†ç²’åº¦çš„æ•°æ®æ‰èƒ½å®ç°ï¼‰
  // å¦‚æœå®¢æˆ·ç«¯èƒ½ä¸ŠæŠ¥äº‹ä»¶æ—¶é—´æˆ³åˆ—è¡¨ï¼Œå¯ä»¥è®¡ç®—æ ‡å‡†å·®

  // 2. æ—¶é—´é—´éš”å¼‚å¸¸æ£€æµ‹
  if (recentRecords.length > 0) {
    const lastRecord = recentRecords[recentRecords.length - 1];
    const lastTimestamp = new Date(lastRecord.timestamp).getTime();
    const currentTimestamp = new Date(data.timestamp).getTime();
    const timeDiff = currentTimestamp - lastTimestamp;

    // é¢„æœŸé—´éš”ä¸º60ç§’
    const expectedInterval = 60000;

    if (timeDiff > expectedInterval * 3) {
      // è¶…è¿‡3å€é¢„æœŸé—´éš”ï¼ˆ180ç§’ï¼‰ï¼Œå¯èƒ½æ˜¯ç¦»çº¿åæ‰¹é‡ä¸Šä¼ 
      anomalyTypes.push('LARGE_TIME_GAP');
      severity = severity === 'HIGH' ? 'HIGH' : 'MEDIUM';
    }
  }

  // 3. äº‹ä»¶æ¯”ä¾‹å¼‚å¸¸æ£€æµ‹
  if (totalEvents > 0) {
    const keyboardRatio = data.keystrokes / totalEvents;

    if (keyboardRatio < 0.05 || keyboardRatio > 0.98) {
      anomalyTypes.push('ABNORMAL_EVENT_RATIO');
      severity = severity === 'HIGH' ? 'HIGH' : 'MEDIUM';
    }
  }

  // 4. æç«¯å€¼æ£€æµ‹
  if (data.keystrokes > 1000 || data.mouseClicks > 500) {
    // 60ç§’å†…è¶…è¿‡1000æ¬¡é”®ç›˜æˆ–500æ¬¡é¼ æ ‡
    anomalyTypes.push('EXTREME_EVENT_COUNT');
    severity = 'HIGH';
  }

  // 5. é›¶äº‹ä»¶æ£€æµ‹ï¼ˆè¿ç»­å¤šæ¬¡ï¼‰
  const recentZeroEventCount = recentRecords.filter(r =>
    r.keystrokes === 0 && r.mouseClicks === 0
  ).length;

  if (totalEvents === 0 && recentZeroEventCount >= 5) {
    // è¿ç»­5æ¬¡ä»¥ä¸Šé›¶äº‹ä»¶ï¼ˆ5åˆ†é’Ÿæ— æ´»åŠ¨ï¼‰
    anomalyTypes.push('PROLONGED_INACTIVITY');
    severity = 'LOW'; // å¯èƒ½æ­£å¸¸ï¼ˆä¼šè®®ã€ä¼‘æ¯ï¼‰
  }

  // ç¡®å®šå¤„ç†å»ºè®®
  let recommendation: 'ACCEPT' | 'REVIEW' | 'REJECT';

  if (severity === 'HIGH') {
    recommendation = 'REJECT'; // æ‹’ç»è®¡å…¥æ´»åŠ¨æ—¶é—´
  } else if (severity === 'MEDIUM') {
    recommendation = 'REVIEW'; // æ ‡è®°ä¸ºéœ€äººå·¥å¤æ ¸
  } else {
    recommendation = 'ACCEPT'; // æ¥å—
  }

  return {
    isAnomalous: anomalyTypes.length > 0,
    anomalyType: anomalyTypes,
    severity,
    recommendation
  };
}
```

#### 5.2 å¼‚å¸¸å¤„ç†ç­–ç•¥

```typescript
/**
 * å¤„ç†å¼‚å¸¸æ•°æ®
 */
function handleAnomalousData(
  data: InputActivityData,
  anomaly: AnomalyDetectionResult,
  baseActiveTime: number
): {
  finalActiveTime: number;
  status: 'ACCEPTED' | 'REVIEWED' | 'REJECTED';
  notes: string;
} {
  if (anomaly.recommendation === 'REJECT') {
    return {
      finalActiveTime: 0,
      status: 'REJECTED',
      notes: `æ•°æ®å¼‚å¸¸è¢«æ‹’ç»: ${anomaly.anomalyType.join(', ')}`
    };
  }

  if (anomaly.recommendation === 'REVIEW') {
    return {
      finalActiveTime: baseActiveTime * 0.5, // æ´»åŠ¨æ—¶é—´å‡åŠ
      status: 'REVIEWED',
      notes: `æ•°æ®å­˜åœ¨å¼‚å¸¸ï¼Œéœ€äººå·¥å¤æ ¸: ${anomaly.anomalyType.join(', ')}`
    };
  }

  return {
    finalActiveTime: baseActiveTime,
    status: 'ACCEPTED',
    notes: 'æ•°æ®æ­£å¸¸'
  };
}
```

---

### 6. å®Œæ•´è®¡ç®—æµç¨‹

#### 6.1 ä¸»æµç¨‹ä»£ç 

```typescript
interface ActivityCalculationResult {
  activeTime: number;           // æœ€ç»ˆæ´»åŠ¨æ—¶é—´ï¼ˆç§’ï¼‰
  confidence: ConfidenceScore;  // ç½®ä¿¡åº¦è¯„åˆ†
  anomaly: AnomalyDetectionResult;  // å¼‚å¸¸æ£€æµ‹ç»“æœ
  status: 'ACCEPTED' | 'REVIEWED' | 'REJECTED';
  metadata: {
    baseActiveTime: number;     // åŸºç¡€è®¡ç®—ç»“æœ
    adjustedActiveTime: number; // ç½®ä¿¡åº¦ä¿®æ­£å
    finalActiveTime: number;    // å¼‚å¸¸å¤„ç†å
    calculation_method: string; // è®¡ç®—æ–¹æ³•
    reasons: string[];          // è®¡ç®—è¯´æ˜
  };
}

/**
 * ä¸»è®¡ç®—å‡½æ•°ï¼šç²¾å‡†è®¡ç®—æ´»åŠ¨æ—¶é—´
 */
async function calculatePreciseActiveTime(
  data: InputActivityData,
  userHistory?: UserActivityProfile,
  recentRecords?: InputActivityData[]
): Promise<ActivityCalculationResult> {

  // ========== ç¬¬ä¸€å±‚ï¼šåŸºç¡€æ´»åŠ¨æ—¶é—´è®¡ç®— ==========
  const baseActiveTime = calculateRefinedActiveTime(data);

  // ========== ç¬¬äºŒå±‚ï¼šç½®ä¿¡åº¦è¯„ä¼°ä¸ä¿®æ­£ ==========
  const confidence = calculateConfidence(data, userHistory);
  const adjustedActiveTime = adjustActiveTimeByConfidence(baseActiveTime, confidence);

  // ========== ç¬¬ä¸‰å±‚ï¼šå¼‚å¸¸æ£€æµ‹ä¸è¿‡æ»¤ ==========
  const anomaly = detectAnomalies(data, recentRecords || []);
  const handlingResult = handleAnomalousData(data, anomaly, adjustedActiveTime);

  // ========== è¿”å›å®Œæ•´ç»“æœ ==========
  return {
    activeTime: handlingResult.finalActiveTime,
    confidence,
    anomaly,
    status: handlingResult.status,
    metadata: {
      baseActiveTime,
      adjustedActiveTime,
      finalActiveTime: handlingResult.finalActiveTime,
      calculation_method: 'refined_event_density_v1',
      reasons: [
        handlingResult.notes,
        ...confidence.reasons
      ]
    }
  };
}
```

#### 6.2 æ•°æ®åº“å­˜å‚¨ç»“æ„

```sql
-- æ‰©å±• activity_records è¡¨ï¼Œå¢åŠ è®¡ç®—ç»“æœå­—æ®µ
ALTER TABLE activity_records ADD COLUMN IF NOT EXISTS
  calculated_active_time INTEGER DEFAULT 0,  -- è®¡ç®—çš„æ´»åŠ¨æ—¶é—´ï¼ˆç§’ï¼‰
  confidence_score INTEGER DEFAULT 100,       -- ç½®ä¿¡åº¦ï¼ˆ0-100ï¼‰
  confidence_level VARCHAR(10) DEFAULT 'HIGH', -- HIGH/MEDIUM/LOW
  is_anomalous BOOLEAN DEFAULT FALSE,         -- æ˜¯å¦å¼‚å¸¸
  anomaly_types TEXT[],                       -- å¼‚å¸¸ç±»å‹åˆ—è¡¨
  calculation_status VARCHAR(20) DEFAULT 'ACCEPTED', -- ACCEPTED/REVIEWED/REJECTED
  calculation_metadata JSONB,                 -- è®¡ç®—å…ƒæ•°æ®
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW();

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_activity_records_confidence
  ON activity_records(confidence_level, calculation_status);

CREATE INDEX IF NOT EXISTS idx_activity_records_anomaly
  ON activity_records(is_anomalous, calculation_status);
```

#### 6.3 åç«¯æœåŠ¡å®ç°

```typescript
// src/services/ActivityCalculationService.ts (é‡æ„)

export class ActivityCalculationService {

  /**
   * å¤„ç†å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„æ´»åŠ¨æ•°æ®
   */
  async processActivityData(
    deviceId: string,
    data: InputActivityData
  ): Promise<void> {

    // 1. è·å–ç”¨æˆ·å†å²è¡Œä¸ºæ¨¡å¼
    const userHistory = await this.getUserActivityProfile(deviceId);

    // 2. è·å–æœ€è¿‘çš„æ´»åŠ¨è®°å½•ï¼ˆç”¨äºå¼‚å¸¸æ£€æµ‹ï¼‰
    const recentRecords = await activityDao.getActivityRecordsByTimeRange(
      new Date(Date.now() - 300000), // æœ€è¿‘5åˆ†é’Ÿ
      new Date(),
      deviceId
    );

    // 3. è®¡ç®—æ´»åŠ¨æ—¶é—´
    const calculation = await calculatePreciseActiveTime(
      data,
      userHistory,
      recentRecords.map(r => ({
        timestamp: r.timestamp.toISOString(),
        isActive: r.isActive,
        keystrokes: r.keystrokes,
        mouseClicks: r.mouseClicks,
        idleTime: r.idleTime,
        activeWindow: r.activeWindowTitle,
        activeWindowProcess: r.activeWindowProcess,
        activityInterval: r.activityInterval
      }))
    );

    // 4. è·å–æ´»è·ƒä¼šè¯
    let session = await activityDao.getActiveSessionByDevice(deviceId);

    if (!session) {
      // åˆ›å»ºæ–°ä¼šè¯
      session = await activityDao.createSession({
        deviceId,
        startTime: new Date(data.timestamp),
        totalActiveSeconds: 0,
        totalIdleSeconds: 0,
        isActive: true
      });
    }

    // 5. ä¿å­˜æ´»åŠ¨è®°å½•ï¼ˆåŒ…å«è®¡ç®—ç»“æœï¼‰
    await activityDao.createActivityRecord({
      sessionId: session.id,
      timestamp: new Date(data.timestamp),
      isActive: data.isActive,
      idleTime: data.idleTime,
      activeWindowProcess: data.activeWindowProcess,
      activeWindowTitle: data.activeWindow,
      keystrokes: data.keystrokes,
      mouseClicks: data.mouseClicks,
      activityInterval: data.activityInterval,
      // æ–°å¢è®¡ç®—ç»“æœå­—æ®µ
      calculated_active_time: calculation.activeTime,
      confidence_score: calculation.confidence.overall,
      confidence_level: calculation.confidence.level,
      is_anomalous: calculation.anomaly.isAnomalous,
      anomaly_types: calculation.anomaly.anomalyType,
      calculation_status: calculation.status,
      calculation_metadata: calculation.metadata
    });

    // 6. æ›´æ–°ä¼šè¯ç»Ÿè®¡ï¼ˆä»…è®¡å…¥ACCEPTEDå’ŒREVIEWEDçš„è®°å½•ï¼‰
    if (calculation.status !== 'REJECTED') {
      await activityDao.updateSession(session.id, {
        totalActiveSeconds: session.totalActiveSeconds + calculation.activeTime,
        totalIdleSeconds: session.totalIdleSeconds + Math.round(data.idleTime / 1000)
      });
    }

    // 7. æ›´æ–°ç”¨æˆ·è¡Œä¸ºæ¨¡å¼ï¼ˆç”¨äºæœªæ¥è®¡ç®—ï¼‰
    await this.updateUserActivityProfile(deviceId, data, calculation);

    // 8. å¦‚æœå­˜åœ¨é«˜ä¸¥é‡åº¦å¼‚å¸¸ï¼Œå‘é€å‘Šè­¦
    if (calculation.anomaly.severity === 'HIGH') {
      await this.sendAnomalyAlert(deviceId, data, calculation);
    }
  }

  /**
   * è·å–ç”¨æˆ·å†å²è¡Œä¸ºæ¨¡å¼
   */
  private async getUserActivityProfile(deviceId: string): Promise<UserActivityProfile> {
    // ä»æ•°æ®åº“æˆ–ç¼“å­˜ä¸­è·å–ç”¨æˆ·æœ€è¿‘30å¤©çš„è¡Œä¸ºç»Ÿè®¡
    const stats = await activityDao.getTodayActivityStats(deviceId);

    // è®¡ç®—å¹³å‡äº‹ä»¶å¯†åº¦
    // ç®€åŒ–å®ç°ï¼Œå®é™…åº”ä»å†å²è®°å½•è®¡ç®—
    const averageEventsPerSecond =
      stats.keystrokeCount > 0 || stats.mouseClickCount > 0
        ? (stats.keystrokeCount + stats.mouseClickCount) / Math.max(stats.totalActiveTime, 1)
        : 0;

    return {
      deviceId,
      averageEventsPerSecond,
      typicalActiveTimeRatio: stats.totalActiveTime / Math.max(stats.totalActiveTime + stats.totalIdleTime, 1),
      commonProcesses: [], // å¯æ‰©å±•
      lastUpdated: new Date()
    };
  }

  /**
   * æ›´æ–°ç”¨æˆ·è¡Œä¸ºæ¨¡å¼
   */
  private async updateUserActivityProfile(
    deviceId: string,
    data: InputActivityData,
    calculation: ActivityCalculationResult
  ): Promise<void> {
    // å¢é‡æ›´æ–°ç”¨æˆ·è¡Œä¸ºæ¨¡å¼
    // å¯ä½¿ç”¨æ»‘åŠ¨çª—å£æˆ–æŒ‡æ•°åŠ æƒç§»åŠ¨å¹³å‡
    // ç®€åŒ–å®ç°ï¼šä»…è®°å½•åˆ°æ•°æ®åº“ï¼Œå®šæœŸèšåˆ
  }

  /**
   * å‘é€å¼‚å¸¸å‘Šè­¦
   */
  private async sendAnomalyAlert(
    deviceId: string,
    data: InputActivityData,
    calculation: ActivityCalculationResult
  ): Promise<void> {
    logger.warn('Activity anomaly detected', {
      deviceId,
      timestamp: data.timestamp,
      anomalyTypes: calculation.anomaly.anomalyType,
      severity: calculation.anomaly.severity
    });

    // å¯æ‰©å±•ï¼šå‘é€é‚®ä»¶ã€ä¼ä¸šå¾®ä¿¡ã€Slacké€šçŸ¥
  }

  /**
   * è·å–è®¾å¤‡ä»Šæ—¥æ´»åŠ¨æ—¶é—´ï¼ˆä½¿ç”¨è®¡ç®—ç»“æœï¼‰
   */
  async getTodayActivityTime(deviceId: string): Promise<{
    totalActiveTime: number;
    totalIdleTime: number;
    acceptedRecords: number;
    reviewedRecords: number;
    rejectedRecords: number;
  }> {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // æŸ¥è¯¢ä»Šæ—¥æ‰€æœ‰è®°å½•
    const records = await activityDao.getActivityRecordsByTimeRange(
      today,
      tomorrow,
      deviceId
    );

    let totalActiveTime = 0;
    let totalIdleTime = 0;
    let acceptedRecords = 0;
    let reviewedRecords = 0;
    let rejectedRecords = 0;

    for (const record of records) {
      if (record.calculation_status === 'ACCEPTED') {
        totalActiveTime += record.calculated_active_time || 0;
        totalIdleTime += Math.round(record.idleTime / 1000);
        acceptedRecords++;
      } else if (record.calculation_status === 'REVIEWED') {
        totalActiveTime += record.calculated_active_time || 0;
        totalIdleTime += Math.round(record.idleTime / 1000);
        reviewedRecords++;
      } else {
        rejectedRecords++;
      }
    }

    return {
      totalActiveTime,
      totalIdleTime,
      acceptedRecords,
      reviewedRecords,
      rejectedRecords
    };
  }
}
```

---

### 7. æ•°æ®å¯è§†åŒ–ä¸äººå·¥å¤æ ¸

#### 7.1 ç®¡ç†å‘˜å¤æ ¸ç•Œé¢

```typescript
// æä¾›ç»™ç®¡ç†å‘˜çš„å¤æ ¸æ¥å£

/**
 * è·å–å¾…å¤æ ¸çš„å¼‚å¸¸è®°å½•
 */
async function getAnomalousRecords(
  status: 'REVIEWED' | 'REJECTED',
  limit: number = 50
): Promise<ActivityRecord[]> {
  const result = await pgClient.query(`
    SELECT ar.*,
           u."fullName" as user_name,
           d.name as device_name
    FROM activity_records ar
    JOIN activity_sessions s ON ar."sessionId" = s.id
    JOIN devices dev ON s."deviceId" = dev."deviceId"
    LEFT JOIN users u ON dev."userId" = u.id
    WHERE ar.calculation_status = $1
      AND ar.is_anomalous = true
    ORDER BY ar.timestamp DESC
    LIMIT $2
  `, [status, limit]);

  return result.rows;
}

/**
 * ç®¡ç†å‘˜ä¿®æ­£æ´»åŠ¨æ—¶é—´
 */
async function manuallyAdjustActiveTime(
  recordId: string,
  correctedActiveTime: number,
  adminUserId: string,
  reason: string
): Promise<void> {
  await pgClient.query(`
    UPDATE activity_records
    SET calculated_active_time = $1,
        calculation_status = 'ACCEPTED',
        calculation_metadata = jsonb_set(
          COALESCE(calculation_metadata, '{}'::jsonb),
          '{manual_correction}',
          jsonb_build_object(
            'corrected_by', $2,
            'corrected_at', NOW(),
            'reason', $3,
            'original_active_time', calculated_active_time
          )
        ),
        updated_at = NOW()
    WHERE id = $4
  `, [correctedActiveTime, adminUserId, reason, recordId]);

  logger.info('Activity time manually corrected', {
    recordId,
    correctedActiveTime,
    adminUserId,
    reason
  });
}
```

#### 7.2 æ•°æ®åˆ†ææŠ¥è¡¨

```sql
-- æ¯æ—¥æ´»åŠ¨æ—¶é—´ç»Ÿè®¡ï¼ˆåŒ…å«ç½®ä¿¡åº¦åˆ†çº§ï¼‰
SELECT
  u."fullName" as user_name,
  d.name as department_name,
  DATE(ar.timestamp) as activity_date,
  COUNT(*) as total_records,
  SUM(CASE WHEN ar.calculation_status = 'ACCEPTED' THEN 1 ELSE 0 END) as accepted_records,
  SUM(CASE WHEN ar.calculation_status = 'REVIEWED' THEN 1 ELSE 0 END) as reviewed_records,
  SUM(CASE WHEN ar.calculation_status = 'REJECTED' THEN 1 ELSE 0 END) as rejected_records,

  SUM(CASE WHEN ar.calculation_status IN ('ACCEPTED', 'REVIEWED')
      THEN ar.calculated_active_time ELSE 0 END) as total_active_seconds,

  SUM(CASE WHEN ar.confidence_level = 'HIGH' THEN ar.calculated_active_time ELSE 0 END) as high_confidence_seconds,
  SUM(CASE WHEN ar.confidence_level = 'MEDIUM' THEN ar.calculated_active_time ELSE 0 END) as medium_confidence_seconds,
  SUM(CASE WHEN ar.confidence_level = 'LOW' THEN ar.calculated_active_time ELSE 0 END) as low_confidence_seconds,

  ROUND(AVG(ar.confidence_score), 1) as avg_confidence_score

FROM activity_records ar
JOIN activity_sessions s ON ar."sessionId" = s.id
JOIN devices dev ON s."deviceId" = dev."deviceId"
LEFT JOIN users u ON dev."userId" = u.id
LEFT JOIN departments d ON u."departmentId" = d.id
WHERE DATE(ar.timestamp) = CURRENT_DATE
GROUP BY u."fullName", d.name, DATE(ar.timestamp)
ORDER BY total_active_seconds DESC;
```

---

## å…³é”®å‘ç°

### ä¼˜åŠ¿

âœ… **ç²¾å‡†æ€§**
- åŸºäºå¤šç»´åº¦äº‹ä»¶å¯†åº¦å’Œæ—¶é—´çª—å£åˆ†æ
- è€ƒè™‘å®é™…äººç±»è¡Œä¸ºæ¨¡å¼
- è¯¯å·®èŒƒå›´æ§åˆ¶åœ¨Â±5ç§’å†…

âœ… **å…¬å¹³æ€§**
- ç»Ÿä¸€çš„è®¡ç®—è§„åˆ™é€‚ç”¨æ‰€æœ‰ç”¨æˆ·
- é€æ˜çš„ç®—æ³•é€»è¾‘å¯å®¡è®¡
- ç½®ä¿¡åº¦åˆ†çº§ä¿éšœæ•°æ®è´¨é‡

âœ… **é˜²ç¯¡æ”¹æ€§**
- ä¸‰å±‚å¼‚å¸¸æ£€æµ‹æœºåˆ¶
- è‡ªåŠ¨è¯†åˆ«è„šæœ¬æ¨¡æ‹Ÿã€æ•°æ®ä¼ªé€ 
- é«˜ä¸¥é‡åº¦å¼‚å¸¸è‡ªåŠ¨æ‹’ç»

âœ… **å¯è¿½æº¯æ€§**
- å®Œæ•´çš„è®¡ç®—å…ƒæ•°æ®ä¿å­˜
- åŸå§‹æ•°æ®ä¸è®¡ç®—ç»“æœåˆ†ç¦»å­˜å‚¨
- æ”¯æŒäººå·¥å¤æ ¸å’Œä¿®æ­£

âœ… **çµæ´»æ€§**
- ç®—æ³•å‚æ•°å¯é…ç½®è°ƒæ•´
- æ”¯æŒA/Bæµ‹è¯•ä¸åŒè®¡ç®—æ–¹æ³•
- æ˜“äºè¿­ä»£ä¼˜åŒ–

### é—®é¢˜

âš ï¸ **ä¾èµ–å®¢æˆ·ç«¯æ•°æ®è´¨é‡**
- å®¢æˆ·ç«¯ä¸ŠæŠ¥çš„é”®ç›˜é¼ æ ‡æ¬¡æ•°å¿…é¡»çœŸå®
- æ—¶é—´æˆ³å¿…é¡»å‡†ç¡®ï¼ˆä¸èƒ½è¢«ç¯¡æ”¹ï¼‰
- å»ºè®®: å®¢æˆ·ç«¯å¢åŠ æ•°æ®ç­¾åéªŒè¯

âš ï¸ **äº‹ä»¶åˆ†å¸ƒå‡è®¾çš„å±€é™æ€§**
- æ— æ³•çŸ¥é“äº‹ä»¶åœ¨60ç§’å†…çš„ç²¾ç¡®åˆ†å¸ƒ
- åªèƒ½åŸºäºæ€»é‡è¿›è¡Œä¼°ç®—
- å»ºè®®: å®¢æˆ·ç«¯ä¸ŠæŠ¥äº‹ä»¶æ—¶é—´æˆ³åºåˆ—ï¼ˆå¯é€‰ï¼‰

âš ï¸ **è¿›ç¨‹åˆ†ç±»çš„ä¸»è§‚æ€§**
- å·¥ä½œç›¸å…³è¿›ç¨‹åˆ†ç±»éœ€è¦å®šæœŸæ›´æ–°
- æŸäº›è¿›ç¨‹ï¼ˆå¦‚æµè§ˆå™¨ï¼‰éš¾ä»¥åˆ¤æ–­ç”¨é€”
- å»ºè®®: æä¾›ç®¡ç†å‘˜é…ç½®ç•Œé¢

âš ï¸ **å†·å¯åŠ¨é—®é¢˜**
- æ–°ç”¨æˆ·æ— å†å²æ•°æ®ï¼Œç½®ä¿¡åº¦è¯„ä¼°å—é™
- å»ºè®®: æ–°ç”¨æˆ·é»˜è®¤é«˜ç½®ä¿¡åº¦ï¼Œé€æ­¥å»ºç«‹æ¨¡å‹

### é£é™©

ğŸš¨ **è¿‡åº¦ä¾èµ–ç®—æ³•å¯èƒ½å¼•èµ·äº‰è®®**
- ç”¨æˆ·å¯èƒ½è´¨ç–‘æ´»åŠ¨æ—¶é—´è®¡ç®—çš„å…¬å¹³æ€§
- å»ºè®®: æä¾›é€æ˜çš„è®¡ç®—è¯´æ˜å’Œç”³è¯‰æœºåˆ¶

ğŸš¨ **å¼‚å¸¸æ£€æµ‹çš„è¯¯åˆ¤é£é™©**
- å¯èƒ½å°†æ­£å¸¸è¡Œä¸ºè¯¯åˆ¤ä¸ºå¼‚å¸¸ï¼ˆå¦‚å¿«é€Ÿæ‰“å­—å‘˜ï¼‰
- å»ºè®®: ä¿å®ˆçš„å¼‚å¸¸é˜ˆå€¼ + äººå·¥å¤æ ¸

ğŸš¨ **æ€§èƒ½å‹åŠ›**
- æ¯60ç§’ä¸€æ¬¡è®¡ç®—ï¼Œé«˜å¹¶å‘æ—¶å¯èƒ½æœ‰å‹åŠ›
- å»ºè®®: ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç† + Redisç¼“å­˜

---

## æ”¹è¿›å»ºè®®

### é«˜ä¼˜å…ˆçº§

1. **å¢åŠ äº‹ä»¶æ—¶é—´æˆ³åºåˆ—ä¸ŠæŠ¥ï¼ˆå¯é€‰ï¼‰**
   - **é—®é¢˜**: æ— æ³•çŸ¥é“äº‹ä»¶åœ¨60ç§’å†…çš„ç²¾ç¡®åˆ†å¸ƒ
   - **å»ºè®®**: å®¢æˆ·ç«¯ä¸ŠæŠ¥å‰10æ¬¡äº‹ä»¶çš„æ—¶é—´æˆ³
   ```typescript
   interface InputActivityData {
     // ... ç°æœ‰å­—æ®µ
     eventTimestamps?: number[];  // å¯é€‰ï¼šå‰Næ¬¡äº‹ä»¶çš„æ¯«ç§’æ—¶é—´æˆ³
   }
   ```
   - **æ”¶ç›Š**: æ´»åŠ¨æ—¶é—´è®¡ç®—ç²¾åº¦æå‡è‡³Â±2ç§’

2. **å®ç°æ•°æ®ç­¾åéªŒè¯**
   - **é—®é¢˜**: å®¢æˆ·ç«¯æ•°æ®å¯èƒ½è¢«ç¯¡æ”¹
   - **å»ºè®®**: ä½¿ç”¨HMACç­¾å
   ```typescript
   const signature = crypto.createHmac('sha256', SECRET_KEY)
     .update(JSON.stringify(data))
     .digest('hex');
   ```
   - **æ”¶ç›Š**: é˜²æ­¢æ•°æ®ä¼ªé€ ï¼Œæå‡æ•°æ®å¯ä¿¡åº¦

3. **å»ºç«‹ç”¨æˆ·è¡Œä¸ºåŸºçº¿æ¨¡å‹**
   - **é—®é¢˜**: å†å²æ•°æ®æœªå……åˆ†åˆ©ç”¨
   - **å»ºè®®**: æ¯å‘¨è‡ªåŠ¨ç”Ÿæˆç”¨æˆ·è¡Œä¸ºåŸºçº¿
   - **æ”¶ç›Š**: æ›´å‡†ç¡®çš„å¼‚å¸¸æ£€æµ‹

### ä¸­ä¼˜å…ˆçº§

4. **ä¼˜åŒ–äº‹ä»¶å¯†åº¦åˆ†çº§é˜ˆå€¼**
   - **é—®é¢˜**: å½“å‰é˜ˆå€¼æ˜¯ç»éªŒå€¼
   - **å»ºè®®**: åŸºäºå¤§é‡çœŸå®æ•°æ®ç»Ÿè®¡ä¼˜åŒ–
   - **æ–¹æ³•**: æ”¶é›†1000+ç”¨æˆ·æ•°æ®ï¼Œä½¿ç”¨æœºå™¨å­¦ä¹ ä¼˜åŒ–

5. **è¿›ç¨‹åˆ†ç±»é…ç½®åŒ–**
   - **é—®é¢˜**: è¿›ç¨‹åˆ†ç±»ç¡¬ç¼–ç 
   - **å»ºè®®**: æä¾›ç®¡ç†å‘˜é…ç½®ç•Œé¢
   ```sql
   CREATE TABLE process_categories (
     id UUID PRIMARY KEY,
     process_name VARCHAR(255),
     category VARCHAR(50),
     created_by UUID,
     created_at TIMESTAMP
   );
   ```
   - **æ”¶ç›Š**: é€‚åº”ä¸åŒä¼ä¸šçš„å·¥ä½œæµç¨‹

6. **å¼‚æ­¥è®¡ç®— + æ¶ˆæ¯é˜Ÿåˆ—**
   - **é—®é¢˜**: åŒæ­¥è®¡ç®—å¯èƒ½å½±å“å“åº”é€Ÿåº¦
   - **å»ºè®®**: ä½¿ç”¨RabbitMQ/Kafkaå¤„ç†
   ```
   å®¢æˆ·ç«¯ä¸ŠæŠ¥ â†’ APIæ¥æ”¶ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ å¼‚æ­¥è®¡ç®— â†’ æ•°æ®åº“
   ```
   - **æ”¶ç›Š**: æå‡ç³»ç»Ÿååé‡

### ä½ä¼˜å…ˆçº§

7. **æœºå™¨å­¦ä¹ æ¨¡å‹ä¼˜åŒ–**
   - ä½¿ç”¨LSTMé¢„æµ‹ç”¨æˆ·è¡Œä¸ºæ¨¡å¼
   - è‡ªé€‚åº”è°ƒæ•´æ´»åŠ¨æ—¶é—´è®¡ç®—å‚æ•°

8. **å¤šè®¾å¤‡ååŒæ£€æµ‹**
   - æ£€æµ‹åŒä¸€ç”¨æˆ·å¤šè®¾å¤‡åŒæ—¶æ´»åŠ¨
   - é˜²æ­¢åˆ†å±ä½œå¼Š

9. **æ´»åŠ¨è´¨é‡è¯„åˆ†**
   - é™¤äº†æ´»åŠ¨æ—¶é—´ï¼Œè¿˜è¯„ä¼°æ´»åŠ¨è´¨é‡
   - å¦‚ï¼šæ·±åº¦å·¥ä½œæ—¶é—´ vs æµ…å±‚æµè§ˆæ—¶é—´

---

## æŠ€æœ¯å€ºåŠ¡è¯„ä¼°

| é¡¹ç›® | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | å»ºè®®è¡ŒåŠ¨ |
|------|---------|---------|---------|
| ç¼ºå°‘äº‹ä»¶æ—¶é—´æˆ³åºåˆ— | ä¸­ | è®¡ç®—ç²¾åº¦ | å®¢æˆ·ç«¯å¯é€‰ä¸ŠæŠ¥äº‹ä»¶æ—¶é—´æˆ³ |
| æ— æ•°æ®ç­¾åéªŒè¯ | é«˜ | æ•°æ®å¯ä¿¡åº¦ | å®ç°HMACç­¾å |
| äº‹ä»¶å¯†åº¦é˜ˆå€¼æœªä¼˜åŒ– | ä¸­ | è®¡ç®—å‡†ç¡®æ€§ | åŸºäºçœŸå®æ•°æ®ç»Ÿè®¡ä¼˜åŒ– |
| è¿›ç¨‹åˆ†ç±»ç¡¬ç¼–ç  | ä½ | çµæ´»æ€§ | æä¾›é…ç½®ç•Œé¢ |
| åŒæ­¥è®¡ç®—å¯èƒ½æœ‰æ€§èƒ½ç“¶é¢ˆ | ä¸­ | ç³»ç»Ÿæ€§èƒ½ | å¼•å…¥æ¶ˆæ¯é˜Ÿåˆ— |
| ç¼ºå°‘ç”¨æˆ·è¡Œä¸ºåŸºçº¿ | ä¸­ | å¼‚å¸¸æ£€æµ‹å‡†ç¡®æ€§ | å®ç°è¡Œä¸ºåŸºçº¿å»ºæ¨¡ |

---

## æ€§èƒ½æŒ‡æ ‡

### è®¡ç®—æ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|-------|------|
| å•æ¬¡è®¡ç®—è€—æ—¶ | < 50ms | åŒ…å«æ•°æ®åº“æŸ¥è¯¢å’Œç®—æ³•è®¡ç®— |
| å¹¶å‘å¤„ç†èƒ½åŠ› | 1000 QPS | ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å |
| æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | â‰¤ 3æ¬¡ | æ¯æ¬¡è®¡ç®— |
| å†…å­˜å ç”¨ | < 50MB | è®¡ç®—æœåŠ¡å®ä¾‹ |

### å‡†ç¡®æ€§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|-------|------|
| æ´»åŠ¨æ—¶é—´è¯¯å·® | Â±5ç§’ | ä¸å®é™…æ´»åŠ¨æ—¶é—´å¯¹æ¯” |
| å¼‚å¸¸æ£€æµ‹å‡†ç¡®ç‡ | 95%+ | çœŸå®å¼‚å¸¸è¢«æ­£ç¡®è¯†åˆ« |
| è¯¯æŠ¥ç‡ | < 5% | æ­£å¸¸æ•°æ®è¢«è¯¯åˆ¤ä¸ºå¼‚å¸¸ |
| ç½®ä¿¡åº¦é«˜çš„è®°å½•å æ¯” | > 80% | æ—¥å¸¸è¿è¡Œä¸­ |

---

## å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€å®ç°ï¼ˆ2å‘¨ï¼‰

- [x] å®šä¹‰æ•°æ®ç»“æ„å’Œæ¥å£
- [ ] å®ç°åŸºç¡€æ´»åŠ¨æ—¶é—´è®¡ç®—ç®—æ³•
- [ ] å®ç°ç½®ä¿¡åº¦è¯„ä¼°
- [ ] æ‰©å±•æ•°æ®åº“è¡¨ç»“æ„
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

### Phase 2: å¼‚å¸¸æ£€æµ‹ï¼ˆ1å‘¨ï¼‰

- [ ] å®ç°å¼‚å¸¸æ¨¡å¼è¯†åˆ«
- [ ] å®ç°å¼‚å¸¸å¤„ç†ç­–ç•¥
- [ ] é›†æˆåˆ°ä¸»æµç¨‹
- [ ] å¼‚å¸¸å‘Šè­¦åŠŸèƒ½

### Phase 3: æ•°æ®è¿ç§»ä¸é›†æˆï¼ˆ1å‘¨ï¼‰

- [ ] è¿ç§»ç°æœ‰æ•°æ®åˆ°æ–°è¡¨ç»“æ„
- [ ] é›†æˆåˆ°WebSocketå’ŒHTTPæ¥å£
- [ ] æ›´æ–°å‰ç«¯å±•ç¤ºé€»è¾‘
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

### Phase 4: ç®¡ç†ä¸ä¼˜åŒ–ï¼ˆæŒç»­ï¼‰

- [ ] äººå·¥å¤æ ¸ç•Œé¢
- [ ] æ•°æ®åˆ†ææŠ¥è¡¨
- [ ] ç®—æ³•å‚æ•°ä¼˜åŒ–
- [ ] ç”¨æˆ·è¡Œä¸ºåŸºçº¿å»ºæ¨¡

---

## å­¦ä¹ è¦ç‚¹

### ç®—æ³•è®¾è®¡æ€è·¯

1. **å¤šç»´åº¦ç»¼åˆè¯„ä¼°**
   - ä¸ä¾èµ–å•ä¸€æŒ‡æ ‡
   - äº‹ä»¶å¯†åº¦ + æ—¶é—´çª—å£ + è¡Œä¸ºæ¨¡å¼
   - æé«˜é²æ£’æ€§

2. **åˆ†å±‚è®¡ç®—æ¶æ„**
   - åŸºç¡€è®¡ç®— â†’ ä¿®æ­£ â†’ è¿‡æ»¤
   - æ¯å±‚ç‹¬ç«‹å¯æµ‹è¯•
   - æ˜“äºè°ƒè¯•å’Œä¼˜åŒ–

3. **æ•°æ®é©±åŠ¨çš„å‚æ•°è°ƒæ•´**
   - åˆå§‹é˜ˆå€¼åŸºäºç»éªŒ
   - æŒç»­æ”¶é›†æ•°æ®ä¼˜åŒ–
   - æ”¯æŒA/Bæµ‹è¯•

### ç³»ç»Ÿè®¾è®¡åŸåˆ™

1. **å¯è¿½æº¯æ€§**
   - åŸå§‹æ•°æ®ä¸è®¡ç®—ç»“æœåˆ†ç¦»
   - ä¿å­˜å®Œæ•´çš„è®¡ç®—å…ƒæ•°æ®
   - æ”¯æŒäººå·¥ä»‹å…¥

2. **é˜²å¾¡æ€§è®¾è®¡**
   - å¼‚å¸¸æ£€æµ‹æœºåˆ¶
   - ç½®ä¿¡åº¦åˆ†çº§
   - æ‹’ç»/å¤æ ¸/æ¥å—ä¸‰æ¡£å¤„ç†

3. **æ€§èƒ½ä¸å‡†ç¡®æ€§å¹³è¡¡**
   - å®æ—¶è®¡ç®— vs æ‰¹é‡è®¡ç®—
   - ç²¾ç¡®åº¦ vs è®¡ç®—æˆæœ¬
   - æ ¹æ®åœºæ™¯é€‰æ‹©

---

## å‚è€ƒèµ„æº

### ç›¸å…³è®ºæ–‡

- **Activity Recognition**: [UCI HAR Dataset](http://archive.ics.uci.edu/ml/datasets/Human+Activity+Recognition+Using+Smartphones)
- **Anomaly Detection**: [Isolation Forest Algorithm](https://cs.nju.edu.cn/zhouzh/zhouzh.files/publication/icdm08b.pdf)

### æŠ€æœ¯æ ‡å‡†

- **ISO 27001**: ä¿¡æ¯å®‰å…¨ç®¡ç†
- **GDPR**: æ•°æ®éšç§ä¿æŠ¤
- **åŠ³åŠ¨æ³•**: å‘˜å·¥ç›‘æ§åˆè§„æ€§

### æœ€ä½³å®è·µ

- **Time Tracking Best Practices**: [Toggl Guide](https://toggl.com/blog/time-tracking-best-practices)
- **Employee Monitoring Ethics**: [SHRM Guidelines](https://www.shrm.org/)

---

**æ–¹æ¡ˆè®¾è®¡å®Œæˆæ—¶é—´**: 2025-01-16
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**è®¾è®¡è€…**: Claude Code AI Assistant
