name: Build and Release Employee Monitor

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v2.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '18'  # Must match Electron's internal Node.js version (Electron 28 uses Node 18.18.2)
  ELECTRON_MIRROR: 'https://npmmirror.com/mirrors/electron/'
  ELECTRON_BUILDER_BINARIES_MIRROR: 'https://npmmirror.com/mirrors/electron-builder-binaries/'

jobs:
  # æ„å»ºWindowsåº”ç”¨ï¼ˆä½¿ç”¨ä»£ç åº“ä¸­é¢„ç¼–è¯‘çš„åŸç”Ÿæ¨¡å—ï¼‰
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Clean workspace before checkout
        run: |
          Write-Host "========================================="
          Write-Host "å½»åº•æ¸…ç†å·¥ä½œåŒºï¼ˆé˜²æ­¢runneré‡ç”¨å¯¼è‡´çš„ç¼“å­˜é—®é¢˜ï¼‰"
          Write-Host "========================================="

          # åˆ é™¤æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„æ„å»ºäº§ç‰©
          Write-Host "ğŸ§¹ Cleaning build artifacts..."
          if (Test-Path "dist") {
            Remove-Item "dist" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… dist/ removed"
          }
          if (Test-Path "release") {
            Remove-Item "release" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… release/ removed"
          }
          if (Test-Path "node_modules") {
            Remove-Item "node_modules" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… node_modules/ removed"
          }

          # æ¸…ç†æ‰€æœ‰electron-builderç¼“å­˜
          Write-Host "ğŸ§¹ Cleaning electron-builder caches..."
          if (Test-Path "$env:LOCALAPPDATA\electron-builder") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Global electron-builder cache cleared"
          }

          Write-Host "âœ… Workspace cleaned completely"
          Write-Host "========================================="

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true        # æ¸…ç†untracked files
          force: true        # å¼ºåˆ¶è¦†ç›–æœ¬åœ°ä¿®æ”¹

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Verify Node.js and npm versions
        run: |
          Write-Host "========================================="
          Write-Host "ç¯å¢ƒä¿¡æ¯æ£€æŸ¥"
          Write-Host "========================================="
          Write-Host "Node.js ç‰ˆæœ¬:"
          node --version
          Write-Host ""
          Write-Host "npm ç‰ˆæœ¬:"
          npm --version
          Write-Host ""
          Write-Host "Node.js è·¯å¾„:"
          where.exe node
          Write-Host ""
          Write-Host "npm è·¯å¾„:"
          where.exe npm
          Write-Host ""
          Write-Host "æœŸæœ› Node.js ç‰ˆæœ¬: ${{ env.NODE_VERSION }}"
          Write-Host "========================================="

      - name: Check Electron version and Node.js compatibility
        run: |
          Write-Host "========================================="
          Write-Host "Electron å…¼å®¹æ€§æ£€æŸ¥"
          Write-Host "========================================="

          # è¯»å– package.json ä¸­çš„ Electron ç‰ˆæœ¬
          $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
          $electronVersion = $packageJson.devDependencies.electron
          Write-Host "package.json ä¸­çš„ Electron ç‰ˆæœ¬: $electronVersion"

          # Electron 28 å†…ç½® Node.js 18.18.2 (ABI 108)
          Write-Host ""
          Write-Host "Electron 28 å†…ç½®ä¿¡æ¯:"
          Write-Host "- Node.js: 18.18.2"
          Write-Host "- ABI Version: 108"
          Write-Host "- Chrome: 120"
          Write-Host ""
          Write-Host "å½“å‰ Node.js ç‰ˆæœ¬:"
          node --version
          Write-Host "========================================="

      - name: Install application dependencies (Windows)
        run: |
          echo "ğŸ”„ Installing Windows application dependencies..."

          # æ¸…ç†ç¯å¢ƒå’Œç¼“å­˜ï¼ˆä½†ä¿ç•™åŸç”Ÿæ¨¡å—ï¼‰
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          if (Test-Path "node_modules") { Remove-Item "node_modules" -Recurse -Force }
          # âŒ ä¸è¦åˆ é™¤ native-event-monitor-win/build/ - å®ƒåŒ…å«ä» artifact ä¸‹è½½çš„ç¼–è¯‘å¥½çš„æ¨¡å—
          if (Test-Path "native-event-monitor-win/node_modules") { Remove-Item "native-event-monitor-win/node_modules" -Recurse -Force }
          
          # è®¾ç½® npm é…ç½®ä»¥é¿å…æƒé™é—®é¢˜
          npm config set fund false
          npm config set audit false
          npm config set progress false
          
          # å¼ºåˆ¶æ¸…ç† npm ç¼“å­˜
          npm cache clean --force

          # å…ˆå•ç‹¬å®‰è£… Electronï¼ˆå…è®¸ postinstallï¼‰
          # Read Electron version from package.json
          $electronVersion = (Get-Content "package.json" -Raw | ConvertFrom-Json).devDependencies.electron
          echo "ğŸ“¦ Installing Electron $electronVersion (allow postinstall)..."
          npm install "electron@$electronVersion" --legacy-peer-deps

          # éªŒè¯ Electron å®‰è£…
          if (Test-Path "node_modules/electron/dist/electron.exe") {
            Write-Host "âœ… Electron installed successfully"
          } else {
            Write-Host "âŒ Electron installation failed"
            exit 1
          }

          # å®‰è£…å…¶ä»–ä¾èµ–åŒ…æ‹¬ devDependenciesï¼ˆæ„å»ºéœ€è¦ï¼‰
          # ä½¿ç”¨ --ignore-scripts é˜»æ­¢ä»»ä½•è‡ªåŠ¨æ„å»ºè„šæœ¬è¦†ç›–æˆ‘ä»¬çš„åŸç”Ÿæ¨¡å—
          echo "ğŸ“¦ Installing other dependencies (block auto-build)..."
          npm install --production=false --legacy-peer-deps --ignore-scripts
          
          # éªŒè¯å…³é”®æ„å»ºä¾èµ–
          echo "ğŸ” Verifying critical build dependencies..."
          $criticalDeps = @("electron-builder", "@electron/packager", "typescript")
          foreach ($dep in $criticalDeps) {
            if (-not (Test-Path "node_modules/$dep")) {
              echo "âŒ Critical dependency missing: $dep"
              echo "ğŸ”§ Attempting individual install..."
              npm install $dep --legacy-peer-deps --ignore-scripts
            } else {
              echo "âœ… $dep is installed"
            }
          }

          # Electron å·²ç»å•ç‹¬å®‰è£…ï¼Œå†æ¬¡éªŒè¯
          if (Test-Path "node_modules/electron") {
            echo "âœ… electron is installed"
          } else {
            echo "âŒ electron missing - this should not happen"
            exit 1
          }
          
          echo "âœ… Dependencies installation completed"

          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "ğŸ“‹ Final dependency status:"
          npm list --depth=0 2>$null | Out-String | Write-Host

      - name: Precompile Windows Native Module for Electron 28
        run: |
          Write-Host "========================================="
          Write-Host "é¢„ç¼–è¯‘ Windows åŸç”Ÿæ¨¡å— for Electron 28"
          Write-Host "========================================="
          Write-Host ""

          # ğŸ”´ æ­¥éª¤1: æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
          Write-Host "ğŸ§¹ Step 1: Cleaning old native module build..."
          if (Test-Path "native-event-monitor-win\build") {
            Remove-Item "native-event-monitor-win\build" -Recurse -Force
            Start-Sleep -Seconds 1
            Write-Host "   âœ… Removed old build/"
          } else {
            Write-Host "   â„¹ï¸  No existing build/ (clean slate)"
          }

          # ğŸ”´ æ­¥éª¤2: å®‰è£…åŸç”Ÿæ¨¡å—çš„ä¾èµ–
          Write-Host ""
          Write-Host "ğŸ“¦ Step 2: Installing native module dependencies..."
          cd native-event-monitor-win
          npm install
          cd ..
          Write-Host "   âœ… Dependencies installed"

          # ğŸ”´ æ­¥éª¤3: ä½¿ç”¨ node-gyp é…åˆ Electron å¤´æ–‡ä»¶ç¼–è¯‘
          Write-Host ""
          Write-Host "ğŸ”¨ Step 3: Compiling with node-gyp for Electron 28..."
          Write-Host "   Target: Electron 28.2.10 (Node.js ABI 108)"
          Write-Host "   This will take 5-10 minutes for C++ compilation..."
          Write-Host ""

          cd native-event-monitor-win

          # è·å– Electron ç‰ˆæœ¬
          $electronVersion = (Get-Content "..\package.json" -Raw | ConvertFrom-Json).devDependencies.electron
          $electronVersion = $electronVersion -replace '\^', ''
          Write-Host "   Electron version: $electronVersion"

          # è®¾ç½®ç¯å¢ƒå˜é‡æŒ‡å‘ Electron
          $env:npm_config_target = $electronVersion
          $env:npm_config_arch = "x64"
          $env:npm_config_target_arch = "x64"
          $env:npm_config_disturl = "https://electronjs.org/headers"
          $env:npm_config_runtime = "electron"
          $env:npm_config_build_from_source = "true"

          Write-Host "   Environment variables set:"
          Write-Host "   - target: $env:npm_config_target"
          Write-Host "   - runtime: electron"
          Write-Host "   - disturl: https://electronjs.org/headers"
          Write-Host ""

          # æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒ
          Write-Host ""
          Write-Host "   Checking build environment..."
          Write-Host "   Python:"
          python --version 2>&1 | Write-Host
          Write-Host "   MSBuild:"
          where.exe msbuild 2>&1 | Write-Host
          Write-Host ""

          # ä½¿ç”¨ node-gyp ç¼–è¯‘ï¼ˆè¯¦ç»†è¾“å‡ºï¼‰
          Write-Host "   Running: node-gyp rebuild --verbose"
          npx node-gyp rebuild --verbose 2>&1 | Tee-Object -Variable gypOutput | Write-Host

          cd ..

          Write-Host ""
          Write-Host "ğŸ” Checking if compilation actually ran..."
          if ($gypOutput -match "cl\.exe|link\.exe|Creating library") {
            Write-Host "   âœ… C++ compiler (cl.exe) was invoked - compilation happened!"
          } else {
            Write-Host "   âŒ WARNING: No C++ compilation detected in output!"
            Write-Host "   This means node-gyp skipped compilation for some reason"
          }

          # ğŸ”´ æ­¥éª¤4: éªŒè¯ç¼–è¯‘ç»“æœ
          Write-Host ""
          Write-Host "ğŸ” Step 4: Verifying compilation result..."

          $modulePath = "native-event-monitor-win\build\Release\event_monitor.node"
          if (-not (Test-Path $modulePath)) {
            Write-Host ""
            Write-Host "âŒ CRITICAL: Native module not found!"
            Write-Host "   Expected: $modulePath"
            Write-Host ""
            Write-Host "Checking build directory:"
            if (Test-Path "native-event-monitor-win\build") {
              Get-ChildItem "native-event-monitor-win\build" -Recurse | Format-Table Name, Length, LastWriteTime
            } else {
              Write-Host "   âŒ build/ doesn't exist - node-gyp failed!"
            }
            exit 1
          }

          # éªŒè¯æ–‡ä»¶æ—¶é—´æˆ³
          $module = Get-Item $modulePath
          $ageMinutes = ((Get-Date) - $module.LastWriteTime).TotalMinutes

          Write-Host ""
          Write-Host "âœ… Native module compiled successfully!"
          Write-Host "   Path: $($module.FullName)"
          Write-Host "   Size: $([math]::Round($module.Length / 1KB, 2)) KB"
          Write-Host "   Created: $($module.LastWriteTime)"
          Write-Host "   Age: $([math]::Round($ageMinutes, 2)) minutes"
          Write-Host ""

          if ($ageMinutes -gt 15) {
            Write-Host "âŒ WARNING: Module is too old (> 15 min)"
            exit 1
          }

          Write-Host "âœ… Precompilation complete - ready for TypeScript build"
          Write-Host "========================================="

      - name: Update package version from git tag
        run: |
          # ä» git tag æå–ç‰ˆæœ¬å·
          if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
            $VERSION = $matches[1]
            Write-Host "ğŸ“Œ Extracted version from tag: $VERSION"

            # æ›´æ–° package.json çš„ç‰ˆæœ¬å·
            $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
            $packageJson.version = $VERSION
            $packageJson | ConvertTo-Json -Depth 100 | Set-Content "package.json"

            Write-Host "âœ… Updated package.json version to: $VERSION"
            Write-Host ""
            Write-Host "éªŒè¯ package.json:"
            Get-Content "package.json" | Select-String '"version"'
          } else {
            Write-Host "âš ï¸ Not a tag push, using package.json version"
          }

      - name: Build TypeScript
        run: |
          Write-Host "========================================="
          Write-Host "å®Œæ•´æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œæ„å»ºäº§ç‰©"
          Write-Host "========================================="

          # 1. æ¸…ç† dist ç›®å½•ï¼ˆåŒé‡ç¡®ä¿ï¼‰
          Write-Host "ğŸ§¹ Cleaning dist directory..."
          if (Test-Path "dist") {
            Remove-Item "dist" -Recurse -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2  # ç­‰å¾…æ–‡ä»¶ç³»ç»Ÿå®Œæˆåˆ é™¤
          }
          npm run clean  # å†æ¬¡ç¡®ä¿æ¸…ç†

          # 2. æ¸…ç†æ‰€æœ‰ electron-builder ç¼“å­˜ä½ç½®ï¼ˆåŒ…æ‹¬NSISç›¸å…³ï¼‰
          Write-Host "ğŸ§¹ Cleaning all electron-builder caches (including NSIS)..."

          # å…¨å±€ç¼“å­˜
          if (Test-Path "$env:LOCALAPPDATA\electron-builder") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Global electron-builder cache cleared"
          }

          # electronç¼“å­˜
          if (Test-Path "$env:LOCALAPPDATA\electron") {
            Remove-Item "$env:LOCALAPPDATA\electron" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Electron cache cleared"
          }

          # Tempç›®å½•ä¸­çš„electron-builderç¼“å­˜
          if (Test-Path "$env:TEMP\electron-builder-*") {
            Remove-Item "$env:TEMP\electron-builder-*" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Temp cache cleared"
          }

          # é¡¹ç›®ç¼“å­˜
          if (Test-Path "node_modules\.cache\electron-builder") {
            Remove-Item "node_modules\.cache\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Project cache cleared"
          }

          # NSISç‰¹å®šç¼“å­˜
          if (Test-Path "$env:LOCALAPPDATA\electron-builder\Cache\nsis") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder\Cache\nsis" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… NSIS cache cleared"
          }

          # 3. æ¸…ç† release ç›®å½•
          Write-Host "ğŸ§¹ Cleaning release directory..."
          if (Test-Path "release") {
            Remove-Item "release" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… release directory cleared"
          }

          # 4. éªŒè¯æ¸…ç†ç»“æœ
          Write-Host "ğŸ” Verifying cleanup..."
          if (Test-Path "dist") {
            Write-Host "âŒ CRITICAL: dist still exists after cleanup!"
            exit 1
          }
          Write-Host "   âœ… dist directory confirmed deleted"

          # 5. ç¼–è¯‘ TypeScript
          Write-Host "ğŸ”¨ Compiling TypeScript..."
          npm run compile

          # 6. éªŒè¯ç¼–è¯‘ç»“æœ
          Write-Host "ğŸ” Verifying compilation..."
          $adapterPath = "dist/platforms/windows/windows-adapter.js"
          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ CRITICAL: WindowsAdapter not compiled!"
            exit 1
          }
          Write-Host "   âœ… WindowsAdapter compiled successfully"

          Write-Host "âœ… Build preparation complete"
          Write-Host "========================================="

      - name: Verify compiled WindowsAdapter has getActiveURL
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯ç¼–è¯‘åçš„ WindowsAdapter"
          Write-Host "========================================="

          $adapterPath = "dist/platforms/windows/windows-adapter.js"

          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ WindowsAdapter not found at: $adapterPath"
            exit 1
          }

          $content = Get-Content $adapterPath -Raw

          # æ£€æŸ¥æ˜¯å¦åŒ…å« getActiveURL æ–¹æ³•
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ… getActiveURL method found in compiled WindowsAdapter"
          } else {
            Write-Host "âŒ getActiveURL method NOT found in compiled WindowsAdapter"
            Write-Host "ğŸš¨ CRITICAL: Old code was compiled! Build must fail!"
            exit 1
          }

          # æ£€æŸ¥ VERSION æ ‡è¯†
          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            $version = $matches[1]
            Write-Host "âœ… WindowsAdapter VERSION: $version"

            if ($version -match "1\.0\.6[0-9]") {
              Write-Host "âœ… Version identifier looks correct"
            } else {
              Write-Host "âš ï¸ Version identifier unexpected: $version"
            }
          } else {
            Write-Host "âš ï¸ VERSION identifier not found (might be minified)"
          }

          Write-Host "========================================="

      - name: Final verification before packaging
        run: |
          Write-Host "========================================="
          Write-Host "æ‰“åŒ…å‰æœ€ç»ˆéªŒè¯"
          Write-Host "========================================="

          # éªŒè¯åŸç”Ÿæ¨¡å—ä»ç„¶å­˜åœ¨
          if (Test-Path "native-event-monitor-win/build/Release/event_monitor.node") {
            $module = Get-Item "native-event-monitor-win/build/Release/event_monitor.node"
            $hash = (Get-FileHash $module.FullName -Algorithm SHA256).Hash.Substring(0,8)
            $lastModified = $module.LastWriteTime

            Write-Host "âœ… åŸç”Ÿæ¨¡å—éªŒè¯é€šè¿‡"
            Write-Host "   æ–‡ä»¶è·¯å¾„: $($module.FullName)"
            Write-Host "   æ–‡ä»¶å¤§å°: $([math]::Round($module.Length / 1KB, 2)) KB"
            Write-Host "   SHA256å“ˆå¸Œ: $hash"
            Write-Host "   æœ€åä¿®æ”¹: $lastModified"

            # å°è¯•æ£€æµ‹ ABI ç‰ˆæœ¬ï¼ˆé€šè¿‡æ–‡ä»¶å†…å®¹ç‰¹å¾ï¼‰
            Write-Host ""
            Write-Host "ğŸ” å°è¯•æ£€æµ‹ NODE_MODULE_VERSION..."
            try {
              # è¯»å–æ–‡ä»¶çš„å‰ 1KB å¯»æ‰¾ NODE_MODULE_VERSION å­—ç¬¦ä¸²
              $bytes = [System.IO.File]::ReadAllBytes($module.FullName)
              $content = [System.Text.Encoding]::ASCII.GetString($bytes)

              if ($content -match "node_module_version.(\d+)") {
                Write-Host "   æ£€æµ‹åˆ° NODE_MODULE_VERSION: $($matches[1])"
                if ($matches[1] -eq "108") {
                  Write-Host "   âœ… æ­£ç¡®ï¼ABI 108 åŒ¹é… Electron 28"
                } else {
                  Write-Host "   âŒ é”™è¯¯ï¼ABI $($matches[1]) ä¸åŒ¹é… Electron 28 (åº”è¯¥æ˜¯ 108)"
                  Write-Host "   ğŸš¨ è¿™ä¸ªæ–‡ä»¶å¯èƒ½æ˜¯ç”¨é”™è¯¯çš„å·¥å…·ç¼–è¯‘çš„ï¼"
                }
              } else {
                Write-Host "   âš ï¸ æ— æ³•ä»æ–‡ä»¶ä¸­æå– NODE_MODULE_VERSION"
              }
            } catch {
              Write-Host "   âš ï¸ ABI ç‰ˆæœ¬æ£€æµ‹å¤±è´¥: $($_.Exception.Message)"
            }

            Write-Host ""
            Write-Host "âš ï¸  æ­¤æ–‡ä»¶å°†è¢« electron-builder æ‰“åŒ…åˆ°æœ€ç»ˆ exe ä¸­"
            Write-Host "   å¦‚æœæœ€åä¿®æ”¹æ—¶é—´å¤ªæ–°ï¼Œå¯èƒ½æ˜¯è¢«æ„å¤–é‡æ–°ç¼–è¯‘äº†ï¼"
          } else {
            Write-Host "âŒ ä¸¥é‡é”™è¯¯: åŸç”Ÿæ¨¡å—æ–‡ä»¶ä¸¢å¤±ï¼"
            Write-Host "   é¢„æœŸä½ç½®: native-event-monitor-win/build/Release/event_monitor.node"
            Write-Host "   electron-builder å°†æ— æ³•æ‰“åŒ…æ­£ç¡®çš„æ–‡ä»¶"
            exit 1
          }

          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯ç–‘çš„ .node æ–‡ä»¶
          Write-Host ""
          Write-Host "æ£€æŸ¥å…¶ä»– .node æ–‡ä»¶:"
          Get-ChildItem -Path "." -Filter "*.node" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "   æ‰¾åˆ°: $($_.FullName) ($([math]::Round($_.Length / 1KB, 2)) KB)"
          }

          Write-Host "========================================="

      - name: Verify dist directory before packaging (CRITICAL)
        run: |
          Write-Host "========================================="
          Write-Host "æ‰“åŒ…å‰éªŒè¯distç›®å½•å†…å®¹ï¼ˆé˜²æ­¢æ‰“åŒ…æ—§ä»£ç ï¼‰"
          Write-Host "========================================="

          $adapterPath = "dist/platforms/windows/windows-adapter.js"

          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ WindowsAdapter not found at: $adapterPath"
            exit 1
          }

          $content = Get-Content $adapterPath -Raw

          Write-Host "ğŸ” Checking dist/platforms/windows/windows-adapter.js..."
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ… getActiveURL found in dist/ (pre-packaging)"
          } else {
            Write-Host "âŒ CRITICAL: getActiveURL NOT found in dist/ before packaging!"
            Write-Host "This means TypeScript compilation failed or produced wrong output!"
            exit 1
          }

          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            Write-Host "âœ… VERSION in dist/: $($matches[1])"
          }

          Write-Host "âœ… dist/ directory verification passed"

          # è®¡ç®—dist/WindowsAdapterçš„hashä½œä¸ºå‚è€ƒ
          $hash = (Get-FileHash $adapterPath -Algorithm SHA256).Hash
          Write-Host "ğŸ“‹ dist/WindowsAdapter SHA256: $hash"
          Write-Host "This hash will be compared with packaged version"

          Write-Host "========================================="

      - name: Create application bundle
        run: |
          npm run pack:win
        env:
          # ä¸è®¾ç½®GH_TOKENï¼Œç¦ç”¨electron-builderè‡ªåŠ¨å‘å¸ƒ
          # Releaseç”±åç»­çš„create-release jobç»Ÿä¸€å¤„ç†
          CSC_IDENTITY_AUTO_DISCOVERY: false
          # å®Œå…¨ç¦ç”¨electron-builderç¼“å­˜
          ELECTRON_BUILDER_CACHE: "${{ runner.temp }}/eb-cache-disabled"
          USE_HARD_LINKS: "false"

      - name: Debug release directory structure
        run: |
          Write-Host "========================================="
          Write-Host "è°ƒè¯•: æ£€æŸ¥ release ç›®å½•ç»“æ„"
          Write-Host "========================================="

          if (Test-Path "release/win-unpacked") {
            Write-Host "ğŸ“ release/win-unpacked å­˜åœ¨"
            Write-Host ""
            Write-Host "ğŸ“‚ èµ„æºç›®å½•ç»“æ„:"
            Get-ChildItem "release/win-unpacked/resources" -Recurse | Select-Object -First 50 | Format-Table Name, FullName

            Write-Host ""
            Write-Host "ğŸ“‚ æŸ¥æ‰¾æ‰€æœ‰ .node æ–‡ä»¶:"
            Get-ChildItem "release/win-unpacked" -Recurse -Filter "*.node" | Format-Table Name, FullName, Length

            Write-Host ""
            Write-Host "ğŸ“‚ æ£€æŸ¥ app.asar.unpacked å†…å®¹:"
            if (Test-Path "release/win-unpacked/resources/app.asar.unpacked") {
              Get-ChildItem "release/win-unpacked/resources/app.asar.unpacked" -Recurse | Select-Object -First 100 | Format-Table Name, FullName
            } else {
              Write-Host "âŒ app.asar.unpacked ä¸å­˜åœ¨ï¼"
            }
          } else {
            Write-Host "âŒ release/win-unpacked ä¸å­˜åœ¨"
          }
          Write-Host "========================================="

      - name: Verify packaged native module (CRITICAL)
        continue-on-error: true
        id: verify-native
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯æ‰“åŒ…åçš„åŸç”Ÿæ¨¡å—ï¼ˆå…³é”®æ­¥éª¤ï¼‰"
          Write-Host "========================================="

          # æ£€æŸ¥ win-unpacked ç›®å½•ï¼ˆelectron-builder çš„è§£å‹ç‰ˆæœ¬ï¼‰
          $unpackedPath = "release/win-unpacked/resources/app.asar.unpacked/native-event-monitor-win/build/Release/event_monitor.node"

          if (Test-Path $unpackedPath) {
            $packedModule = Get-Item $unpackedPath
            $packedHash = (Get-FileHash $packedModule.FullName -Algorithm SHA256).Hash.Substring(0,8)

            Write-Host "âœ… åœ¨å®‰è£…åŒ…ä¸­æ‰¾åˆ°åŸç”Ÿæ¨¡å—"
            Write-Host "   è·¯å¾„: $unpackedPath"
            Write-Host "   å¤§å°: $([math]::Round($packedModule.Length / 1KB, 2)) KB"
            Write-Host "   SHA256: $packedHash"
            Write-Host ""

            # æ£€æµ‹æ‰“åŒ…æ–‡ä»¶çš„ ABI ç‰ˆæœ¬
            Write-Host "ğŸ” æ£€æµ‹æ‰“åŒ…æ–‡ä»¶çš„ NODE_MODULE_VERSION..."
            try {
              $bytes = [System.IO.File]::ReadAllBytes($packedModule.FullName)
              $content = [System.Text.Encoding]::ASCII.GetString($bytes)

              if ($content -match "node_module_version.(\d+)") {
                Write-Host "   æ‰“åŒ…æ–‡ä»¶çš„ NODE_MODULE_VERSION: $($matches[1])"
                if ($matches[1] -eq "108") {
                  Write-Host "   âœ…âœ…âœ… å®Œç¾ï¼æ‰“åŒ…çš„æ˜¯ ABI 108ï¼ˆæ­£ç¡®ï¼‰"
                } else {
                  Write-Host "   âŒâŒâŒ ä¸¥é‡é”™è¯¯ï¼æ‰“åŒ…çš„æ˜¯ ABI $($matches[1])ï¼Œåº”è¯¥æ˜¯ 108"
                  Write-Host "   ğŸš¨ ç”¨æˆ·å°†æ”¶åˆ° NODE_MODULE_VERSION é”™è¯¯ï¼"
                  exit 1
                }
              }
            } catch {
              Write-Host "   âš ï¸ æ— æ³•æ£€æµ‹ ABI: $($_.Exception.Message)"
            }
          } else {
            Write-Host "âŒ æœªåœ¨å®‰è£…åŒ…ä¸­æ‰¾åˆ°åŸç”Ÿæ¨¡å—"
            Write-Host "   é¢„æœŸè·¯å¾„: $unpackedPath"
            Write-Host ""
            Write-Host "âš ï¸ ç»§ç»­æ‰§è¡Œä»¥æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯..."
          }

          Write-Host "========================================="

      - name: Verify NSIS installer contains getActiveURL (CRITICAL)
        continue-on-error: true
        id: verify-nsis
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯NSISå®‰è£…åŒ…ä¸­çš„WindowsAdapterï¼ˆå…³é”®æ­¥éª¤ï¼‰"
          Write-Host "========================================="

          # æ£€æŸ¥ release ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "release")) {
            Write-Host "âŒ release ç›®å½•ä¸å­˜åœ¨ï¼"
            Write-Host "   è¿™æ„å‘³ç€ electron-builder æ‰“åŒ…å¤±è´¥"
            Write-Host "   è¯·æ£€æŸ¥å‰é¢çš„ 'Create application bundle' æ­¥éª¤"
            exit 1
          }

          # å®‰è£…å¿…è¦å·¥å…·
          Write-Host "ğŸ“¦ Installing tools..."
          npm install -g asar
          choco install 7zip -y --no-progress

          # æ‰¾åˆ°NSIS .exeå®‰è£…åŒ…
          $exePath = Get-ChildItem "release" -Filter "*.exe" | Where-Object { $_.Name -match "Setup" } | Select-Object -First 1

          if (-not $exePath) {
            Write-Host "âŒ NSIS installer not found!"
            Write-Host "ğŸ“‚ release ç›®å½•å†…å®¹:"
            Get-ChildItem "release" | Format-Table Name, Length
            exit 1
          }

          Write-Host "ğŸ“¦ Found installer: $($exePath.FullName)"
          Write-Host "   Size: $([math]::Round($exePath.Length / 1MB, 2)) MB"

          # ä½¿ç”¨7zipè§£å‹NSISå®‰è£…åŒ…
          Write-Host "ğŸ“‚ Extracting NSIS installer..."
          & "C:\Program Files\7-Zip\7z.exe" x $exePath.FullName -o"temp-nsis-extracted" -y | Out-Null

          # NSISå°†åº”ç”¨æ‰“åŒ…ä¸ºapp-64.7zï¼Œéœ€è¦å…ˆè§£å‹
          Write-Host "ğŸ” Searching for app-64.7z in extracted installer..."
          $app7z = Get-ChildItem "temp-nsis-extracted" -Recurse -Filter "app-64.7z" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $app7z) {
            Write-Host "âŒ app-64.7z not found in NSIS installer!"
            Write-Host "Extracted structure:"
            Get-ChildItem "temp-nsis-extracted" -Recurse | Format-Table
            Remove-Item "temp-nsis-extracted" -Recurse -Force
            exit 1
          }

          Write-Host "âœ… Found app-64.7z: $($app7z.FullName)"
          Write-Host "   Size: $([math]::Round($app7z.Length / 1MB, 2)) MB"

          # è§£å‹app-64.7z
          Write-Host "ğŸ“‚ Extracting app-64.7z..."
          & "C:\Program Files\7-Zip\7z.exe" x $app7z.FullName -o"temp-app-extracted" -y | Out-Null

          # ç°åœ¨æŸ¥æ‰¾app.asar
          Write-Host "ğŸ” Searching for app.asar in extracted app-64.7z..."
          $asarFiles = Get-ChildItem "temp-app-extracted" -Recurse -Filter "app.asar" -ErrorAction SilentlyContinue

          if ($asarFiles.Count -eq 0) {
            Write-Host "âŒ app.asar not found in app-64.7z!"
            Write-Host "Extracted app-64.7z structure:"
            Get-ChildItem "temp-app-extracted" -Recurse | Select-Object -First 20 | Format-Table
            Remove-Item "temp-nsis-extracted" -Recurse -Force
            Remove-Item "temp-app-extracted" -Recurse -Force
            exit 1
          }

          Write-Host "âœ… Found $($asarFiles.Count) app.asar file(s) in app-64.7z"

          # éªŒè¯ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„app.asar
          $asarPath = $asarFiles[0].FullName
          Write-Host "ğŸ“‚ Extracting app.asar from app-64.7z..."
          asar extract $asarPath temp-installer-asar-extracted

          # æ£€æŸ¥WindowsAdapter
          $extractedAdapter = "temp-installer-asar-extracted/dist/platforms/windows/windows-adapter.js"
          if (-not (Test-Path $extractedAdapter)) {
            Write-Host "âŒ WindowsAdapter not found at: $extractedAdapter"
            Write-Host "Available files:"
            Get-ChildItem "temp-installer-asar-extracted" -Recurse | Select-Object -First 20 | Format-Table
            Remove-Item "temp-nsis-extracted" -Recurse -Force
            Remove-Item "temp-installer-asar-extracted" -Recurse -Force
            exit 1
          }

          $content = Get-Content $extractedAdapter -Raw

          Write-Host ""
          Write-Host "ğŸ” Checking for getActiveURL method in NSIS installer..."
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ…âœ…âœ… SUCCESS: getActiveURL method found in NSIS installer!"
          } else {
            Write-Host "âŒâŒâŒ CRITICAL FAILURE: getActiveURL NOT found in NSIS installer!"
            Write-Host "ğŸš¨ This means the .exe installer contains OLD CODE!"
            Write-Host "ğŸš¨ Users who download this will receive broken version!"
            Write-Host ""
            Write-Host "File preview (first 500 chars):"
            Write-Host $content.Substring(0, [Math]::Min(500, $content.Length))
            Write-Host ""
            Write-Host "ğŸ” Comparing with win-unpacked version..."

            # å¯¹æ¯”win-unpackedç‰ˆæœ¬
            $unpackedAdapter = "release/win-unpacked/dist/platforms/windows/windows-adapter.js"
            if (Test-Path $unpackedAdapter) {
              $unpackedContent = Get-Content $unpackedAdapter -Raw
              if ($unpackedContent -match "getActiveURL\s*\(") {
                Write-Host "âš ï¸ win-unpacked has getActiveURL but NSIS installer does NOT!"
                Write-Host "ğŸš¨ This confirms electron-builder NSIS packaging is using cached/old files!"
              }
            }

            # æ¸…ç†å¹¶é€€å‡º
            Remove-Item "temp-nsis-extracted" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "temp-app-extracted" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "temp-installer-asar-extracted" -Recurse -Force -ErrorAction SilentlyContinue
            exit 1
          }

          # æ£€æŸ¥VERSIONæ ‡è¯†
          Write-Host ""
          Write-Host "ğŸ” Checking VERSION identifier in NSIS installer..."
          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            $version = $matches[1]
            Write-Host "âœ… NSIS installer VERSION: $version"

            if ($version -match "1\.0\.6[0-9]-with-getActiveURL") {
              Write-Host "âœ…âœ…âœ… PERFECT: Version identifier is correct!"
            } else {
              Write-Host "âš ï¸ WARNING: Version identifier unexpected: $version"
            }
          } else {
            Write-Host "âš ï¸ VERSION identifier not found (code might be minified)"
          }

          Write-Host ""
          Write-Host "âœ… NSIS installer content verification PASSED"
          Write-Host "âœ… Users will receive correct code!"

          # è®¡ç®—NSISä¸­WindowsAdapterçš„hashå¹¶å¯¹æ¯”
          Write-Host ""
          Write-Host "ğŸ“‹ Computing hash for verification..."
          $nsisAdapterHash = (Get-FileHash $extractedAdapter -Algorithm SHA256).Hash
          Write-Host "NSIS installer WindowsAdapter SHA256: $nsisAdapterHash"

          # å¯¹æ¯”åŸå§‹dist/ä¸­çš„hash
          $origAdapter = "dist/platforms/windows/windows-adapter.js"
          if (Test-Path $origAdapter) {
            $origHash = (Get-FileHash $origAdapter -Algorithm SHA256).Hash
            Write-Host "Original dist/ WindowsAdapter SHA256:  $origHash"

            if ($nsisAdapterHash -eq $origHash) {
              Write-Host "âœ…âœ…âœ… PERFECT: Hashes match! NSIS contains same file as dist/"
            } else {
              Write-Host "âŒâŒâŒ CRITICAL: Hash mismatch!"
              Write-Host "ğŸš¨ NSIS installer contains DIFFERENT WindowsAdapter than dist/!"
              Write-Host "ğŸš¨ This proves electron-builder is using cached/old files!"
              Remove-Item "temp-nsis-extracted" -Recurse -Force -ErrorAction SilentlyContinue
              Remove-Item "temp-app-extracted" -Recurse -Force -ErrorAction SilentlyContinue
              Remove-Item "temp-installer-asar-extracted" -Recurse -Force -ErrorAction SilentlyContinue
              exit 1
            }
          }

          # æ¸…ç†æå–çš„æ–‡ä»¶
          Remove-Item "temp-nsis-extracted" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "temp-app-extracted" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "temp-installer-asar-extracted" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "ğŸ§¹ Cleanup complete"

          Write-Host "========================================="

      - name: List build outputs
        run: |
          Write-Host "Build outputs:"
          if (Test-Path "release") {
            Get-ChildItem -Path "release" -Recurse | ForEach-Object {
              $relativePath = $_.FullName.Replace((Get-Location).Path + "\release\", "")
              if ($_.PSIsContainer) {
                Write-Host "  ğŸ“ $relativePath"
              } else {
                $sizeMB = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  ğŸ“„ $relativePath ($sizeMB MB)"
              }
            }
          } else {
            Write-Host "âŒ Release directory not found"
            Get-ChildItem -Path "." -Name
          }

      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            release/*.exe
            release/*.msi
            release/*.zip
          retention-days: 1
          if-no-files-found: error

  # æ„å»ºLinuxåº”ç”¨
  build-linux:
    name: Build Linux Application
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Linux build dependencies
        run: |
          echo "========================================="
          echo "å®‰è£… Linux æ„å»ºä¾èµ–"
          echo "========================================="
          sudo apt-get update
          sudo apt-get install -y \
            libinput-dev \
            libudev-dev \
            libx11-dev \
            libxtst-dev \
            libxi-dev \
            libxkbcommon-dev \
            build-essential \
            python3 \
            pkg-config \
            rpm \
            fakeroot

          echo "âœ… Linux dependencies installed"

      - name: Verify environment
        run: |
          echo "========================================="
          echo "ç¯å¢ƒä¿¡æ¯æ£€æŸ¥"
          echo "========================================="
          echo "Node.js ç‰ˆæœ¬:"
          node --version
          echo ""
          echo "npm ç‰ˆæœ¬:"
          npm --version
          echo ""
          echo "ç³»ç»Ÿä¿¡æ¯:"
          uname -a
          echo ""
          echo "GCC ç‰ˆæœ¬:"
          gcc --version | head -1
          echo ""
          echo "Python ç‰ˆæœ¬:"
          python3 --version
          echo "========================================="

      - name: Pre-download Electron binary
        run: |
          echo "ğŸ“¥ Pre-downloading Electron binary from mirror..."

          ELECTRON_VERSION="28.2.10"
          ELECTRON_CACHE_DIR="$HOME/.cache/electron"
          ELECTRON_ZIP="electron-v${ELECTRON_VERSION}-linux-x64.zip"
          MIRROR_URL="https://npmmirror.com/mirrors/electron/v${ELECTRON_VERSION}/${ELECTRON_ZIP}"

          # åˆ›å»ºç¼“å­˜ç›®å½•
          mkdir -p "$ELECTRON_CACHE_DIR"

          # ä¸‹è½½ Electron
          echo "Downloading from: $MIRROR_URL"
          curl -L -o "$ELECTRON_CACHE_DIR/$ELECTRON_ZIP" "$MIRROR_URL"

          # éªŒè¯ä¸‹è½½
          if [ -f "$ELECTRON_CACHE_DIR/$ELECTRON_ZIP" ]; then
            ls -lh "$ELECTRON_CACHE_DIR/$ELECTRON_ZIP"
            echo "âœ… Electron binary downloaded successfully"
          else
            echo "âŒ Failed to download Electron binary"
            exit 1
          fi

          # åˆ›å»º SHASUMS256.txtï¼ˆelectron å®‰è£…è„šæœ¬éœ€è¦ï¼‰
          cd "$ELECTRON_CACHE_DIR"
          sha256sum "$ELECTRON_ZIP" > "SHASUMS256.txt-${ELECTRON_VERSION}"
          cat "SHASUMS256.txt-${ELECTRON_VERSION}"

      - name: Install application dependencies
        env:
          ELECTRON_SKIP_BINARY_DOWNLOAD: 0
        run: |
          echo "ğŸ”„ Installing application dependencies..."

          # è®¾ç½® electron ç¼“å­˜è·¯å¾„
          export electron_config_cache="$HOME/.cache/electron"
          export ELECTRON_CACHE="$HOME/.cache/electron"

          # æ¸…ç†ç¯å¢ƒ
          rm -rf node_modules package-lock.json
          rm -rf native-event-monitor-linux/node_modules

          # npm é…ç½®
          npm config set fund false
          npm config set audit false
          npm config set progress false

          # æ¸…ç† npm ç¼“å­˜ï¼ˆä½†ä¸æ¸…ç† electron ç¼“å­˜ï¼‰
          npm cache clean --force

          # å®‰è£…ä¾èµ–
          npm install --production=false --legacy-peer-deps

          echo "âœ… Dependencies installation completed"

      - name: Build native Linux module
        run: |
          echo "========================================="
          echo "æ„å»º Linux åŸç”Ÿæ¨¡å—"
          echo "========================================="

          cd native-event-monitor-linux

          # å®‰è£…åŸç”Ÿæ¨¡å—ä¾èµ–
          echo "ğŸ“¦ Installing native module dependencies..."
          npm install

          # æ„å»ºåŸç”Ÿæ¨¡å—
          echo "ğŸ”¨ Building native module..."
          npm run build:native || npm run build || node-gyp rebuild

          # æ„å»º TypeScript
          echo "ğŸ“ Compiling TypeScript..."
          npm run build:ts || npx tsc

          # éªŒè¯æ„å»ºç»“æœ
          if [ -f "build/Release/linux_event_monitor.node" ]; then
            echo "âœ… åŸç”Ÿæ¨¡å—ç¼–è¯‘æˆåŠŸ"
            ls -la build/Release/linux_event_monitor.node
          else
            echo "âŒ åŸç”Ÿæ¨¡å—ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

          cd ..
          echo "========================================="

      - name: Rebuild native module for Electron
        run: |
          echo "========================================="
          echo "ä¸º Electron é‡æ–°ç¼–è¯‘åŸç”Ÿæ¨¡å—"
          echo "========================================="

          cd native-event-monitor-linux

          # ä½¿ç”¨ electron-rebuild ç¡®ä¿ ABI å…¼å®¹
          npx electron-rebuild --version=28.2.10 --force || true

          # éªŒè¯
          if [ -f "build/Release/linux_event_monitor.node" ]; then
            echo "âœ… åŸç”Ÿæ¨¡å— Electron å…¼å®¹ç¼–è¯‘æˆåŠŸ"
            ls -la build/Release/linux_event_monitor.node
          fi

          cd ..
          echo "========================================="

      - name: Update package version from git tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "ğŸ“Œ Extracted version from tag: $VERSION"

            # æ›´æ–° package.json ç‰ˆæœ¬å·
            npm version $VERSION --no-git-tag-version --allow-same-version

            echo "âœ… Updated package.json version to: $VERSION"
          else
            echo "âš ï¸ Not a tag push, using package.json version"
          fi

      - name: Build TypeScript
        run: |
          npm run compile

      - name: Build Linux packages (x64)
        run: |
          echo "========================================="
          echo "æ„å»º Linux å®‰è£…åŒ… (x64)"
          echo "========================================="

          # æ„å»º AppImage (x64)
          echo "ğŸ“¦ Building AppImage (x64)..."
          npx electron-builder --linux AppImage --x64

          # æ„å»º DEB åŒ…
          echo "ğŸ“¦ Building DEB package (x64)..."
          npx electron-builder --linux deb --x64

          echo "========================================="
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          ELECTRON_MIRROR: 'https://npmmirror.com/mirrors/electron/'
          ELECTRON_BUILDER_BINARIES_MIRROR: 'https://npmmirror.com/mirrors/electron-builder-binaries/'

      - name: Setup QEMU for ARM64 cross-compilation
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Install ARM64 cross-compilation toolchain
        run: |
          echo "ğŸ“¦ Installing ARM64 cross-compilation toolchain..."
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

          # å®‰è£… ARM64 å¼€å‘åº“ï¼ˆç”¨äºåŸç”Ÿæ¨¡å—äº¤å‰ç¼–è¯‘ï¼‰
          # æ³¨æ„ï¼šè¿™äº›åº“å¯èƒ½ä¸å¯ç”¨ï¼Œæ‰€ä»¥ä½¿ç”¨ || true
          sudo apt-get install -y libinput-dev:arm64 libudev-dev:arm64 || {
            echo "âš ï¸ ARM64 å¼€å‘åº“å®‰è£…å¤±è´¥ï¼ŒåŸç”Ÿæ¨¡å—å¯èƒ½æ— æ³•äº¤å‰ç¼–è¯‘"
          }

          # éªŒè¯å·¥å…·é“¾
          aarch64-linux-gnu-gcc --version || echo "ARM64 GCC not found"
          aarch64-linux-gnu-g++ --version || echo "ARM64 G++ not found"

          echo "âœ… ARM64 toolchain installed"

      - name: Install ARM64 native dependencies
        run: |
          echo "ğŸ“¦ Installing ARM64 native dependencies..."

          # å¼ºåˆ¶å®‰è£… sharp ARM64 ç‰ˆæœ¬åŠå…¶æ‰€æœ‰ä¾èµ–
          npm uninstall sharp 2>/dev/null || true

          # å®‰è£… sharp ARM64 é¢„ç¼–è¯‘åŒ…ï¼ˆåŒ…å« libvipsï¼‰
          npm install --force --cpu=arm64 --os=linux @img/sharp-linux-arm64
          npm install --force --cpu=arm64 --os=linux @img/sharp-libvips-linux-arm64
          npm install --force --cpu=arm64 --os=linux sharp

          # éªŒè¯å®‰è£…
          echo "ğŸ“‹ Checking sharp installation..."
          ls -la node_modules/@img/ 2>/dev/null || echo "No @img modules"
          ls -la node_modules/sharp/build/ 2>/dev/null || echo "No sharp build"

          echo "âœ… ARM64 dependencies installed"

      - name: Build native Linux module for ARM64
        run: |
          echo "========================================="
          echo "äº¤å‰ç¼–è¯‘ Linux åŸç”Ÿæ¨¡å— (ARM64)"
          echo "========================================="

          cd native-event-monitor-linux

          # æ¸…ç†ä¹‹å‰çš„ x64 æ„å»º
          rm -rf build node_modules

          # å®‰è£…ä¾èµ–
          npm install

          # ä½¿ç”¨ node-gyp äº¤å‰ç¼–è¯‘ ARM64
          # æ³¨æ„ï¼šè¿™éœ€è¦ ARM64 å·¥å…·é“¾ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨é¢„ç¼–è¯‘äºŒè¿›åˆ¶
          echo "ğŸ”¨ Cross-compiling native module for ARM64..."

          # å°è¯•ä½¿ç”¨ prebuildify æˆ–ç›´æ¥äº¤å‰ç¼–è¯‘
          if command -v aarch64-linux-gnu-gcc &> /dev/null; then
            echo "ä½¿ç”¨ ARM64 å·¥å…·é“¾è¿›è¡Œäº¤å‰ç¼–è¯‘..."
            CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++ \
            npm_config_arch=arm64 \
            npm_config_target_arch=arm64 \
            node-gyp rebuild --arch=arm64 || {
              echo "âš ï¸ ARM64 äº¤å‰ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ QEMU..."
            }
          fi

          # å¦‚æœäº¤å‰ç¼–è¯‘å¤±è´¥ï¼Œè·³è¿‡åŸç”Ÿæ¨¡å—ï¼ˆé”®ç›˜/é¼ æ ‡ç›‘æ§å°†ä¸å¯ç”¨ï¼‰
          if [ -f "build/Release/linux_event_monitor.node" ]; then
            echo "âœ… ARM64 åŸç”Ÿæ¨¡å—ç¼–è¯‘æˆåŠŸ"
            ls -la build/Release/linux_event_monitor.node
            file build/Release/linux_event_monitor.node
          else
            echo "âš ï¸ ARM64 åŸç”Ÿæ¨¡å—ç¼–è¯‘å¤±è´¥ - é”®ç›˜/é¼ æ ‡ç›‘æ§å°†ä¸å¯ç”¨"
            echo "âš ï¸ è¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºï¼Œå› ä¸ºäº¤å‰ç¼–è¯‘åŸç”Ÿæ¨¡å—æ¯”è¾ƒå¤æ‚"
            echo "âš ï¸ ç”¨æˆ·å¯ä»¥åœ¨ ARM64 è®¾å¤‡ä¸Šæ‰‹åŠ¨ç¼–è¯‘åŸç”Ÿæ¨¡å—"

            # åˆ›å»ºå ä½ç›®å½•
            mkdir -p build/Release
            touch build/Release/.placeholder
          fi

          cd ..
          echo "========================================="

      - name: Build Linux packages (ARM64)
        run: |
          echo "========================================="
          echo "æ„å»º Linux å®‰è£…åŒ… (ARM64)"
          echo "========================================="

          # æ„å»º AppImage (arm64) - ä½¿ç”¨ electron-builder çš„äº¤å‰ç¼–è¯‘åŠŸèƒ½
          echo "ğŸ“¦ Building AppImage (arm64)..."
          npx electron-builder --linux AppImage --arm64 || {
            echo "âš ï¸ ARM64 AppImage build failed, skipping..."
          }

          echo "========================================="
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: false
          ELECTRON_MIRROR: 'https://npmmirror.com/mirrors/electron/'
          ELECTRON_BUILDER_BINARIES_MIRROR: 'https://npmmirror.com/mirrors/electron-builder-binaries/'
          npm_config_arch: arm64
          npm_config_platform: linux

      - name: List build outputs
        run: |
          echo "Build outputs:"
          if [ -d "release" ]; then
            find release -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) -exec ls -lh {} \;
          else
            echo "âŒ Release directory not found"
            ls -la
          fi

      - name: Upload Linux build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: |
            release/*.AppImage
            release/*.deb
            release/*.rpm
          retention-days: 1
          if-no-files-found: error

  # ç¬¬ä¸‰é˜¶æ®µï¼šæ„å»ºmacOSåº”ç”¨ï¼ˆå¯é€‰ï¼‰
  build-macos:
    name: Build macOS Application
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install application dependencies (macOS)
        run: |
          echo "ğŸ”„ Installing macOS application dependencies..."
          
          # è®¾ç½® npm é…ç½®
          npm config set fund false
          npm config set audit false
          npm config set progress false
          
          # æ¸…ç†ç¼“å­˜
          npm cache clean --force
          
          # å®‰è£…æ‰€æœ‰ä¾èµ–åŒ…æ‹¬ devDependenciesï¼ˆæ„å»ºéœ€è¦ï¼‰
          echo "ğŸ“± macOS build - installing all dependencies..."
          npm install --production=false --legacy-peer-deps
          
          # éªŒè¯å…³é”®æ„å»ºä¾èµ–
          echo "ğŸ” Verifying critical build dependencies..."
          for dep in "electron" "electron-builder" "@electron/packager" "typescript"; do
            if [ ! -d "node_modules/$dep" ]; then
              echo "âŒ Critical dependency missing: $dep"
              echo "ğŸ”§ Attempting individual install..."
              npm install $dep --legacy-peer-deps
            else
              echo "âœ… $dep is installed"
            fi
          done
          
          echo "âœ… Dependencies installation completed"
          
          echo "ğŸ“‹ Final dependency status:"
          npm list --depth=0 2>/dev/null || echo "Dependencies installed successfully"

      - name: Build TypeScript
        run: |
          echo "========================================="
          echo "æ¸…ç†å¹¶ç¼–è¯‘ TypeScript"
          echo "========================================="

          # 1. æ¸…ç† dist ç›®å½•
          echo "ğŸ§¹ Cleaning dist directory..."
          npm run clean

          # 2. æ¸…ç† electron-builder ç¼“å­˜
          echo "ğŸ§¹ Cleaning electron-builder cache..."
          if [ -d "$HOME/Library/Caches/electron-builder" ]; then
            rm -rf "$HOME/Library/Caches/electron-builder"
            echo "   âœ… electron-builder cache cleared"
          else
            echo "   â„¹ï¸ No electron-builder cache found"
          fi

          # 3. æ¸…ç† release ç›®å½•
          echo "ğŸ§¹ Cleaning release directory..."
          if [ -d "release" ]; then
            rm -rf release
            echo "   âœ… release directory cleared"
          fi

          # 4. ç¼–è¯‘ TypeScript
          echo "ğŸ”¨ Compiling TypeScript..."
          npm run compile

          echo "âœ… Build preparation complete"
          echo "========================================="

      - name: Build native modules for macOS
        run: |
          npm run build:native:mac

      - name: Create macOS bundle
        run: |
          npm run pack:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            release/*.dmg
            release/*.zip
          retention-days: 1
          if-no-files-found: warn

  # ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux]
    if: always() && (needs.build-windows.result == 'success' || needs.build-linux.result == 'success')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" = "true" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: release-artifacts/windows/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: linux-installer
          path: release-artifacts/linux/

      - name: Download macOS artifacts (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: macos-installer
          path: release-artifacts/macos/

      - name: Prepare release notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          # Employee Monitor ${{ steps.version.outputs.version }}

          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ

          ### ğŸ“¦ å®‰è£…åŒ…

          **Windows ç”¨æˆ·ï¼š**
          - `EmployeeSafety-Setup-${{ steps.version.outputs.version }}.exe` - Windows å®‰è£…ç¨‹åºï¼ˆæ¨èï¼‰
          - `EmployeeSafety-${{ steps.version.outputs.version }}-win.zip` - Windows ä¾¿æºç‰ˆ

          **Linux ç”¨æˆ·ï¼š**
          - `EmployeeSafety-${{ steps.version.outputs.version }}-x64.AppImage` - é€šç”¨ Linux ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
          - `EmployeeSafety-${{ steps.version.outputs.version }}-amd64.deb` - Debian/Ubuntu å®‰è£…åŒ…

          **macOS ç”¨æˆ·ï¼š**
          - `EmployeeSafety-${{ steps.version.outputs.version }}.dmg` - macOS å®‰è£…åŒ…
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§

          - ğŸ–¥ï¸ è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxï¼‰
          - ğŸ“Š å®æ—¶æ´»åŠ¨ç›‘æ§
          - ğŸ“¸ è‡ªåŠ¨æˆªå±åŠŸèƒ½
          - ğŸ”’ æœ¬åœ°æ•°æ®å®‰å…¨å­˜å‚¨
          - ğŸŒ æœåŠ¡å™¨åŒæ­¥æ”¯æŒ
          - âš™ï¸ çµæ´»çš„é…ç½®é€‰é¡¹
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          
          - **æ„å»ºæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') UTC
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **Node.js ç‰ˆæœ¬**: ${{ env.NODE_VERSION }}
          - **åŸç”Ÿæ¨¡å—**: âœ… ä½¿ç”¨é¢„ç¼–è¯‘æ¨¡å—ï¼ˆä»£ç åº“ï¼‰
          
          ### ğŸ“‹ å®‰è£…è¯´æ˜

          1. **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œå³é”®ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
          2. **Linux (AppImage)**: ä¸‹è½½ `.AppImage`ï¼Œæ·»åŠ æ‰§è¡Œæƒé™åè¿è¡Œï¼š`chmod +x *.AppImage && ./*.AppImage`
          3. **Linux (DEB)**: ä¸‹è½½ `.deb`ï¼Œä½¿ç”¨ `sudo dpkg -i *.deb` å®‰è£…
          4. **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹

          ### ğŸ§ Linux ç‰¹åˆ«è¯´æ˜

          ä¸ºè·å¾—å®Œæ•´åŠŸèƒ½ï¼Œè¯·å°†ç”¨æˆ·æ·»åŠ åˆ° `input` ç»„ï¼š
          ```bash
          sudo usermod -a -G input $USER
          # ç„¶åæ³¨é”€å¹¶é‡æ–°ç™»å½•
          ```
          
          ### ğŸ†˜ æŠ€æœ¯æ”¯æŒ
          
          å¦‚é‡é—®é¢˜ï¼Œè¯·è®¿é—® [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æŠ¥å‘Šã€‚
          
          EOF
          
          echo "Release notes prepared"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Employee Monitor ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            release-artifacts/windows/*.exe
            release-artifacts/windows/*.msi
            release-artifacts/windows/*.zip
            release-artifacts/linux/*.AppImage
            release-artifacts/linux/*.deb
            release-artifacts/linux/*.rpm
            release-artifacts/macos/*.dmg
            release-artifacts/macos/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release summary
        run: |
          echo "ğŸ‰ Release ${{ steps.version.outputs.version }} created successfully!" 
          echo "ğŸ“¦ Artifacts uploaded:"
          find release-artifacts -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.msi" | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "  - $filename ($size)"
          done
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"

  # ç¬¬å››é˜¶æ®µï¼šé€šçŸ¥å®Œæˆ
  notify-completion:
    name: Notify Build Completion
    runs-on: ubuntu-latest
    needs: [build-windows, build-linux, create-release]
    if: always()
    
    steps:
      - name: Notify success
        if: needs.create-release.result == 'success'
        run: |
          echo "ğŸ‰ Employee Monitor æ„å»ºå’Œå‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "âœ… Windows åº”ç”¨æ„å»ºå®Œæˆ"
          echo "âœ… Linux åº”ç”¨æ„å»ºå®Œæˆ"
          echo "ğŸ“¦ å®‰è£…åŒ…å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "ğŸ”— ç«‹å³ä¸‹è½½: https://github.com/${{ github.repository }}/releases/latest"
          
      - name: Notify failure
        if: needs.create-release.result != 'success'
        run: |
          echo "âŒ Employee Monitor æ„å»ºæˆ–å‘å¸ƒå¤±è´¥"
          echo "ğŸ”§ è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ğŸ“‹ æ•…éšœæ’é™¤ï¼š"
          echo "  1. æ£€æŸ¥ TypeScript ç¼–è¯‘é”™è¯¯"
          echo "  2. éªŒè¯ electron-builder é…ç½®"
          echo "  3. ç¡®è®¤ä¾èµ–é¡¹å®Œæ•´æ€§"
          echo "  4. æ£€æŸ¥ GitHub token æƒé™"
          exit 1