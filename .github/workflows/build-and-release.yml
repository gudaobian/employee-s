name: Build and Release Employee Monitor

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v2.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '18'  # Must match Electron's internal Node.js version (Electron 28 uses Node 18.18.2)

jobs:
  # æž„å»ºWindowsåº”ç”¨ï¼ˆä½¿ç”¨ä»£ç åº“ä¸­é¢„ç¼–è¯‘çš„åŽŸç”Ÿæ¨¡å—ï¼‰
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Verify Node.js and npm versions
        run: |
          Write-Host "========================================="
          Write-Host "çŽ¯å¢ƒä¿¡æ¯æ£€æŸ¥"
          Write-Host "========================================="
          Write-Host "Node.js ç‰ˆæœ¬:"
          node --version
          Write-Host ""
          Write-Host "npm ç‰ˆæœ¬:"
          npm --version
          Write-Host ""
          Write-Host "Node.js è·¯å¾„:"
          where.exe node
          Write-Host ""
          Write-Host "npm è·¯å¾„:"
          where.exe npm
          Write-Host ""
          Write-Host "æœŸæœ› Node.js ç‰ˆæœ¬: ${{ env.NODE_VERSION }}"
          Write-Host "========================================="

      - name: Check Electron version and Node.js compatibility
        run: |
          Write-Host "========================================="
          Write-Host "Electron å…¼å®¹æ€§æ£€æŸ¥"
          Write-Host "========================================="

          # è¯»å– package.json ä¸­çš„ Electron ç‰ˆæœ¬
          $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
          $electronVersion = $packageJson.devDependencies.electron
          Write-Host "package.json ä¸­çš„ Electron ç‰ˆæœ¬: $electronVersion"

          # Electron 28 å†…ç½® Node.js 18.18.2 (ABI 108)
          Write-Host ""
          Write-Host "Electron 28 å†…ç½®ä¿¡æ¯:"
          Write-Host "- Node.js: 18.18.2"
          Write-Host "- ABI Version: 108"
          Write-Host "- Chrome: 120"
          Write-Host ""
          Write-Host "å½“å‰ Node.js ç‰ˆæœ¬:"
          node --version
          Write-Host "========================================="

      - name: Install application dependencies (Windows)
        run: |
          echo "ðŸ”„ Installing Windows application dependencies..."

          # æ¸…ç†çŽ¯å¢ƒå’Œç¼“å­˜ï¼ˆä½†ä¿ç•™åŽŸç”Ÿæ¨¡å—ï¼‰
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          if (Test-Path "node_modules") { Remove-Item "node_modules" -Recurse -Force }
          # âŒ ä¸è¦åˆ é™¤ native-event-monitor-win/build/ - å®ƒåŒ…å«ä»Ž artifact ä¸‹è½½çš„ç¼–è¯‘å¥½çš„æ¨¡å—
          if (Test-Path "native-event-monitor-win/node_modules") { Remove-Item "native-event-monitor-win/node_modules" -Recurse -Force }
          
          # è®¾ç½® npm é…ç½®ä»¥é¿å…æƒé™é—®é¢˜
          npm config set fund false
          npm config set audit false
          npm config set progress false
          
          # å¼ºåˆ¶æ¸…ç† npm ç¼“å­˜
          npm cache clean --force

          # å…ˆå•ç‹¬å®‰è£… Electronï¼ˆå…è®¸ postinstallï¼‰
          # Read Electron version from package.json
          $electronVersion = (Get-Content "package.json" -Raw | ConvertFrom-Json).devDependencies.electron
          echo "ðŸ“¦ Installing Electron $electronVersion (allow postinstall)..."
          npm install "electron@$electronVersion" --legacy-peer-deps

          # éªŒè¯ Electron å®‰è£…
          if (Test-Path "node_modules/electron/dist/electron.exe") {
            Write-Host "âœ… Electron installed successfully"
          } else {
            Write-Host "âŒ Electron installation failed"
            exit 1
          }

          # å®‰è£…å…¶ä»–ä¾èµ–åŒ…æ‹¬ devDependenciesï¼ˆæž„å»ºéœ€è¦ï¼‰
          # ä½¿ç”¨ --ignore-scripts é˜»æ­¢ä»»ä½•è‡ªåŠ¨æž„å»ºè„šæœ¬è¦†ç›–æˆ‘ä»¬çš„åŽŸç”Ÿæ¨¡å—
          echo "ðŸ“¦ Installing other dependencies (block auto-build)..."
          npm install --production=false --legacy-peer-deps --ignore-scripts
          
          # éªŒè¯å…³é”®æž„å»ºä¾èµ–
          echo "ðŸ” Verifying critical build dependencies..."
          $criticalDeps = @("electron-builder", "@electron/packager", "typescript")
          foreach ($dep in $criticalDeps) {
            if (-not (Test-Path "node_modules/$dep")) {
              echo "âŒ Critical dependency missing: $dep"
              echo "ðŸ”§ Attempting individual install..."
              npm install $dep --legacy-peer-deps --ignore-scripts
            } else {
              echo "âœ… $dep is installed"
            }
          }

          # Electron å·²ç»å•ç‹¬å®‰è£…ï¼Œå†æ¬¡éªŒè¯
          if (Test-Path "node_modules/electron") {
            echo "âœ… electron is installed"
          } else {
            echo "âŒ electron missing - this should not happen"
            exit 1
          }
          
          echo "âœ… Dependencies installation completed"

          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "ðŸ“‹ Final dependency status:"
          npm list --depth=0 2>$null | Out-String | Write-Host

      - name: Rebuild native module
        run: |
          Write-Host "========================================="
          Write-Host "é‡æ–°ç¼–è¯‘ Windows åŽŸç”Ÿæ¨¡å—"
          Write-Host "========================================="
          cd native-event-monitor-win

          Write-Host "ðŸ“¦ Installing native module dependencies..."
          npm install

          Write-Host "ðŸ”¨ Rebuilding native module..."
          npm run build

          if (Test-Path "build/Release/event_monitor.node") {
            $module = Get-Item "build/Release/event_monitor.node"
            Write-Host "âœ… åŽŸç”Ÿæ¨¡å—ç¼–è¯‘æˆåŠŸ"
            Write-Host "   å¤§å°: $([math]::Round($module.Length / 1KB, 2)) KB"
          } else {
            Write-Host "âŒ åŽŸç”Ÿæ¨¡å—ç¼–è¯‘å¤±è´¥"
            exit 1
          }

          cd ..
          Write-Host "========================================="

      - name: Verify precompiled native module
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯ä»£ç åº“ä¸­çš„é¢„ç¼–è¯‘åŽŸç”Ÿæ¨¡å—"
          Write-Host "========================================="
          if (Test-Path "native-event-monitor-win/build/Release/event_monitor.node") {
            $module = Get-Item "native-event-monitor-win/build/Release/event_monitor.node"
            $hash = (Get-FileHash $module.FullName -Algorithm SHA256).Hash.Substring(0,8)
            Write-Host "âœ… åŽŸç”Ÿæ¨¡å—å·²å­˜åœ¨ï¼ˆæ¥è‡ªä»£ç åº“ï¼‰"
            Write-Host "   æ–‡ä»¶: $($module.FullName)"
            Write-Host "   å¤§å°: $([math]::Round($module.Length / 1KB, 2)) KB"
            Write-Host "   å“ˆå¸Œ: $hash"
            Write-Host ""
            Write-Host "âš ï¸  é‡è¦: æ­¤æ–‡ä»¶å°†è¢« electron-builder æ‰“åŒ…"
            Write-Host "   è¯·å‹¿åœ¨åŽç»­æ­¥éª¤ä¸­åˆ é™¤æˆ–è¦†ç›–æ­¤æ–‡ä»¶"
          } else {
            Write-Host "âŒ æœªæ‰¾åˆ°åŽŸç”Ÿæ¨¡å—"
            Write-Host "   é¢„æœŸä½ç½®: native-event-monitor-win/build/Release/event_monitor.node"
            Write-Host "   è¯·ç¡®ä¿åŽŸç”Ÿæ¨¡å—å·²æäº¤åˆ°ä»£ç åº“"
            exit 1
          }
          Write-Host "========================================="

      - name: Update package version from git tag
        run: |
          # ä»Ž git tag æå–ç‰ˆæœ¬å·
          if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
            $VERSION = $matches[1]
            Write-Host "ðŸ“Œ Extracted version from tag: $VERSION"

            # æ›´æ–° package.json çš„ç‰ˆæœ¬å·
            $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
            $packageJson.version = $VERSION
            $packageJson | ConvertTo-Json -Depth 100 | Set-Content "package.json"

            Write-Host "âœ… Updated package.json version to: $VERSION"
            Write-Host ""
            Write-Host "éªŒè¯ package.json:"
            Get-Content "package.json" | Select-String '"version"'
          } else {
            Write-Host "âš ï¸ Not a tag push, using package.json version"
          }

      - name: Build TypeScript
        run: |
          Write-Host "========================================="
          Write-Host "æ¸…ç†å¹¶ç¼–è¯‘ TypeScript"
          Write-Host "========================================="

          # 1. æ¸…ç† dist ç›®å½•
          Write-Host "ðŸ§¹ Cleaning dist directory..."
          npm run clean

          # 2. æ¸…ç† electron-builder ç¼“å­˜
          Write-Host "ðŸ§¹ Cleaning electron-builder cache..."
          if (Test-Path "$env:LOCALAPPDATA\electron-builder\cache") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder\cache" -Recurse -Force
            Write-Host "   âœ… electron-builder cache cleared"
          } else {
            Write-Host "   â„¹ï¸ No electron-builder cache found"
          }

          # 3. æ¸…ç† release ç›®å½•ï¼ˆæ—§çš„æ‰“åŒ…æ–‡ä»¶ï¼‰
          Write-Host "ðŸ§¹ Cleaning release directory..."
          if (Test-Path "release") {
            Remove-Item "release" -Recurse -Force
            Write-Host "   âœ… release directory cleared"
          }

          # 4. ç¼–è¯‘ TypeScript
          Write-Host "ðŸ”¨ Compiling TypeScript..."
          npm run compile

          Write-Host "âœ… Build preparation complete"
          Write-Host "========================================="

      - name: Rebuild Windows native module for Electron 28
        run: |
          Write-Host "========================================="
          Write-Host "é‡æ–°ç¼–è¯‘WindowsåŽŸç”Ÿæ¨¡å—ï¼ˆElectron 28 ABI 108ï¼‰"
          Write-Host "========================================="

          cd native-event-monitor-win

          # å®‰è£…ä¾èµ–
          npm install --ignore-scripts

          # ä½¿ç”¨ electron-rebuild é‡æ–°ç¼–è¯‘ï¼ˆç¡®ä¿ABI 108ï¼‰
          npx electron-rebuild --version=28.2.10 --force

          # éªŒè¯é‡æ–°ç¼–è¯‘åŽçš„æ–‡ä»¶
          if (Test-Path "build/Release/event_monitor.node") {
            $module = Get-Item "build/Release/event_monitor.node"
            Write-Host "âœ… åŽŸç”Ÿæ¨¡å—é‡æ–°ç¼–è¯‘æˆåŠŸ"
            Write-Host "   å¤§å°: $([math]::Round($module.Length / 1KB, 2)) KB"
            Write-Host "   ä¿®æ”¹æ—¶é—´: $($module.LastWriteTime)"
          } else {
            Write-Host "âŒ é‡æ–°ç¼–è¯‘å¤±è´¥ - æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          }

          cd ..
          Write-Host "========================================="

      - name: Verify compiled WindowsAdapter has getActiveURL
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯ç¼–è¯‘åŽçš„ WindowsAdapter"
          Write-Host "========================================="

          $adapterPath = "dist/platforms/windows/windows-adapter.js"

          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ WindowsAdapter not found at: $adapterPath"
            exit 1
          }

          $content = Get-Content $adapterPath -Raw

          # æ£€æŸ¥æ˜¯å¦åŒ…å« getActiveURL æ–¹æ³•
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ… getActiveURL method found in compiled WindowsAdapter"
          } else {
            Write-Host "âŒ getActiveURL method NOT found in compiled WindowsAdapter"
            Write-Host "ðŸš¨ CRITICAL: Old code was compiled! Build must fail!"
            exit 1
          }

          # æ£€æŸ¥ VERSION æ ‡è¯†
          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            $version = $matches[1]
            Write-Host "âœ… WindowsAdapter VERSION: $version"

            if ($version -match "1\.0\.6[0-9]") {
              Write-Host "âœ… Version identifier looks correct"
            } else {
              Write-Host "âš ï¸ Version identifier unexpected: $version"
            }
          } else {
            Write-Host "âš ï¸ VERSION identifier not found (might be minified)"
          }

          Write-Host "========================================="

      - name: Final verification before packaging
        run: |
          Write-Host "========================================="
          Write-Host "æ‰“åŒ…å‰æœ€ç»ˆéªŒè¯"
          Write-Host "========================================="

          # éªŒè¯åŽŸç”Ÿæ¨¡å—ä»ç„¶å­˜åœ¨
          if (Test-Path "native-event-monitor-win/build/Release/event_monitor.node") {
            $module = Get-Item "native-event-monitor-win/build/Release/event_monitor.node"
            $hash = (Get-FileHash $module.FullName -Algorithm SHA256).Hash.Substring(0,8)
            $lastModified = $module.LastWriteTime

            Write-Host "âœ… åŽŸç”Ÿæ¨¡å—éªŒè¯é€šè¿‡"
            Write-Host "   æ–‡ä»¶è·¯å¾„: $($module.FullName)"
            Write-Host "   æ–‡ä»¶å¤§å°: $([math]::Round($module.Length / 1KB, 2)) KB"
            Write-Host "   SHA256å“ˆå¸Œ: $hash"
            Write-Host "   æœ€åŽä¿®æ”¹: $lastModified"

            # å°è¯•æ£€æµ‹ ABI ç‰ˆæœ¬ï¼ˆé€šè¿‡æ–‡ä»¶å†…å®¹ç‰¹å¾ï¼‰
            Write-Host ""
            Write-Host "ðŸ” å°è¯•æ£€æµ‹ NODE_MODULE_VERSION..."
            try {
              # è¯»å–æ–‡ä»¶çš„å‰ 1KB å¯»æ‰¾ NODE_MODULE_VERSION å­—ç¬¦ä¸²
              $bytes = [System.IO.File]::ReadAllBytes($module.FullName)
              $content = [System.Text.Encoding]::ASCII.GetString($bytes)

              if ($content -match "node_module_version.(\d+)") {
                Write-Host "   æ£€æµ‹åˆ° NODE_MODULE_VERSION: $($matches[1])"
                if ($matches[1] -eq "108") {
                  Write-Host "   âœ… æ­£ç¡®ï¼ABI 108 åŒ¹é… Electron 28"
                } else {
                  Write-Host "   âŒ é”™è¯¯ï¼ABI $($matches[1]) ä¸åŒ¹é… Electron 28 (åº”è¯¥æ˜¯ 108)"
                  Write-Host "   ðŸš¨ è¿™ä¸ªæ–‡ä»¶å¯èƒ½æ˜¯ç”¨é”™è¯¯çš„å·¥å…·ç¼–è¯‘çš„ï¼"
                }
              } else {
                Write-Host "   âš ï¸ æ— æ³•ä»Žæ–‡ä»¶ä¸­æå– NODE_MODULE_VERSION"
              }
            } catch {
              Write-Host "   âš ï¸ ABI ç‰ˆæœ¬æ£€æµ‹å¤±è´¥: $($_.Exception.Message)"
            }

            Write-Host ""
            Write-Host "âš ï¸  æ­¤æ–‡ä»¶å°†è¢« electron-builder æ‰“åŒ…åˆ°æœ€ç»ˆ exe ä¸­"
            Write-Host "   å¦‚æžœæœ€åŽä¿®æ”¹æ—¶é—´å¤ªæ–°ï¼Œå¯èƒ½æ˜¯è¢«æ„å¤–é‡æ–°ç¼–è¯‘äº†ï¼"
          } else {
            Write-Host "âŒ ä¸¥é‡é”™è¯¯: åŽŸç”Ÿæ¨¡å—æ–‡ä»¶ä¸¢å¤±ï¼"
            Write-Host "   é¢„æœŸä½ç½®: native-event-monitor-win/build/Release/event_monitor.node"
            Write-Host "   electron-builder å°†æ— æ³•æ‰“åŒ…æ­£ç¡®çš„æ–‡ä»¶"
            exit 1
          }

          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯ç–‘çš„ .node æ–‡ä»¶
          Write-Host ""
          Write-Host "æ£€æŸ¥å…¶ä»– .node æ–‡ä»¶:"
          Get-ChildItem -Path "." -Filter "*.node" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "   æ‰¾åˆ°: $($_.FullName) ($([math]::Round($_.Length / 1KB, 2)) KB)"
          }

          Write-Host "========================================="

      - name: Create application bundle
        run: |
          npm run pack:win
        env:
          # ä¸è®¾ç½®GH_TOKENï¼Œç¦ç”¨electron-builderè‡ªåŠ¨å‘å¸ƒ
          # Releaseç”±åŽç»­çš„create-release jobç»Ÿä¸€å¤„ç†
          CSC_IDENTITY_AUTO_DISCOVERY: false

      - name: Verify packaged native module (CRITICAL)
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯æ‰“åŒ…åŽçš„åŽŸç”Ÿæ¨¡å—ï¼ˆå…³é”®æ­¥éª¤ï¼‰"
          Write-Host "========================================="

          # æ£€æŸ¥ win-unpacked ç›®å½•ï¼ˆelectron-builder çš„è§£åŽ‹ç‰ˆæœ¬ï¼‰
          $unpackedPath = "release/win-unpacked/resources/app.asar.unpacked/native-event-monitor-win/build/Release/event_monitor.node"

          if (Test-Path $unpackedPath) {
            $packedModule = Get-Item $unpackedPath
            $packedHash = (Get-FileHash $packedModule.FullName -Algorithm SHA256).Hash.Substring(0,8)

            Write-Host "âœ… åœ¨å®‰è£…åŒ…ä¸­æ‰¾åˆ°åŽŸç”Ÿæ¨¡å—"
            Write-Host "   è·¯å¾„: $unpackedPath"
            Write-Host "   å¤§å°: $([math]::Round($packedModule.Length / 1KB, 2)) KB"
            Write-Host "   SHA256: $packedHash"
            Write-Host ""

            # æ£€æµ‹æ‰“åŒ…æ–‡ä»¶çš„ ABI ç‰ˆæœ¬
            Write-Host "ðŸ” æ£€æµ‹æ‰“åŒ…æ–‡ä»¶çš„ NODE_MODULE_VERSION..."
            try {
              $bytes = [System.IO.File]::ReadAllBytes($packedModule.FullName)
              $content = [System.Text.Encoding]::ASCII.GetString($bytes)

              if ($content -match "node_module_version.(\d+)") {
                Write-Host "   æ‰“åŒ…æ–‡ä»¶çš„ NODE_MODULE_VERSION: $($matches[1])"
                if ($matches[1] -eq "108") {
                  Write-Host "   âœ…âœ…âœ… å®Œç¾Žï¼æ‰“åŒ…çš„æ˜¯ ABI 108ï¼ˆæ­£ç¡®ï¼‰"
                } else {
                  Write-Host "   âŒâŒâŒ ä¸¥é‡é”™è¯¯ï¼æ‰“åŒ…çš„æ˜¯ ABI $($matches[1])ï¼Œåº”è¯¥æ˜¯ 108"
                  Write-Host "   ðŸš¨ ç”¨æˆ·å°†æ”¶åˆ° NODE_MODULE_VERSION é”™è¯¯ï¼"
                  exit 1
                }
              }
            } catch {
              Write-Host "   âš ï¸ æ— æ³•æ£€æµ‹ ABI: $($_.Exception.Message)"
            }
          } else {
            Write-Host "âŒ æœªåœ¨å®‰è£…åŒ…ä¸­æ‰¾åˆ°åŽŸç”Ÿæ¨¡å—"
            Write-Host "   é¢„æœŸè·¯å¾„: $unpackedPath"
            Write-Host ""
            Write-Host "å¯èƒ½çš„åŽŸå› :"
            Write-Host "1. electron-builder é…ç½®é”™è¯¯"
            Write-Host "2. æ–‡ä»¶æœªè¢«åŒ…å«åœ¨ asar.unpacked ä¸­"
            exit 1
          }

          Write-Host "========================================="

      - name: List build outputs
        run: |
          Write-Host "Build outputs:"
          if (Test-Path "release") {
            Get-ChildItem -Path "release" -Recurse | ForEach-Object {
              $relativePath = $_.FullName.Replace((Get-Location).Path + "\release\", "")
              if ($_.PSIsContainer) {
                Write-Host "  ðŸ“ $relativePath"
              } else {
                $sizeMB = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  ðŸ“„ $relativePath ($sizeMB MB)"
              }
            }
          } else {
            Write-Host "âŒ Release directory not found"
            Get-ChildItem -Path "." -Name
          }

      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            release/*.exe
            release/*.msi
            release/*.zip
          retention-days: 1
          if-no-files-found: error

  # ç¬¬ä¸‰é˜¶æ®µï¼šæž„å»ºmacOSåº”ç”¨ï¼ˆå¯é€‰ï¼‰
  build-macos:
    name: Build macOS Application
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install application dependencies (macOS)
        run: |
          echo "ðŸ”„ Installing macOS application dependencies..."
          
          # è®¾ç½® npm é…ç½®
          npm config set fund false
          npm config set audit false
          npm config set progress false
          
          # æ¸…ç†ç¼“å­˜
          npm cache clean --force
          
          # å®‰è£…æ‰€æœ‰ä¾èµ–åŒ…æ‹¬ devDependenciesï¼ˆæž„å»ºéœ€è¦ï¼‰
          echo "ðŸ“± macOS build - installing all dependencies..."
          npm install --production=false --legacy-peer-deps
          
          # éªŒè¯å…³é”®æž„å»ºä¾èµ–
          echo "ðŸ” Verifying critical build dependencies..."
          for dep in "electron" "electron-builder" "@electron/packager" "typescript"; do
            if [ ! -d "node_modules/$dep" ]; then
              echo "âŒ Critical dependency missing: $dep"
              echo "ðŸ”§ Attempting individual install..."
              npm install $dep --legacy-peer-deps
            else
              echo "âœ… $dep is installed"
            fi
          done
          
          echo "âœ… Dependencies installation completed"
          
          echo "ðŸ“‹ Final dependency status:"
          npm list --depth=0 2>/dev/null || echo "Dependencies installed successfully"

      - name: Build TypeScript
        run: |
          echo "========================================="
          echo "æ¸…ç†å¹¶ç¼–è¯‘ TypeScript"
          echo "========================================="

          # 1. æ¸…ç† dist ç›®å½•
          echo "ðŸ§¹ Cleaning dist directory..."
          npm run clean

          # 2. æ¸…ç† electron-builder ç¼“å­˜
          echo "ðŸ§¹ Cleaning electron-builder cache..."
          if [ -d "$HOME/Library/Caches/electron-builder" ]; then
            rm -rf "$HOME/Library/Caches/electron-builder"
            echo "   âœ… electron-builder cache cleared"
          else
            echo "   â„¹ï¸ No electron-builder cache found"
          fi

          # 3. æ¸…ç† release ç›®å½•
          echo "ðŸ§¹ Cleaning release directory..."
          if [ -d "release" ]; then
            rm -rf release
            echo "   âœ… release directory cleared"
          fi

          # 4. ç¼–è¯‘ TypeScript
          echo "ðŸ”¨ Compiling TypeScript..."
          npm run compile

          echo "âœ… Build preparation complete"
          echo "========================================="

      - name: Build native modules for macOS
        run: |
          npm run build:native:mac

      - name: Create macOS bundle
        run: |
          npm run pack:mac
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload macOS build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer
          path: |
            release/*.dmg
            release/*.zip
          retention-days: 1
          if-no-files-found: warn

  # ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: always() && (needs.build-windows.result == 'success')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" = "true" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: release-artifacts/windows/

      - name: Download macOS artifacts (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: macos-installer
          path: release-artifacts/macos/

      - name: Prepare release notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          # Employee Monitor ${{ steps.version.outputs.version }}
          
          ## ðŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          ### ðŸ“¦ å®‰è£…åŒ…
          
          **Windows ç”¨æˆ·ï¼š**
          - `Employee-Monitor-Setup-${{ steps.version.outputs.version }}.exe` - Windows å®‰è£…ç¨‹åºï¼ˆæŽ¨èï¼‰
          - `Employee-Monitor-${{ steps.version.outputs.version }}-win.zip` - Windows ä¾¿æºç‰ˆ
          
          **macOS ç”¨æˆ·ï¼š**
          - `Employee-Monitor-${{ steps.version.outputs.version }}.dmg` - macOS å®‰è£…åŒ…
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          
          - ðŸ–¥ï¸ è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSï¼‰
          - ðŸ“Š å®žæ—¶æ´»åŠ¨ç›‘æŽ§
          - ðŸ“¸ è‡ªåŠ¨æˆªå±åŠŸèƒ½
          - ðŸ”’ æœ¬åœ°æ•°æ®å®‰å…¨å­˜å‚¨
          - ðŸŒ æœåŠ¡å™¨åŒæ­¥æ”¯æŒ
          - âš™ï¸ çµæ´»çš„é…ç½®é€‰é¡¹
          
          ### ðŸ”§ æŠ€æœ¯ä¿¡æ¯
          
          - **æž„å»ºæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') UTC
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **Node.js ç‰ˆæœ¬**: ${{ env.NODE_VERSION }}
          - **åŽŸç”Ÿæ¨¡å—**: âœ… ä½¿ç”¨é¢„ç¼–è¯‘æ¨¡å—ï¼ˆä»£ç åº“ï¼‰
          
          ### ðŸ“‹ å®‰è£…è¯´æ˜Ž
          
          1. **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œå³é”®ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
          2. **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          
          ### ðŸ†˜ æŠ€æœ¯æ”¯æŒ
          
          å¦‚é‡é—®é¢˜ï¼Œè¯·è®¿é—® [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æŠ¥å‘Šã€‚
          
          EOF
          
          echo "Release notes prepared"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Employee Monitor ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            release-artifacts/windows/*.exe
            release-artifacts/windows/*.msi
            release-artifacts/windows/*.zip
            release-artifacts/macos/*.dmg
            release-artifacts/macos/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release summary
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.version }} created successfully!" 
          echo "ðŸ“¦ Artifacts uploaded:"
          find release-artifacts -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.msi" | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "  - $filename ($size)"
          done
          echo ""
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"

  # ç¬¬å››é˜¶æ®µï¼šé€šçŸ¥å®Œæˆ
  notify-completion:
    name: Notify Build Completion
    runs-on: ubuntu-latest
    needs: [build-windows, create-release]
    if: always()
    
    steps:
      - name: Notify success
        if: needs.create-release.result == 'success'
        run: |
          echo "ðŸŽ‰ Employee Monitor æž„å»ºå’Œå‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "âœ… Windows åº”ç”¨æž„å»ºå®Œæˆ"
          echo "ðŸ“¦ å®‰è£…åŒ…å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "ðŸ”— ç«‹å³ä¸‹è½½: https://github.com/${{ github.repository }}/releases/latest"
          
      - name: Notify failure
        if: needs.create-release.result != 'success'
        run: |
          echo "âŒ Employee Monitor æž„å»ºæˆ–å‘å¸ƒå¤±è´¥"
          echo "ðŸ”§ è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ðŸ“‹ æ•…éšœæŽ’é™¤ï¼š"
          echo "  1. æ£€æŸ¥ TypeScript ç¼–è¯‘é”™è¯¯"
          echo "  2. éªŒè¯ electron-builder é…ç½®"
          echo "  3. ç¡®è®¤ä¾èµ–é¡¹å®Œæ•´æ€§"
          echo "  4. æ£€æŸ¥ GitHub token æƒé™"
          exit 1