name: Build and Release Employee Monitor

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v2.0.0'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: '18'  # Must match Electron's internal Node.js version (Electron 28 uses Node 18.18.2)
  ELECTRON_MIRROR: 'https://npmmirror.com/mirrors/electron/'
  ELECTRON_BUILDER_BINARIES_MIRROR: 'https://npmmirror.com/mirrors/electron-builder-binaries/'

jobs:
  # æž„å»ºWindowsåº”ç”¨ï¼ˆä½¿ç”¨ä»£ç åº“ä¸­é¢„ç¼–è¯‘çš„åŽŸç”Ÿæ¨¡å—ï¼‰
  build-windows:
    name: Build Windows Application
    runs-on: windows-latest

    steps:
      - name: Clean workspace before checkout
        run: |
          Write-Host "========================================="
          Write-Host "å½»åº•æ¸…ç†å·¥ä½œåŒºï¼ˆé˜²æ­¢runneré‡ç”¨å¯¼è‡´çš„ç¼“å­˜é—®é¢˜ï¼‰"
          Write-Host "========================================="

          # åˆ é™¤æ‰€æœ‰å¯èƒ½æ®‹ç•™çš„æž„å»ºäº§ç‰©
          Write-Host "ðŸ§¹ Cleaning build artifacts..."
          if (Test-Path "out") {
            Remove-Item "out" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… out/ removed"
          }
          if (Test-Path "node_modules") {
            Remove-Item "node_modules" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… node_modules/ removed"
          }

          # æ¸…ç†æ‰€æœ‰electron-builderç¼“å­˜
          Write-Host "ðŸ§¹ Cleaning electron-builder caches..."
          if (Test-Path "$env:LOCALAPPDATA\electron-builder") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Global electron-builder cache cleared"
          }

          Write-Host "âœ… Workspace cleaned completely"
          Write-Host "========================================="

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true        # æ¸…ç†untracked files
          force: true        # å¼ºåˆ¶è¦†ç›–æœ¬åœ°ä¿®æ”¹

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Verify Node.js and npm versions
        run: |
          Write-Host "========================================="
          Write-Host "çŽ¯å¢ƒä¿¡æ¯æ£€æŸ¥"
          Write-Host "========================================="
          Write-Host "Node.js ç‰ˆæœ¬:"
          node --version
          Write-Host ""
          Write-Host "npm ç‰ˆæœ¬:"
          npm --version
          Write-Host ""
          Write-Host "Node.js è·¯å¾„:"
          where.exe node
          Write-Host ""
          Write-Host "npm è·¯å¾„:"
          where.exe npm
          Write-Host ""
          Write-Host "æœŸæœ› Node.js ç‰ˆæœ¬: ${{ env.NODE_VERSION }}"
          Write-Host "========================================="

      - name: Check Electron version and Node.js compatibility
        run: |
          Write-Host "========================================="
          Write-Host "Electron å…¼å®¹æ€§æ£€æŸ¥"
          Write-Host "========================================="

          # è¯»å– package.json ä¸­çš„ Electron ç‰ˆæœ¬
          $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
          $electronVersion = $packageJson.devDependencies.electron
          Write-Host "package.json ä¸­çš„ Electron ç‰ˆæœ¬: $electronVersion"

          # Electron 28 å†…ç½® Node.js 18.18.2 (ABI 108)
          Write-Host ""
          Write-Host "Electron 28 å†…ç½®ä¿¡æ¯:"
          Write-Host "- Node.js: 18.18.2"
          Write-Host "- ABI Version: 108"
          Write-Host "- Chrome: 120"
          Write-Host ""
          Write-Host "å½“å‰ Node.js ç‰ˆæœ¬:"
          node --version
          Write-Host "========================================="

      - name: Install application dependencies (Windows)
        run: |
          echo "ðŸ”„ Installing Windows application dependencies..."

          # æ¸…ç†çŽ¯å¢ƒå’Œç¼“å­˜ï¼ˆä½†ä¿ç•™åŽŸç”Ÿæ¨¡å—ï¼‰
          if (Test-Path "package-lock.json") { Remove-Item "package-lock.json" -Force }
          if (Test-Path "node_modules") { Remove-Item "node_modules" -Recurse -Force }
          # âŒ ä¸è¦åˆ é™¤ native/windows/build/ - å®ƒåŒ…å«ä»Ž artifact ä¸‹è½½çš„ç¼–è¯‘å¥½çš„æ¨¡å—
          if (Test-Path "native/windows/node_modules") { Remove-Item "native/windows/node_modules" -Recurse -Force }
          
          # è®¾ç½® npm é…ç½®ä»¥é¿å…æƒé™é—®é¢˜
          npm config set fund false
          npm config set audit false
          npm config set progress false
          
          # å¼ºåˆ¶æ¸…ç† npm ç¼“å­˜
          npm cache clean --force

          # å…ˆå•ç‹¬å®‰è£… Electronï¼ˆå…è®¸ postinstallï¼‰
          # Read Electron version from package.json
          $electronVersion = (Get-Content "package.json" -Raw | ConvertFrom-Json).devDependencies.electron
          echo "ðŸ“¦ Installing Electron $electronVersion (allow postinstall)..."
          npm install "electron@$electronVersion" --legacy-peer-deps

          # éªŒè¯ Electron å®‰è£…
          if (Test-Path "node_modules/electron/dist/electron.exe") {
            Write-Host "âœ… Electron installed successfully"
          } else {
            Write-Host "âŒ Electron installation failed"
            exit 1
          }

          # å®‰è£…å…¶ä»–ä¾èµ–åŒ…æ‹¬ devDependenciesï¼ˆæž„å»ºéœ€è¦ï¼‰
          # ä½¿ç”¨ --ignore-scripts é˜»æ­¢ä»»ä½•è‡ªåŠ¨æž„å»ºè„šæœ¬è¦†ç›–æˆ‘ä»¬çš„åŽŸç”Ÿæ¨¡å—
          echo "ðŸ“¦ Installing other dependencies (block auto-build)..."
          npm install --production=false --legacy-peer-deps --ignore-scripts
          
          # éªŒè¯å…³é”®æž„å»ºä¾èµ–
          echo "ðŸ” Verifying critical build dependencies..."
          $criticalDeps = @("electron-builder", "@electron/packager", "typescript")
          foreach ($dep in $criticalDeps) {
            if (-not (Test-Path "node_modules/$dep")) {
              echo "âŒ Critical dependency missing: $dep"
              echo "ðŸ”§ Attempting individual install..."
              npm install $dep --legacy-peer-deps --ignore-scripts
            } else {
              echo "âœ… $dep is installed"
            }
          }

          # Electron å·²ç»å•ç‹¬å®‰è£…ï¼Œå†æ¬¡éªŒè¯
          if (Test-Path "node_modules/electron") {
            echo "âœ… electron is installed"
          } else {
            echo "âŒ electron missing - this should not happen"
            exit 1
          }
          
          echo "âœ… Dependencies installation completed"

          # æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
          echo "ðŸ“‹ Final dependency status:"
          npm list --depth=0 2>$null | Out-String | Write-Host

      - name: Precompile Windows Native Module for Electron 28
        run: |
          Write-Host "========================================="
          Write-Host "é¢„ç¼–è¯‘ Windows åŽŸç”Ÿæ¨¡å— for Electron 28"
          Write-Host "========================================="
          Write-Host ""

          # ðŸ”´ æ­¥éª¤1: æ¸…ç†æ—§çš„æž„å»ºäº§ç‰©
          Write-Host "ðŸ§¹ Step 1: Cleaning old native module build..."
          if (Test-Path "native\windows\build") {
            Remove-Item "native\windows\build" -Recurse -Force
            Start-Sleep -Seconds 1
            Write-Host "   âœ… Removed old build/"
          } else {
            Write-Host "   â„¹ï¸  No existing build/ (clean slate)"
          }

          # ðŸ”´ æ­¥éª¤2: å®‰è£…åŽŸç”Ÿæ¨¡å—çš„ä¾èµ–
          Write-Host ""
          Write-Host "ðŸ“¦ Step 2: Installing native module dependencies..."
          cd native/windows
          npm install
          cd ../..
          Write-Host "   âœ… Dependencies installed"

          # ðŸ”´ æ­¥éª¤3: ä½¿ç”¨ node-gyp é…åˆ Electron å¤´æ–‡ä»¶ç¼–è¯‘
          Write-Host ""
          Write-Host "ðŸ”¨ Step 3: Compiling with node-gyp for Electron 28..."
          Write-Host "   Target: Electron 28.2.10 (Node.js ABI 108)"
          Write-Host "   This will take 5-10 minutes for C++ compilation..."
          Write-Host ""

          cd native/windows

          # èŽ·å– Electron ç‰ˆæœ¬
          $electronVersion = (Get-Content "..\..\package.json" -Raw | ConvertFrom-Json).devDependencies.electron
          $electronVersion = $electronVersion -replace '\^', ''
          Write-Host "   Electron version: $electronVersion"

          # è®¾ç½®çŽ¯å¢ƒå˜é‡æŒ‡å‘ Electron
          $env:npm_config_target = $electronVersion
          $env:npm_config_arch = "x64"
          $env:npm_config_target_arch = "x64"
          $env:npm_config_disturl = "https://electronjs.org/headers"
          $env:npm_config_runtime = "electron"
          $env:npm_config_build_from_source = "true"

          Write-Host "   Environment variables set:"
          Write-Host "   - target: $env:npm_config_target"
          Write-Host "   - runtime: electron"
          Write-Host "   - disturl: https://electronjs.org/headers"
          Write-Host ""

          # æ£€æŸ¥ç¼–è¯‘çŽ¯å¢ƒ
          Write-Host ""
          Write-Host "   Checking build environment..."
          Write-Host "   Python:"
          python --version 2>&1 | Write-Host
          Write-Host "   MSBuild:"
          where.exe msbuild 2>&1 | Write-Host
          Write-Host ""

          # ä½¿ç”¨ node-gyp ç¼–è¯‘ï¼ˆè¯¦ç»†è¾“å‡ºï¼‰
          Write-Host "   Running: node-gyp rebuild --verbose"
          npx node-gyp rebuild --verbose 2>&1 | Tee-Object -Variable gypOutput | Write-Host

          cd ../..

          Write-Host ""
          Write-Host "ðŸ” Checking if compilation actually ran..."
          if ($gypOutput -match "cl\.exe|link\.exe|Creating library") {
            Write-Host "   âœ… C++ compiler (cl.exe) was invoked - compilation happened!"
          } else {
            Write-Host "   âŒ WARNING: No C++ compilation detected in output!"
            Write-Host "   This means node-gyp skipped compilation for some reason"
          }

          # ðŸ”´ æ­¥éª¤4: éªŒè¯ç¼–è¯‘ç»“æžœ
          Write-Host ""
          Write-Host "ðŸ” Step 4: Verifying compilation result..."

          $modulePath = "native\windows\build\Release\event_monitor.node"
          if (-not (Test-Path $modulePath)) {
            Write-Host ""
            Write-Host "âŒ CRITICAL: Native module not found!"
            Write-Host "   Expected: $modulePath"
            Write-Host ""
            Write-Host "Checking build directory:"
            if (Test-Path "native\windows\build") {
              Get-ChildItem "native\windows\build" -Recurse | Format-Table Name, Length, LastWriteTime
            } else {
              Write-Host "   âŒ build/ doesn't exist - node-gyp failed!"
            }
            exit 1
          }

          # éªŒè¯æ–‡ä»¶æ—¶é—´æˆ³
          $module = Get-Item $modulePath
          $ageMinutes = ((Get-Date) - $module.LastWriteTime).TotalMinutes

          Write-Host ""
          Write-Host "âœ… Native module compiled successfully!"
          Write-Host "   Path: $($module.FullName)"
          Write-Host "   Size: $([math]::Round($module.Length / 1KB, 2)) KB"
          Write-Host "   Created: $($module.LastWriteTime)"
          Write-Host "   Age: $([math]::Round($ageMinutes, 2)) minutes"
          Write-Host ""

          if ($ageMinutes -gt 15) {
            Write-Host "âŒ WARNING: Module is too old (> 15 min)"
            exit 1
          }

          Write-Host "âœ… Precompilation complete - ready for TypeScript build"
          Write-Host "========================================="

      - name: Update package version from git tag
        run: |
          # ä»Ž git tag æå–ç‰ˆæœ¬å·
          if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
            $VERSION = $matches[1]
            Write-Host "ðŸ“Œ Extracted version from tag: $VERSION"

            # æ›´æ–° package.json çš„ç‰ˆæœ¬å·
            $packageJson = Get-Content "package.json" -Raw | ConvertFrom-Json
            $packageJson.version = $VERSION
            $packageJson | ConvertTo-Json -Depth 100 | Set-Content "package.json"

            Write-Host "âœ… Updated package.json version to: $VERSION"
            Write-Host ""
            Write-Host "éªŒè¯ package.json:"
            Get-Content "package.json" | Select-String '"version"'
          } else {
            Write-Host "âš ï¸ Not a tag push, using package.json version"
          }

      - name: Build TypeScript
        run: |
          Write-Host "========================================="
          Write-Host "å®Œæ•´æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œæž„å»ºäº§ç‰©"
          Write-Host "========================================="

          # 1. æ¸…ç† dist ç›®å½•ï¼ˆåŒé‡ç¡®ä¿ï¼‰
          Write-Host "ðŸ§¹ Cleaning dist directory..."
          if (Test-Path "dist") {
            Remove-Item "dist" -Recurse -Force -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 2  # ç­‰å¾…æ–‡ä»¶ç³»ç»Ÿå®Œæˆåˆ é™¤
          }
          npm run clean  # å†æ¬¡ç¡®ä¿æ¸…ç†

          # 2. æ¸…ç†æ‰€æœ‰ electron-builder ç¼“å­˜ä½ç½®ï¼ˆåŒ…æ‹¬NSISç›¸å…³ï¼‰
          Write-Host "ðŸ§¹ Cleaning all electron-builder caches (including NSIS)..."

          # å…¨å±€ç¼“å­˜
          if (Test-Path "$env:LOCALAPPDATA\electron-builder") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Global electron-builder cache cleared"
          }

          # electronç¼“å­˜
          if (Test-Path "$env:LOCALAPPDATA\electron") {
            Remove-Item "$env:LOCALAPPDATA\electron" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Electron cache cleared"
          }

          # Tempç›®å½•ä¸­çš„electron-builderç¼“å­˜
          if (Test-Path "$env:TEMP\electron-builder-*") {
            Remove-Item "$env:TEMP\electron-builder-*" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Temp cache cleared"
          }

          # é¡¹ç›®ç¼“å­˜
          if (Test-Path "node_modules\.cache\electron-builder") {
            Remove-Item "node_modules\.cache\electron-builder" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… Project cache cleared"
          }

          # NSISç‰¹å®šç¼“å­˜
          if (Test-Path "$env:LOCALAPPDATA\electron-builder\Cache\nsis") {
            Remove-Item "$env:LOCALAPPDATA\electron-builder\Cache\nsis" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… NSIS cache cleared"
          }

          # 3. æ¸…ç† release ç›®å½•
          Write-Host "ðŸ§¹ Cleaning release directory..."
          if (Test-Path "release") {
            Remove-Item "release" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "   âœ… release directory cleared"
          }

          # 4. éªŒè¯æ¸…ç†ç»“æžœ
          Write-Host "ðŸ” Verifying cleanup..."
          if (Test-Path "dist") {
            Write-Host "âŒ CRITICAL: dist still exists after cleanup!"
            exit 1
          }
          Write-Host "   âœ… dist directory confirmed deleted"

          # 5. ç¼–è¯‘ TypeScript
          Write-Host "ðŸ”¨ Compiling TypeScript..."
          npm run compile

          # Debug: æ˜¾ç¤ºå½“å‰ç›®å½•å’Œç¼–è¯‘è¾“å‡º
          Write-Host ""
          Write-Host "ðŸ“ Debug: Current working directory:"
          Get-Location
          Write-Host ""
          Write-Host "ðŸ“ Debug: Checking if out/dist exists:"
          if (Test-Path "out/dist") {
            Write-Host "   âœ… out/dist exists"
            Write-Host ""
            Write-Host "ðŸ“ Debug: Contents of out/dist/platforms:"
            if (Test-Path "out/dist/platforms") {
              Get-ChildItem "out/dist/platforms" -Recurse -File | Select-Object FullName | Format-Table -AutoSize
            } else {
              Write-Host "   âŒ out/dist/platforms does NOT exist"
            }
          } else {
            Write-Host "   âŒ out/dist does NOT exist"
            Write-Host ""
            Write-Host "ðŸ“ Debug: Contents of current directory:"
            Get-ChildItem . -Directory | Select-Object Name
          }
          Write-Host ""

          # 6. éªŒè¯ç¼–è¯‘ç»“æžœ
          Write-Host "ðŸ” Verifying compilation..."
          $adapterPath = "out/dist/platforms/windows/windows-adapter.js"
          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ CRITICAL: WindowsAdapter not compiled!"
            Write-Host "âŒ Expected path: $adapterPath"
            Write-Host "âŒ Absolute path: $((Get-Location).Path)\$adapterPath"
            exit 1
          }
          Write-Host "   âœ… WindowsAdapter compiled successfully"

          Write-Host "âœ… Build preparation complete"
          Write-Host "========================================="

      - name: Verify compiled WindowsAdapter has getActiveURL
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯ç¼–è¯‘åŽçš„ WindowsAdapter"
          Write-Host "========================================="

          $adapterPath = "out/dist/platforms/windows/windows-adapter.js"

          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ WindowsAdapter not found at: $adapterPath"
            exit 1
          }

          $content = Get-Content $adapterPath -Raw

          # æ£€æŸ¥æ˜¯å¦åŒ…å« getActiveURL æ–¹æ³•
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ… getActiveURL method found in compiled WindowsAdapter"
          } else {
            Write-Host "âŒ getActiveURL method NOT found in compiled WindowsAdapter"
            Write-Host "ðŸš¨ CRITICAL: Old code was compiled! Build must fail!"
            exit 1
          }

          # æ£€æŸ¥ VERSION æ ‡è¯†
          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            $version = $matches[1]
            Write-Host "âœ… WindowsAdapter VERSION: $version"

            if ($version -match "1\.0\.6[0-9]") {
              Write-Host "âœ… Version identifier looks correct"
            } else {
              Write-Host "âš ï¸ Version identifier unexpected: $version"
            }
          } else {
            Write-Host "âš ï¸ VERSION identifier not found (might be minified)"
          }

          Write-Host "========================================="

      - name: Final verification before packaging
        run: |
          Write-Host "========================================="
          Write-Host "æ‰“åŒ…å‰æœ€ç»ˆéªŒè¯"
          Write-Host "========================================="

          # éªŒè¯åŽŸç”Ÿæ¨¡å—ä»ç„¶å­˜åœ¨
          if (Test-Path "native/windows/build/Release/event_monitor.node") {
            $module = Get-Item "native/windows/build/Release/event_monitor.node"
            $hash = (Get-FileHash $module.FullName -Algorithm SHA256).Hash.Substring(0,8)
            $lastModified = $module.LastWriteTime

            Write-Host "âœ… åŽŸç”Ÿæ¨¡å—éªŒè¯é€šè¿‡"
            Write-Host "   æ–‡ä»¶è·¯å¾„: $($module.FullName)"
            Write-Host "   æ–‡ä»¶å¤§å°: $([math]::Round($module.Length / 1KB, 2)) KB"
            Write-Host "   SHA256å“ˆå¸Œ: $hash"
            Write-Host "   æœ€åŽä¿®æ”¹: $lastModified"

            # å°è¯•æ£€æµ‹ ABI ç‰ˆæœ¬ï¼ˆé€šè¿‡æ–‡ä»¶å†…å®¹ç‰¹å¾ï¼‰
            Write-Host ""
            Write-Host "ðŸ” å°è¯•æ£€æµ‹ NODE_MODULE_VERSION..."
            try {
              # è¯»å–æ–‡ä»¶çš„å‰ 1KB å¯»æ‰¾ NODE_MODULE_VERSION å­—ç¬¦ä¸²
              $bytes = [System.IO.File]::ReadAllBytes($module.FullName)
              $content = [System.Text.Encoding]::ASCII.GetString($bytes)

              if ($content -match "node_module_version.(\d+)") {
                Write-Host "   æ£€æµ‹åˆ° NODE_MODULE_VERSION: $($matches[1])"
                if ($matches[1] -eq "108") {
                  Write-Host "   âœ… æ­£ç¡®ï¼ABI 108 åŒ¹é… Electron 28"
                } else {
                  Write-Host "   âŒ é”™è¯¯ï¼ABI $($matches[1]) ä¸åŒ¹é… Electron 28 (åº”è¯¥æ˜¯ 108)"
                  Write-Host "   ðŸš¨ è¿™ä¸ªæ–‡ä»¶å¯èƒ½æ˜¯ç”¨é”™è¯¯çš„å·¥å…·ç¼–è¯‘çš„ï¼"
                }
              } else {
                Write-Host "   âš ï¸ æ— æ³•ä»Žæ–‡ä»¶ä¸­æå– NODE_MODULE_VERSION"
              }
            } catch {
              Write-Host "   âš ï¸ ABI ç‰ˆæœ¬æ£€æµ‹å¤±è´¥: $($_.Exception.Message)"
            }

            Write-Host ""
            Write-Host "âš ï¸  æ­¤æ–‡ä»¶å°†è¢« electron-builder æ‰“åŒ…åˆ°æœ€ç»ˆ exe ä¸­"
            Write-Host "   å¦‚æžœæœ€åŽä¿®æ”¹æ—¶é—´å¤ªæ–°ï¼Œå¯èƒ½æ˜¯è¢«æ„å¤–é‡æ–°ç¼–è¯‘äº†ï¼"
          } else {
            Write-Host "âŒ ä¸¥é‡é”™è¯¯: åŽŸç”Ÿæ¨¡å—æ–‡ä»¶ä¸¢å¤±ï¼"
            Write-Host "   é¢„æœŸä½ç½®: native/windows/build/Release/event_monitor.node"
            Write-Host "   electron-builder å°†æ— æ³•æ‰“åŒ…æ­£ç¡®çš„æ–‡ä»¶"
            exit 1
          }

          # æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯ç–‘çš„ .node æ–‡ä»¶
          Write-Host ""
          Write-Host "æ£€æŸ¥å…¶ä»– .node æ–‡ä»¶:"
          Get-ChildItem -Path "." -Filter "*.node" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "   æ‰¾åˆ°: $($_.FullName) ($([math]::Round($_.Length / 1KB, 2)) KB)"
          }

          Write-Host "========================================="

      - name: Verify dist directory before packaging (CRITICAL)
        run: |
          Write-Host "========================================="
          Write-Host "æ‰“åŒ…å‰éªŒè¯distç›®å½•å†…å®¹ï¼ˆé˜²æ­¢æ‰“åŒ…æ—§ä»£ç ï¼‰"
          Write-Host "========================================="

          $adapterPath = "out/dist/platforms/windows/windows-adapter.js"

          if (-not (Test-Path $adapterPath)) {
            Write-Host "âŒ WindowsAdapter not found at: $adapterPath"
            exit 1
          }

          $content = Get-Content $adapterPath -Raw

          Write-Host "ðŸ” Checking out/dist/platforms/windows/windows-adapter.js..."
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ… getActiveURL found in dist/ (pre-packaging)"
          } else {
            Write-Host "âŒ CRITICAL: getActiveURL NOT found in dist/ before packaging!"
            Write-Host "This means TypeScript compilation failed or produced wrong output!"
            exit 1
          }

          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            Write-Host "âœ… VERSION in dist/: $($matches[1])"
          }

          Write-Host "âœ… dist/ directory verification passed"

          # è®¡ç®—dist/WindowsAdapterçš„hashä½œä¸ºå‚è€ƒ
          $hash = (Get-FileHash $adapterPath -Algorithm SHA256).Hash
          Write-Host "ðŸ“‹ dist/WindowsAdapter SHA256: $hash"
          Write-Host "This hash will be compared with packaged version"

          Write-Host "========================================="

      - name: Create application bundle
        run: |
          npm run pack:win
        env:
          # ä¸è®¾ç½®GH_TOKENï¼Œç¦ç”¨electron-builderè‡ªåŠ¨å‘å¸ƒ
          # Releaseç”±åŽç»­çš„create-release jobç»Ÿä¸€å¤„ç†
          CSC_IDENTITY_AUTO_DISCOVERY: false
          # å®Œå…¨ç¦ç”¨electron-builderç¼“å­˜
          ELECTRON_BUILDER_CACHE: "${{ runner.temp }}/eb-cache-disabled"
          USE_HARD_LINKS: "false"

      - name: Debug release directory structure
        run: |
          Write-Host "========================================="
          Write-Host "è°ƒè¯•: æ£€æŸ¥ release ç›®å½•ç»“æž„"
          Write-Host "========================================="

          if (Test-Path "out/release/win-unpacked") {
            Write-Host "ðŸ“ out/release/win-unpacked å­˜åœ¨"
            Write-Host ""
            Write-Host "ðŸ“‚ èµ„æºç›®å½•ç»“æž„:"
            Get-ChildItem "out/release/win-unpacked/resources" -Recurse | Select-Object -First 50 | Format-Table Name, FullName

            Write-Host ""
            Write-Host "ðŸ“‚ æŸ¥æ‰¾æ‰€æœ‰ .node æ–‡ä»¶:"
            Get-ChildItem "out/release/win-unpacked" -Recurse -Filter "*.node" | Format-Table Name, FullName, Length

            Write-Host ""
            Write-Host "ðŸ“‚ æ£€æŸ¥ app.asar.unpacked å†…å®¹:"
            if (Test-Path "out/release/win-unpacked/resources/app.asar.unpacked") {
              Get-ChildItem "out/release/win-unpacked/resources/app.asar.unpacked" -Recurse | Select-Object -First 100 | Format-Table Name, FullName
            } else {
              Write-Host "âŒ app.asar.unpacked ä¸å­˜åœ¨ï¼"
            }
          } else {
            Write-Host "âŒ out/release/win-unpacked ä¸å­˜åœ¨"
          }
          Write-Host "========================================="

      - name: Verify packaged native module (CRITICAL)
        continue-on-error: true
        id: verify-native
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯æ‰“åŒ…åŽçš„åŽŸç”Ÿæ¨¡å—ï¼ˆå…³é”®æ­¥éª¤ï¼‰"
          Write-Host "========================================="

          # æ£€æŸ¥ win-unpacked ç›®å½•ï¼ˆelectron-builder çš„è§£åŽ‹ç‰ˆæœ¬ï¼‰
          $unpackedPath = "out/release/win-unpacked/resources/app.asar.unpacked/native/windows/build/Release/event_monitor.node"

          if (Test-Path $unpackedPath) {
            $packedModule = Get-Item $unpackedPath
            $packedHash = (Get-FileHash $packedModule.FullName -Algorithm SHA256).Hash.Substring(0,8)

            Write-Host "âœ… åœ¨å®‰è£…åŒ…ä¸­æ‰¾åˆ°åŽŸç”Ÿæ¨¡å—"
            Write-Host "   è·¯å¾„: $unpackedPath"
            Write-Host "   å¤§å°: $([math]::Round($packedModule.Length / 1KB, 2)) KB"
            Write-Host "   SHA256: $packedHash"
            Write-Host ""

            # æ£€æµ‹æ‰“åŒ…æ–‡ä»¶çš„ ABI ç‰ˆæœ¬
            Write-Host "ðŸ” æ£€æµ‹æ‰“åŒ…æ–‡ä»¶çš„ NODE_MODULE_VERSION..."
            try {
              $bytes = [System.IO.File]::ReadAllBytes($packedModule.FullName)
              $content = [System.Text.Encoding]::ASCII.GetString($bytes)

              if ($content -match "node_module_version.(\d+)") {
                Write-Host "   æ‰“åŒ…æ–‡ä»¶çš„ NODE_MODULE_VERSION: $($matches[1])"
                if ($matches[1] -eq "108") {
                  Write-Host "   âœ…âœ…âœ… å®Œç¾Žï¼æ‰“åŒ…çš„æ˜¯ ABI 108ï¼ˆæ­£ç¡®ï¼‰"
                } else {
                  Write-Host "   âŒâŒâŒ ä¸¥é‡é”™è¯¯ï¼æ‰“åŒ…çš„æ˜¯ ABI $($matches[1])ï¼Œåº”è¯¥æ˜¯ 108"
                  Write-Host "   ðŸš¨ ç”¨æˆ·å°†æ”¶åˆ° NODE_MODULE_VERSION é”™è¯¯ï¼"
                  exit 1
                }
              }
            } catch {
              Write-Host "   âš ï¸ æ— æ³•æ£€æµ‹ ABI: $($_.Exception.Message)"
            }
          } else {
            Write-Host "âŒ æœªåœ¨å®‰è£…åŒ…ä¸­æ‰¾åˆ°åŽŸç”Ÿæ¨¡å—"
            Write-Host "   é¢„æœŸè·¯å¾„: $unpackedPath"
            Write-Host ""
            Write-Host "âš ï¸ ç»§ç»­æ‰§è¡Œä»¥æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯..."
          }

          Write-Host "========================================="

      - name: Verify NSIS installer contains getActiveURL (CRITICAL)
        continue-on-error: true
        id: verify-nsis
        run: |
          Write-Host "========================================="
          Write-Host "éªŒè¯NSISå®‰è£…åŒ…ä¸­çš„WindowsAdapterï¼ˆå…³é”®æ­¥éª¤ï¼‰"
          Write-Host "========================================="

          # æ£€æŸ¥ release ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "release")) {
            Write-Host "âŒ release ç›®å½•ä¸å­˜åœ¨ï¼"
            Write-Host "   è¿™æ„å‘³ç€ electron-builder æ‰“åŒ…å¤±è´¥"
            Write-Host "   è¯·æ£€æŸ¥å‰é¢çš„ 'Create application bundle' æ­¥éª¤"
            exit 1
          }

          # å®‰è£…å¿…è¦å·¥å…·
          Write-Host "ðŸ“¦ Installing tools..."
          npm install -g asar
          choco install 7zip -y --no-progress

          # æ‰¾åˆ°NSIS .exeå®‰è£…åŒ…
          $exePath = Get-ChildItem "release" -Filter "*.exe" | Where-Object { $_.Name -match "Setup" } | Select-Object -First 1

          if (-not $exePath) {
            Write-Host "âŒ NSIS installer not found!"
            Write-Host "ðŸ“‚ release ç›®å½•å†…å®¹:"
            Get-ChildItem "release" | Format-Table Name, Length
            exit 1
          }

          Write-Host "ðŸ“¦ Found installer: $($exePath.FullName)"
          Write-Host "   Size: $([math]::Round($exePath.Length / 1MB, 2)) MB"

          # ä½¿ç”¨7zipè§£åŽ‹NSISå®‰è£…åŒ…
          Write-Host "ðŸ“‚ Extracting NSIS installer..."
          & "C:\Program Files\7-Zip\7z.exe" x $exePath.FullName -o"temp-nsis-extracted" -y | Out-Null

          # NSISå°†åº”ç”¨æ‰“åŒ…ä¸ºapp-64.7zï¼Œéœ€è¦å…ˆè§£åŽ‹
          Write-Host "ðŸ” Searching for app-64.7z in extracted installer..."
          $app7z = Get-ChildItem "temp-nsis-extracted" -Recurse -Filter "app-64.7z" -ErrorAction SilentlyContinue | Select-Object -First 1

          if (-not $app7z) {
            Write-Host "âŒ app-64.7z not found in NSIS installer!"
            Write-Host "Extracted structure:"
            Get-ChildItem "temp-nsis-extracted" -Recurse | Format-Table
            Remove-Item "temp-nsis-extracted" -Recurse -Force
            exit 1
          }

          Write-Host "âœ… Found app-64.7z: $($app7z.FullName)"
          Write-Host "   Size: $([math]::Round($app7z.Length / 1MB, 2)) MB"

          # è§£åŽ‹app-64.7z
          Write-Host "ðŸ“‚ Extracting app-64.7z..."
          & "C:\Program Files\7-Zip\7z.exe" x $app7z.FullName -o"temp-app-extracted" -y | Out-Null

          # çŽ°åœ¨æŸ¥æ‰¾app.asar
          Write-Host "ðŸ” Searching for app.asar in extracted app-64.7z..."
          $asarFiles = Get-ChildItem "temp-app-extracted" -Recurse -Filter "app.asar" -ErrorAction SilentlyContinue

          if ($asarFiles.Count -eq 0) {
            Write-Host "âŒ app.asar not found in app-64.7z!"
            Write-Host "Extracted app-64.7z structure:"
            Get-ChildItem "temp-app-extracted" -Recurse | Select-Object -First 20 | Format-Table
            Remove-Item "temp-nsis-extracted" -Recurse -Force
            Remove-Item "temp-app-extracted" -Recurse -Force
            exit 1
          }

          Write-Host "âœ… Found $($asarFiles.Count) app.asar file(s) in app-64.7z"

          # éªŒè¯ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„app.asar
          $asarPath = $asarFiles[0].FullName
          Write-Host "ðŸ“‚ Extracting app.asar from app-64.7z..."
          asar extract $asarPath temp-installer-asar-extracted

          # æ£€æŸ¥WindowsAdapter
          $extractedAdapter = "temp-installer-asar-extracted/out/dist/platforms/windows/windows-adapter.js"
          if (-not (Test-Path $extractedAdapter)) {
            Write-Host "âŒ WindowsAdapter not found at: $extractedAdapter"
            Write-Host "Available files:"
            Get-ChildItem "temp-installer-asar-extracted" -Recurse | Select-Object -First 20 | Format-Table
            Remove-Item "temp-nsis-extracted" -Recurse -Force
            Remove-Item "temp-installer-asar-extracted" -Recurse -Force
            exit 1
          }

          $content = Get-Content $extractedAdapter -Raw

          Write-Host ""
          Write-Host "ðŸ” Checking for getActiveURL method in NSIS installer..."
          if ($content -match "getActiveURL\s*\(") {
            Write-Host "âœ…âœ…âœ… SUCCESS: getActiveURL method found in NSIS installer!"
          } else {
            Write-Host "âŒâŒâŒ CRITICAL FAILURE: getActiveURL NOT found in NSIS installer!"
            Write-Host "ðŸš¨ This means the .exe installer contains OLD CODE!"
            Write-Host "ðŸš¨ Users who download this will receive broken version!"
            Write-Host ""
            Write-Host "File preview (first 500 chars):"
            Write-Host $content.Substring(0, [Math]::Min(500, $content.Length))
            Write-Host ""
            Write-Host "ðŸ” Comparing with win-unpacked version..."

            # å¯¹æ¯”win-unpackedç‰ˆæœ¬
            $unpackedAdapter = "out/release/win-unpacked/out/dist/platforms/windows/windows-adapter.js"
            if (Test-Path $unpackedAdapter) {
              $unpackedContent = Get-Content $unpackedAdapter -Raw
              if ($unpackedContent -match "getActiveURL\s*\(") {
                Write-Host "âš ï¸ win-unpacked has getActiveURL but NSIS installer does NOT!"
                Write-Host "ðŸš¨ This confirms electron-builder NSIS packaging is using cached/old files!"
              }
            }

            # æ¸…ç†å¹¶é€€å‡º
            Remove-Item "temp-nsis-extracted" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "temp-app-extracted" -Recurse -Force -ErrorAction SilentlyContinue
            Remove-Item "temp-installer-asar-extracted" -Recurse -Force -ErrorAction SilentlyContinue
            exit 1
          }

          # æ£€æŸ¥VERSIONæ ‡è¯†
          Write-Host ""
          Write-Host "ðŸ” Checking VERSION identifier in NSIS installer..."
          if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
            $version = $matches[1]
            Write-Host "âœ… NSIS installer VERSION: $version"

            if ($version -match "1\.0\.6[0-9]-with-getActiveURL") {
              Write-Host "âœ…âœ…âœ… PERFECT: Version identifier is correct!"
            } else {
              Write-Host "âš ï¸ WARNING: Version identifier unexpected: $version"
            }
          } else {
            Write-Host "âš ï¸ VERSION identifier not found (code might be minified)"
          }

          Write-Host ""
          Write-Host "âœ… NSIS installer content verification PASSED"
          Write-Host "âœ… Users will receive correct code!"

          # è®¡ç®—NSISä¸­WindowsAdapterçš„hashå¹¶å¯¹æ¯”
          Write-Host ""
          Write-Host "ðŸ“‹ Computing hash for verification..."
          $nsisAdapterHash = (Get-FileHash $extractedAdapter -Algorithm SHA256).Hash
          Write-Host "NSIS installer WindowsAdapter SHA256: $nsisAdapterHash"

          # å¯¹æ¯”åŽŸå§‹dist/ä¸­çš„hash
          $origAdapter = "out/dist/platforms/windows/windows-adapter.js"
          if (Test-Path $origAdapter) {
            $origHash = (Get-FileHash $origAdapter -Algorithm SHA256).Hash
            Write-Host "Original dist/ WindowsAdapter SHA256:  $origHash"

            if ($nsisAdapterHash -eq $origHash) {
              Write-Host "âœ…âœ…âœ… PERFECT: Hashes match! NSIS contains same file as dist/"
            } else {
              Write-Host "âŒâŒâŒ CRITICAL: Hash mismatch!"
              Write-Host "ðŸš¨ NSIS installer contains DIFFERENT WindowsAdapter than dist/!"
              Write-Host "ðŸš¨ This proves electron-builder is using cached/old files!"
              Remove-Item "temp-nsis-extracted" -Recurse -Force -ErrorAction SilentlyContinue
              Remove-Item "temp-app-extracted" -Recurse -Force -ErrorAction SilentlyContinue
              Remove-Item "temp-installer-asar-extracted" -Recurse -Force -ErrorAction SilentlyContinue
              exit 1
            }
          }

          # æ¸…ç†æå–çš„æ–‡ä»¶
          Remove-Item "temp-nsis-extracted" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "temp-app-extracted" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "temp-installer-asar-extracted" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "ðŸ§¹ Cleanup complete"

          Write-Host "========================================="

      - name: List build outputs
        run: |
          Write-Host "Build outputs:"
          if (Test-Path "release") {
            Get-ChildItem -Path "release" -Recurse | ForEach-Object {
              $relativePath = $_.FullName.Replace((Get-Location).Path + "\release\", "")
              if ($_.PSIsContainer) {
                Write-Host "  ðŸ“ $relativePath"
              } else {
                $sizeMB = [math]::Round($_.Length / 1MB, 2)
                Write-Host "  ðŸ“„ $relativePath ($sizeMB MB)"
              }
            }
          } else {
            Write-Host "âŒ Release directory not found"
            Get-ChildItem -Path "." -Name
          }

      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            out/release/*.exe
            out/release/*.msi
            out/release/*.zip
          retention-days: 1
          if-no-files-found: error

  # ç¬¬äºŒé˜¶æ®µï¼šmacOS æž„å»ºå·²ç§»é™¤ï¼ˆæœ¬åœ°æž„å»ºï¼‰
  # macOS å®‰è£…åŒ…è¯·ä½¿ç”¨æœ¬åœ°å‘½ä»¤æž„å»º: npm run pack:mac

  # ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-windows]
    if: always() && needs.build-windows.result == 'success'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ startsWith(github.ref, 'refs/tags/') }}" = "true" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="v$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-installer
          path: release-artifacts/windows/

      - name: Prepare release notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          # Employee Monitor ${{ steps.version.outputs.version }}

          ## ðŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ

          ### ðŸ“¦ å®‰è£…åŒ…

          **Windows ç”¨æˆ·ï¼š**
          - `EmployeeSafety-Setup-${{ steps.version.outputs.version }}.exe` - Windows å®‰è£…ç¨‹åºï¼ˆæŽ¨èï¼‰
          - `EmployeeSafety-${{ steps.version.outputs.version }}-win.zip` - Windows ä¾¿æºç‰ˆ

          **macOS ç”¨æˆ·ï¼š**
          - macOS å®‰è£…åŒ…è¯·æœ¬åœ°æž„å»ºï¼š`npm run pack:mac`

          ### âœ¨ ä¸»è¦ç‰¹æ€§

          - ðŸ–¥ï¸ è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSï¼‰
          - ðŸ“Š å®žæ—¶æ´»åŠ¨ç›‘æŽ§
          - ðŸ“¸ è‡ªåŠ¨æˆªå±åŠŸèƒ½
          - ðŸ”’ æœ¬åœ°æ•°æ®å®‰å…¨å­˜å‚¨
          - ðŸŒ æœåŠ¡å™¨åŒæ­¥æ”¯æŒ
          - âš™ï¸ çµæ´»çš„é…ç½®é€‰é¡¹

          ### ðŸ”§ æŠ€æœ¯ä¿¡æ¯

          - **æž„å»ºæ—¶é—´**: $(date -u +'%Y-%m-%d %H:%M:%S') UTC
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **Node.js ç‰ˆæœ¬**: ${{ env.NODE_VERSION }}
          - **å¹³å°**: Windows (CI æž„å»º), macOS (æœ¬åœ°æž„å»º)

          ### ðŸ“‹ å®‰è£…è¯´æ˜Ž

          **Windows**: ä¸‹è½½ `.exe` å®‰è£…ç¨‹åºï¼Œå³é”®ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ

          **macOS**: æœ¬åœ°æž„å»ºæ­¥éª¤
          ```bash
          npm install
          npm run build:native:mac
          npm run pack:mac
          # æž„å»ºäº§ç‰©ä½äºŽ out/release/ ç›®å½•
          ```

          ### ðŸ†˜ æŠ€æœ¯æ”¯æŒ

          å¦‚é‡é—®é¢˜ï¼Œè¯·è®¿é—® [Issues](https://github.com/${{ github.repository }}/issues) é¡µé¢æŠ¥å‘Šã€‚

          EOF

          echo "Release notes prepared"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Employee Monitor ${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            release-artifacts/windows/*.exe
            release-artifacts/windows/*.msi
            release-artifacts/windows/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release summary
        run: |
          echo "ðŸŽ‰ Release ${{ steps.version.outputs.version }} created successfully!" 
          echo "ðŸ“¦ Artifacts uploaded:"
          find release-artifacts -type f -name "*.exe" -o -name "*.dmg" -o -name "*.zip" -o -name "*.msi" | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "  - $filename ($size)"
          done
          echo ""
          echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"

  # ç¬¬å››é˜¶æ®µï¼šé€šçŸ¥å®Œæˆ
  notify-completion:
    name: Notify Build Completion
    runs-on: ubuntu-latest
    needs: [build-windows, create-release]
    if: always()

    steps:
      - name: Notify success
        if: needs.create-release.result == 'success'
        run: |
          echo "ðŸŽ‰ Employee Monitor æž„å»ºå’Œå‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "âœ… Windows åº”ç”¨æž„å»ºå®Œæˆ"
          echo "ðŸ“¦ Windows å®‰è£…åŒ…å·²ä¸Šä¼ åˆ° GitHub Releases"
          echo "ðŸ“ macOS å®‰è£…åŒ…è¯·æœ¬åœ°æž„å»º"
          echo "ðŸ”— ç«‹å³ä¸‹è½½: https://github.com/${{ github.repository }}/releases/latest"
          
      - name: Notify failure
        if: needs.create-release.result != 'success'
        run: |
          echo "âŒ Employee Monitor æž„å»ºæˆ–å‘å¸ƒå¤±è´¥"
          echo "ðŸ”§ è¯·æ£€æŸ¥æž„å»ºæ—¥å¿—èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "ðŸ“‹ æ•…éšœæŽ’é™¤ï¼š"
          echo "  1. æ£€æŸ¥ TypeScript ç¼–è¯‘é”™è¯¯"
          echo "  2. éªŒè¯ electron-builder é…ç½®"
          echo "  3. ç¡®è®¤ä¾èµ–é¡¹å®Œæ•´æ€§"
          echo "  4. æ£€æŸ¥ GitHub token æƒé™"
          exit 1