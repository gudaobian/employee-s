name: Precompile Linux Native Module

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'native-event-monitor-linux/**'
      - 'scripts/precompile-linux-native.js'
  pull_request:
    branches: [ main ]
    paths:
      - 'native-event-monitor-linux/**'
      - 'scripts/precompile-linux-native.js'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes detected'
        required: false
        default: 'false'
      build_x64:
        description: 'Build x64 version'
        required: false
        default: 'true'
      build_arm64:
        description: 'Build arm64 version'
        required: false
        default: 'true'

permissions:
  contents: write
  actions: read

jobs:
  # ========================================
  # x64 ÊûÑÂª∫ - ‰ΩøÁî®Ê†áÂáÜ ubuntu runner
  # ========================================
  precompile-linux-x64:
    name: Precompile for Linux x64
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.build_x64 != 'false' }}

    env:
      ELECTRON_VERSION: "28.2.10"
      NODE_ABI: "119"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            python3 \
            pkg-config \
            libinput-dev \
            libudev-dev \
            libx11-dev \
            libxtst-dev \
            libxi-dev

          echo "‚úÖ Build dependencies installed"

      - name: Cache native module build
        uses: actions/cache@v4
        with:
          path: |
            native-event-monitor-linux/build
            native-event-monitor-linux/node_modules
            ~/.npm
          key: linux-native-x64-node18-${{ hashFiles('native-event-monitor-linux/package.json', 'native-event-monitor-linux/binding.gyp', 'native-event-monitor-linux/src/**/*.cpp', 'native-event-monitor-linux/src/**/*.h') }}
          restore-keys: |
            linux-native-x64-node18-

      - name: Install dependencies and build
        run: |
          cd native-event-monitor-linux

          # Clean previous builds
          rm -rf build node_modules

          # Install dependencies
          npm install

          # Build native module for current Node.js
          echo "üî® Building native module for Node.js..."
          npm run build:native

          # Build TypeScript
          echo "üìù Compiling TypeScript..."
          npm run build:ts || npx tsc || true

          # Verify build
          if [ -f "build/Release/linux_event_monitor.node" ]; then
            echo "‚úÖ Native module built successfully"
            ls -la build/Release/linux_event_monitor.node
            file build/Release/linux_event_monitor.node
          else
            echo "‚ùå Native module build failed"
            exit 1
          fi

      - name: Rebuild for Electron ABI
        run: |
          cd native-event-monitor-linux

          echo "üîÑ Rebuilding for Electron ${ELECTRON_VERSION} (ABI ${NODE_ABI})..."

          # Install electron-rebuild
          npm install --save-dev electron-rebuild electron@${ELECTRON_VERSION}

          # Rebuild for Electron
          npx electron-rebuild --version=${ELECTRON_VERSION} --force || {
            echo "‚ö†Ô∏è electron-rebuild failed, using node-gyp directly..."
            npx node-gyp rebuild \
              --target=${ELECTRON_VERSION} \
              --arch=x64 \
              --dist-url=https://electronjs.org/headers \
              --build-from-source || true
          }

          # Verify rebuilt module
          if [ -f "build/Release/linux_event_monitor.node" ]; then
            echo "‚úÖ Module rebuilt for Electron"
            file build/Release/linux_event_monitor.node
          fi

      - name: Create precompiled package
        run: |
          cd native-event-monitor-linux

          # Create precompiled directory structure
          mkdir -p precompiled/linux-x64-${NODE_ABI}
          mkdir -p bin/linux-x64-${NODE_ABI}

          # Copy built module
          cp build/Release/linux_event_monitor.node precompiled/linux-x64-${NODE_ABI}/
          cp build/Release/linux_event_monitor.node bin/linux-x64-${NODE_ABI}/

          # Create metadata
          cat > precompiled/linux-x64-${NODE_ABI}/build-metadata.json << EOF
          {
            "buildTime": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')",
            "nodeVersion": "$(node --version)",
            "electronVersion": "${ELECTRON_VERSION}",
            "nodeABI": "${NODE_ABI}",
            "platform": "linux",
            "arch": "x64",
            "commit": "${{ github.sha }}"
          }
          EOF

          echo "üì¶ Precompiled package created:"
          ls -la precompiled/linux-x64-${NODE_ABI}/
          ls -la bin/linux-x64-${NODE_ABI}/

      - name: Upload x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-native-module-x64
          path: |
            native-event-monitor-linux/precompiled/linux-x64-*/
            native-event-monitor-linux/bin/linux-x64-*/
          retention-days: 30
          if-no-files-found: error

  # ========================================
  # ARM64 ÊûÑÂª∫ - ‰ΩøÁî® QEMU Ê®°Êãü
  # ========================================
  precompile-linux-arm64:
    name: Precompile for Linux ARM64
    runs-on: ubuntu-22.04
    if: ${{ github.event.inputs.build_arm64 != 'false' }}

    env:
      ELECTRON_VERSION: "28.2.10"
      NODE_ABI: "119"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU for ARM64
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ARM64 native module in Docker
        run: |
          # Create a Dockerfile for ARM64 build
          # Note: Electron 28 = Node ABI 119
          cat > Dockerfile.arm64-build << 'DOCKERFILE'
          FROM arm64v8/node:18-bookworm

          # Install build dependencies
          RUN apt-get update && apt-get install -y \
              build-essential \
              python3 \
              pkg-config \
              libinput-dev \
              libudev-dev \
              libx11-dev \
              libxtst-dev \
              libxi-dev \
              && rm -rf /var/lib/apt/lists/*

          WORKDIR /build

          # Copy source files
          COPY native-event-monitor-linux/ ./native-event-monitor-linux/

          # Build
          WORKDIR /build/native-event-monitor-linux
          RUN npm install
          RUN npm run build:native || node-gyp rebuild

          # Create output directories (Electron 28 = ABI 119)
          RUN mkdir -p /output/precompiled/linux-arm64-119 /output/bin/linux-arm64-119
          RUN cp build/Release/linux_event_monitor.node /output/precompiled/linux-arm64-119/ || true
          RUN cp build/Release/linux_event_monitor.node /output/bin/linux-arm64-119/ || true

          # Create metadata
          RUN echo '{"buildTime":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","platform":"linux","arch":"arm64","nodeABI":"119","electronVersion":"28.2.10"}' > /output/precompiled/linux-arm64-119/build-metadata.json
          DOCKERFILE

          # Build using Docker with QEMU emulation
          echo "üê≥ Building ARM64 native module using Docker + QEMU..."
          docker buildx build \
            --platform linux/arm64 \
            --load \
            -t linux-native-arm64-builder \
            -f Dockerfile.arm64-build \
            .

          # Extract built artifacts
          echo "üì¶ Extracting built artifacts..."
          mkdir -p arm64-output
          docker create --name arm64-extract linux-native-arm64-builder
          docker cp arm64-extract:/output/. arm64-output/
          docker rm arm64-extract

          # Verify output
          echo "üìã Build output:"
          find arm64-output -type f -exec ls -la {} \;

          # Check if native module was built
          if [ -f "arm64-output/precompiled/linux-arm64-119/linux_event_monitor.node" ]; then
            echo "‚úÖ ARM64 native module built successfully"
            file arm64-output/precompiled/linux-arm64-119/linux_event_monitor.node
          else
            echo "‚ùå ARM64 native module build failed"
            # Don't fail - we'll use JavaScript fallback
            mkdir -p arm64-output/precompiled/linux-arm64-119
            echo '{"buildTime":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","platform":"linux","arch":"arm64","nodeABI":"119","buildFailed":true,"fallbackAvailable":true}' > arm64-output/precompiled/linux-arm64-119/build-metadata.json
          fi

      - name: Copy artifacts to native-event-monitor-linux
        run: |
          # Copy built artifacts back to source tree
          mkdir -p native-event-monitor-linux/precompiled
          mkdir -p native-event-monitor-linux/bin

          cp -r arm64-output/precompiled/* native-event-monitor-linux/precompiled/ || true
          cp -r arm64-output/bin/* native-event-monitor-linux/bin/ || true

          echo "üì¶ Final artifacts:"
          find native-event-monitor-linux/precompiled -type f -exec ls -la {} \; || echo "No precompiled files"
          find native-event-monitor-linux/bin -type f -exec ls -la {} \; || echo "No bin files"

      - name: Upload ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-native-module-arm64
          path: |
            native-event-monitor-linux/precompiled/linux-arm64-*/
            native-event-monitor-linux/bin/linux-arm64-*/
            arm64-output/
          retention-days: 30
          if-no-files-found: warn

  # ========================================
  # ÂêàÂπ∂È¢ÑÁºñËØë‰∫ßÁâ©Âπ∂Êõ¥Êñ∞‰ªìÂ∫ì
  # ========================================
  merge-and-commit:
    name: Merge Precompiled Artifacts
    runs-on: ubuntu-latest
    needs: [precompile-linux-x64, precompile-linux-arm64]
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts

      - name: Merge artifacts into repository
        run: |
          echo "üì¶ Merging precompiled artifacts..."

          # Create target directories
          mkdir -p native-event-monitor-linux/bin
          mkdir -p native-event-monitor-linux/precompiled

          # Copy x64 artifacts
          if [ -d "downloaded-artifacts/linux-native-module-x64" ]; then
            echo "üìã Copying x64 artifacts..."
            cp -r downloaded-artifacts/linux-native-module-x64/native-event-monitor-linux/bin/* native-event-monitor-linux/bin/ 2>/dev/null || true
            cp -r downloaded-artifacts/linux-native-module-x64/native-event-monitor-linux/precompiled/* native-event-monitor-linux/precompiled/ 2>/dev/null || true
          fi

          # Copy ARM64 artifacts
          if [ -d "downloaded-artifacts/linux-native-module-arm64" ]; then
            echo "üìã Copying ARM64 artifacts..."
            cp -r downloaded-artifacts/linux-native-module-arm64/native-event-monitor-linux/bin/* native-event-monitor-linux/bin/ 2>/dev/null || true
            cp -r downloaded-artifacts/linux-native-module-arm64/native-event-monitor-linux/precompiled/* native-event-monitor-linux/precompiled/ 2>/dev/null || true
            cp -r downloaded-artifacts/linux-native-module-arm64/arm64-output/bin/* native-event-monitor-linux/bin/ 2>/dev/null || true
            cp -r downloaded-artifacts/linux-native-module-arm64/arm64-output/precompiled/* native-event-monitor-linux/precompiled/ 2>/dev/null || true
          fi

          echo "üìã Final structure:"
          find native-event-monitor-linux/bin -type f -exec ls -la {} \; 2>/dev/null || echo "No bin files"
          find native-event-monitor-linux/precompiled -type f -exec ls -la {} \; 2>/dev/null || echo "No precompiled files"

      - name: Commit precompiled binaries
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Check if there are changes
          if [ -n "$(git status --porcelain native-event-monitor-linux/bin native-event-monitor-linux/precompiled)" ]; then
            git add native-event-monitor-linux/bin/ native-event-monitor-linux/precompiled/
            git commit -m "chore: update precompiled Linux native modules (x64/arm64)

            - Built for Electron 28.2.10 (Node ABI 121)
            - Includes x64 and ARM64 binaries
            - Auto-generated by GitHub Actions

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"

            git push
            echo "‚úÖ Precompiled binaries committed and pushed"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

      - name: Create release package artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-native-modules-release
          path: |
            native-event-monitor-linux/bin/
            native-event-monitor-linux/precompiled/
          retention-days: 90

  # ========================================
  # ÈÄöÁü•ÂÆåÊàêÁä∂ÊÄÅ
  # ========================================
  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [precompile-linux-x64, precompile-linux-arm64, merge-and-commit]
    if: always()

    steps:
      - name: Check results and notify
        run: |
          echo "========================================="
          echo "Linux Native Module Precompilation Summary"
          echo "========================================="

          if [ "${{ needs.precompile-linux-x64.result }}" == "success" ]; then
            echo "‚úÖ x64 build: SUCCESS"
          else
            echo "‚ùå x64 build: ${{ needs.precompile-linux-x64.result }}"
          fi

          if [ "${{ needs.precompile-linux-arm64.result }}" == "success" ]; then
            echo "‚úÖ ARM64 build: SUCCESS"
          else
            echo "‚ö†Ô∏è ARM64 build: ${{ needs.precompile-linux-arm64.result }}"
            echo "   Note: ARM64 build failure is expected if QEMU times out"
            echo "   The JavaScript fallback will be used instead"
          fi

          if [ "${{ needs.merge-and-commit.result }}" == "success" ]; then
            echo "‚úÖ Merge & Commit: SUCCESS"
          else
            echo "‚ö†Ô∏è Merge & Commit: ${{ needs.merge-and-commit.result }}"
          fi

          echo "========================================="
