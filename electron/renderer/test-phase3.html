<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Phase 3 IPC å¤„ç†å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .test-section {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 3px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            flex: 1;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-box.total { background: #e3f2fd; }
        .stat-box.passed { background: #d4edda; }
        .stat-box.failed { background: #f8d7da; }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 3 IPC å¤„ç†å™¨æµ‹è¯•</h1>

    <div class="test-section">
        <h2>æµ‹è¯•è¯´æ˜</h2>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• <code>simplified-ipc-handlers.js</code> æ¨¡å—çš„æ‰€æœ‰åŠŸèƒ½ã€‚</p>
        <p><strong>å½“å‰æµ‹è¯•æ¨¡å¼</strong>: app_instance = nullï¼ˆé™çº§æœºåˆ¶æµ‹è¯•ï¼‰</p>
        <p>é¢„æœŸæ‰€æœ‰ IPC è°ƒç”¨éƒ½åº”è¯¥è¿”å›é»˜è®¤å€¼/mock æ•°æ®ã€‚</p>
    </div>

    <div class="stats">
        <div class="stat-box total">
            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
            <div class="stat-number" id="total-tests">0</div>
        </div>
        <div class="stat-box passed">
            <div class="stat-label">é€šè¿‡</div>
            <div class="stat-number" id="passed-tests">0</div>
        </div>
        <div class="stat-box failed">
            <div class="stat-label">å¤±è´¥</div>
            <div class="stat-number" id="failed-tests">0</div>
        </div>
    </div>

    <div class="test-section">
        <button onclick="runAllTests()">â–¶ï¸ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    </div>

    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;

        function updateStats() {
            document.getElementById('total-tests').textContent = totalTests;
            document.getElementById('passed-tests').textContent = passedTests;
            document.getElementById('failed-tests').textContent = failedTests;
        }

        function addResult(category, testName, status, message, data = null) {
            totalTests++;
            if (status === 'success') passedTests++;
            if (status === 'error') failedTests++;
            updateStats();

            let section = document.getElementById(`section-${category}`);
            if (!section) {
                section = document.createElement('div');
                section.id = `section-${category}`;
                section.className = 'test-section';
                section.innerHTML = `<h2>${category}</h2>`;
                results.appendChild(section);
            }

            const div = document.createElement('div');
            div.className = `test-result ${status}`;

            let html = `<strong>${testName}</strong>: ${message}`;

            if (data) {
                html += `<div class="code">${JSON.stringify(data, null, 2)}</div>`;
            }

            div.innerHTML = html;
            section.appendChild(div);
        }

        function clearResults() {
            results.innerHTML = '';
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            updateStats();
        }

        // ==================== æµ‹è¯•å‡½æ•° ====================

        async function testGetConfig() {
            try {
                const config = await window.electronAPI.invoke('get-config');

                if (config && config.apiUrl && config.syncInterval) {
                    addResult('é…ç½®ç®¡ç†', 'get-config', 'success',
                        'âœ… æˆåŠŸè·å–é…ç½®ï¼ˆé™çº§åˆ°é»˜è®¤å€¼ï¼‰', config);
                } else {
                    addResult('é…ç½®ç®¡ç†', 'get-config', 'error',
                        'âŒ è¿”å›çš„é…ç½®æ ¼å¼ä¸æ­£ç¡®', config);
                }
            } catch (error) {
                addResult('é…ç½®ç®¡ç†', 'get-config', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testGetDeviceId() {
            try {
                const deviceId = await window.electronAPI.invoke('get-device-id');

                if (deviceId && typeof deviceId === 'string' && deviceId.length > 0) {
                    addResult('è®¾å¤‡ä¿¡æ¯', 'get-device-id', 'success',
                        `âœ… æˆåŠŸè·å–è®¾å¤‡ IDï¼ˆé™çº§åˆ°ç³»ç»Ÿæ ‡è¯†ï¼‰: ${deviceId}`);
                } else {
                    addResult('è®¾å¤‡ä¿¡æ¯', 'get-device-id', 'error',
                        'âŒ è¿”å›çš„è®¾å¤‡ ID æ— æ•ˆ', deviceId);
                }
            } catch (error) {
                addResult('è®¾å¤‡ä¿¡æ¯', 'get-device-id', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testGetSystemInfo() {
            try {
                const sysInfo = await window.electronAPI.invoke('get-system-info');

                if (sysInfo && sysInfo.platform && sysInfo.hostname) {
                    addResult('è®¾å¤‡ä¿¡æ¯', 'get-system-info', 'success',
                        'âœ… æˆåŠŸè·å–ç³»ç»Ÿä¿¡æ¯', sysInfo);
                } else {
                    addResult('è®¾å¤‡ä¿¡æ¯', 'get-system-info', 'error',
                        'âŒ è¿”å›çš„ç³»ç»Ÿä¿¡æ¯ä¸å®Œæ•´', sysInfo);
                }
            } catch (error) {
                addResult('è®¾å¤‡ä¿¡æ¯', 'get-system-info', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testFSMGetCurrentState() {
            try {
                const state = await window.electronAPI.fsm.getCurrentState();

                if (state === 'INIT') {
                    addResult('FSM çŠ¶æ€ç®¡ç†', 'fsm:getCurrentState', 'success',
                        `âœ… æˆåŠŸè·å– FSM çŠ¶æ€ï¼ˆé™çº§åˆ° INITï¼‰: ${state}`);
                } else {
                    addResult('FSM çŠ¶æ€ç®¡ç†', 'fsm:getCurrentState', 'warning',
                        `âš ï¸ è¿”å›çš„çŠ¶æ€ä¸æ˜¯é¢„æœŸçš„ INIT: ${state}`);
                }
            } catch (error) {
                addResult('FSM çŠ¶æ€ç®¡ç†', 'fsm:getCurrentState', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testFSMForceTransition() {
            try {
                const result = await window.electronAPI.fsm.forceTransition('RUNNING');

                if (result && result.success === false) {
                    addResult('FSM çŠ¶æ€ç®¡ç†', 'fsm:forceTransition', 'success',
                        'âœ… æ­£ç¡®è¿”å›å¤±è´¥ï¼ˆFSM ä¸å¯ç”¨ï¼‰', result);
                } else {
                    addResult('FSM çŠ¶æ€ç®¡ç†', 'fsm:forceTransition', 'warning',
                        'âš ï¸ è¿”å›å€¼ä¸ç¬¦åˆé¢„æœŸ', result);
                }
            } catch (error) {
                addResult('FSM çŠ¶æ€ç®¡ç†', 'fsm:forceTransition', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testSyncData() {
            try {
                const result = await window.electronAPI.system.syncData();

                if (result && result.synced === true && result.message) {
                    addResult('æ•°æ®åŒæ­¥', 'system:syncData', 'success',
                        'âœ… æˆåŠŸè§¦å‘åŒæ­¥ï¼ˆé™çº§åˆ° mockï¼‰', result);
                } else {
                    addResult('æ•°æ®åŒæ­¥', 'system:syncData', 'error',
                        'âŒ è¿”å›çš„åŒæ­¥ç»“æœæ ¼å¼ä¸æ­£ç¡®', result);
                }
            } catch (error) {
                addResult('æ•°æ®åŒæ­¥', 'system:syncData', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testAppStart() {
            try {
                const result = await window.electronAPI.app.start();

                if (result && result.success === false && result.message) {
                    addResult('åº”ç”¨æ§åˆ¶', 'app:start', 'success',
                        'âœ… æ­£ç¡®è¿”å›å¤±è´¥ï¼ˆapp_instance ä¸å¯ç”¨ï¼‰', result);
                } else {
                    addResult('åº”ç”¨æ§åˆ¶', 'app:start', 'warning',
                        'âš ï¸ è¿”å›å€¼ä¸ç¬¦åˆé¢„æœŸ', result);
                }
            } catch (error) {
                addResult('åº”ç”¨æ§åˆ¶', 'app:start', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testAppStop() {
            try {
                const result = await window.electronAPI.app.stop();

                if (result && result.success === false && result.message) {
                    addResult('åº”ç”¨æ§åˆ¶', 'app:stop', 'success',
                        'âœ… æ­£ç¡®è¿”å›å¤±è´¥ï¼ˆapp_instance ä¸å¯ç”¨ï¼‰', result);
                } else {
                    addResult('åº”ç”¨æ§åˆ¶', 'app:stop', 'warning',
                        'âš ï¸ è¿”å›å€¼ä¸ç¬¦åˆé¢„æœŸ', result);
                }
            } catch (error) {
                addResult('åº”ç”¨æ§åˆ¶', 'app:stop', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testAppGetStatus() {
            try {
                const status = await window.electronAPI.app.getStatus();

                if (status && status.state === 'INIT' && status.isRunning === false) {
                    addResult('åº”ç”¨æ§åˆ¶', 'app:getStatus', 'success',
                        'âœ… æˆåŠŸè·å–åº”ç”¨çŠ¶æ€ï¼ˆé»˜è®¤å€¼ï¼‰', status);
                } else {
                    addResult('åº”ç”¨æ§åˆ¶', 'app:getStatus', 'warning',
                        'âš ï¸ è¿”å›çš„çŠ¶æ€ä¸ç¬¦åˆé¢„æœŸ', status);
                }
            } catch (error) {
                addResult('åº”ç”¨æ§åˆ¶', 'app:getStatus', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testWindowMinimize() {
            try {
                const result = await window.electronAPI.window.minimize();

                if (result && result.success === true) {
                    addResult('çª—å£æ§åˆ¶', 'window:minimize', 'success',
                        'âœ… çª—å£æœ€å°åŒ–æˆåŠŸï¼ˆçª—å£åº”è¯¥éšè—äº†ï¼‰');

                    // 2ç§’åæ¢å¤çª—å£
                    setTimeout(async () => {
                        await window.electronAPI.window.show();
                        addResult('çª—å£æ§åˆ¶', 'window:show', 'info',
                            'â„¹ï¸ çª—å£å·²æ¢å¤æ˜¾ç¤º');
                    }, 2000);
                } else {
                    addResult('çª—å£æ§åˆ¶', 'window:minimize', 'error',
                        'âŒ çª—å£æœ€å°åŒ–å¤±è´¥', result);
                }
            } catch (error) {
                addResult('çª—å£æ§åˆ¶', 'window:minimize', 'error',
                    `âŒ è°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }

        async function testEventListening() {
            addResult('äº‹ä»¶å¹¿æ’­', 'event-setup', 'info',
                'â„¹ï¸ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');

            // ç›‘å¬ FSM çŠ¶æ€å˜åŒ–
            const unsub1 = window.electronAPI.on('fsm-state-changed', (data) => {
                addResult('äº‹ä»¶å¹¿æ’­', 'fsm-state-changed', 'success',
                    'âœ… æ”¶åˆ° FSM çŠ¶æ€å˜åŒ–äº‹ä»¶', data);
            });

            // ç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–
            const unsub2 = window.electronAPI.on('device-status-changed', (data) => {
                addResult('äº‹ä»¶å¹¿æ’­', 'device-status-changed', 'success',
                    'âœ… æ”¶åˆ°è®¾å¤‡çŠ¶æ€å˜åŒ–äº‹ä»¶', data);
            });

            addResult('äº‹ä»¶å¹¿æ’­', 'event-setup', 'success',
                'âœ… äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®ï¼ˆå¦‚æœä¸»è¿›ç¨‹è§¦å‘äº‹ä»¶ï¼Œå°†æ˜¾ç¤ºåœ¨è¿™é‡Œï¼‰');

            // æ³¨æ„ï¼šæ¸…ç†ç›‘å¬å™¨
            window._testEventUnsubscribers = [unsub1, unsub2];
        }

        // ==================== è¿è¡Œæ‰€æœ‰æµ‹è¯• ====================

        async function runAllTests() {
            clearResults();

            addResult('æµ‹è¯•å¼€å§‹', 'info', 'info',
                'ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');

            // é…ç½®ç®¡ç†æµ‹è¯•
            await testGetConfig();

            // è®¾å¤‡ä¿¡æ¯æµ‹è¯•
            await testGetDeviceId();
            await testGetSystemInfo();

            // FSM çŠ¶æ€ç®¡ç†æµ‹è¯•
            await testFSMGetCurrentState();
            await testFSMForceTransition();

            // æ•°æ®åŒæ­¥æµ‹è¯•
            await testSyncData();

            // åº”ç”¨æ§åˆ¶æµ‹è¯•
            await testAppStart();
            await testAppStop();
            await testAppGetStatus();

            // çª—å£æ§åˆ¶æµ‹è¯•
            await testWindowMinimize();

            // äº‹ä»¶ç›‘å¬æµ‹è¯•
            await testEventListening();

            addResult('æµ‹è¯•å®Œæˆ', 'summary', 'success',
                `âœ… æ‰€æœ‰æµ‹è¯•å·²å®Œæˆï¼æ€»å…± ${totalTests} ä¸ªæµ‹è¯•ï¼Œé€šè¿‡ ${passedTests} ä¸ªï¼Œå¤±è´¥ ${failedTests} ä¸ª`);

            console.log('[TEST] æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }

        // ==================== é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯• ====================

        window.addEventListener('DOMContentLoaded', () => {
            console.log('[TEST] é¡µé¢åŠ è½½å®Œæˆ');
            addResult('åˆå§‹åŒ–', 'page-loaded', 'success',
                'âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½');

            // è‡ªåŠ¨è¿è¡Œæµ‹è¯•
            setTimeout(() => {
                runAllTests();
            }, 1000);
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('beforeunload', () => {
            if (window._testEventUnsubscribers) {
                window._testEventUnsubscribers.forEach(unsub => unsub());
            }
        });
    </script>
</body>
</html>
