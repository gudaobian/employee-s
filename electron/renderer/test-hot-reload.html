<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hot Reload Test - Phase 4-5</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .content {
      padding: 30px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 15px;
      color: #667eea;
    }

    .state-display {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .state-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .state-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .state-value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
    }

    .state-value.success {
      color: #28a745;
    }

    .state-value.error {
      color: #dc3545;
    }

    .state-value.warning {
      color: #ffc107;
    }

    .instructions {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .instructions h3 {
      color: #856404;
      margin-bottom: 10px;
    }

    .instructions ol {
      margin-left: 20px;
      color: #856404;
    }

    .instructions li {
      margin-bottom: 8px;
      line-height: 1.6;
    }

    .test-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
    }

    .log-display {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 3px;
    }

    .log-entry.info {
      color: #4fc3f7;
    }

    .log-entry.success {
      color: #81c784;
    }

    .log-entry.error {
      color: #e57373;
    }

    .log-entry.warning {
      color: #ffb74d;
    }

    .reload-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ffc107;
      color: #000;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
      display: none;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .reload-indicator.show {
      display: block;
    }

    .timestamp {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”¥ Hot Reload Test - Phase 4-5 âœ¨</h1>
      <p>æ¸²æŸ“è¿›ç¨‹çƒ­æ›´æ–°æœåŠ¡æµ‹è¯• - ç¬¬äºŒæ¬¡æµ‹è¯•</p>
    </div>

    <div class="content">
      <!-- è¯´æ˜ -->
      <div class="instructions">
        <h3>ğŸ“ æµ‹è¯•è¯´æ˜</h3>
        <ol>
          <li>æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—</li>
          <li>ä¿®æ”¹è¿™ä¸ª HTML æ–‡ä»¶ï¼ˆæ¯”å¦‚ä¿®æ”¹æ ‡é¢˜é¢œè‰²ã€æ–‡å­—ç­‰ï¼‰</li>
          <li>ä¿å­˜æ–‡ä»¶åï¼Œåº”ç”¨ä¼šåœ¨ 500ms åè‡ªåŠ¨é‡è½½</li>
          <li>é‡è½½åï¼Œè§‚å¯ŸçŠ¶æ€æ˜¯å¦æ­£ç¡®æ¢å¤</li>
          <li>æ£€æŸ¥é‡è½½è®¡æ•°å™¨æ˜¯å¦å¢åŠ </li>
        </ol>
      </div>

      <!-- é‡è½½çŠ¶æ€ -->
      <div class="section">
        <h2>ğŸ”„ é‡è½½çŠ¶æ€</h2>
        <div class="state-display">
          <div class="state-card">
            <h3>é‡è½½æ¬¡æ•°</h3>
            <div class="state-value" id="reload-count">0</div>
          </div>
          <div class="state-card">
            <h3>ä¸Šæ¬¡é‡è½½æ—¶é—´</h3>
            <div class="state-value" id="last-reload" style="font-size: 16px;">ä»æœªé‡è½½</div>
          </div>
          <div class="state-card">
            <h3>åº”ç”¨åˆå§‹åŒ–æ—¶é—´</h3>
            <div class="state-value" id="init-time" style="font-size: 16px;">åŠ è½½ä¸­...</div>
          </div>
        </div>
      </div>

      <!-- æœåŠ¡çŠ¶æ€ -->
      <div class="section">
        <h2>âš™ï¸ æœåŠ¡çŠ¶æ€</h2>
        <div class="state-display">
          <div class="state-card">
            <h3>FSM çŠ¶æ€</h3>
            <div class="state-value" id="fsm-state">INIT</div>
          </div>
          <div class="state-card">
            <h3>è®¤è¯çŠ¶æ€</h3>
            <div class="state-value" id="auth-state">æœªè®¤è¯</div>
          </div>
          <div class="state-card">
            <h3>æ•°æ®åŒæ­¥çŠ¶æ€</h3>
            <div class="state-value" id="sync-state">æœªåŒæ­¥</div>
          </div>
        </div>
      </div>

      <!-- æµ‹è¯•æ§åˆ¶ -->
      <div class="section">
        <h2>ğŸ® æµ‹è¯•æ§åˆ¶</h2>
        <div class="test-controls">
          <button class="btn btn-primary" onclick="testStateChange()">æ›´æ”¹ FSM çŠ¶æ€</button>
          <button class="btn btn-success" onclick="testAuthChange()">åˆ‡æ¢è®¤è¯çŠ¶æ€</button>
          <button class="btn btn-primary" onclick="testSyncChange()">è§¦å‘æ•°æ®åŒæ­¥</button>
          <button class="btn btn-danger" onclick="manualReload()">æ‰‹åŠ¨è§¦å‘é‡è½½</button>
        </div>
      </div>

      <!-- æ—¥å¿—æ˜¾ç¤º -->
      <div class="section">
        <h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
        <div class="log-display" id="log-display">
          <div class="log-entry info">[INFO] æ—¥å¿—ç³»ç»Ÿå·²å°±ç»ª</div>
        </div>
      </div>
    </div>
  </div>

  <!-- é‡è½½æŒ‡ç¤ºå™¨ -->
  <div class="reload-indicator" id="reload-indicator">
    ğŸ”„ å‡†å¤‡é‡è½½ä¸­...
  </div>

  <script>
    console.log('[TEST-HOT-RELOAD] Test page script loading...');

    // å…¨å±€çŠ¶æ€
    let reloadCount = 0;
    let lastReloadTime = null;
    let initTime = new Date();
    let mockFsmState = 'INIT';
    let mockAuthState = false;
    let mockSyncState = 'idle';

    // æ—¥å¿—å‡½æ•°
    function addLog(message, level = 'info') {
      const logDisplay = document.getElementById('log-display');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${level}`;
      entry.textContent = `[${timestamp}] ${message}`;
      logDisplay.appendChild(entry);
      logDisplay.scrollTop = logDisplay.scrollHeight;
      console.log(`[TEST-HOT-RELOAD] ${message}`);
    }

    // æ›´æ–°æ˜¾ç¤º
    function updateDisplay() {
      document.getElementById('reload-count').textContent = reloadCount;
      document.getElementById('last-reload').textContent =
        lastReloadTime ? lastReloadTime.toLocaleTimeString() : 'ä»æœªé‡è½½';
      document.getElementById('init-time').textContent = initTime.toLocaleTimeString();
      document.getElementById('fsm-state').textContent = mockFsmState;
      document.getElementById('auth-state').textContent = mockAuthState ? 'å·²è®¤è¯' : 'æœªè®¤è¯';
      document.getElementById('sync-state').textContent = mockSyncState;
    }

    // æ¢å¤çŠ¶æ€
    function restoreState() {
      try {
        const savedState = localStorage.getItem('app-state-backup');
        if (savedState) {
          const state = JSON.parse(savedState);

          // æ¢å¤é‡è½½è®¡æ•°
          reloadCount = (state.reloadCount || 0) + 1;
          lastReloadTime = new Date(state.timestamp);

          // æ¢å¤æ¨¡æ‹ŸçŠ¶æ€
          mockFsmState = state.mockFsmState || 'INIT';
          mockAuthState = state.mockAuthState || false;
          mockSyncState = state.mockSyncState || 'idle';

          addLog(`âœ… çŠ¶æ€å·²æ¢å¤ (é‡è½½ #${reloadCount})`, 'success');
          addLog(`FSM: ${mockFsmState}, Auth: ${mockAuthState}, Sync: ${mockSyncState}`, 'info');
        } else {
          addLog('â„¹ï¸ é¦–æ¬¡åŠ è½½ï¼Œæ— çŠ¶æ€éœ€è¦æ¢å¤', 'info');
        }
      } catch (error) {
        addLog(`âŒ çŠ¶æ€æ¢å¤å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // ä¿å­˜çŠ¶æ€
    function saveState() {
      try {
        const state = {
          reloadCount: reloadCount,
          timestamp: Date.now(),
          mockFsmState: mockFsmState,
          mockAuthState: mockAuthState,
          mockSyncState: mockSyncState
        };
        localStorage.setItem('app-state-backup', JSON.stringify(state));
        addLog('ğŸ’¾ çŠ¶æ€å·²ä¿å­˜', 'success');
      } catch (error) {
        addLog(`âŒ çŠ¶æ€ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æµ‹è¯•å‡½æ•°
    function testStateChange() {
      const states = ['INIT', 'HEARTBEAT', 'REGISTER', 'RUNNING', 'PAUSED'];
      const currentIndex = states.indexOf(mockFsmState);
      mockFsmState = states[(currentIndex + 1) % states.length];
      updateDisplay();
      saveState();
      addLog(`ğŸ”„ FSM çŠ¶æ€å·²æ›´æ”¹ä¸º: ${mockFsmState}`, 'info');
    }

    function testAuthChange() {
      mockAuthState = !mockAuthState;
      updateDisplay();
      saveState();
      addLog(`ğŸ” è®¤è¯çŠ¶æ€å·²åˆ‡æ¢ä¸º: ${mockAuthState ? 'å·²è®¤è¯' : 'æœªè®¤è¯'}`, 'info');
    }

    function testSyncChange() {
      const states = ['idle', 'syncing', 'success', 'error'];
      const currentIndex = states.indexOf(mockSyncState);
      mockSyncState = states[(currentIndex + 1) % states.length];
      updateDisplay();
      saveState();
      addLog(`ğŸ“¡ æ•°æ®åŒæ­¥çŠ¶æ€: ${mockSyncState}`, 'info');
    }

    function manualReload() {
      addLog('ğŸ”„ æ‰‹åŠ¨è§¦å‘é‡è½½...', 'warning');
      saveState();
      setTimeout(() => {
        location.reload();
      }, 500);
    }

    // ç›‘å¬çƒ­æ›´æ–°äº‹ä»¶
    if (window.electronAPI && window.electronAPI.on) {
      addLog('âœ… Electron API å·²å°±ç»ª', 'success');

      // ç›‘å¬é‡è½½é€šçŸ¥
      window.electronAPI.on('reload-renderer', () => {
        addLog('ğŸ”¥ æ”¶åˆ°çƒ­æ›´æ–°é€šçŸ¥ï¼Œå‡†å¤‡é‡è½½...', 'warning');

        // æ˜¾ç¤ºé‡è½½æŒ‡ç¤ºå™¨
        const indicator = document.getElementById('reload-indicator');
        indicator.classList.add('show');

        // ä¿å­˜çŠ¶æ€
        saveState();

        // æ³¨æ„ï¼šä¸éœ€è¦æ‰‹åŠ¨ reloadï¼Œä¸»è¿›ç¨‹ä¼šåœ¨ 100ms åè‡ªåŠ¨æ‰§è¡Œ
      });

      // ç›‘å¬æ—¥å¿—
      window.electronAPI.on('log:received', (data) => {
        addLog(`[MAIN] ${data.message}`, 'info');
      });
    } else {
      addLog('âš ï¸ Electron API ä¸å¯ç”¨ï¼Œå¯èƒ½ä¸åœ¨ Electron ç¯å¢ƒä¸­', 'warning');
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('DOMContentLoaded', () => {
      addLog('ğŸ“„ DOM åŠ è½½å®Œæˆ', 'info');

      // æ¢å¤çŠ¶æ€
      restoreState();

      // æ›´æ–°æ˜¾ç¤º
      updateDisplay();

      addLog('âœ… çƒ­æ›´æ–°æµ‹è¯•é¡µé¢å·²å°±ç»ª', 'success');
      addLog('â„¹ï¸ ä¿®æ”¹æ­¤ HTML æ–‡ä»¶å¹¶ä¿å­˜ï¼Œå°†è§¦å‘è‡ªåŠ¨é‡è½½', 'info');
    });

    // é¡µé¢å¸è½½å‰ä¿å­˜çŠ¶æ€
    window.addEventListener('beforeunload', () => {
      addLog('ğŸšª é¡µé¢å³å°†å¸è½½ï¼Œä¿å­˜çŠ¶æ€...', 'warning');
      saveState();
    });

    console.log('[TEST-HOT-RELOAD] Test page script loaded');
  </script>
</body>
</html>
