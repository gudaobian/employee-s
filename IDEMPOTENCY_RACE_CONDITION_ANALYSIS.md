# å¹‚ç­‰æ€§ä¸å¹¶å‘ç«æ€æ¡ä»¶æ·±åº¦åˆ†æ

## å‰è¨€ï¼šç”¨æˆ·æå‡ºçš„å…³é”®é—®é¢˜

ç”¨æˆ·æŒ‡å‡ºäº†å‡ ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. âœ… **å¹‚ç­‰æ€§åˆ¤æ–­å¿…é¡»åœ¨åç«¯**ï¼šå‰ç«¯æ— æ³•åˆ¤æ–­æ•°æ®æ˜¯å¦å·²ä¸Šä¼ 
2. âœ… **æ•°æ®åº“å†™å…¥æ—¶æœºé—®é¢˜**ï¼šå…ˆä¸Šä¼ OSSåå†™æ•°æ®åº“ä¼šå¯¼è‡´å¹¶å‘ç«æ€
3. âœ… **å¹¶å‘è¯·æ±‚é‡å¤æ’å…¥**ï¼šä¸¤ä¸ªç›¸åŒè¯·æ±‚åŒæ—¶åˆ°è¾¾ï¼Œéƒ½æ£€æŸ¥æ•°æ®åº“ä¸ºç©ºï¼Œéƒ½æ’å…¥ï¼Œå¯¼è‡´é‡å¤
4. âœ… **æ´»åŠ¨æ•°æ®é‡å¤åŸå› **ï¼šå®¢æˆ·ç«¯æ²¡æœ‰å¤šçº¿ç¨‹ï¼Œä½†ä»ç„¶å‡ºç°é‡å¤ â†’ è¶…æ—¶é‡è¯•å¯¼è‡´

**ç»“è®º**ï¼šç”¨æˆ·çš„åˆ†æå®Œå…¨æ­£ç¡®ï¼Œè¿™äº›éƒ½æ˜¯ç»å…¸çš„åˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜ã€‚

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šå¹‚ç­‰æ€§åˆ¤æ–­çš„ä½ç½®

### ä¸ºä»€ä¹ˆå‰ç«¯æ— æ³•åˆ¤æ–­å¹‚ç­‰æ€§ï¼Ÿ

#### å‰ç«¯çš„çŸ¥è¯†è¾¹ç•Œ

```
å®¢æˆ·ç«¯çŸ¥é“çš„ï¼š
- æˆ‘è¦ä¸Šä¼  screenshot_1766557428498
- è¿™ä¸ªæˆªå›¾å·²ç»åœ¨å†…å­˜é˜Ÿåˆ—/ç£ç›˜é˜Ÿåˆ—ä¸­
- æˆ‘ä¹‹å‰å‘é€è¿‡è¿™ä¸ªIDï¼ˆå¯èƒ½è¶…æ—¶æˆ–å¤±è´¥ï¼‰

å®¢æˆ·ç«¯ä¸çŸ¥é“çš„ï¼š
- è¿™ä¸ªæˆªå›¾æ˜¯å¦å·²ç»åœ¨æœåŠ¡å™¨æ•°æ®åº“ä¸­ â“
- è¿™ä¸ªæˆªå›¾æ˜¯å¦å·²ç»åœ¨OSSä¸­ â“
- ä¹‹å‰çš„ä¸Šä¼ æ˜¯å¦çœŸçš„æˆåŠŸäº† â“
```

#### å‰ç«¯çš„å±€é™æ€§

**åœºæ™¯1ï¼šç½‘ç»œè¶…æ—¶ä½†æœåŠ¡å™¨æˆåŠŸ**
```
å®¢æˆ·ç«¯è§†è§’ï¼š
T0: å‘é€ screenshot_A
T1-T30: ç­‰å¾…å“åº”...
T30: è¶…æ—¶ï¼è®¤ä¸ºå¤±è´¥
T31: åˆ¤æ–­ï¼šéœ€è¦é‡æ–°ä¸Šä¼ å—ï¼Ÿâ“

å®é™…æƒ…å†µï¼š
T0: å‘é€ screenshot_A
T1: æœåŠ¡å™¨æ¥æ”¶ âœ…
T2-T10: æœåŠ¡å™¨ä¸Šä¼ åˆ°OSS âœ…
T11: æœåŠ¡å™¨å†™å…¥æ•°æ®åº“ âœ…
T12: æœåŠ¡å™¨å‘é€å“åº”
T13: å“åº”åœ¨ç½‘ç»œä¸­ä¸¢å¤± âŒ
T30: å®¢æˆ·ç«¯è¶…æ—¶
```

**å®¢æˆ·ç«¯æ— æ³•çŸ¥é“**ï¼šæœåŠ¡å™¨æ˜¯å¦çœŸçš„æˆåŠŸäº†ã€‚

**åœºæ™¯2ï¼šå¤šè®¾å¤‡åŒæ—¶ä¸Šä¼ **
```
è®¾å¤‡Aï¼šä¸Šä¼  screenshot_Aï¼ˆå·²æˆåŠŸï¼‰
è®¾å¤‡Bï¼šä¸Šä¼  screenshot_Aï¼ˆç›¸åŒæˆªå›¾ï¼Œä¸åŒè®¾å¤‡ï¼‰

è®¾å¤‡Bçš„å®¢æˆ·ç«¯å¦‚ä½•çŸ¥é“è®¾å¤‡Aå·²ç»ä¸Šä¼ è¿‡ï¼Ÿ
ç­”æ¡ˆï¼šæ— æ³•çŸ¥é“ï¼åªæœ‰æœåŠ¡å™¨æœ‰å…¨å±€è§†å›¾ã€‚
```

**ç»“è®º**ï¼š
- âœ… å‰ç«¯åªèƒ½ç”Ÿæˆå”¯ä¸€IDå¹¶å‘é€
- âœ… åç«¯æ‰æ˜¯å¹‚ç­‰æ€§åˆ¤æ–­çš„å”¯ä¸€æƒå¨
- âœ… åç«¯éœ€è¦æŸ¥è¯¢æ•°æ®åº“/OSSåˆ¤æ–­æ˜¯å¦å·²å­˜åœ¨

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°æ®åº“å†™å…¥æ—¶æœºçš„ç«æ€æ¡ä»¶

### é”™è¯¯æµç¨‹1ï¼šå…ˆä¸Šä¼ OSSï¼Œåå†™æ•°æ®åº“

ç”¨æˆ·æŒ‡å‡ºçš„é—®é¢˜åœºæ™¯ï¼š

```
æ—¶é—´çº¿ï¼š
T0: è¯·æ±‚1åˆ°è¾¾åç«¯
    â†’ æŸ¥è¯¢æ•°æ®åº“ï¼šscreenshot_A ä¸å­˜åœ¨ âœ…
    â†’ å¼€å§‹ä¸Šä¼ åˆ°OSSï¼ˆè€—æ—¶10ç§’ï¼‰

T1: è¯·æ±‚2åˆ°è¾¾åç«¯ï¼ˆåŒä¸€ä¸ªscreenshot_Aï¼‰
    â†’ æŸ¥è¯¢æ•°æ®åº“ï¼šscreenshot_A ä¸å­˜åœ¨ âœ…ï¼ˆè¯·æ±‚1è¿˜æ²¡å†™æ•°æ®åº“ï¼ï¼‰
    â†’ å¼€å§‹ä¸Šä¼ åˆ°OSSï¼ˆå¹¶å‘æ‰§è¡Œï¼Œè€—æ—¶10ç§’ï¼‰

T10: è¯·æ±‚1 OSSä¸Šä¼ å®Œæˆ âœ…
     â†’ å†™å…¥æ•°æ®åº“ï¼šscreenshot_A âœ…

T11: è¯·æ±‚2 OSSä¸Šä¼ å®Œæˆ âœ…
     â†’ å†™å…¥æ•°æ®åº“ï¼šscreenshot_A âœ…ï¼ˆé‡å¤æ’å…¥ï¼ï¼‰

ç»“æœï¼š
- OSSå­˜å‚¨ï¼šscreenshot_A æ–‡ä»¶è¢«ä¸Šä¼ ä¸¤æ¬¡ï¼ˆæµªè´¹å­˜å‚¨ï¼‰
- æ•°æ®åº“ï¼šscreenshot_A æœ‰ä¸¤æ¡è®°å½•ï¼ˆæ•°æ®é‡å¤ï¼‰
```

**æ ¹æœ¬åŸå› **ï¼š
```
Check-Then-Act ç«æ€æ¡ä»¶ï¼ˆTOCTOU: Time-of-check to time-of-useï¼‰

Check: æŸ¥è¯¢æ•°æ®åº“æ˜¯å¦å­˜åœ¨
[æ—¶é—´é—´éš”] â† å¹¶å‘è¯·æ±‚å¯èƒ½åœ¨è¿™é‡Œè¿›å…¥ï¼
Act: ä¸Šä¼ OSS + å†™æ•°æ®åº“
```

è¿™æ˜¯**éåŸå­æ€§**æ“ä½œå¯¼è‡´çš„ã€‚

---

### é”™è¯¯æµç¨‹2ï¼šå…ˆå†™æ•°æ®åº“ï¼Œåä¸Šä¼ OSS

ç”¨æˆ·å»ºè®®ï¼šå…ˆå†™æ•°æ®åº“ï¼Œå†ä¸Šä¼ OSSã€‚

**è¿™ä¹Ÿæœ‰é—®é¢˜**ï¼

```
æ—¶é—´çº¿ï¼š
T0: è¯·æ±‚1åˆ°è¾¾
    â†’ æŸ¥è¯¢æ•°æ®åº“ï¼šscreenshot_A ä¸å­˜åœ¨ âœ…
    â†’ å†™å…¥æ•°æ®åº“ï¼šscreenshot_A âœ…

T1: è¯·æ±‚1å¼€å§‹ä¸Šä¼ OSSï¼ˆè€—æ—¶10ç§’ï¼‰

T2: è¯·æ±‚2åˆ°è¾¾
    â†’ æŸ¥è¯¢æ•°æ®åº“ï¼šscreenshot_A å·²å­˜åœ¨ âœ…
    â†’ å¹‚ç­‰æ€§æ£€æŸ¥é€šè¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ âœ…

T10: è¯·æ±‚1 OSSä¸Šä¼ å¤±è´¥ âŒï¼ˆç½‘ç»œé—®é¢˜ã€OSSæ•…éšœç­‰ï¼‰

æœ€ç»ˆçŠ¶æ€ï¼š
- æ•°æ®åº“ï¼šscreenshot_A å­˜åœ¨ âœ…
- OSSï¼šscreenshot_A ä¸å­˜åœ¨ âŒ
- æ•°æ®ä¸ä¸€è‡´ï¼
```

**é—®é¢˜**ï¼š
- æ•°æ®åº“è®°å½•äº†æˆªå›¾å­˜åœ¨
- ä½†å®é™…OSSä¸­æ²¡æœ‰æ–‡ä»¶
- åç»­æŸ¥è¯¢ä¼šè¿”å›ä¸€ä¸ªä¸å­˜åœ¨çš„OSS URL
- ç”¨æˆ·è®¿é—®æ—¶404é”™è¯¯

---

### æ­£ç¡®æµç¨‹ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ + çŠ¶æ€æœº

#### æ–¹æ¡ˆAï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + é‡è¯•æœºåˆ¶

**æ•°æ®åº“Schema**ï¼š
```sql
CREATE TABLE screenshots (
  id VARCHAR(255) PRIMARY KEY,  -- å”¯ä¸€çº¦æŸ
  device_id VARCHAR(255) NOT NULL,
  oss_key VARCHAR(512),
  oss_url VARCHAR(512),
  status VARCHAR(20) NOT NULL,  -- pending, uploading, completed, failed
  timestamp BIGINT NOT NULL,
  file_size INT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
);

CREATE UNIQUE INDEX idx_screenshots_id ON screenshots(id);
```

**åç«¯é€»è¾‘**ï¼š
```typescript
async handleScreenshotUpload(data) {
  const { screenshotId, buffer, timestamp, fileSize } = data;

  try {
    // âœ… åŸå­æ€§æ“ä½œï¼šæ•°æ®åº“æ’å…¥ï¼ˆå”¯ä¸€çº¦æŸä¿æŠ¤ï¼‰
    await db.screenshots.create({
      id: screenshotId,
      device_id: deviceId,
      oss_key: null,  // å…ˆä¸ºç©º
      oss_url: null,
      status: 'pending',  // å¾…ä¸Šä¼ 
      timestamp,
      file_size: fileSize
    });

    logger.info(`[Screenshot] æ’å…¥æ•°æ®åº“æˆåŠŸ: ${screenshotId}`);

  } catch (error) {
    // å”¯ä¸€çº¦æŸå†²çª â†’ å·²å­˜åœ¨
    if (error.code === 'ER_DUP_ENTRY' || error.code === '23505') {
      const existing = await db.screenshots.findOne({
        where: { id: screenshotId }
      });

      // æ£€æŸ¥çŠ¶æ€
      if (existing.status === 'completed') {
        logger.info(`[Idempotent] ${screenshotId} å·²å®Œæˆä¸Šä¼ ï¼Œè·³è¿‡`);
        return {
          success: true,
          duplicate: true,
          ossUrl: existing.oss_url
        };
      }

      if (existing.status === 'uploading') {
        logger.warn(`[Concurrent] ${screenshotId} æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œç­‰å¾…å®Œæˆ`);
        // è½®è¯¢æˆ–ç­‰å¾…çŠ¶æ€å˜æ›´
        return await this.waitForUploadComplete(screenshotId);
      }

      if (existing.status === 'failed') {
        logger.info(`[Retry] ${screenshotId} ä¹‹å‰å¤±è´¥ï¼Œé‡æ–°ä¸Šä¼ `);
        // ç»§ç»­ä¸‹é¢çš„ä¸Šä¼ æµç¨‹
      }
    } else {
      throw error;  // å…¶ä»–é”™è¯¯
    }
  }

  // âœ… æ›´æ–°çŠ¶æ€ä¸º"ä¸Šä¼ ä¸­"
  await db.screenshots.update(
    { status: 'uploading' },
    { where: { id: screenshotId } }
  );

  try {
    // âœ… ä¸Šä¼ åˆ°OSS
    const ossKey = `screenshots/${deviceId}/${screenshotId}.jpg`;
    const uploadResult = await ossService.upload(ossKey, buffer);

    // âœ… æ›´æ–°çŠ¶æ€ä¸º"å®Œæˆ"
    await db.screenshots.update(
      {
        status: 'completed',
        oss_key: ossKey,
        oss_url: uploadResult.url
      },
      { where: { id: screenshotId } }
    );

    logger.info(`[Screenshot] ä¸Šä¼ å®Œæˆ: ${screenshotId}`);

    return {
      success: true,
      screenshotId,
      ossUrl: uploadResult.url
    };

  } catch (error) {
    // âœ… OSSä¸Šä¼ å¤±è´¥ï¼Œæ ‡è®°ä¸ºå¤±è´¥çŠ¶æ€
    await db.screenshots.update(
      { status: 'failed' },
      { where: { id: screenshotId } }
    );

    logger.error(`[Screenshot] ä¸Šä¼ å¤±è´¥: ${screenshotId}`, error);
    throw error;
  }
}
```

**å¹¶å‘å¤„ç†**ï¼š
```
æ—¶é—´çº¿ï¼š
T0: è¯·æ±‚1åˆ°è¾¾
    â†’ æ’å…¥æ•°æ®åº“ï¼šscreenshot_A (status: pending) âœ…

T1: è¯·æ±‚2åˆ°è¾¾
    â†’ æ’å…¥æ•°æ®åº“ï¼šscreenshot_A âŒ å”¯ä¸€çº¦æŸå†²çª
    â†’ æŸ¥è¯¢çŠ¶æ€ï¼šstatus = 'pending' æˆ– 'uploading'
    â†’ ç­‰å¾…è¯·æ±‚1å®Œæˆ æˆ– ç›´æ¥è¿”å›æˆåŠŸ

T2: è¯·æ±‚1æ›´æ–°çŠ¶æ€ï¼šscreenshot_A (status: uploading)
    â†’ ä¸Šä¼ OSSï¼ˆ10ç§’ï¼‰

T12: è¯·æ±‚1ä¸Šä¼ å®Œæˆ
     â†’ æ›´æ–°çŠ¶æ€ï¼šscreenshot_A (status: completed, oss_url: ...)

ç»“æœï¼š
- æ•°æ®åº“ï¼šåªæœ‰ä¸€æ¡è®°å½• âœ…
- OSSï¼šåªæœ‰ä¸€ä¸ªæ–‡ä»¶ âœ…
- å¹‚ç­‰æ€§ï¼šè¯·æ±‚2è¢«æ­£ç¡®å¤„ç†ï¼ˆç­‰å¾…æˆ–ç›´æ¥è¿”å›ï¼‰âœ…
```

---

#### æ–¹æ¡ˆBï¼šåˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰

```typescript
async handleScreenshotUpload(data) {
  const { screenshotId, buffer } = data;
  const lockKey = `upload_lock:${screenshotId}`;

  // âœ… è·å–åˆ†å¸ƒå¼é”ï¼ˆ5ç§’è¿‡æœŸï¼‰
  const lock = await redis.set(lockKey, '1', 'EX', 5, 'NX');

  if (!lock) {
    // é”å·²è¢«å ç”¨ â†’ å…¶ä»–è¯·æ±‚æ­£åœ¨å¤„ç†
    logger.warn(`[Concurrent] ${screenshotId} æ­£åœ¨è¢«å…¶ä»–è¯·æ±‚å¤„ç†`);

    // ç­‰å¾…æˆ–è½®è¯¢
    await this.waitForLockRelease(lockKey);

    // æ£€æŸ¥ç»“æœ
    const existing = await db.screenshots.findOne({
      where: { id: screenshotId }
    });

    if (existing && existing.status === 'completed') {
      return { success: true, duplicate: true };
    }
  }

  try {
    // âœ… æŒæœ‰é”ï¼Œæ‰§è¡Œä¸Šä¼ 
    const existing = await db.screenshots.findOne({
      where: { id: screenshotId }
    });

    if (existing && existing.status === 'completed') {
      // å·²å®Œæˆï¼Œå¹‚ç­‰æ€§
      return { success: true, duplicate: true };
    }

    // ä¸Šä¼ æµç¨‹...
    await db.screenshots.create({ ... });
    await ossService.upload(...);

    return { success: true };

  } finally {
    // âœ… é‡Šæ”¾é”
    await redis.del(lockKey);
  }
}
```

**ä¼˜åŠ¿**ï¼š
- å®Œå…¨é¿å…å¹¶å‘ç«æ€
- åˆ†å¸ƒå¼ç¯å¢ƒé€‚ç”¨ï¼ˆå¤šä¸ªåç«¯å®ä¾‹ï¼‰

**ç¼ºç‚¹**ï¼š
- ä¾èµ–Redis
- é”è¿‡æœŸæ—¶é—´éš¾ä»¥è®¾ç½®ï¼ˆå¤ªçŸ­å¯èƒ½è¯¯é‡Šæ”¾ï¼Œå¤ªé•¿å½±å“æ€§èƒ½ï¼‰

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨æ•°æ®é‡å¤çš„æ ¹æœ¬åŸå› åˆ†æ

### ç”¨æˆ·çš„è§‚å¯Ÿ

> "æ´»åŠ¨æ•°æ®å‡ºç°å¤šæ¡ç›¸åŒè®°å½•æ’å…¥"
> "å®¢æˆ·ç«¯æ²¡æœ‰å¤šçº¿ç¨‹"

### å¯èƒ½åŸå› åˆ†æ

#### åŸå› 1ï¼šå®¢æˆ·ç«¯è¶…æ—¶é‡è¯•ï¼ˆæœ€å¯èƒ½ï¼‰

**è¯æ®**ï¼šä»ä¹‹å‰çš„æ—¥å¿—åˆ†æ

```
å®¢æˆ·ç«¯æ—¥å¿—ï¼ˆæ¨æµ‹ï¼‰ï¼š
2025-12-24T08:01:14.487Z å‘é€ activity_1766557428498
2025-12-24T08:01:44.487Z è¶…æ—¶ï¼ˆ30ç§’ï¼‰ï¼Œé‡æ–°å…¥é˜Ÿ
2025-12-24T08:02:14.487Z å†æ¬¡å‘é€ activity_1766557428498

åç«¯æ—¥å¿—ï¼ˆæ¨æµ‹ï¼‰ï¼š
2025-12-24T08:01:14.500Z æ¥æ”¶ activity_1766557428498
2025-12-24T08:01:14.510Z å†™å…¥æ•°æ®åº“ âœ…
2025-12-24T08:01:14.520Z å‘é€å“åº”
2025-12-24T08:01:14.530Z å“åº”ä¸¢å¤±ï¼ˆç½‘ç»œé—®é¢˜ï¼‰

2025-12-24T08:02:14.500Z æ¥æ”¶ activity_1766557428498ï¼ˆé‡å¤ï¼ï¼‰
2025-12-24T08:02:14.510Z å†™å…¥æ•°æ®åº“ âœ…ï¼ˆé‡å¤æ’å…¥ï¼ï¼‰
```

**å®Œæ•´æµç¨‹**ï¼š
```
T0: å®¢æˆ·ç«¯é‡‡é›†æ´»åŠ¨æ•°æ®
    â†’ ç”Ÿæˆ activity_1766557428498
    â†’ å…¥é˜Ÿ BoundedQueue

T1: UploadLoopå–å‡º
    â†’ è°ƒç”¨ uploadActivity()
    â†’ WebSocket.emit('client:activity', data)
    â†’ ç­‰å¾…å“åº”ï¼ˆ30ç§’è¶…æ—¶ï¼‰

T2: åç«¯æ¥æ”¶
    â†’ å¤„ç†æ´»åŠ¨æ•°æ®
    â†’ å†™å…¥æ•°æ®åº“ âœ…
    â†’ å‘é€å“åº”

T3: å“åº”åœ¨ç½‘ç»œä¸­ä¸¢å¤± âŒ
    æˆ– åç«¯å¤„ç†å¤ªæ…¢ï¼ˆ>30ç§’ï¼‰

T30: å®¢æˆ·ç«¯è¶…æ—¶
     â†’ è®¤ä¸ºå¤±è´¥
     â†’ é‡æ–°å…¥é˜Ÿ activity_1766557428498

T31: ä¸‹ä¸€è½®å¾ªç¯
     â†’ å†æ¬¡ä¸Šä¼  activity_1766557428498
     â†’ åç«¯å†æ¬¡æ¥æ”¶
     â†’ åç«¯æ²¡æœ‰å¹‚ç­‰æ€§æ£€æŸ¥ âŒ
     â†’ å†æ¬¡å†™å…¥æ•°æ®åº“ âœ…ï¼ˆé‡å¤ï¼ï¼‰
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹å®¢æˆ·ç«¯æ—¥å¿—ä¸­çš„é‡è¯•è®°å½•
grep "activity_" /tmp/app-console.log | grep "é‡æ–°å…¥é˜Ÿ"

# æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„é‡å¤ID
# å¦‚æœåŒä¸€ä¸ªactivityIdå‡ºç°å¤šæ¬¡ï¼Œè¯æ˜æ˜¯é‡å¤ä¸Šä¼ 
```

---

#### åŸå› 2ï¼šåç«¯æ²¡æœ‰å¹‚ç­‰æ€§æ£€æŸ¥

**å½“å‰åç«¯å®ç°ï¼ˆæ¨æµ‹ï¼‰**ï¼š
```typescript
socket.on('client:activity', async (data) => {
  const { activityId, type, timestamp, ...activityData } = data;

  // âŒ æ²¡æœ‰æ£€æŸ¥activityIdæ˜¯å¦å·²å­˜åœ¨ï¼
  await db.activities.create({
    id: activityId,
    device_id: deviceId,
    type,
    timestamp,
    data: activityData
  });

  callback(null, { success: true });
});
```

**é—®é¢˜**ï¼š
- æ¯æ¬¡æ¥æ”¶åˆ°æ•°æ®å°±ç›´æ¥æ’å…¥
- æ²¡æœ‰æ£€æŸ¥ `activityId` æ˜¯å¦å·²å­˜åœ¨
- å³ä½¿æ˜¯é‡å¤è¯·æ±‚ï¼Œä¹Ÿä¼šé‡å¤æ’å…¥

**åæœ**ï¼š
```
æ•°æ®åº“ï¼š
| id                        | type   | timestamp      | data               |
|---------------------------|--------|----------------|-------------------|
| activity_1766557428498    | click  | 1766557428498  | {url: "..."}      |
| activity_1766557428498    | click  | 1766557428498  | {url: "..."}      | â† é‡å¤ï¼
| activity_1766557428498    | click  | 1766557428498  | {url: "..."}      | â† é‡å¤ï¼

ç»Ÿè®¡ç»“æœï¼š
- ç‚¹å‡»æ¬¡æ•°ï¼š3æ¬¡
- å®é™…ç‚¹å‡»ï¼š1æ¬¡
- é”™è¯¯ç‡ï¼š200%
```

---

#### åŸå› 3ï¼šæ•°æ®åº“æ²¡æœ‰å”¯ä¸€çº¦æŸ

**å½“å‰æ•°æ®åº“Schemaï¼ˆæ¨æµ‹ï¼‰**ï¼š
```sql
CREATE TABLE activities (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,  -- âŒ è‡ªå¢ID
  device_id VARCHAR(255),
  type VARCHAR(50),
  timestamp BIGINT,
  data JSON
);
```

**é—®é¢˜**ï¼š
- `id` æ˜¯è‡ªå¢ä¸»é”®ï¼Œä¸æ˜¯ `activityId`
- æ²¡æœ‰å¯¹ `activityId` çš„å”¯ä¸€çº¦æŸ
- ç›¸åŒçš„ `activityId` å¯ä»¥æ’å…¥å¤šæ¬¡

**æ­£ç¡®Schema**ï¼š
```sql
CREATE TABLE activities (
  id VARCHAR(255) PRIMARY KEY,  -- âœ… activityIdä½œä¸ºä¸»é”®
  device_id VARCHAR(255) NOT NULL,
  type VARCHAR(50) NOT NULL,
  timestamp BIGINT NOT NULL,
  data JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_activities_id ON activities(id);  -- âœ… å”¯ä¸€çº¦æŸ
```

---

#### åŸå› 4ï¼šå®¢æˆ·ç«¯æ²¡æœ‰"ä¸Šä¼ ä¸­"çŠ¶æ€è·Ÿè¸ª

è™½ç„¶å®¢æˆ·ç«¯æ²¡æœ‰å¤šçº¿ç¨‹ï¼Œä½†æœ‰å¹¶å‘æ‰¹æ¬¡ï¼š

**å½“å‰å®ç°**ï¼š
```typescript
// upload-manager.ts
async uploadLoop() {
  while (this.uploading) {
    const batch = [];
    for (let i = 0; i < 5; i++) {
      const item = await queue.dequeue();  // å–å‡ºactivity_A
      batch.push(item);
    }

    // å¹¶å‘ä¸Šä¼ 
    await Promise.allSettled(
      batch.map(item => uploadActivity(item))
    );
  }
}
```

**æ½œåœ¨é—®é¢˜**ï¼š
```
T0: æ‰¹æ¬¡1å¼€å§‹
    â†’ å–å‡º activity_A
    â†’ ä¸Šä¼ ä¸­...

T1: æ‰¹æ¬¡1è¶…æ—¶ï¼ˆ30ç§’ï¼‰
    â†’ é‡æ–°å…¥é˜Ÿ activity_A

T2: æ‰¹æ¬¡2å¼€å§‹
    â†’ å–å‡º activity_Aï¼ˆåŒä¸€ä¸ªï¼ï¼‰
    â†’ ä¸Šä¼ ä¸­...ï¼ˆä¸æ‰¹æ¬¡1å¹¶å‘ï¼‰

ç»“æœï¼š
- æ‰¹æ¬¡1å’Œæ‰¹æ¬¡2åŒæ—¶ä¸Šä¼  activity_A
- ä¸¤ä¸ªå¹¶å‘è¯·æ±‚åˆ°è¾¾åç«¯
- åç«¯æ”¶åˆ°ä¸¤æ¬¡ï¼Œæ’å…¥ä¸¤æ¬¡
```

**ä½†æ˜¯**ï¼šæ ¹æ®ä¹‹å‰çš„ä»£ç ï¼Œæˆ‘å®ç°äº† `this.uploading` æ ‡å¿—ï¼Œåº”è¯¥ä¸ä¼šæœ‰å¤šä¸ªå¾ªç¯å¹¶å‘æ‰§è¡Œã€‚

**æ‰€ä»¥è¿™ä¸ªåŸå› ä¸å¤ªå¯èƒ½**ï¼Œé™¤éé˜Ÿåˆ—ä¸­æœ¬èº«å°±æœ‰é‡å¤çš„IDã€‚

---

### æ´»åŠ¨æ•°æ®é‡å¤çš„æœ€å¯èƒ½åŸå› 

**ç»“è®º**ï¼š

1. **ä¸»è¦åŸå› **ï¼šå®¢æˆ·ç«¯è¶…æ—¶é‡è¯• + åç«¯æ²¡æœ‰å¹‚ç­‰æ€§æ£€æŸ¥
   - å®¢æˆ·ç«¯ï¼š30ç§’è¶…æ—¶ â†’ é‡æ–°å…¥é˜Ÿ
   - åç«¯ï¼šå·²å¤„ç†æˆåŠŸï¼Œä½†å“åº”ä¸¢å¤±
   - å®¢æˆ·ç«¯ï¼šå†æ¬¡å‘é€
   - åç«¯ï¼šå†æ¬¡æ’å…¥ï¼ˆæ²¡æœ‰æ£€æŸ¥é‡å¤ï¼‰

2. **æ¬¡è¦åŸå› **ï¼šæ•°æ®åº“æ²¡æœ‰å”¯ä¸€çº¦æŸ
   - å³ä½¿åº”ç”¨å±‚æœ‰æ£€æŸ¥ï¼Œæ•°æ®åº“å±‚æ²¡æœ‰ä¿æŠ¤
   - å¹¶å‘è¯·æ±‚å¯èƒ½ç»•è¿‡åº”ç”¨å±‚æ£€æŸ¥

3. **éªŒè¯æ–¹æ³•**ï¼š
   ```sql
   -- æŸ¥è¯¢é‡å¤çš„activityId
   SELECT id, COUNT(*) as count
   FROM activities
   GROUP BY id
   HAVING COUNT(*) > 1;

   -- å¦‚æœæœ‰ç»“æœï¼Œè¯æ˜ç¡®å®æœ‰é‡å¤
   ```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå¹¶å‘ç«æ€æ¡ä»¶çš„ç»å…¸æ¨¡å¼

### TOCTOU (Time-of-check to time-of-use)

**å®šä¹‰**ï¼šåœ¨æ£€æŸ¥æŸä¸ªæ¡ä»¶å’Œä½¿ç”¨è¯¥æ¡ä»¶ä¹‹é—´å­˜åœ¨æ—¶é—´é—´éš”ï¼Œå¯¼è‡´å¹¶å‘é—®é¢˜ã€‚

**ç¤ºä¾‹**ï¼š
```typescript
// âŒ é”™è¯¯å®ç°
async handleUpload(data) {
  // Check: æ£€æŸ¥æ˜¯å¦å­˜åœ¨
  const exists = await db.findOne({ id: data.id });

  if (exists) {
    return { success: true, duplicate: true };
  }

  // [æ—¶é—´é—´éš”] â† å¹¶å‘è¯·æ±‚å¯èƒ½åœ¨è¿™é‡Œè¿›å…¥ï¼

  // Use: ä½¿ç”¨è¯¥æ¡ä»¶ï¼ˆæ’å…¥ï¼‰
  await db.insert({ id: data.id, ... });
  await ossService.upload(...);
}
```

**å¹¶å‘æ‰§è¡Œ**ï¼š
```
è¯·æ±‚1: Check (T0) â†’ ä¸å­˜åœ¨ â†’ [æš‚åœ] â†’ Insert (T2)
è¯·æ±‚2: Check (T1) â†’ ä¸å­˜åœ¨ï¼ˆè¯·æ±‚1è¿˜æ²¡Insertï¼‰ â†’ [æš‚åœ] â†’ Insert (T3) â† é‡å¤ï¼
```

---

### è§£å†³æ–¹æ¡ˆæ€»ç»“

#### æ–¹æ¡ˆ1ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸï¼ˆæ¨èï¼‰

```sql
CREATE UNIQUE INDEX ON table(id);
```

```typescript
try {
  await db.insert({ id: data.id, ... });
} catch (error) {
  if (error.code === 'ER_DUP_ENTRY') {
    // å¹‚ç­‰æ€§ï¼šå·²å­˜åœ¨ï¼Œè¿”å›æˆåŠŸ
    return { success: true, duplicate: true };
  }
}
```

**ä¼˜åŠ¿**ï¼š
- æ•°æ®åº“å±‚ä¿è¯åŸå­æ€§
- æ— éœ€é¢å¤–åŸºç¡€è®¾æ–½
- æ€§èƒ½å¥½

---

#### æ–¹æ¡ˆ2ï¼šåˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰

```typescript
const lock = await redis.set(`lock:${id}`, '1', 'EX', 5, 'NX');

if (!lock) {
  // å…¶ä»–è¯·æ±‚æ­£åœ¨å¤„ç†
  return await waitForCompletion(id);
}

try {
  // æ‰§è¡Œä¸Šä¼ é€»è¾‘
} finally {
  await redis.del(`lock:${id}`);
}
```

**ä¼˜åŠ¿**ï¼š
- å®Œå…¨é¿å…å¹¶å‘
- é€‚ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿ

**ç¼ºç‚¹**ï¼š
- ä¾èµ–Redis
- é”ç®¡ç†å¤æ‚

---

#### æ–¹æ¡ˆ3ï¼šæ•°æ®åº“äº‹åŠ¡ + æ‚²è§‚é”

```typescript
await db.transaction(async (tx) => {
  // SELECT ... FOR UPDATE (è¡Œçº§é”)
  const existing = await tx.screenshots.findOne({
    where: { id: screenshotId },
    lock: true  // æ‚²è§‚é”
  });

  if (existing) {
    return { success: true, duplicate: true };
  }

  // æ’å…¥ï¼ˆé”ä¿æŠ¤ï¼Œå…¶ä»–äº‹åŠ¡ç­‰å¾…ï¼‰
  await tx.screenshots.create({ id: screenshotId, ... });
});
```

**ä¼˜åŠ¿**ï¼š
- æ•°æ®åº“åŸç”Ÿæ”¯æŒ
- å¼ºä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š
- æ€§èƒ½è¾ƒå·®ï¼ˆé”ç­‰å¾…ï¼‰
- æ­»é”é£é™©

---

#### æ–¹æ¡ˆ4ï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰

```sql
CREATE TABLE screenshots (
  id VARCHAR(255) PRIMARY KEY,
  version INT NOT NULL DEFAULT 0,
  ...
);
```

```typescript
// æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
const updated = await db.screenshots.update(
  { oss_url: url, version: version + 1 },
  {
    where: {
      id: screenshotId,
      version: version  // åªæœ‰ç‰ˆæœ¬å·åŒ¹é…æ‰æ›´æ–°
    }
  }
);

if (updated === 0) {
  // ç‰ˆæœ¬å·ä¸åŒ¹é… â†’ å¹¶å‘å†²çª
  throw new Error('Concurrent update detected');
}
```

**ä¼˜åŠ¿**ï¼š
- æ— é”ï¼Œæ€§èƒ½å¥½
- æ£€æµ‹å¹¶å‘å†²çª

**ç¼ºç‚¹**ï¼š
- å†²çªåéœ€è¦é‡è¯•
- å®ç°å¤æ‚

---

## ç¬¬äº”éƒ¨åˆ†ï¼šæ¨èçš„å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ•°æ®åº“Schemaè®¾è®¡

```sql
-- æˆªå›¾è¡¨
CREATE TABLE screenshots (
  id VARCHAR(255) PRIMARY KEY,  -- screenshotId
  device_id VARCHAR(255) NOT NULL,
  oss_key VARCHAR(512),
  oss_url VARCHAR(512),
  status VARCHAR(20) NOT NULL,  -- pending, uploading, completed, failed
  timestamp BIGINT NOT NULL,
  file_size INT,
  retry_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW() ON UPDATE NOW()
);

CREATE UNIQUE INDEX idx_screenshots_id ON screenshots(id);
CREATE INDEX idx_screenshots_device_id ON screenshots(device_id);
CREATE INDEX idx_screenshots_status ON screenshots(status);

-- æ´»åŠ¨è¡¨
CREATE TABLE activities (
  id VARCHAR(255) PRIMARY KEY,  -- activityId
  device_id VARCHAR(255) NOT NULL,
  type VARCHAR(50) NOT NULL,
  timestamp BIGINT NOT NULL,
  data JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_activities_id ON activities(id);
CREATE INDEX idx_activities_device_id ON activities(device_id);
CREATE INDEX idx_activities_timestamp ON activities(timestamp);

-- è¿›ç¨‹è¡¨
CREATE TABLE processes (
  id VARCHAR(255) PRIMARY KEY,  -- processId
  device_id VARCHAR(255) NOT NULL,
  timestamp BIGINT NOT NULL,
  data JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_processes_id ON processes(id);
```

---

### åç«¯å¹‚ç­‰æ€§å®ç°

```typescript
// æˆªå›¾ä¸Šä¼ ï¼ˆå¸¦çŠ¶æ€æœºï¼‰
async handleScreenshotUpload(data) {
  const { screenshotId, buffer, timestamp, fileSize } = data;

  try {
    // âœ… å°è¯•æ’å…¥ï¼ˆå”¯ä¸€çº¦æŸä¿æŠ¤ï¼‰
    await db.screenshots.create({
      id: screenshotId,
      device_id: deviceId,
      status: 'pending',
      timestamp,
      file_size: fileSize
    });

  } catch (error) {
    if (error.code === 'ER_DUP_ENTRY' || error.code === '23505') {
      // å·²å­˜åœ¨ï¼Œæ£€æŸ¥çŠ¶æ€
      const existing = await db.screenshots.findOne({
        where: { id: screenshotId }
      });

      if (existing.status === 'completed') {
        // å¹‚ç­‰æ€§ï¼šå·²å®Œæˆ
        return { success: true, duplicate: true, ossUrl: existing.oss_url };
      }

      if (existing.status === 'uploading') {
        // æ­£åœ¨ä¸Šä¼ ï¼Œç­‰å¾…
        return await this.waitForCompletion(screenshotId, 30000);
      }

      if (existing.status === 'failed') {
        // å¤±è´¥ï¼Œå…è®¸é‡è¯•
        logger.info(`[Retry] ${screenshotId} é‡è¯•ä¸Šä¼ `);
      }
    } else {
      throw error;
    }
  }

  // æ›´æ–°çŠ¶æ€ï¼šuploading
  await db.screenshots.update(
    { status: 'uploading' },
    { where: { id: screenshotId } }
  );

  try {
    // ä¸Šä¼ OSS
    const ossKey = `screenshots/${deviceId}/${screenshotId}.jpg`;
    const uploadResult = await ossService.upload(ossKey, buffer);

    // æ›´æ–°çŠ¶æ€ï¼šcompleted
    await db.screenshots.update(
      {
        status: 'completed',
        oss_key: ossKey,
        oss_url: uploadResult.url
      },
      { where: { id: screenshotId } }
    );

    return { success: true, screenshotId, ossUrl: uploadResult.url };

  } catch (error) {
    // ä¸Šä¼ å¤±è´¥ï¼Œæ ‡è®°çŠ¶æ€
    await db.screenshots.update(
      {
        status: 'failed',
        retry_count: db.literal('retry_count + 1')
      },
      { where: { id: screenshotId } }
    );

    throw error;
  }
}

// æ´»åŠ¨æ•°æ®ä¸Šä¼ ï¼ˆç®€å•å¹‚ç­‰æ€§ï¼‰
async handleActivityUpload(data) {
  const { activityId, type, timestamp, ...activityData } = data;

  try {
    // âœ… å°è¯•æ’å…¥ï¼ˆå”¯ä¸€çº¦æŸä¿æŠ¤ï¼‰
    await db.activities.create({
      id: activityId,
      device_id: deviceId,
      type,
      timestamp,
      data: activityData
    });

    return { success: true };

  } catch (error) {
    if (error.code === 'ER_DUP_ENTRY' || error.code === '23505') {
      // å¹‚ç­‰æ€§ï¼šå·²å­˜åœ¨ï¼Œè¿”å›æˆåŠŸ
      logger.info(`[Idempotent] Activity ${activityId} already exists`);
      return { success: true, duplicate: true };
    }

    throw error;
  }
}
```

---

## æ€»ç»“

### å…³é”®ç»“è®º

1. âœ… **å¹‚ç­‰æ€§åˆ¤æ–­å¿…é¡»åœ¨åç«¯**
   - å‰ç«¯æ— æ³•çŸ¥é“æœåŠ¡å™¨çŠ¶æ€
   - åç«¯æ˜¯å”¯ä¸€æƒå¨æ•°æ®æº

2. âœ… **æ•°æ®åº“å†™å…¥æ—¶æœºæœ‰è®²ç©¶**
   - å…ˆä¸Šä¼ OSSåå†™æ•°æ®åº“ â†’ å¹¶å‘ç«æ€
   - å…ˆå†™æ•°æ®åº“åä¸Šä¼ OSS â†’ æ•°æ®ä¸ä¸€è‡´
   - æ­£ç¡®ï¼šå…ˆå†™æ•°æ®åº“ï¼ˆpendingçŠ¶æ€ï¼‰ â†’ ä¸Šä¼ OSS â†’ æ›´æ–°çŠ¶æ€ï¼ˆcompletedï¼‰

3. âœ… **å¹¶å‘ç«æ€æ¡ä»¶æ˜¯çœŸå®å­˜åœ¨çš„**
   - ä¸¤ä¸ªç›¸åŒè¯·æ±‚åŒæ—¶åˆ°è¾¾
   - éƒ½æ£€æŸ¥æ•°æ®åº“ä¸ºç©º
   - éƒ½æ’å…¥æ•°æ®
   - å¯¼è‡´é‡å¤

4. âœ… **æ´»åŠ¨æ•°æ®é‡å¤çš„åŸå› **
   - ä¸»è¦ï¼šå®¢æˆ·ç«¯è¶…æ—¶é‡è¯• + åç«¯æ— å¹‚ç­‰æ€§æ£€æŸ¥
   - æ¬¡è¦ï¼šæ•°æ®åº“æ— å”¯ä¸€çº¦æŸ
   - è§£å†³ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + åº”ç”¨å±‚å¹‚ç­‰æ€§æ£€æŸ¥

### æ¨èæ–¹æ¡ˆ

**æœ€ç®€å•æœ‰æ•ˆ**ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + Try-Catchå¤„ç†

**ä¼ä¸šçº§**ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + çŠ¶æ€æœº + åˆ†å¸ƒå¼é”ï¼ˆå¯é€‰ï¼‰

---

**ç‰ˆæœ¬**: v2.3.6-analysis
**æ—¥æœŸ**: 2025-12-24
**çŠ¶æ€**: ğŸ“Š æ·±åº¦åˆ†æå®Œæˆ
**ä¼˜å…ˆçº§**: ğŸ”´ **CRITICAL** - æ•°æ®å®Œæ•´æ€§é—®é¢˜
