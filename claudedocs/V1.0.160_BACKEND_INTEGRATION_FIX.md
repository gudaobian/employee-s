# v1.0.160 å‰åç«¯çƒ­æ›´æ–°é›†æˆä¿®å¤

**ä¿®å¤æ—¥æœŸ**: 2025-12-22
**ä¿®å¤ç‰ˆæœ¬**: 1.0.160
**é—®é¢˜**: å‰åç«¯å·®å¼‚åŒ…æ ¼å¼ä¸åŒ¹é…ï¼Œå¯¼è‡´çƒ­æ›´æ–°å¤±è´¥å›é€€å…¨é‡æ›´æ–°

---

## ğŸ”´ é—®é¢˜æ€»ç»“

### v1.0.159 æµ‹è¯•å¤±è´¥çš„åŸå› 

æµ‹è¯• 1.0.158 â†’ 1.0.159 çƒ­æ›´æ–°æ—¶å‡ºç°ï¼š

1. âŒ **çƒ­æ›´æ–°å¤±è´¥**: "å·®å¼‚æ¸…å•æ ¼å¼æ— æ•ˆ"
2. âŒ **å›é€€å…¨é‡æ›´æ–°**: ä¸‹è½½ 103.94 MB
3. âŒ **åº”ç”¨ç›´æ¥å…³é—­**: ä»£ç ç­¾åéªŒè¯å¤±è´¥

### æ ¹æœ¬åŸå› 

**å‰åç«¯åè®®ä¸åŒ¹é…**:

| é¡¹ç›® | å‰ç«¯æœŸæœ› | åç«¯å®é™… | é—®é¢˜ |
|------|---------|---------|------|
| æ¸…å•æ–‡ä»¶å | `manifest.json` | `metadata.json` | âŒ æ–‡ä»¶åä¸åŒ¹é… |
| å­—æ®µå | `version, changed, deleted` | `toVersion, changedFiles, deletedFiles` | âŒ å­—æ®µåä¸åŒ |
| æ–‡ä»¶ç›®å½• | `files/` | `changed/` | âŒ ç›®å½•ç»“æ„ä¸åŒ |
| ç¼ºå°‘å­—æ®µ | - | `fromVersion, timestamp` | âš ï¸ ç±»å‹ä¸å®Œæ•´ |

---

## ğŸ”§ åº”ç”¨çš„ä¿®å¤

### ä¿®å¤ 1: é€‚é…åç«¯å·®å¼‚åŒ…æ ¼å¼

**æ–‡ä»¶**: `src/common/services/hot-update/DiffApplier.ts`

#### ä¿®æ”¹ 1.1: æ”¯æŒä¸¤ç§æ¸…å•æ–‡ä»¶æ ¼å¼

```typescript
// ä¹‹å‰ï¼ˆåªæ”¯æŒå‰ç«¯æ ¼å¼ï¼‰
async readManifest(diffDir: string): Promise<DiffManifest> {
  const manifestPath = path.join(diffDir, 'manifest.json');
  const content = await fs.readJson(manifestPath);
  // ...
}

// ä¹‹åï¼ˆæ”¯æŒå‰ç«¯+åç«¯æ ¼å¼ï¼‰
async readManifest(diffDir: string): Promise<DiffManifest> {
  const manifestPath = path.join(diffDir, 'manifest.json');
  const metadataPath = path.join(diffDir, 'metadata.json');

  if (fs.existsSync(manifestPath)) {
    // å‰ç«¯æ ¼å¼
    content = await fs.readJson(manifestPath);
  } else if (fs.existsSync(metadataPath)) {
    // âœ… åç«¯æ ¼å¼ï¼ˆæ–°å¢ï¼‰
    content = await fs.readJson(metadataPath);
    isBackendFormat = true;
  }

  // è½¬æ¢åç«¯æ ¼å¼åˆ°å‰ç«¯æ ¼å¼
  if (isBackendFormat) {
    return {
      version: content.toVersion,
      fromVersion: content.fromVersion || '',
      toVersion: content.toVersion,
      changed: content.changedFiles || [],  // å­—æ®µæ˜ å°„
      deleted: content.deletedFiles || [],  // å­—æ®µæ˜ å°„
      timestamp: content.timestamp || new Date().toISOString()
    };
  }
}
```

**è§£å†³**:
- âœ… å…¼å®¹ `manifest.json` å’Œ `metadata.json`
- âœ… è‡ªåŠ¨è½¬æ¢å­—æ®µå (`changedFiles` â†’ `changed`, `deletedFiles` â†’ `deleted`)
- âœ… è¡¥å……ç¼ºå¤±å­—æ®µ (`fromVersion`, `timestamp`)

#### ä¿®æ”¹ 1.2: æ”¯æŒä¸¤ç§æ–‡ä»¶ç›®å½•ç»“æ„

```typescript
// ä¹‹å‰ï¼ˆåªæ”¯æŒ files/ï¼‰
const filesDir = path.join(diffDir, 'files');

// ä¹‹åï¼ˆæ”¯æŒ files/ å’Œ changed/ï¼‰
const frontendFilesDir = path.join(diffDir, 'files');
const backendFilesDir = path.join(diffDir, 'changed');

const filesDir = fs.existsSync(backendFilesDir)
  ? backendFilesDir   // âœ… åç«¯æ ¼å¼
  : frontendFilesDir; // å‰ç«¯æ ¼å¼
```

**è§£å†³**:
- âœ… è‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨æ­£ç¡®çš„ç›®å½•ï¼ˆ`changed/` æˆ– `files/`ï¼‰

---

### ä¿®å¤ 2: è·³è¿‡ä»£ç ç­¾åéªŒè¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**æ–‡ä»¶**: `electron/auto-update-integration.js:23-30`

```javascript
// è·³è¿‡ä»£ç ç­¾åéªŒè¯ï¼ˆå¼€å‘ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒï¼‰
// ç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨æ­£ç¡®ç­¾åçš„åº”ç”¨
if (!app.isPackaged || process.env.NODE_ENV === 'development' || process.env.SKIP_CODE_SIGN_VALIDATION === '1') {
  process.env.ELECTRON_UPDATER_ALLOW_UNSIGNED = '1';
  log.info('[AUTO_UPDATE] Code signature validation skipped (development/testing mode)');
} else {
  log.info('[AUTO_UPDATE] Code signature validation enabled (production mode)');
}
```

**è§£å†³**:
- âœ… å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒè‡ªåŠ¨è·³è¿‡ç­¾åéªŒè¯
- âœ… ç”Ÿäº§ç¯å¢ƒä¿æŒç­¾åéªŒè¯å¯ç”¨
- âœ… å¯é€šè¿‡ç¯å¢ƒå˜é‡ `SKIP_CODE_SIGN_VALIDATION=1` æ‰‹åŠ¨æ§åˆ¶

**è§¦å‘æ¡ä»¶**:
1. æœªæ‰“åŒ…åº”ç”¨ (`!app.isPackaged`)
2. å¼€å‘ç¯å¢ƒ (`NODE_ENV=development`)
3. æ˜¾å¼è®¾ç½®è·³è¿‡ (`SKIP_CODE_SIGN_VALIDATION=1`)

---

## ğŸ“‹ æµ‹è¯•å‰çš„å‡†å¤‡å·¥ä½œ

### æ­¥éª¤ 1: æ¸…ç†ç ´åç­¾åçš„å¤‡ä»½æ–‡ä»¶ âš ï¸

ä¹‹å‰çš„çƒ­æ›´æ–°å¤±è´¥ç•™ä¸‹äº† `app.asar.backup`ï¼Œè¿™ä¸ªæ–‡ä»¶ç ´åäº†åº”ç”¨çš„ä»£ç ç­¾åã€‚

**å¿…é¡»æ‰‹åŠ¨æ‰§è¡Œ**:

```bash
# åˆ é™¤ç ´åç­¾åçš„å¤‡ä»½æ–‡ä»¶
sudo rm -f /Applications/EmployeeSafety.app/Contents/Resources/app.asar.backup

# éªŒè¯ç­¾åä¿®å¤
codesign -vvv --deep --strict /Applications/EmployeeSafety.app 2>&1 | grep -i "fail\|invalid"
# åº”è¯¥æ²¡æœ‰è¾“å‡ºï¼ˆè¡¨ç¤ºç­¾åæ­£å¸¸ï¼‰
```

**å¦‚æœä¸åˆ é™¤**:
- âŒ å…¨é‡æ›´æ–°ä»ä¼šå¤±è´¥ï¼ˆä»£ç ç­¾åéªŒè¯ï¼‰
- âŒ åº”ç”¨ä¼šåœ¨ä¸‹è½½å®Œæˆåç›´æ¥å…³é—­

### æ­¥éª¤ 2: éƒ¨ç½² v1.0.160 åˆ°æœåŠ¡å™¨

ç¡®ä¿åç«¯å·²ç»ï¼š

1. âœ… ä¸Šä¼  `EmployeeSafety-1.0.160-arm64-mac.zip`
2. âœ… ç”Ÿæˆ 1.0.158 â†’ 1.0.160 çš„å·®å¼‚åŒ…
3. âœ… æ£€æŸ¥æ›´æ–°APIè¿”å›æ­£ç¡®çš„ `updateType: "hot"`

**éªŒè¯å‘½ä»¤**:

```bash
# æ£€æŸ¥ API å“åº”
curl "https://es-client-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/api/hot-update/check?currentVersion=1.0.158&platform=darwin&deviceId=xxx"

# æœŸæœ›è¿”å›ï¼š
{
  "success": true,
  "data": {
    "hasUpdate": true,
    "updateType": "hot",  # â† å…³é”®
    "version": "1.0.160",
    "manifest": {
      "diffUrl": "http://.../hot-updates/darwin/1.0.158-to-1.0.160/diff.tar.gz",
      ...
    }
  }
}
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•åœºæ™¯: 1.0.158 â†’ 1.0.160 çƒ­æ›´æ–°

**å½“å‰çŠ¶æ€**:
- å·²å®‰è£…ç‰ˆæœ¬: 1.0.158 (é»„è‰²æŒ‰é’®)
- ç›®æ ‡ç‰ˆæœ¬: 1.0.160 (ç°è‰²æŒ‰é’®)
- å·®å¼‚åŒ…: ~25KB (vs å…¨é‡ 103.94 MB)

**æµ‹è¯•æ­¥éª¤**:

1. âœ… **åˆ é™¤å¤‡ä»½æ–‡ä»¶** (è§æ­¥éª¤ 1)
2. âœ… **ç¡®è®¤å½“å‰ç‰ˆæœ¬**: 1.0.158ï¼Œé»„è‰²æŒ‰é’®
3. âœ… **ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"** æˆ–ç­‰å¾…è‡ªåŠ¨æ£€æµ‹
4. âœ… **è§‚å¯Ÿä¸‹è½½å¤§å°**: åº”è¯¥æ˜¯ ~25KBï¼Œå‡ ç§’å®Œæˆ
5. âœ… **ç­‰å¾…å¯¹è¯æ¡†**: "ç‰ˆæœ¬ 1.0.160 å·²ä¸‹è½½å®Œæˆ"
6. âœ… **ç‚¹å‡»"ç«‹å³é‡å¯"**
7. âœ… **éªŒè¯ç»“æœ**:
   - åº”ç”¨æ­£å¸¸é‡å¯
   - ç‰ˆæœ¬å·æ˜¾ç¤º 1.0.160
   - æŒ‰é’®å˜å›ç°è‰²

**å…³é”®æ—¥å¿—**:

```bash
# å®æ—¶æŸ¥çœ‹çƒ­æ›´æ–°æ—¥å¿—
tail -f ~/Library/Logs/employee-safety-client/update.log

# æœŸæœ›çœ‹åˆ°ï¼š
[HotUpdate] å‘ç°æ›´æ–°: 1.0.160 (hot)  â† updateTypeæ­£ç¡®
[HotUpdate] å¼€å§‹ä¸‹è½½å¹¶åº”ç”¨æ›´æ–°: 1.0.160
[HotUpdate] ä¸‹è½½å®Œæˆ,è€—æ—¶: ~200ms  â† å·®å¼‚åŒ…å¾ˆå°
[DiffApplier] ä½¿ç”¨åç«¯æ ¼å¼: metadata.json  â† âœ… æ ¼å¼é€‚é…
[DiffApplier] è½¬æ¢åç«¯æ ¼å¼åˆ°å‰ç«¯æ ¼å¼
[DiffApplier] ä½¿ç”¨æ–‡ä»¶ç›®å½•: .../changed  â† âœ… ç›®å½•é€‚é…
[HotUpdate] ASARè§£å‹æˆåŠŸ  â† âœ… v1.0.158ä¿®å¤æœ‰æ•ˆ
[HotUpdate] åº”ç”¨å·®å¼‚æˆåŠŸ
[HotUpdate] ç‰ˆæœ¬éªŒè¯é€šè¿‡: 1.0.160
[HotUpdate] çƒ­æ›´æ–°æˆåŠŸå®Œæˆ  â† âœ… å®Œæ•´æµç¨‹æˆåŠŸ
```

**å¤±è´¥æ—¶çš„æ—¥å¿—**:

```bash
# å¦‚æœä»ç„¶å¤±è´¥ï¼Œä¼šçœ‹åˆ°ï¼š
[HotUpdate] Error: å·®å¼‚æ¸…å•æ ¼å¼æ— æ•ˆ  â† metadata.jsonä»æœ‰é—®é¢˜
# æˆ–
[HotUpdate] Error: æºæ–‡ä»¶ä¸å­˜åœ¨  â† changed/ç›®å½•ç»“æ„é—®é¢˜
# æˆ–
[UPDATE] [CHECK] Hot update failed, fallback to full update  â† å›é€€å…¨é‡
```

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

âœ… **çƒ­æ›´æ–°æˆåŠŸ**:
1. ä¸‹è½½å¤§å° < 1MBï¼ˆå·®å¼‚åŒ…ï¼‰
2. æ—¥å¿—æ˜¾ç¤º `updateType: "hot"`
3. æ—¥å¿—æ˜¾ç¤º `ä½¿ç”¨åç«¯æ ¼å¼: metadata.json`
4. æ—¥å¿—æ˜¾ç¤º `ä½¿ç”¨æ–‡ä»¶ç›®å½•: .../changed`
5. åº”ç”¨æ­£å¸¸é‡å¯åˆ° 1.0.160
6. æŒ‰é’®é¢œè‰²ä»é»„è‰²å˜ç°è‰²

âŒ **ä»ç„¶å¤±è´¥**:
1. ä¸‹è½½ 103.94 MBï¼ˆå…¨é‡æ›´æ–°ï¼‰
2. æ—¥å¿—æ˜¾ç¤º `fallback to full update`
3. å·®å¼‚æ¸…å•æ ¼å¼é”™è¯¯
4. åº”ç”¨å…³é—­ï¼ˆç­¾åéªŒè¯å¤±è´¥ï¼‰

---

## ğŸ“ åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

### 1. è°ƒæ•´å¤‡ä»½ä½ç½®ï¼ˆé¿å…ç ´åç­¾åï¼‰

**å½“å‰é—®é¢˜**: å¤‡ä»½åˆ° `Resources/app.asar.backup` ç ´åä»£ç ç­¾å

**å»ºè®®ä¿®æ”¹**: `src/common/services/hot-update/AsarManager.ts`

```typescript
// å½“å‰ï¼ˆç ´åç­¾åï¼‰
const backupPath = path.join(resourcesPath, 'app.asar.backup');

// å»ºè®®ï¼ˆä¸ç ´åç­¾åï¼‰
const backupPath = path.join(
  app.getPath('userData'),  // ~/Library/Application Support/...
  'backups',
  'app.asar.backup'
);
```

### 2. å…¨é‡æ›´æ–°æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†

**å½“å‰é—®é¢˜**: å…¨é‡æ›´æ–°ä¸‹è½½å®Œæˆåç›´æ¥å…³é—­åº”ç”¨

**å»ºè®®ä¿®æ”¹**: `electron/auto-update-integration.js`

```javascript
// å½“å‰è¡Œä¸º
autoUpdater.on('update-downloaded', () => {
  // ç›´æ¥æ‰§è¡Œå®‰è£…
  executeAutoInstall();
});

// å»ºè®®è¡Œä¸º
autoUpdater.on('update-downloaded', () => {
  dialog.showMessageBox({
    title: 'æ›´æ–°å·²ä¸‹è½½',
    message: 'æ˜¯å¦ç«‹å³é‡å¯å®‰è£…ï¼Ÿ',
    buttons: ['ç«‹å³é‡å¯', 'ç¨åå®‰è£…']
  }).then(result => {
    if (result.response === 0) {
      executeAutoInstall();
    }
  });
});
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- v1.0.158 ESMä¿®å¤: `V1.0.158_ESM_IMPORT_FIX.md`
- å®Œæ•´æµ‹è¯•æŠ¥å‘Š: `V1.0.158_TESTING_REPORT.md`
- v1.0.156 ä¿®å¤: `V1.0.156_FIXES.md`

---

## ğŸ“ éœ€è¦åç«¯é…åˆçš„äº‹é¡¹

### å·²ç¡®è®¤ï¼ˆåç«¯å·²å®ç°ï¼‰âœ…

1. âœ… å·®å¼‚åŒ…è‡ªåŠ¨ç”Ÿæˆ
2. âœ… `/api/hot-update/check` APIæ”¯æŒ
3. âœ… `updateType` å­—æ®µå‡†ç¡®è¿”å›
4. âœ… å·®å¼‚åŒ…è·¯å¾„: `hot-updates/darwin/1.0.158-to-1.0.160/diff.tar.gz`
5. âœ… å·®å¼‚åŒ…æ ¼å¼: `metadata.json` + `changed/` ç›®å½•

### æµ‹è¯•æ—¶éœ€ç¡®è®¤ï¼ˆéƒ¨ç½²çŠ¶æ€ï¼‰âš ï¸

1. âš ï¸ v1.0.160 å·²ä¸Šä¼ åˆ°OSS
2. âš ï¸ 1.0.158 â†’ 1.0.160 å·®å¼‚åŒ…å·²ç”Ÿæˆ
3. âš ï¸ æ£€æŸ¥æ›´æ–°APIè¿”å› `updateType: "hot"`

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-22 14:30
**ä¸‹ä¸€æ­¥**: æ¸…ç†å¤‡ä»½æ–‡ä»¶ â†’ éƒ¨ç½² v1.0.160 â†’ æµ‹è¯•çƒ­æ›´æ–°æµç¨‹
