================================================================
快速调试指南 - 运行时getActiveURL错误
================================================================

如果诊断工具显示代码正确，但运行时仍报错，按以下步骤执行：

================================================================
步骤1：检查ASAR内容（最重要）
================================================================

目的：验证打包的app.asar中是否真的包含getActiveURL代码

执行：
------
1. 打开PowerShell（管理员）

2. 进入项目目录：
   cd C:\path\to\employee-client

3. 运行脚本：
   .\claudedocs\check-asar-contents.ps1

期望结果：
---------
[OK] Contains getActiveURL method
[OK] Contains VERSION: 1.0.78-with-url-collection
[OK] url-collector.js exists

如果看到 [ERROR]：
-----------------
→ 问题：GitHub Actions打包有问题
→ 解决：需要重新构建release或使用本地构建

================================================================
步骤2：测试运行时方法（如果步骤1通过）
================================================================

目的：验证运行时是否能正确加载WindowsAdapter和getActiveURL

执行：
------
1. 打开命令提示符或PowerShell

2. 进入应用安装目录：
   cd C:\Users\张小鱼\AppData\Local\Programs\EmployeeSafety\resources

3. 复制调试脚本到这个目录：
   copy C:\path\to\employee-client\claudedocs\debug-runtime-methods.js .

4. 运行脚本：
   node debug-runtime-methods.js

期望结果：
---------
[OK] WindowsAdapter imported successfully
[OK] WindowsAdapter instantiated
VERSION: 1.0.78-with-url-collection
[OK] getActiveURL is callable
[OK] WindowsURLCollector imported

如果看到错误：
-------------
→ "Cannot find module './url-collector'"
   → 问题：动态导入路径错误
   → 解决：改用静态导入（见修复方案A）

→ "getActiveURL is NOT callable"
   → 问题：方法在运行时丢失
   → 解决：检查原型链（见修复方案B）

================================================================
步骤3：检查实际运行日志
================================================================

目的：查看应用实际运行时的错误信息

执行：
------
1. 停止应用（如果正在运行）：
   taskkill /F /IM EmployeeSafety.exe

2. 清空日志目录：
   del /Q %APPDATA%\employee-monitor\logs\*.*

3. 启动应用

4. 等待30秒（让应用完全启动）

5. 查看日志：
   cd %APPDATA%\employee-monitor\logs
   type *.log | findstr /i "WindowsAdapter getActiveURL VERSION"

期望看到：
---------
[WindowsAdapter] Constructor called - VERSION: 1.0.78-with-url-collection
[URLCollector] Platform adapter version: 1.0.78-with-url-collection
[URLCollector] getActiveURL method exists: true

如果看到：
---------
[URLCollector] Platform adapter version: UNKNOWN
[URLCollector] getActiveURL method exists: false
→ 说明运行的还是旧版本！

================================================================
常见问题诊断结果
================================================================

情况A：步骤1失败（ASAR中缺少getActiveURL）
----------------------------------------
原因：GitHub Actions打包问题或electron-builder配置错误

解决方案：
1. 检查electron-builder.yml中的asarUnpack配置
2. 重新运行GitHub Actions构建
3. 或者使用本地构建：npm run pack:win

情况B：步骤1通过，步骤2失败（运行时导入失败）
------------------------------------------
原因：动态import在ASAR打包后路径解析有问题

解决方案：
修改 platforms/windows/windows-adapter.ts

将第1191行的动态导入：
  const { WindowsURLCollector } = await import('./url-collector');

改为文件顶部的静态导入：
  import { WindowsURLCollector } from './url-collector';

然后重新编译和打包。

情况C：步骤1和2都通过，但步骤3仍显示UNKNOWN
-------------------------------------------
原因：应用缓存或多版本共存

解决方案：
1. 完全卸载应用
2. 删除所有残留文件：
   Remove-Item "$env:LOCALAPPDATA\Programs\EmployeeSafety" -Recurse -Force
   Remove-Item "$env:APPDATA\employee-monitor" -Recurse -Force
3. 重启计算机
4. 重新安装

情况D：诊断工具显示正确，运行时也正确，但仍报错
----------------------------------------------
原因：时序问题或特定条件下触发的bug

解决方案：
1. 查看完整日志找到具体错误堆栈
2. 检查是否在特定浏览器触发
3. 检查UI Automation权限
4. 查看是否有其他错误先发生

================================================================
获取更多帮助
================================================================

如果以上步骤都无法解决问题，请收集以下信息：

1. 步骤1的完整输出（check-asar-contents.ps1）
2. 步骤2的完整输出（debug-runtime-methods.js）
3. 步骤3的完整日志文件：
   %APPDATA%\employee-monitor\logs\*.log

4. 系统信息：
   - Windows版本：winver
   - Node.js版本：node --version
   - npm版本：npm --version

5. 应用版本信息：
   - 从哪里下载的（GitHub release链接）
   - 下载时间
   - 安装包文件名

然后提交Issue到：
https://github.com/zhangxiaoyu2000/employee-s/issues

================================================================
