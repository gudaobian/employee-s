# æ·±åº¦è°ƒè¯•æ–¹æ¡ˆ - è¿è¡Œæ—¶getActiveURLé”™è¯¯

**åœºæ™¯**ï¼šè¯Šæ–­å·¥å…·æ˜¾ç¤ºä»£ç æ­£ç¡®ï¼Œä½†è¿è¡Œæ—¶ä»æŠ¥é”™ `getActiveURL method not found`

---

## ğŸ” é—®é¢˜å‡è®¾

### å‡è®¾1ï¼šåŠ¨æ€å¯¼å…¥å¤±è´¥ï¼ˆæ¦‚ç‡ï¼š40%ï¼‰

**é—®é¢˜æè¿°**ï¼š
- WindowsAdapterä½¿ç”¨åŠ¨æ€importåŠ è½½url-collector
- ASARæ‰“åŒ…åï¼ŒåŠ¨æ€importè·¯å¾„è§£æå¯èƒ½å¤±è´¥
- ç¼–è¯‘åä»£ç ï¼š`require('./url-collector')`

**éªŒè¯æ–¹æ³•**ï¼š

#### æ­¥éª¤1ï¼šæ£€æŸ¥æ¨¡å—åŠ è½½æ—¥å¿—
```powershell
# æŸ¥çœ‹æ˜¯å¦æœ‰æ¨¡å—åŠ è½½é”™è¯¯
$logPath = "$env:APPDATA\employee-monitor\logs"
Get-ChildItem $logPath -Filter "*.log" |
  Sort-Object LastWriteTime -Descending |
  Select-Object -First 1 |
  Get-Content |
  Select-String "url-collector|MODULE_NOT_FOUND|Cannot find module"
```

#### æ­¥éª¤2ï¼šæ‰‹åŠ¨æµ‹è¯•åŠ¨æ€å¯¼å…¥
åˆ›å»ºæµ‹è¯•è„šæœ¬ `test-dynamic-import.js`ï¼š

```javascript
// æµ‹è¯•åŠ¨æ€å¯¼å…¥æ˜¯å¦å·¥ä½œ
const path = require('path');

async function testImport() {
  try {
    console.log('Testing dynamic import...');

    // æµ‹è¯•ç›¸å¯¹è·¯å¾„å¯¼å…¥
    const urlCollectorPath = path.join(__dirname, 'dist/platforms/windows/url-collector');
    console.log('Import path:', urlCollectorPath);

    const { WindowsURLCollector } = require(urlCollectorPath);
    console.log('âœ… Import successful!');
    console.log('WindowsURLCollector:', typeof WindowsURLCollector);

    const collector = new WindowsURLCollector();
    console.log('âœ… Instantiation successful!');
    console.log('getActiveURL method:', typeof collector.getActiveURL);

  } catch (error) {
    console.error('âŒ Import failed:', error);
    console.error('Error stack:', error.stack);
  }
}

testImport();
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
cd C:\Users\å¼ å°é±¼\AppData\Local\Programs\EmployeeSafety\resources
node test-dynamic-import.js
```

### å‡è®¾2ï¼šåŸå‹é“¾æ±¡æŸ“/æ–¹æ³•è¦†ç›–ï¼ˆæ¦‚ç‡ï¼š25%ï¼‰

**é—®é¢˜æè¿°**ï¼š
- WindowsAdapterçš„æ–¹æ³•åœ¨è¿è¡Œæ—¶è¢«è¦†ç›–
- å¯èƒ½æ˜¯åŸºç±»ï¼ˆPlatformAdapterBaseï¼‰çš„é—®é¢˜
- æˆ–è€…å®ä¾‹åŒ–è¿‡ç¨‹ä¸­çš„é—®é¢˜

**éªŒè¯æ–¹æ³•**ï¼š

#### æ­¥éª¤1ï¼šæ£€æŸ¥å®ä¾‹åŒ–æ—¥å¿—
```powershell
# æŸ¥æ‰¾WindowsAdapterå®ä¾‹åŒ–ç›¸å…³æ—¥å¿—
$logPath = "$env:APPDATA\employee-monitor\logs"
Get-ChildItem $logPath -Filter "*.log" |
  Sort-Object LastWriteTime -Descending |
  Select-Object -First 1 |
  Get-Content |
  Select-String "WindowsAdapter|Constructor called|VERSION"
```

#### æ­¥éª¤2ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—
åœ¨ `platforms/windows/windows-adapter.ts` æ„é€ å‡½æ•°ä¸­æ·»åŠ ï¼š

```typescript
constructor() {
  super();
  this.permissionChecker = new WindowsPermissionChecker();

  // ğŸ” è°ƒè¯•æ—¥å¿—ï¼šéªŒè¯æ–¹æ³•å­˜åœ¨æ€§
  logger.info(`[WindowsAdapter] Constructor called - VERSION: ${this.VERSION}`);
  logger.info(`[WindowsAdapter] getActiveURL method type: ${typeof this.getActiveURL}`);
  logger.info(`[WindowsAdapter] All methods:`, Object.getOwnPropertyNames(Object.getPrototypeOf(this)));
}
```

é‡æ–°ç¼–è¯‘å¹¶æ‰“åŒ…æµ‹è¯•ã€‚

### å‡è®¾3ï¼šGitHub Actionsæ‰“åŒ…é—®é¢˜ï¼ˆæ¦‚ç‡ï¼š20%ï¼‰

**é—®é¢˜æè¿°**ï¼š
- æœ¬åœ°distç›®å½•æ˜¯æ­£ç¡®çš„
- ä½†GitHub Actionsæ‰“åŒ…çš„NSISå¯èƒ½æœ‰ç¼“å­˜
- electron-builderä½¿ç”¨äº†æ—§çš„ç¼“å­˜

**éªŒè¯æ–¹æ³•**ï¼š

#### æ­¥éª¤1ï¼šå¯¹æ¯”æœ¬åœ°ç¼–è¯‘å’ŒGitHub Release
```bash
# 1. æœ¬åœ°ç¼–è¯‘
npm run clean
npm run compile

# 2. è®¡ç®—æœ¬åœ°æ–‡ä»¶å“ˆå¸Œ
sha256sum dist/platforms/windows/windows-adapter.js

# 3. ä¸‹è½½GitHub releaseå¹¶è§£åŒ…
# (å‚è€ƒä¹‹å‰çš„éªŒè¯æ­¥éª¤)

# 4. è®¡ç®—releaseä¸­çš„å“ˆå¸Œ
sha256sum temp-release-extracted/dist/platforms/windows/windows-adapter.js

# 5. å¯¹æ¯”ä¸¤ä¸ªå“ˆå¸Œå€¼
```

#### æ­¥éª¤2ï¼šæ£€æŸ¥GitHub Actionsæ—¥å¿—

è®¿é—®ï¼š
```
https://github.com/zhangxiaoyu2000/employee-s/actions
```

æ£€æŸ¥æœ€è¿‘çš„æ„å»ºï¼ˆv1.0.81ï¼‰ï¼š
- "Verify compiled WindowsAdapter has getActiveURL" æ­¥éª¤
- "Verify NSIS installer contains getActiveURL" æ­¥éª¤
- æ˜¯å¦æ‰€æœ‰SHA256å“ˆå¸ŒéªŒè¯éƒ½é€šè¿‡

### å‡è®¾4ï¼šASARæ‰“åŒ…è·¯å¾„é—®é¢˜ï¼ˆæ¦‚ç‡ï¼š15%ï¼‰

**é—®é¢˜æè¿°**ï¼š
- electron-builderå°†ä»£ç æ‰“åŒ…åˆ°app.asar
- åŠ¨æ€requireåœ¨ASARä¸­çš„è·¯å¾„è§£æä¸åŒ
- asarUnpacké…ç½®å¯èƒ½æœ‰é—®é¢˜

**éªŒè¯æ–¹æ³•**ï¼š

#### æ­¥éª¤1ï¼šæ£€æŸ¥electron-builder.ymlé…ç½®
```yaml
asarUnpack:
  - dist/**/*              # âœ… åº”è¯¥åŒ…å«è¿™ä¸ª
  - native-event-monitor/**/*
  - native-event-monitor-win/**/*
```

#### æ­¥éª¤2ï¼šéªŒè¯distæ˜¯å¦çœŸçš„unpacked
```powershell
# æ£€æŸ¥app.asar.unpackedç›®å½•
$unpackedPath = "C:\Users\å¼ å°é±¼\AppData\Local\Programs\EmployeeSafety\resources\app.asar.unpacked"

if (Test-Path $unpackedPath) {
    Write-Host "âœ… app.asar.unpacked exists"

    # æ£€æŸ¥distç›®å½•
    if (Test-Path "$unpackedPath\dist") {
        Write-Host "âœ… dist/ is unpacked"

        # æ£€æŸ¥WindowsAdapter
        $adapterPath = "$unpackedPath\dist\platforms\windows\windows-adapter.js"
        if (Test-Path $adapterPath) {
            Write-Host "âœ… WindowsAdapter is unpacked"

            # æ£€æŸ¥æ˜¯å¦åŒ…å«getActiveURL
            $content = Get-Content $adapterPath -Raw
            if ($content -match "getActiveURL") {
                Write-Host "âœ… getActiveURL found in unpacked file"
            } else {
                Write-Host "âŒ getActiveURL NOT found in unpacked file"
            }
        }
    } else {
        Write-Host "âŒ dist/ is NOT unpacked (packed in asar)"
        Write-Host "This is the problem! Need to fix electron-builder.yml"
    }
} else {
    Write-Host "âš ï¸ No app.asar.unpacked directory"
    Write-Host "All files are packed in asar"
}
```

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ”¹ç”¨é™æ€å¯¼å…¥ï¼ˆæ¨èï¼‰

**é—®é¢˜**ï¼šåŠ¨æ€importåœ¨ASARä¸­ä¸å¯é 

**è§£å†³**ï¼šæ”¹ä¸ºé™æ€å¯¼å…¥

ä¿®æ”¹ `platforms/windows/windows-adapter.ts`:

```typescript
// âŒ æ—§ä»£ç ï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰
async getActiveURL(browserName: string): Promise<string | null> {
  try {
    // åŠ¨æ€å¯¼å…¥ URL é‡‡é›†å™¨
    const { WindowsURLCollector } = await import('./url-collector');
    const collector = new WindowsURLCollector();
    // ...
  }
}

// âœ… æ–°ä»£ç ï¼ˆé™æ€å¯¼å…¥ï¼‰
import { WindowsURLCollector } from './url-collector';  // æ–‡ä»¶é¡¶éƒ¨

async getActiveURL(browserName: string): Promise<string | null> {
  try {
    logger.info(`[Windows] Starting URL collection for browser: ${browserName}`);

    // ç›´æ¥ä½¿ç”¨é™æ€å¯¼å…¥çš„ç±»
    const collector = new WindowsURLCollector();

    // å°†æµè§ˆå™¨æ˜¾ç¤ºåè½¬æ¢ä¸ºè¿›ç¨‹å
    const processName = this.browserNameToProcessName(browserName);
    // ...
  }
}
```

**ä¸ºä»€ä¹ˆåŠ¨æ€å¯¼å…¥åœ¨è¿™é‡Œä¸æ˜¯å¿…éœ€çš„**ï¼š
- WindowsURLCollectorä¸æ˜¯å¤§å‹æ¨¡å—
- æ²¡æœ‰å¾ªç¯ä¾èµ–é—®é¢˜
- é™æ€å¯¼å…¥æ›´å¯é ï¼Œæ‰“åŒ…åè·¯å¾„ä¸ä¼šå‡ºé”™

### æ–¹æ¡ˆBï¼šä¿®å¤åŠ¨æ€å¯¼å…¥è·¯å¾„

å¦‚æœå¿…é¡»ä½¿ç”¨åŠ¨æ€å¯¼å…¥ï¼Œä½¿ç”¨ç»å¯¹è·¯å¾„ï¼š

```typescript
async getActiveURL(browserName: string): Promise<string | null> {
  try {
    // ä½¿ç”¨ç»å¯¹è·¯å¾„
    const modulePath = require.resolve('./url-collector');
    const { WindowsURLCollector } = await import(modulePath);

    // æˆ–è€…ä½¿ç”¨ requireï¼ˆæ›´å¯é ï¼‰
    const { WindowsURLCollector } = require('./url-collector');

    const collector = new WindowsURLCollector();
    // ...
  }
}
```

### æ–¹æ¡ˆCï¼šæ·»åŠ è¿è¡Œæ—¶éªŒè¯å’Œé™çº§

å³ä½¿æ–¹æ³•ä¸å­˜åœ¨ä¹Ÿä¸å´©æºƒï¼š

```typescript
async getActiveURL(browserName: string): Promise<string | null> {
  try {
    // éªŒè¯æ–¹æ³•æ˜¯å¦å­˜åœ¨
    if (typeof this.getActiveURL !== 'function') {
      logger.error('[Windows] getActiveURL method not found on this instance!');
      logger.error('[Windows] This should never happen!');
      return null;
    }

    // åŠ¨æ€å¯¼å…¥ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
    let WindowsURLCollector;
    try {
      const module = await import('./url-collector');
      WindowsURLCollector = module.WindowsURLCollector;
    } catch (importError) {
      logger.error('[Windows] Failed to import url-collector:', importError);

      // å°è¯•ä½¿ç”¨requireä½œä¸ºé™çº§
      try {
        WindowsURLCollector = require('./url-collector').WindowsURLCollector;
      } catch (requireError) {
        logger.error('[Windows] Failed to require url-collector:', requireError);
        return null;
      }
    }

    const collector = new WindowsURLCollector();
    // ...
  } catch (error) {
    logger.error('[Windows] Failed to get active URL:', error);
    return null;
  }
}
```

### æ–¹æ¡ˆDï¼šç¡®ä¿electron-builderæ­£ç¡®é…ç½®

ä¿®æ”¹ `electron-builder.yml`:

```yaml
# ç¡®ä¿distç›®å½•ä¸è¢«æ‰“åŒ…åˆ°asarï¼ˆæˆ–è€…å®Œå…¨unpackedï¼‰
asarUnpack:
  - "dist/**/*"
  - "native-event-monitor/**/*"
  - "native-event-monitor-win/**/*"
  - "node_modules/screenshot-desktop/**/*"

# æˆ–è€…å¹²è„†ä¸ä½¿ç”¨asar
asar: false  # ä¸æ¨èï¼Œä½†å¯ä»¥æµ‹è¯•

# æˆ–è€…åªåœ¨å¼€å‘ç¯å¢ƒä¸ä½¿ç”¨asar
afterPack: |
  # éªŒè¯unpackedæ–‡ä»¶
```

---

## ğŸ§ª è°ƒè¯•å·¥å…·è„šæœ¬

### 1. è¿è¡Œæ—¶æ–¹æ³•æ£€æµ‹è„šæœ¬

åˆ›å»º `claudedocs/debug-runtime-methods.js`:

```javascript
/**
 * è¿è¡Œæ—¶æ–¹æ³•æ£€æµ‹å·¥å…·
 * åœ¨åº”ç”¨å¯åŠ¨æ—¶è¿è¡Œï¼Œæ£€æŸ¥WindowsAdapterçš„æ–¹æ³•
 */

const path = require('path');

async function debugWindowsAdapter() {
  console.log('='.repeat(60));
  console.log('Windows Adapter Runtime Debug');
  console.log('='.repeat(60));

  try {
    // å°è¯•å¯¼å…¥WindowsAdapter
    const adapterPath = path.join(__dirname, '../dist/platforms/windows/windows-adapter');
    console.log('Adapter path:', adapterPath);

    const { WindowsAdapter } = require(adapterPath);
    console.log('âœ… WindowsAdapter imported successfully');

    // åˆ›å»ºå®ä¾‹
    const adapter = new WindowsAdapter();
    console.log('âœ… WindowsAdapter instantiated');

    // æ£€æŸ¥VERSION
    console.log('\nVERSION:', adapter.VERSION || 'UNDEFINED');

    // æ£€æŸ¥æ–¹æ³•
    console.log('\nMethod checks:');
    console.log('  getActiveURL:', typeof adapter.getActiveURL);
    console.log('  getActiveWindow:', typeof adapter.getActiveWindow);
    console.log('  takeScreenshot:', typeof adapter.takeScreenshot);

    // åˆ—å‡ºæ‰€æœ‰æ–¹æ³•
    console.log('\nAll methods:');
    const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(adapter));
    methods.forEach(method => {
      if (typeof adapter[method] === 'function') {
        console.log(`  - ${method}`);
      }
    });

    // æµ‹è¯•getActiveURLæ˜¯å¦çœŸçš„å¯ä»¥è°ƒç”¨
    if (typeof adapter.getActiveURL === 'function') {
      console.log('\nâœ… getActiveURL is callable');

      // å°è¯•è°ƒç”¨ï¼ˆä¸éœ€è¦çœŸçš„é‡‡é›†ï¼‰
      try {
        const result = await adapter.getActiveURL('chrome');
        console.log('  Call result:', result);
      } catch (callError) {
        console.log('  Call failed:', callError.message);
      }
    } else {
      console.log('\nâŒ getActiveURL is NOT callable');
    }

  } catch (error) {
    console.error('âŒ Debug failed:', error);
    console.error('Stack:', error.stack);
  }

  console.log('='.repeat(60));
}

// å¦‚æœç›´æ¥è¿è¡Œ
if (require.main === module) {
  debugWindowsAdapter();
}

module.exports = { debugWindowsAdapter };
```

è¿è¡Œï¼š
```bash
cd C:\Users\å¼ å°é±¼\AppData\Local\Programs\EmployeeSafety\resources
node debug-runtime-methods.js
```

### 2. ASARå†…å®¹æ£€æŸ¥è„šæœ¬

åˆ›å»º `claudedocs/check-asar-contents.ps1`:

```powershell
# æ£€æŸ¥app.asarä¸­çš„å†…å®¹

Write-Host "========================================="
Write-Host "ASAR Contents Verification"
Write-Host "========================================="

$asarPath = "$env:LOCALAPPDATA\Programs\EmployeeSafety\resources\app.asar"
$extractPath = "temp-asar-check"

# æ¸…ç†
if (Test-Path $extractPath) {
    Remove-Item $extractPath -Recurse -Force
}

# æå–asar
Write-Host "[INFO] Extracting app.asar..."
asar extract $asarPath $extractPath

# æ£€æŸ¥WindowsAdapter
$adapterPath = "$extractPath\dist\platforms\windows\windows-adapter.js"

if (Test-Path $adapterPath) {
    $content = Get-Content $adapterPath -Raw

    Write-Host "[INFO] Checking windows-adapter.js..."

    # æ£€æŸ¥æ–‡ä»¶å¤§å°
    $size = (Get-Item $adapterPath).Length
    Write-Host "  File size: $([math]::Round($size/1KB, 2)) KB"

    # æ£€æŸ¥å…³é”®å†…å®¹
    if ($content -match "getActiveURL") {
        Write-Host "  âœ… Contains getActiveURL"
    } else {
        Write-Host "  âŒ Missing getActiveURL"
    }

    if ($content -match "VERSION.*=") {
        Write-Host "  âœ… Contains VERSION"
    } else {
        Write-Host "  âŒ Missing VERSION"
    }

    # æ£€æŸ¥åŠ¨æ€å¯¼å…¥
    if ($content -match "require\(['\"]\./url-collector['\"]\)") {
        Write-Host "  âœ… Contains url-collector import"
    } else {
        Write-Host "  âš ï¸ Different import pattern"
    }
} else {
    Write-Host "[ERROR] windows-adapter.js not found in ASAR!"
}

# æ£€æŸ¥url-collector
$collectorPath = "$extractPath\dist\platforms\windows\url-collector.js"
if (Test-Path $collectorPath) {
    Write-Host "[INFO] âœ… url-collector.js exists in ASAR"
} else {
    Write-Host "[ERROR] âŒ url-collector.js missing from ASAR!"
}

# æ¸…ç†
Remove-Item $extractPath -Recurse -Force

Write-Host "========================================="
```

---

## ğŸ“‹ è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³æ‰§è¡Œï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

#### Priority 1: éªŒè¯ASARå†…å®¹
```powershell
.\claudedocs\check-asar-contents.ps1
```

**å¦‚æœurl-collector.jsç¼ºå¤±æˆ–getActiveURLä¸å­˜åœ¨**ï¼š
â†’ é—®é¢˜æ˜¯æ‰“åŒ…é…ç½®ï¼Œæ‰§è¡Œæ–¹æ¡ˆD

#### Priority 2: æµ‹è¯•åŠ¨æ€å¯¼å…¥
```bash
# åœ¨åº”ç”¨å®‰è£…ç›®å½•è¿è¡Œ
node claudedocs/debug-runtime-methods.js
```

**å¦‚æœå¯¼å…¥å¤±è´¥**ï¼š
â†’ é—®é¢˜æ˜¯åŠ¨æ€å¯¼å…¥ï¼Œæ‰§è¡Œæ–¹æ¡ˆAï¼ˆæ”¹ç”¨é™æ€å¯¼å…¥ï¼‰

#### Priority 3: æ£€æŸ¥è¿è¡Œæ—¶æ—¥å¿—
```powershell
# æŸ¥çœ‹æœ€æ–°æ—¥å¿—
Get-Content $env:APPDATA\employee-monitor\logs\*.log -Tail 100 |
  Select-String "WindowsAdapter|getActiveURL|url-collector"
```

**å¦‚æœçœ‹åˆ° "MODULE_NOT_FOUND"**ï¼š
â†’ é—®é¢˜æ˜¯æ¨¡å—è·¯å¾„ï¼Œæ‰§è¡Œæ–¹æ¡ˆBï¼ˆä¿®å¤è·¯å¾„ï¼‰

#### Priority 4: å¯¹æ¯”GitHub Release
```bash
# ä¸‹è½½å¹¶éªŒè¯GitHub release
# å¯¹æ¯”SHA256å“ˆå¸Œ
```

**å¦‚æœå“ˆå¸Œä¸åŒ¹é…**ï¼š
â†’ é—®é¢˜æ˜¯GitHub Actionsï¼Œéœ€è¦é‡æ–°æ„å»º

---

## ğŸ’¡ é¢„é˜²æªæ–½ï¼ˆæœªæ¥ï¼‰

### 1. æ·»åŠ è¿è¡Œæ—¶è‡ªæ£€

åœ¨åº”ç”¨å¯åŠ¨æ—¶éªŒè¯å…³é”®æ–¹æ³•ï¼š

```typescript
// main/index.ts
async function validatePlatformAdapter(adapter: any) {
  const requiredMethods = ['getActiveURL', 'getActiveWindow', 'takeScreenshot'];

  for (const method of requiredMethods) {
    if (typeof adapter[method] !== 'function') {
      logger.error(`âŒ CRITICAL: ${method} method missing!`);
      throw new Error(`Platform adapter validation failed: ${method} missing`);
    }
  }

  logger.info('âœ… Platform adapter validation passed');
}
```

### 2. æ”¹è¿›æ„å»ºéªŒè¯

åœ¨ `.github/workflows/build-and-release.yml` æ·»åŠ ï¼š

```yaml
- name: Runtime method verification
  run: |
    # åœ¨æ„å»ºå®Œæˆåè¿è¡Œruntimeæ£€æµ‹è„šæœ¬
    node claudedocs/debug-runtime-methods.js
```

### 3. ä½¿ç”¨é™æ€å¯¼å…¥

é¿å…åŠ¨æ€importï¼Œæ”¹ç”¨é™æ€importä»¥æé«˜å¯é æ€§ã€‚

---

**ä¸‹ä¸€æ­¥**ï¼šè¯·æŒ‰ç…§"è¡ŒåŠ¨è®¡åˆ’"ä¸­çš„Priority 1-4é¡ºåºæ‰§è¡Œï¼Œå¹¶å°†ç»“æœåé¦ˆç»™æˆ‘ï¼
