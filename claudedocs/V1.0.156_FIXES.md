# v1.0.156 修复总结

**发布日期**: 2025-12-22
**修复版本**: 1.0.156
**修复问题**: 热更新和全量更新都无法正常工作

---

## 🔧 应用的修复

### 修复 1: AsarManager.extract - ASAR CLI 路径问题 ✅

**问题**: `ERR_PACKAGE_PATH_NOT_EXPORTED: Package subpath './bin/asar.mjs' is not defined by "exports"`

**文件**: `src/common/services/hot-update/AsarManager.ts:90-107`

**改动**:
```typescript
// ❌ 之前：使用 CLI（打包后路径不可用）
const { execSync } = require('child_process');
const asarCli = require.resolve('@electron/asar/bin/asar.mjs'); // 打包后失败
execSync(`node "${asarCli}" extract "${this.asarPath}" "${targetDir}"`);

// ✅ 现在：使用 API（稳定可靠）
const asar = await this.loadAsarModule();
await asar.extractAll(this.asarPath, targetDir);
```

**效果**:
- ✅ 热更新的 ASAR 解压在打包后可以正常工作
- ✅ 不再依赖 CLI 路径解析
- ✅ 性能更好（直接 API 调用）

**验证**:
```bash
# 已验证编译到 ASAR 中
grep -A5 "解包ASAR到临时目录" /tmp/verify-1.0.156/out/dist/common/services/hot-update/AsarManager.js
# 输出包含: "使用 @electron/asar API 而非 CLI（修复打包后路径不可用问题）"
```

---

### 修复 2: 安装脚本打包配置 ✅

**问题**: `[AUTO_UPDATE] Install script not found: .../installer-scripts/auto-install-update-macos.sh`

**文件 A**: `scripts/build/pack-mac-universal.js:36-39`

**改动**:
```javascript
const commonConfig = {
  // ...
  // ✅ 新增：打包安装脚本
  extraResource: [
    path.join(__dirname, '../../scripts/installer/macos/auto-install-update-macos.sh')
  ],
  // ...
};
```

**文件 B**: `electron/auto-update-integration.js:473-493`

**改动**:
```javascript
// ✅ 优先尝试 Resources 根目录（extraResource 默认位置）
scriptPath = path.join(process.resourcesPath, 'auto-install-update-macos.sh');

// 如果不存在，尝试 installer-scripts 子目录（向后兼容）
if (!fs.existsSync(scriptPath)) {
  scriptPath = path.join(process.resourcesPath, 'installer-scripts', 'auto-install-update-macos.sh');
}
```

**效果**:
- ✅ 安装脚本被打包到应用中
- ✅ 全量更新可以自动安装
- ✅ 向后兼容不同的目录结构

**验证**:
```bash
# 脚本已打包
find release/EmployeeSafety-darwin-arm64/EmployeeSafety.app/Contents/Resources -name "auto-install*"
# 输出: Resources/auto-install-update-macos.sh
```

---

### 修复 3: 按钮颜色（测试标识）

**文件**: `electron/renderer/minimal-index.html:345-352`

**改动**: 黄色 (v1.0.155) → 灰色 (v1.0.156)

**用途**: 视觉确认热更新是否成功

---

## 📊 修复前后对比

### 热更新流程（1.0.154 → 1.0.155）

**修复前** ❌:
```
检测更新 → 服务端返回 { updateType: 'hot' }
  ↓
下载差异包 (164ms) ✅
  ↓
校验通过 ✅
  ↓
备份 app.asar ✅
  ↓
❌ ASAR 解压失败 (ERR_PACKAGE_PATH_NOT_EXPORTED)
  ↓
回滚 → 回退到全量更新 (103.94 MB)
  ↓
下载完成 → 点击"立即重启"
  ↓
❌ 安装脚本不存在 → 自动安装失败
  ↓
❌ quitAndInstall() 失败（签名问题）
  ↓
应用未重启，更新未安装
```

**修复后** ✅ (1.0.155 → 1.0.156):
```
检测更新 → 服务端返回 { updateType: 'hot' }
  ↓
下载差异包 (~25KB) ✅
  ↓
校验通过 ✅
  ↓
备份 app.asar ✅
  ↓
✅ ASAR 解压成功 (使用 API)
  ↓
应用差异 ✅
  ↓
创建 app.asar.new ✅
  ↓
提示重启 → 用户点击
  ↓
应用重启 → main-minimal.js 检测 .new 文件
  ↓
替换 ASAR ✅
  ↓
版本更新为 1.0.156，按钮变灰色 ✅
```

### 全量更新流程（备用）

**修复前** ❌:
```
下载全量包 (103.94 MB) ✅
  ↓
检测到本地缓存 ✅
  ↓
尝试自动安装
  ↓
❌ 安装脚本不存在
  ↓
回退到 quitAndInstall()
  ↓
❌ 签名验证失败 → 应用未重启
```

**修复后** ✅:
```
下载全量包 (103.94 MB) ✅
  ↓
检测到本地缓存 ✅
  ↓
尝试自动安装
  ↓
✅ 找到安装脚本 (Resources/auto-install-update-macos.sh)
  ↓
执行安装脚本 ✅
  ↓
应用自动重启并安装 ✅
```

---

## 🧪 测试计划

### 测试 1: 热更新流程（主要场景）

**前提条件**:
- 当前版本: 1.0.155
- 服务端已部署: 1.0.156
- 差异包已生成: 1.0.155 → 1.0.156

**测试步骤**:
1. 启动 v1.0.155 应用
2. 等待自动检测更新（或手动点击"检查更新"）
3. 观察下载进度（应该很快，~25KB）
4. 等待"版本 1.0.156 已下载完成"对话框
5. 点击"立即重启"
6. 观察应用重启

**预期结果**:
- ✅ 下载差异包（不是 103.94 MB）
- ✅ 下载完成后提示重启
- ✅ 点击重启后应用正常重启
- ✅ 重启后版本显示 1.0.156
- ✅ 按钮背景变为灰色

**验证日志**:
```bash
tail -100 ~/Library/Logs/employee-safety-client/update.log | grep -i "extract\|热更新"
```

**期望日志**:
```
[HotUpdate] 开始下载并应用更新: 1.0.156
[HotUpdate] 下载完成,耗时: ...ms
[HotUpdate] 校验通过
[HotUpdate] 备份完成
[HotUpdate] ASAR解压成功  # ✅ 新增（之前失败）
[HotUpdate] 应用差异成功
[HotUpdate] 创建 app.asar.new 成功
[PROMPT] User chose to restart
```

### 测试 2: 全量更新流程（备用场景）

**前提条件**:
- 服务端禁用热更新或版本跨度大
- 触发全量更新

**测试步骤**:
1. 触发全量更新检测
2. 观察下载进度（103.94 MB）
3. 等待下载完成对话框
4. 点击"立即重启"

**预期结果**:
- ✅ 下载全量包
- ✅ 自动安装脚本执行（不显示对话框，直接重启）
- ✅ 应用自动重启并安装
- ✅ 版本更新成功

**验证日志**:
```bash
tail -50 ~/Library/Logs/employee-safety-client/auto-update.log | grep -i "install script"
```

**期望日志**:
```
[AUTO_UPDATE] Found update zip: .../EmployeeSafety.zip
[AUTO_UPDATE] Executing install script: .../auto-install-update-macos.sh  # ✅ 找到脚本
[AUTO_UPDATE] Install script launched successfully
```

---

## 🚨 已知问题和限制

### 1. quitAndInstall 签名验证（次要）

**问题**: 如果自动安装脚本失败，回退到 `quitAndInstall()` 可能因签名问题失败

**影响**: 全量更新时，极少数情况下点击"立即重启"无反应

**状态**: 已在分析报告中记录，P2 优先级

**临时解决方案**: 用户手动重启应用即可完成安装

### 2. electron-packager extraResource 限制

**问题**: `extraResource` 将文件直接放在 Resources 根目录，不支持子目录结构

**当前方案**: 代码适配，优先查找根目录

**长期方案**: 考虑使用 electron-builder 的 `extraResources` 配置（支持目录结构）

---

## 📝 部署检查清单

### 构建验证

- [x] v1.0.156 编译成功
- [x] AsarManager.extract 修复已编译到 ASAR
- [x] 安装脚本已打包到 Resources
- [x] 按钮颜色为灰色（视觉确认）

### 服务端配置

- [ ] 部署 v1.0.156 到更新服务器
- [ ] 配置 1.0.155 → 1.0.156 差异包
- [ ] 验证 API 返回 `updateType: 'hot'`

### 测试验证

- [ ] 测试热更新流程（主要）
- [ ] 测试全量更新流程（备用）
- [ ] 检查日志确认修复生效

---

## 📦 发布文件

```
release/
├── EmployeeSafety-1.0.156-mac.zip           # Intel Mac (110.09 MB)
├── EmployeeSafety-1.0.156-arm64-mac.zip     # Apple Silicon (103.94 MB)
├── 安装-Intel.command                        # Intel 一键安装
├── 安装-AppleSilicon.command                 # M1/M2 一键安装
└── 安装指南.md
```

---

## 🔗 相关文档

- 问题分析报告: `claudedocs/DEBUGGING_RESULTS.md`
- 原始崩溃分析: `claudedocs/HOT_UPDATE_CRASH_ANALYSIS.md`
- 重启失败分析: `claudedocs/UPDATE_RESTART_FAILURE_ANALYSIS.md`

---

**修复完成时间**: 2025-12-22 10:45
**下一步**: 部署 v1.0.156，测试热更新流程
