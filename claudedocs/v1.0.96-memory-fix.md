# v1.0.96 - 激进内存管理修复

## 问题分析

**崩溃原因**: `v8::internal::V8::FatalProcessOutOfMemory` - V8堆内存溢出

**崩溃时间**: 应用运行约6分钟后崩溃

**之前的问题**:
1. 内存监控间隔太长（5分钟）- 应用在第一次检查前就崩溃
2. GC触发阈值太高（300MB），而最大堆内存只有512MB
3. 统计系统无限增长，没有数据限制
4. 堆内存限制过小（512MB）不足以支撑应用运行

## 修复措施

### 1. 增加堆内存限制
**文件**: `electron/main-minimal.js:14`

**修改前**:
```javascript
app.commandLine.appendSwitch('--max-old-space-size=512');
```

**修改后**:
```javascript
app.commandLine.appendSwitch('--max-old-space-size=2048'); // 从512MB增加到2048MB
```

### 2. 激进的内存监控策略
**文件**: `electron/main-minimal.js:124-148`

**修改前**:
- 检查间隔: 5分钟
- GC阈值: 300MB
- 无警告机制

**修改后**:
```javascript
// Memory monitoring (every 1 minute for aggressive memory management)
memoryMonitorInterval = setInterval(() => {
    const memUsage = process.memoryUsage();
    const heapUsedMB = Math.round(memUsage.heapUsed / 1024 / 1024);
    const heapTotalMB = Math.round(memUsage.heapTotal / 1024 / 1024);
    const rssMB = Math.round(memUsage.rss / 1024 / 1024);

    console.log(`[MEMORY] Heap: ${heapUsedMB}MB / ${heapTotalMB}MB, RSS: ${rssMB}MB`);

    // Trigger GC if heap usage exceeds 200MB (lowered from 300MB)
    if (heapUsedMB > 200 && global.gc) {
        console.log(`[MEMORY] Triggering GC (heap > 200MB: ${heapUsedMB}MB)`);
        const beforeGC = heapUsedMB;
        global.gc();

        const afterGC = process.memoryUsage();
        const afterGCMB = Math.round(afterGC.heapUsed / 1024 / 1024);
        console.log(`[MEMORY] After GC: ${afterGCMB}MB (freed ${beforeGC - afterGCMB}MB)`);
    }

    // Warning if approaching limit
    if (heapUsedMB > 400) {
        console.warn(`[MEMORY] ⚠️ WARNING: High memory usage: ${heapUsedMB}MB / 2048MB`);
    }
}, 60 * 1000); // 1 minute (reduced from 5 minutes)
```

**改进**:
- ✅ 检查间隔: 5分钟 → 1分钟
- ✅ GC阈值: 300MB → 200MB
- ✅ 添加RSS内存监控
- ✅ 添加400MB高内存警告
- ✅ 显示GC释放的内存量

### 3. 统计数据限制
**文件**: `common/utils/url-collect-stats.ts`

**修改前**:
- 无数据限制，Map无限增长
- 可能导致内存泄漏

**修改后**:
```typescript
export class URLCollectStats {
  private static readonly MAX_RECORDS = 10000; // 防止无限增长

  recordSuccess(browser: string, method: string, latency: number): void {
    // Check if we need to reset to prevent memory buildup
    if (this.metrics.total >= URLCollectStats.MAX_RECORDS) {
      logger.warn(`[URLCollectStats] Max records (${URLCollectStats.MAX_RECORDS}) reached, resetting stats`);
      this.reset();
    }
    // ... rest of code
  }

  recordFailure(browser: string, reason?: string): void {
    // Check if we need to reset to prevent memory buildup
    if (this.metrics.total >= URLCollectStats.MAX_RECORDS) {
      logger.warn(`[URLCollectStats] Max records (${URLCollectStats.MAX_RECORDS}) reached, resetting stats`);
      this.reset();
    }
    // ... rest of code
  }
}
```

**改进**:
- ✅ 最大记录数限制: 10,000条
- ✅ 达到限制后自动重置统计
- ✅ 防止Map无限增长

## 内存管理策略对比

| 指标 | 旧版本 | 新版本 | 改进 |
|------|--------|--------|------|
| 最大堆内存 | 512MB | 2048MB | **+300%** |
| 监控频率 | 5分钟 | 1分钟 | **5倍** |
| GC阈值 | 300MB (58%) | 200MB (10%) | **更早触发** |
| 统计限制 | 无限制 | 10,000条 | **防止泄漏** |
| 内存警告 | 无 | 400MB时警告 | **新增** |
| 详细日志 | 基础 | Heap+RSS+释放量 | **增强** |

## 预期效果

### 1. 崩溃预防
- ✅ 更大的内存空间（4倍增长空间）
- ✅ 更频繁的GC（60秒 vs 300秒）
- ✅ 更早的GC触发（200MB vs 300MB）
- ✅ 数据结构有界限（10K记录上限）

### 2. 可观察性
- ✅ 每分钟一次内存报告
- ✅ GC效果可见（显示释放的内存）
- ✅ 高内存使用警告（400MB+）
- ✅ RSS内存监控

### 3. 运行稳定性
**预期运行时间**:
- 旧版本: ~6分钟崩溃
- 新版本: **预期稳定运行数小时**

## 测试验证

### 安装新版本

**Apple Silicon (M1/M2/M3)**:
```bash
cd release
./安装-AppleSilicon.command
```

**Intel Mac**:
```bash
cd release
./安装-Intel.command
```

### 验证内存监控

1. **启动应用**
2. **查看日志**:
```bash
tail -f ~/Library/Logs/employee-monitor/logs/app.log | grep MEMORY
```

3. **预期输出** (每分钟一次):
```
[MEMORY] Heap: XXMaB / XXXMB, RSS: XXXMB
[MEMORY] Triggering GC (heap > 200MB: 215MB)
[MEMORY] After GC: 180MB (freed 35MB)
```

### 长时间运行测试

**测试步骤**:
1. 启动应用
2. 运行至少30分钟
3. 检查应用是否稳定运行
4. 检查内存日志，确认GC正常工作

**成功标准**:
- ✅ 应用稳定运行30分钟以上
- ✅ 内存在200-400MB范围内波动
- ✅ 无崩溃报告生成
- ✅ URL采集功能正常

## 回退方案

如果新版本仍有问题，可以考虑：

1. **进一步增加堆内存**: 2048MB → 4096MB
2. **更频繁的GC**: 1分钟 → 30秒
3. **更低的GC阈值**: 200MB → 150MB
4. **减少统计记录**: 10,000 → 5,000

## 额外建议

### 1. 监控指标
关注以下日志：
- `[MEMORY]` - 内存使用情况
- `[URLCollectStats]` - 统计数据重置
- `DiagnosticReports/EmployeeMonitor-*` - 崩溃报告

### 2. 性能优化
如果内存使用仍然偏高，可以考虑：
- 减少日志输出频率
- 优化数据结构（使用循环缓冲区）
- 清理不必要的缓存

### 3. 生产环境建议
- 启用自动重启机制（如果崩溃）
- 定期监控内存使用趋势
- 收集用户反馈和崩溃日志

## 相关文件

- `electron/main-minimal.js:12-14` - 启动参数
- `electron/main-minimal.js:124-148` - 内存监控
- `common/utils/url-collect-stats.ts:48,66-71,104-109` - 统计限制
- `common/utils/memory-monitor.ts` - 备用内存监控类（未使用）

## 版本信息

- **版本号**: 1.0.96 (下一个版本)
- **修复时间**: 2025-11-05
- **修复类型**: 内存管理优化
- **优先级**: 🔴 Critical（应用崩溃修复）
