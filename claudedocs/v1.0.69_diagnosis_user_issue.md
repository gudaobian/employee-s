# v1.0.69 用户问题诊断

**时间**: 2025-11-04 14:16
**问题**: 用户报告v1.0.69仍显示 "UNKNOWN (old version)"
**状态**: 🔍 调查中

---

## 用户日志分析

```
Platform adapter version: UNKNOWN (old version)
getActiveURL method exists: false
Available methods: constructor,takeScreenshot,captureWindow,...[没有getActiveURL]
```

**安装路径**: `C:\Users\张小鱼\AppData\Local\Programs\EmployeeSafety\resources\app.asar`

## 可能原因

### 原因1: 用户未完全卸载旧版本（最可能 80%）

**现象**:
- Windows安装程序可能没有完全删除旧文件
- `AppData\Local\Programs\EmployeeSafety` 目录有残留
- 新安装覆盖时，某些文件被保留

**验证方法**:
```powershell
# 检查安装目录中的文件时间
Get-Item "C:\Users\张小鱼\AppData\Local\Programs\EmployeeSafety\resources\app.asar" |
  Select-Object FullName, Length, CreationTime, LastWriteTime

# 检查app.asar的创建时间
# 预期：应该是 2025-11-04 14:04 (v1.0.69发布时间)
# 如果是更早的时间，说明是旧版本残留
```

**解决方案**:
```powershell
# 1. 完全卸载
# 控制面板 → 卸载程序 → Employee Safety Client → 卸载

# 2. 手动删除残留目录
Remove-Item "$env:LOCALAPPDATA\Programs\EmployeeSafety" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item "$env:APPDATA\employee-safety-client" -Recurse -Force -ErrorAction SilentlyContinue
Remove-Item "$env:LOCALAPPDATA\employee-safety-client" -Recurse -Force -ErrorAction SilentlyContinue

# 3. 重新下载并安装 v1.0.69
# https://github.com/gudaobian/employee-s/releases/tag/v1.0.69
```

### 原因2: v1.0.69安装包本身包含旧代码（可能性 15%）

**原因**:
- GitHub Actions构建时，native module重建失败但没有abort
- 或者重建步骤被跳过
- 或者electron-builder打包时使用了缓存的旧文件

**验证方法**:
需要下载v1.0.69安装包，解压并检查其中的代码：

```powershell
# 下载安装包
# https://github.com/gudaobian/employee-s/releases/download/v1.0.69/EmployeeSafety-Setup-1.0.69.exe

# 使用7zip解压NSIS安装包
& "C:\Program Files\7-Zip\7z.exe" x EmployeeSafety-Setup-1.0.69.exe -o"temp-verify" -y

# 找到app-64.7z并解压
$app7z = Get-ChildItem "temp-verify" -Recurse -Filter "app-64.7z" | Select-Object -First 1
& "C:\Program Files\7-Zip\7z.exe" x $app7z.FullName -o"temp-app" -y

# 找到app.asar并提取
$asar = Get-ChildItem "temp-app" -Recurse -Filter "app.asar" | Select-Object -First 1
npm install -g asar
asar extract $asar.FullName temp-extracted

# 检查WindowsAdapter的VERSION
Get-Content "temp-extracted\dist\platforms\windows\windows-adapter.js" | Select-String "VERSION"

# 预期输出：
# VERSION = '1.0.69-with-getActiveURL-native-rebuilt'
```

### 原因3: 多版本混用（可能性 5%）

**现象**:
- 用户系统中有多个安装路径
- 运行的是旧路径的版本
- 或者快捷方式指向旧版本

**验证方法**:
```powershell
# 搜索所有EmployeeSafety.exe
Get-ChildItem C:\ -Recurse -Filter "EmployeeSafety.exe" -ErrorAction SilentlyContinue |
  Select-Object FullName, Length, LastWriteTime

# 检查快捷方式指向
$desktopShortcut = "$env:USERPROFILE\Desktop\Employee Safety Client.lnk"
if (Test-Path $desktopShortcut) {
  $shell = New-Object -ComObject WScript.Shell
  $shortcut = $shell.CreateShortcut($desktopShortcut)
  Write-Host "快捷方式目标: $($shortcut.TargetPath)"
}
```

---

## 立即诊断步骤（请用户执行）

### 步骤1: 检查当前安装的版本文件

```powershell
# 检查app.asar文件信息
$asarPath = "C:\Users\张小鱼\AppData\Local\Programs\EmployeeSafety\resources\app.asar"
if (Test-Path $asarPath) {
  $file = Get-Item $asarPath
  Write-Host "=== app.asar 文件信息 ==="
  Write-Host "文件大小: $($file.Length) bytes"
  Write-Host "创建时间: $($file.CreationTime)"
  Write-Host "修改时间: $($file.LastWriteTime)"
  Write-Host ""

  # v1.0.69发布时间: 2025-11-04 14:04 (UTC+8)
  # 如果修改时间早于这个时间，说明是旧版本
  if ($file.LastWriteTime -lt (Get-Date "2025-11-04 14:00:00")) {
    Write-Host "❌ 警告: 这是旧版本的文件！"
    Write-Host "   文件修改时间早于v1.0.69发布时间"
  } else {
    Write-Host "✅ 文件时间正确"
  }
}
```

### 步骤2: 提取并检查app.asar中的代码

```powershell
# 安装asar工具（如果没有）
npm install -g asar

# 提取app.asar
$asarPath = "C:\Users\张小鱼\AppData\Local\Programs\EmployeeSafety\resources\app.asar"
asar extract $asarPath "$env:TEMP\verify-app-asar"

# 检查WindowsAdapter的VERSION
$adapterPath = "$env:TEMP\verify-app-asar\dist\platforms\windows\windows-adapter.js"
if (Test-Path $adapterPath) {
  Write-Host "=== WindowsAdapter VERSION 检查 ==="
  $content = Get-Content $adapterPath -Raw

  if ($content -match 'VERSION\s*=\s*[''"]([^''"]+)[''"]') {
    Write-Host "VERSION: $($matches[1])"

    if ($matches[1] -match "1\.0\.69") {
      Write-Host "✅ VERSION正确包含1.0.69"
    } else {
      Write-Host "❌ VERSION不正确: $($matches[1])"
    }
  } else {
    Write-Host "❌ 未找到VERSION字段"
  }

  # 检查getActiveURL方法
  if ($content -match "getActiveURL\s*\(") {
    Write-Host "✅ getActiveURL方法存在"
  } else {
    Write-Host "❌ getActiveURL方法不存在"
  }

} else {
  Write-Host "❌ WindowsAdapter文件不存在: $adapterPath"
}

# 清理
Remove-Item "$env:TEMP\verify-app-asar" -Recurse -Force -ErrorAction SilentlyContinue
```

### 步骤3: 检查原生模块

```powershell
# 检查native module
$nativeModulePath = "C:\Users\张小鱼\AppData\Local\Programs\EmployeeSafety\resources\app.asar.unpacked\native-event-monitor-win\build\Release\event_monitor.node"

if (Test-Path $nativeModulePath) {
  $module = Get-Item $nativeModulePath
  Write-Host "=== Native Module 信息 ==="
  Write-Host "文件大小: $($module.Length) bytes"
  Write-Host "修改时间: $($module.LastWriteTime)"

  # 检查文件是否在v1.0.69发布后编译
  if ($module.LastWriteTime -lt (Get-Date "2025-11-04 14:00:00")) {
    Write-Host "❌ 警告: 原生模块是旧版本！"
  } else {
    Write-Host "✅ 原生模块时间正确"
  }
} else {
  Write-Host "⚠️ 原生模块不存在（可能在app.asar内）"
}
```

---

## 推荐解决方案

### 方案1: 完全重新安装（推荐给用户）

```powershell
# === 第1步：完全卸载 ===
Write-Host "第1步：完全卸载旧版本..."

# 如果程序正在运行，先关闭
taskkill /F /IM EmployeeSafety.exe /T 2>$null

# 卸载程序（需要手动操作）
Write-Host "请在控制面板中卸载 'Employee Safety Client'"
Read-Host "卸载完成后按回车继续"

# === 第2步：手动删除残留 ===
Write-Host "第2步：删除残留文件..."

$paths = @(
    "$env:LOCALAPPDATA\Programs\EmployeeSafety",
    "$env:APPDATA\employee-safety-client",
    "$env:LOCALAPPDATA\employee-safety-client"
)

foreach ($path in $paths) {
    if (Test-Path $path) {
        Write-Host "删除: $path"
        Remove-Item $path -Recurse -Force -ErrorAction SilentlyContinue
    }
}

Write-Host "✅ 残留文件已清理"

# === 第3步：重新安装 ===
Write-Host "第3步：下载并安装v1.0.69..."
Write-Host "下载地址: https://github.com/gudaobian/employee-s/releases/download/v1.0.69/EmployeeSafety-Setup-1.0.69.exe"
Write-Host ""
Write-Host "⚠️ 重要提示："
Write-Host "1. 确保下载的是 v1.0.69 版本"
Write-Host "2. 文件大小应该约为 82 MB (86159156 bytes)"
Write-Host "3. 安装完成后重启电脑"
```

### 方案2: 如果方案1失败，验证安装包本身

如果用户完全重新安装后问题依然存在，那么问题可能在安装包本身。

需要我们：
1. 下载v1.0.69安装包
2. 解压并验证其中的代码
3. 检查GitHub Actions构建日志

---

## 后续行动

### 立即行动

1. **请用户执行"立即诊断步骤"**
2. **收集诊断结果**
3. **根据结果判断是用户端问题还是安装包问题**

### 如果是用户端问题

- 指导用户完全重新安装（方案1）

### 如果是安装包问题

需要检查：
1. GitHub Actions v1.0.69构建日志
2. "Rebuild Windows native module for Electron 28"步骤是否成功
3. 验证步骤是否通过
4. 如果发现问题，需要修复并重新发布v1.0.70

---

## 关键问题

**为什么v1.0.69构建通过了所有验证步骤，但用户还是收到旧代码？**

可能的原因：
1. ✅ 验证步骤检查的是`dist/`目录中的代码（正确）
2. ❌ electron-builder打包时使用了不同的代码源
3. ❌ 或者NSIS安装包创建过程中替换了文件

**检验方法**：
下载v1.0.69的`.exe`安装包，解压后检查其中的`app.asar`是否包含正确的代码。

---

**文档版本**: v1.0
**下一步**: 等待用户诊断结果
